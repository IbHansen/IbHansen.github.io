

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>modelclass &mdash; ModelFlow  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../index.html">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">content:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/Core.html">Core Modules, creates and solves model instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onboard/onboard.html">Processing model specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../attribution/Attribution.html">Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vis/modelvis.html">Quick result visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../report/modelreport.html">Report writing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotly/modeldashsidebar.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter/jupyter.html">Jupyter Stuff</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelinvert.html">Targets and instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelmf.html">Enrich dataframes with modelflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/model_cvx.html">Convex optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelsandbox.html">Template for a user defined  model class based on the model class</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ModelFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">modelclass</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for modelclass</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Sep 02 19:41:11 2013</span>

<span class="sd">This module creates the **model** class (:class:`model`), which is the main class for </span>
<span class="sd">managing models.  </span>

<span class="sd">To make life easy the model class is constructed through a numner of mixin classes. </span>
<span class="sd">Each of these handles more or less common tasks. </span>

<span class="sd">- :class:`BaseModel`</span>
<span class="sd">- :class:`Solver_Mixin`</span>
<span class="sd">- :class:`Zip_Mixin`</span>
<span class="sd">- :class:`Json_Mixin`</span>
<span class="sd">- :class:`Model_help_Mixin`</span>
<span class="sd">- :class:`Display_Mixin`</span>
<span class="sd">- :class:`Graph_Draw_Mixin`</span>
<span class="sd">- :class:`Graph_Mixin`</span>
<span class="sd">- :class:`Dekomp_Mixin`</span>
<span class="sd">- :class:`Org_model_Mixin`</span>
<span class="sd">- :class:`Description_Mixin`</span>
<span class="sd">- :class:`Excel_Mixin`</span>
<span class="sd">- :class:`Dash_Mixin`</span>
<span class="sd">- :class:`Modify_Mixin`</span>
<span class="sd">- :class:`Fix_Mixin`</span>
<span class="sd">- :class:`Stability_Mixin`</span>
<span class="sd">- :class:`Report_Mixin`</span>

<span class="sd">In addition the :class:`upd` class is defines, It defines a pandas dataframe extension </span>
<span class="sd">which allows the user to use the upd methods on dataframes. </span>

<span class="sd">The core function of **model** is :func:`BaseModel.analyzemodelnew` which first </span>
<span class="sd">tokenizes a model specification then anlyzes the model. Then the model can be solved </span>
<span class="sd">by one of the methods in the :class:`Solver_Mixin` class. </span>



<span class="sd">@author: Ib</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># if in linux </span>
    <span class="kn">import</span> <span class="nn">model_Excel</span> <span class="k">as</span> <span class="nn">me</span>
<span class="k">except</span><span class="p">:</span> 
    <span class="o">...</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">zip_longest</span><span class="p">,</span><span class="n">accumulate</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">import</span> <span class="nn">webbrowser</span> <span class="k">as</span> <span class="nn">wb</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>

<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span><span class="n">cached_property</span><span class="p">,</span><span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span><span class="p">,</span><span class="n">StringIO</span>


<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
<span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;figure.autolayout&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;figure.max_open_warning&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">SVG</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">IFrame</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ip</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span><span class="p">,</span> <span class="n">njit</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">xlwings</span> <span class="k">as</span> <span class="nn">xw</span>
<span class="k">except</span><span class="p">:</span>
    <span class="o">...</span>




<span class="kn">import</span> <span class="nn">modelmanipulation</span> <span class="k">as</span> <span class="nn">mp</span>

<span class="kn">import</span> <span class="nn">modelvis</span> <span class="k">as</span> <span class="nn">mv</span>
<span class="kn">import</span> <span class="nn">modelpattern</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="kn">from</span> <span class="nn">modelnet</span> <span class="kn">import</span> <span class="n">draw_adjacency_matrix</span>
<span class="kn">from</span> <span class="nn">modelnewton</span> <span class="kn">import</span> <span class="n">newton_diff</span>
<span class="kn">import</span> <span class="nn">modeljupyter</span> <span class="k">as</span> <span class="nn">mj</span>
<span class="kn">from</span> <span class="nn">modelhelp</span> <span class="kn">import</span> <span class="n">cutout</span><span class="p">,</span> <span class="n">update_var</span>
<span class="kn">from</span> <span class="nn">modelnormalize</span> <span class="kn">import</span> <span class="n">normal</span>
<span class="kn">from</span> <span class="nn">modeldekom</span> <span class="kn">import</span> <span class="n">totdif</span>


<span class="c1"># functions used in BL language</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">isclose</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">erf</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erfinv</span><span class="p">,</span> <span class="n">ndtri</span>
<span class="kn">import</span> <span class="nn">gzip</span>


<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="BaseModel">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel">[docs]</a>
<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">():</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class which defines a model from equations</span>


<span class="sd">   In itself the BaseModel is of no use. </span>
<span class="sd">   </span>
<span class="sd">   The **model** class enriches BaseModel with additional </span>
<span class="sd">   Mixin classes which has additional methods and properties. </span>

<span class="sd">  </span>
<span class="sd">   A model instance has a number of properties among which theese can be particular useful:</span>

<span class="sd">       :allvar: Information regarding all variables </span>
<span class="sd">       :basedf: A dataframe with first result created with this model instance</span>
<span class="sd">       :lastdf: A dataframe with the last result created with this model instance </span>

<span class="sd">   The two result dataframes are used for comparision and visualisation. The user can set both basedf and altdf.     </span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_eq</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">modelname</span><span class="o">=</span><span class="s1">&#39;testmodel&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">straight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">tabcomplete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">previousbase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_preorder</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">safeorder</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">var_description</span><span class="o">=</span><span class="p">{},</span> <span class="n">model_description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> 
                 <span class="n">var_groups</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">reports</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">equations_latex</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">eviews_dict</span> <span class="o">=</span> <span class="p">{},</span><span class="n">use_fbmin</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; initialize a model&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">i_eq</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">funks</span> <span class="o">=</span> <span class="n">funks</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span> <span class="o">=</span> <span class="n">i_eq</span> <span class="k">if</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">i_eq</span> <span class="k">else</span> <span class="n">mp</span><span class="o">.</span><span class="n">tofrml</span><span class="p">(</span><span class="n">i_eq</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">modelname</span>
            <span class="c1"># if True the dependency graph will not be called and calculation wil be in input sequence</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">straight</span> <span class="o">=</span> <span class="n">straight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">safeorder</span><span class="o">=</span> <span class="n">safeorder</span> 

            <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>    <span class="c1"># saves the dataframe in self.basedf, self.lastdf</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_fbmin</span> <span class="o">=</span> <span class="n">use_fbmin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analyzemodelnew</span><span class="p">(</span><span class="n">silent</span><span class="p">)</span>  <span class="c1"># on board the model equations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxstart</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># do we want tabcompletion (slows dovn input to large models)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tabcomplete</span> <span class="o">=</span> <span class="n">tabcomplete</span>
            <span class="c1"># set basedf to the previous run instead of the first run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">previousbase</span> <span class="o">=</span> <span class="n">previousbase</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">istopo</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">straight</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span> <span class="o">=</span> <span class="n">use_preorder</span>    <span class="c1"># if prolog is used in sim2d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group_dict</span> <span class="o">=</span> <span class="p">{}</span> 
            
            <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="o">=</span> <span class="n">var_description</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span> <span class="o">=</span> <span class="n">var_groups</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="o">=</span>  <span class="n">reports</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">model_description</span><span class="o">=</span> <span class="n">model_description</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eviews_dict</span> <span class="o">=</span> <span class="n">eviews_dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations_latex</span> <span class="o">=</span> <span class="n">equations_latex</span>
        <span class="k">return</span>

<div class="viewcode-block" id="BaseModel.from_eq">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.from_eq">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_eq</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">equations</span><span class="p">,</span> <span class="n">modelname</span><span class="o">=</span><span class="s1">&#39;testmodel&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">straight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">params</span><span class="o">=</span><span class="p">{},</span> <span class="n">tabcomplete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">previousbase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a model from macro Business logic language.</span>

<span class="sd">        That is the model specification is first exploded. </span>

<span class="sd">        :parameter equations: The model</span>
<span class="sd">        :parameter modelname: Name of the model. Defaults to &#39;testmodel&#39;.</span>
<span class="sd">        :parameter silent: Suppress messages. Defaults to False.</span>
<span class="sd">        :parameter straigth: Don&#39;t reorder the model. Defaults to False.</span>
<span class="sd">        :parameter funks: Functions incorporated in the model specification . Defaults to [].</span>
<span class="sd">        :parameter params: For later use. Defaults to {}.</span>
<span class="sd">        :parameter tabcomplete: Allow tab compleetion in editor, for large model time consuming. Defaults to True.</span>
<span class="sd">        :parameter previousbase: Use previous run as basedf not the first. Defaults to False.</span>
<span class="sd">        :parameter norm: Normalize the model. Defaults to True.</span>
<span class="sd">        :parameter sym: If normalize do it symbolic. Defaults to False.</span>
<span class="sd">        :parameter sep: Seperate the equations. Defaults to newline.        </span>
<span class="sd">        :return:  A model instance </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">udrullet</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">equations</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
                              <span class="n">sym</span><span class="o">=</span><span class="n">sym</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">check_syntax_model</span><span class="p">(</span><span class="n">udrullet</span><span class="p">)</span>
        <span class="n">mmodel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span> <span class="n">modelname</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="n">straight</span><span class="o">=</span><span class="n">straight</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">,</span>
                     <span class="n">tabcomplete</span><span class="o">=</span><span class="n">tabcomplete</span><span class="p">,</span> <span class="n">previousbase</span><span class="o">=</span><span class="n">previousbase</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="n">normalized</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">equations_original</span> <span class="o">=</span> <span class="n">equations</span>
        <span class="k">return</span> <span class="n">mmodel</span></div>


<div class="viewcode-block" id="BaseModel.get_histmodel">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.get_histmodel">[docs]</a>
    <span class="k">def</span> <span class="nf">get_histmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; return a model instance with a model which generates historic values for equations </span>
<span class="sd">        marked by a frml name I or IDENT</span>
<span class="sd">        </span>
<span class="sd">        Uses :any:`find_hist_model`</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hist_eq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">find_hist_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">hist_eq</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.analyzemodelnew">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.analyzemodelnew">[docs]</a>
    <span class="k">def</span> <span class="nf">analyzemodelnew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Analyze a model</span>

<span class="sd">        The function creats:**Self.allvar** is a dictory with an entry for every variable in the model </span>
<span class="sd">        the key is the variable name. </span>
<span class="sd">        For each endogeneous variable there is a directory with thees keys:</span>

<span class="sd">        :maxlag: The max lag for this variable</span>
<span class="sd">        :maxlead: The max Lead for this variable</span>
<span class="sd">        :endo: 1 if the variable is endogeneous (ie on the left hand side of =</span>
<span class="sd">        :frml: String with the formular for this variable</span>
<span class="sd">        :frmlnumber: The number of the formular </span>
<span class="sd">        :varnr: Number of this variable </span>
<span class="sd">        :terms: The frml for this variable translated to terms </span>
<span class="sd">        :frmlname: The frmlname for this variable </span>
<span class="sd">        :startnr: Start of this variable in gauss seidel solutio vector :Advanced:</span>
<span class="sd">        :matrix: This lhs element is a matrix</span>
<span class="sd">        :dropfrml: If this frml shoud be excluded from the evaluation.</span>


<span class="sd">        In addition theese properties will be created: </span>

<span class="sd">        :endogene: Set of endogeneous variable in the model </span>
<span class="sd">        :exogene: Se exogeneous variable in the model </span>
<span class="sd">        :maxnavlen: The longest variable name </span>
<span class="sd">        :blank: An emty string which can contain the longest variable name </span>
<span class="sd">        :solveorder: The order in which the model is solved - initaly the order of the equations in the model </span>
<span class="sd">        :normalized: This model is normalized</span>
<span class="sd">        :endogene_true: Set of endogeneous variables in model if normalized, else the set of declared endogeneous variables </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="n">mega_all</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">model_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
        <span class="c1"># mega = mega_all</span>
        <span class="c1"># breakpoint()</span>
        <span class="c1"># now separate a model for calculating add_factor  after the model is </span>
        <span class="c1"># run        # the add factor  model has a frmlname of CALC_ADD_FACTOR  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_calc_add_factor</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span> <span class="p">[</span><span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">frmlname</span><span class="p">,</span> <span class="s1">&#39;CALC_ADD_FACTOR&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">nt</span> <span class="ow">in</span> <span class="n">mega_all</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_calc_add_factor</span><span class="p">:</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">mega</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span><span class="n">nt</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">nt</span> <span class="ow">in</span> <span class="n">mega_all</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">frmlname</span><span class="p">,</span> <span class="s1">&#39;CALC_ADD_FACTOR&#39;</span><span class="p">)]</span>
            <span class="n">mega_calc_add_factor</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span><span class="n">nt</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">nt</span> <span class="ow">in</span> <span class="n">mega_all</span> <span class="k">if</span> <span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">frmlname</span><span class="p">,</span> <span class="s1">&#39;CALC_ADD_FACTOR&#39;</span><span class="p">)]</span>
            <span class="n">calc_add_factor_frml</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;FRML &lt;CALC&gt; </span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">expression</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">nt</span> <span class="ow">in</span> <span class="n">mega_calc_add_factor</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_add_factor_model</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calc_add_factor_frml</span><span class="p">),</span><span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="n">modelname</span><span class="o">=</span><span class="s1">&#39;Calculate add factors&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_add_factor_model</span><span class="o">.</span><span class="n">istopo</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The add factor calculation model should be recursive&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mega</span> <span class="o">=</span> <span class="n">mega_all</span> 
                                                                   
        <span class="n">termswithvar</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span> <span class="k">for</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">mega</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nt</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">}</span>
<span class="c1">#        varnames = list({t.var for t in termswithvar})</span>
        <span class="n">termswithlag</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">termswithvar</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>   <span class="c1"># sorted by varname and lag</span>
        <span class="n">groupedvars</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">termswithlag</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">varmaxlag</span> <span class="o">=</span> <span class="p">{</span><span class="n">varandlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span>
            <span class="nb">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">varandlags</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span> <span class="k">for</span> <span class="n">varandlags</span> <span class="ow">in</span> <span class="n">groupedvars</span><span class="p">}</span>
        <span class="n">groupedvars</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">termswithlag</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">varmaxlead</span> <span class="o">=</span> <span class="p">{</span><span class="n">varandlags</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span>
            <span class="nb">max</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">varandlags</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span> <span class="k">for</span> <span class="n">varandlags</span> <span class="ow">in</span> <span class="n">groupedvars</span><span class="p">}</span>
<span class="c1">#        self.maxlag   = min(varmaxlag[v] for v in varmaxlag.keys())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varmaxlag</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varmaxlead</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;maxlag&#39;</span><span class="p">:</span> <span class="n">varmaxlag</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
            <span class="s1">&#39;maxlead&#39;</span><span class="p">:</span> <span class="n">varmaxlead</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
            <span class="s1">&#39;matrix&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1">#                            &#39;startnr&#39;    : 0,</span>
            <span class="s1">&#39;endo&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">{</span><span class="n">t</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">termswithvar</span><span class="p">}}</span>

        <span class="c1"># self.aequalterm = (&#39;&#39;,&#39;&#39;,&#39;=&#39;,&#39;&#39;,&#39;&#39;)     # this is how a term with = looks like</span>
        <span class="c1"># this is how a term with = looks like</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aequalterm</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">frmlnumber</span><span class="p">,</span> <span class="p">((</span><span class="n">frml</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">udtryk</span><span class="p">),</span> <span class="n">nt</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mega</span><span class="p">):</span>
            <span class="c1"># find the position of =</span>
            <span class="n">assigpos</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aequalterm</span><span class="p">)</span>
            <span class="c1"># variables to the left of the =</span>
            <span class="n">zendovar</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nt</span><span class="p">[:</span><span class="n">assigpos</span><span class="p">]</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">]</span>
            <span class="c1"># do this formular define a matrix on the left of =</span>
            <span class="n">boolmatrix</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;MATRIX&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">endo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zendovar</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; **** On the left hand side several times: &#39;</span><span class="p">,</span> <span class="n">endo</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;frmlnumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frmlnumber</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">frml</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nt</span><span class="p">[:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boolmatrix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">endo</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assigpos</span>

        <span class="c1"># finished looping over all the equations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">]}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">allvar_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">exogene_true</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">}</span>
        <span class="c1"># breakpoint()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">((</span><span class="n">v</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;___RES&#39;</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endogene_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="k">if</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">}</span>

        
        <span class="c1"># dummy variables  for variables for which to calculate adjustment variables </span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span> <span class="o">=</span>  <span class="nb">sorted</span><span class="p">(</span><span class="n">vx</span><span class="o">+</span><span class="s1">&#39;_D&#39;</span> <span class="k">for</span> <span class="n">vx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> 
                    <span class="k">if</span>   <span class="n">vx</span><span class="o">+</span><span class="s1">&#39;_X&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="ow">and</span>  <span class="n">vx</span><span class="o">+</span><span class="s1">&#39;_D&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_add_factor</span>   <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_A&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_value</span>     <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_X&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fix_endo</span>       <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span><span class="p">]</span>
                



<span class="c1">#        # the order as in the equations</span>
<span class="c1">#        for iz, a in enumerate(sorted(self.allvar)):</span>
<span class="c1">#            self.allvar[a][&#39;varnr&#39;] = iz</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v_nr</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frmlnumber&#39;</span><span class="p">])</span>
                           <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrorder</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_nr</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">straight</span><span class="p">:</span>  <span class="c1"># no sequencing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">istopo</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrorder</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">topo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topo</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">istopo</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">topo</span>
                <span class="c1"># check if there is formulars with several left hand side variables</span>
                <span class="c1"># this is a little tricky</span>
                <span class="n">dropvar</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">topo</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frmlnumber&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topo</span>
                           <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]]</span>   <span class="c1"># all dropped vars and their index in topo and frmlnumber</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dropvar</span><span class="p">):</span>
                    <span class="c1"># all multi-lhs formulars</span>
                    <span class="n">multiendofrml</span> <span class="o">=</span> <span class="p">{</span><span class="n">frmlnr</span> <span class="k">for</span> <span class="p">(</span>
                        <span class="n">var</span><span class="p">,</span> <span class="n">toposort</span><span class="p">,</span> <span class="n">frmlnr</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dropvar</span><span class="p">}</span>
                    <span class="n">dropthisvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span>  <span class="c1"># theese should also be droppen, now all are dropped</span>
                                   <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frmlnumber&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">multiendofrml</span>
                                   <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dropthisvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># now find the first lhs variable in the topo for each formulars. They have to be not dropped</span>
                    <span class="c1"># this means that they should be evaluated first</span>
                    <span class="n">keepthisvarnr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">([</span><span class="n">topoindex</span> <span class="k">for</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">topoindex</span><span class="p">,</span> <span class="n">frmlnr</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dropvar</span> <span class="k">if</span> <span class="n">frmlnr</span> <span class="o">==</span> <span class="n">thisfrml</span><span class="p">])</span>
                                     <span class="k">for</span> <span class="n">thisfrml</span> <span class="ow">in</span> <span class="n">multiendofrml</span><span class="p">]</span>
                    <span class="n">keepthisvar</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">topo</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="k">for</span> <span class="n">nr</span> <span class="ow">in</span> <span class="n">keepthisvarnr</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">keepthisvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># print(&#39;This model has simultaneous elements or cyclical elements.&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">istopo</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrorder</span>

        <span class="c1"># for pretty printing of variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxnavlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blank</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxnavlen</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>  <span class="c1"># a blank of right lenth</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
<span class="c1">#        gc.collect()</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="BaseModel.smpl">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.smpl">[docs]</a>
    <span class="k">def</span> <span class="nf">smpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Defines the model.current_per which is used for calculation period/index</span>
<span class="sd">        when no parameters are issues the current current period is returned \n</span>
<span class="sd">        Either none or all parameters have to be provided &#39;&#39;&#39;</span>
        <span class="n">df_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span> <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># if first invocation just use the max slize</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;current_per&#39;</span><span class="p">):</span>
                <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span>
                    <span class="n">df_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">],</span> <span class="n">df_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">per</span> <span class="o">=</span> <span class="n">df_</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">per</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_current_per</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span></div>


<div class="viewcode-block" id="BaseModel.check_sim_smpl">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.check_sim_smpl">[docs]</a>
    <span class="k">def</span> <span class="nf">check_sim_smpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if the current period (the SMPL) is can contain the lags and the leads&quot;&quot;&quot;</span>
        <span class="c1"># breakpoint() </span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="p">:</span>
            <span class="n">war</span> <span class="o">=</span> <span class="s1">&#39;You are trying to solve the model before all lags are avaiable&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">war</span><span class="si">}</span><span class="se">\n</span><span class="s1">Maxlag:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlag</span><span class="si">}</span><span class="s1">, First solveperiod:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">, First dataframe index:</span><span class="si">{</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span><span class="p">:</span>
            <span class="n">war</span> <span class="o">=</span> <span class="s1">&#39;You are trying to solve the model after all leads are avaiable&#39;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">war</span><span class="si">}</span><span class="se">\n</span><span class="s1">MaxLeead:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span><span class="si">}</span><span class="s1">, Last solveperiod:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">, Last dataframe index:</span><span class="si">{</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  </div>


<div class="viewcode-block" id="BaseModel.set_smpl">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.set_smpl">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">set_smpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the scope for the models time range, and restors it afterward </span>

<span class="sd">        Args:</span>
<span class="sd">            start : Start time. Defaults to &#39;&#39;.</span>
<span class="sd">            end : End time. Defaults to &#39;&#39;.</span>
<span class="sd">            df (Dataframe, optional): Used on a dataframe not self.basedf. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;current_per&#39;</span><span class="p">):</span>
            <span class="n">old_current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
            <span class="n">old_current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># yield</span>
        <span class="c1"># self.current_per = old_current_per</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">old_current_per</span></div>

        


<div class="viewcode-block" id="BaseModel.set_smpl_relative">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.set_smpl_relative">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">set_smpl_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Sets the scope for the models time range relative to the current, and restores it afterward&#39;&#39;&#39;</span>

        <span class="n">old_current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">old_start</span><span class="p">,</span> <span class="n">old_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span>
            <span class="n">old_current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">new_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">old_start</span><span class="o">+</span><span class="n">start_ofset</span><span class="p">)</span>
        <span class="n">new_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">old_end</span><span class="o">+</span><span class="n">end_ofset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">new_start</span><span class="p">:</span><span class="n">new_end</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">old_current_per</span></div>




<div class="viewcode-block" id="BaseModel.keepswitch">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.keepswitch">[docs]</a>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">keepswitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">switch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">base_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scenarios</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
<span class="w">         </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         temporary place basedf,lastdf in keep_solutions</span>
<span class="sd">         if scenarios contains * or ? they are separated by | else space</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">         &quot;&quot;&quot;</span>
         <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
         <span class="c1"># old_keep_solutions = {k:v.copy() for k,v in self.keep_solutions.items() }</span>
         <span class="n">old_keep_solutions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span>
         
         <span class="k">if</span> <span class="n">switch</span> <span class="ow">or</span> <span class="n">base_last</span> <span class="ow">or</span> <span class="n">scenarios</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;base_last&#39;</span><span class="p">}</span> <span class="p">:</span>
             <span class="n">basename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;basename&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Baseline solution&#39;</span>
             <span class="n">lastname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastname</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lastname&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Last solution&#39;</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span> <span class="o">=</span> <span class="p">{</span><span class="n">basename</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">,</span> <span class="n">lastname</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()}</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">scenariolist</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
             <span class="k">if</span> <span class="n">scenarios</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                 <span class="n">selected</span> <span class="o">=</span> <span class="n">scenariolist</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">sep</span><span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">scenarios</span> <span class="ow">or</span> <span class="s1">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">scenarios</span> <span class="k">else</span> <span class="s1">&#39;|&#39;</span> 
                 <span class="n">selected</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span>  <span class="n">up</span> <span class="ow">in</span> <span class="n">scenarios</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">scenariolist</span><span class="p">,</span> <span class="n">up</span><span class="p">))]</span>
             <span class="c1"># print(f&#39;{selected=}&#39;)</span>
             <span class="c1"># print(f&#39;{scenariolist=}&#39;)</span>
             
             <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected</span><span class="p">):</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span>  <span class="n">v</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">}</span>
             <span class="k">else</span><span class="p">:</span> 
                 <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No scenarios match the scenarios: </span><span class="si">{</span><span class="n">scenarios</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span> <span class="o">=</span> <span class="n">old_keep_solutions</span>
         
         <span class="c1"># yield</span>
                     
         <span class="c1"># self.keep_solutions = old_keep_solutions</span>
         <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
         <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span> <span class="o">=</span> <span class="n">old_keep_solutions</span></div>




    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">endograph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Dependencygraph for currrent periode endogeneous variable, used for reorder the equations</span>
<span class="sd">        if self.safeorder is true feedback for all lags are included </span>
<span class="sd">        </span>
<span class="sd">        safeorder was a fix to handle lags = -0 which unexpected was used in WB models. Now it is handeled in modelpattern</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_endograph&#39;</span><span class="p">):</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;endo&#39;</span><span class="p">])</span>

            <span class="n">rhss</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">term</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]:])</span>
                    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">safeorder</span><span class="p">:</span> 
                <span class="c1"># print(&#39;safeorder&#39;)</span>
                <span class="n">rhsvar</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="o">!=</span>
                           <span class="n">var</span>                <span class="p">})</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhss</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rhsvar</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="o">!=</span>
                          <span class="n">var</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">lag</span><span class="p">})</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhss</span><span class="p">)</span>

            <span class="n">edges</span> <span class="o">=</span> <span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhsvar</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endograph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endograph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>
            <span class="c1"># print(self._endograph)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endograph</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calculate_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; The number of operators in the model &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_calculate_freq&#39;</span><span class="p">):</span>
            <span class="n">operators</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;$,()=[]&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">operators</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span>
            <span class="nb">all</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">res</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_freq</span> <span class="o">=</span> <span class="n">res</span><span class="o">+</span><span class="p">[(</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_freq</span>
    
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">flop_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; The number of operators in the model prolog,core and epilog&#39;&#39;&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;prolog&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preorder</span><span class="p">),</span>
            <span class="s1">&#39;core&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">),</span>
            <span class="s1">&#39;epilog&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epiorder</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span>
    
<div class="viewcode-block" id="BaseModel.calculate_freq_list">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.calculate_freq_list">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_freq_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">varlist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Args:</span>
<span class="sd">            varlist (TYPE): calculates number of operations in list of variables.</span>

<span class="sd">        Returns:</span>
<span class="sd">            calculate_freq (TYPE): DESCRIPTION.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">operators</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varlist</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="ow">and</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s1">&#39;$,()=[]&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">operators</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">()</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">res</span><span class="p">))</span>
        <span class="n">calculate_freq</span> <span class="o">=</span> <span class="n">res</span><span class="o">+</span><span class="p">[(</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="nb">all</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">calculate_freq</span></div>


        
    
<div class="viewcode-block" id="BaseModel.get_columnsnr">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.get_columnsnr">[docs]</a>
    <span class="k">def</span> <span class="nf">get_columnsnr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns a dict a databanks variables as keys and column number as item</span>
<span class="sd">        used for fast getting and setting of variable values in the dataframe&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)}</span></div>


<div class="viewcode-block" id="BaseModel.outeval">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.outeval">[docs]</a>
    <span class="k">def</span> <span class="nf">outeval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a evaluater function called los</span>

<span class="sd">        The model axcess the data through:Dataframe.value[rowindex+lag,coloumnindex] which is very efficient </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">short</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">longer</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span>

        <span class="k">def</span> <span class="nf">totext</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; This function returns a python representation of a term&#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>

        <span class="n">columnsnr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columnsnr</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
        <span class="n">fib1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;def make_los(funks=[]):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modeluserfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">userfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modelBLfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">BLfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">funktext</span> <span class="o">=</span> <span class="p">[</span><span class="n">short</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; = funks[&#39;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funktext</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def los(values,row,solveorder, allvar):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;try :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">startline</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">content</span> <span class="o">=</span> <span class="p">(</span><span class="n">longer</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;pass  # &#39;</span><span class="o">+</span><span class="n">v</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span>
                   <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">totext</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">])))</span>
                   <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">)</span>

        <span class="n">fib2</span> <span class="o">=</span> <span class="p">[</span><span class="n">long</span> <span class="o">+</span> <span class="s1">&#39;except :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">longer</span> <span class="o">+</span> <span class="s1">&#39;print(&quot;Error in&quot;,allvar[solveorder[sys.exc_info()[2].tb_lineno-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">startline</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]][&quot;frml&quot;])</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span> <span class="o">+</span> <span class="s1">&#39;raise</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span> <span class="o">+</span> <span class="s1">&#39;return </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;return los</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">fib2</span><span class="p">))</span></div>


    <span class="c1"># def errfunk(self,linenr,startlines=4):</span>
    <span class="c1">#     &#39;&#39;&#39; developement function</span>

    <span class="c1">#     to handle run time errors in model calculations&#39;&#39;&#39;</span>

    <span class="c1">#     winsound.Beep(500,1000)</span>
    <span class="c1">#     print(&#39;&gt;&gt; Error in     :&#39;,self.name)</span>
    <span class="c1">#     print(&#39;&gt;&gt; At           :&#39;,self._per)</span>
    <span class="c1">#     self.errdump = pd.DataFrame(self.values,columns=self.currentdf.columns, index= self.currentdf.index)</span>
    <span class="c1">#     outeq = self.currentmodel[linenr-startlines]</span>
    <span class="c1">#     varout = sorted(list({(var,lag) for (var,lag) in re.findall(self.ypat,outeq) if var not in self.funk}))</span>
    <span class="c1">#     print(&#39;&gt;&gt; Equation     :&#39;,outeq)</span>
    <span class="c1">#     maxlen = str(3+max([len(var) for (var,lag) in varout]))</span>
    <span class="c1">#     fmt = &#39;{:&gt;&#39;+maxlen+&#39;} {:&gt;3} {:&gt;20} &#39;</span>
    <span class="c1">#     print(&#39;&gt;&gt;&#39;,fmt.format(&#39;Var&#39;,&#39;Lag&#39;,&#39;Value&#39;))</span>
    <span class="c1">#     for var,lag in varout:</span>
    <span class="c1">#         lagout = 0 if lag ==&#39;&#39; else int(lag)</span>
    <span class="c1">#         print(&#39;&gt;&gt;&#39;,(&#39;{:&gt;&#39;+maxlen+&#39;} {:&gt;3} {:&gt;20} &#39;).format(var,lagout,self.errdump.loc[self._per+lagout,var]))</span>
    <span class="c1">#     print(&#39;A snapshot of the data at the error point is at .errdump &#39;)</span>

<div class="viewcode-block" id="BaseModel.eqcolumns">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.eqcolumns">[docs]</a>
    <span class="k">def</span> <span class="nf">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; compares two lists&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel.xgenr">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.xgenr">[docs]</a>
    <span class="k">def</span> <span class="nf">xgenr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to end (means end in Danish). </span>

<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>

<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">samedata</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;solve_dag&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="c1"># fill all Missing value with 0.0</span>
            <span class="n">databank</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="c1"># Make sure columns with matrixes are of this type</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">make_los_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outeval</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_los_text</span> <span class="o">=</span> <span class="n">make_los_text</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">make_los_text</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_dag</span> <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="k">for</span> <span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">periode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_dag</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">periode</span><span class="p">,</span> <span class="s1">&#39; solved&#39;</span><span class="p">)</span>
        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; calculated &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="BaseModel.findpos">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.findpos">[docs]</a>
    <span class="k">def</span> <span class="nf">findpos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; find a startposition in the calculation array for a model </span>
<span class="sd">        places startposition for each variable in model.allvar[variable][&#39;startpos&#39;]</span>
<span class="sd">        places the max startposition in model.maxstart &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxstart</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">variabler</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;maxlag&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variabler</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
            <span class="c1"># print(v.ljust(self.maxnavlen),str(m).rjust(6),str(self.allvar[v][&#39;start&#39;]).rju</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxstart</span> <span class="o">=</span> <span class="n">start</span></div>


<div class="viewcode-block" id="BaseModel.make_gaussline">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.make_gaussline">[docs]</a>
    <span class="k">def</span> <span class="nf">make_gaussline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vx</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a line in a gauss-seidel solver for </span>
<span class="sd">        simultanius models</span>
<span class="sd">        the variables are mapped to position in a vector which has all relevant varaibles lagged </span>
<span class="sd">        this is in order to provide opertunity to optimise data and solving </span>

<span class="sd">        New version to take hand of several lhs variables. Dampning is not allowed for</span>
<span class="sd">        this. But can easely be implemented by makeing a function to multiply tupels</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">termer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
        <span class="n">assigpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nodamp</span><span class="p">:</span>
            <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># convention for damping equations</span>
            <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">],</span> <span class="s1">&#39;DAMP&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">assigpos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;You can not dampen equations with several left hand sides:&#39;</span><span class="o">+</span><span class="n">vx</span>
                <span class="n">endovar</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;a[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">assigpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># to implemet dampning of solution</span>
                <span class="n">damp</span> <span class="o">=</span> <span class="s1">&#39;(1-alfa)*(&#39;</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">endovar</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)+alfa*(&#39;</span>
                <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># drop the trailing $</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">assigpos</span> <span class="ow">and</span> <span class="n">ldamp</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">damp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;a[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">lag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ldamp</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>  <span class="c1"># the last ) in the dampening</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="BaseModel.make_resline">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.make_resline">[docs]</a>
    <span class="k">def</span> <span class="nf">make_resline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a line calculating line</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">termer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
        <span class="n">assigpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># drop the trailing $</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">assigpos</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;b[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">lag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;a[&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">lag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="BaseModel.createstuff3">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.createstuff3">[docs]</a>
    <span class="k">def</span> <span class="nf">createstuff3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfxx</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Connect a dataframe with the solution vector used by the iterative sim2 solver) </span>
<span class="sd">        return a function to place data in solution vector and to retrieve it again. &#39;&#39;&#39;</span>

        <span class="n">columsnr</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfxx</span><span class="o">.</span><span class="n">columns</span><span class="p">)}</span>
        <span class="n">pos0</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">lag</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">columsnr</span><span class="p">[</span><span class="n">var</span><span class="p">]))</span>
                       <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;maxlag&#39;</span><span class="p">]),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
<span class="c1">#      if problems check if find_pos has been calculated</span>
        <span class="n">posrow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lag</span> <span class="k">for</span> <span class="p">(</span><span class="n">startpos</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">colpos</span><span class="p">))</span> <span class="ow">in</span> <span class="n">pos0</span><span class="p">])</span>
        <span class="n">poscol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">colpos</span> <span class="k">for</span> <span class="p">(</span><span class="n">startpos</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">colpos</span><span class="p">))</span> <span class="ow">in</span> <span class="n">pos0</span><span class="p">])</span>

        <span class="n">poscolendo</span> <span class="o">=</span> <span class="p">[</span><span class="n">columsnr</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
        <span class="n">posstartendo</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">stuff3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;Fills  a calculating vector with data, </span>
<span class="sd">            speeded up by using dataframe.values &#39;&#39;&#39;</span>

            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="c1">#                a = np.array(values[posrow+row,poscol],dtype=np.dtype(&#39;f8&#39;))</span>
                <span class="c1">#                a = np.ascontiguousarray(values[posrow+row,poscol],dtype=np.dtype(&#39;f8&#39;))</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">posrow</span><span class="o">+</span><span class="n">row</span><span class="p">,</span> <span class="n">poscol</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># a = values[posrow+row,poscol]</span>
                <span class="c1"># a = np.array(values[posrow+row,poscol],dtype=np.dtype(&#39;f8&#39;))</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">posrow</span><span class="o">+</span><span class="n">row</span><span class="p">,</span> <span class="n">poscol</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;f8&#39;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">a</span>

        <span class="k">def</span> <span class="nf">saveeval3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
            <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">poscolendo</span><span class="p">]</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">posstartendo</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">stuff3</span><span class="p">,</span> <span class="n">saveeval3</span></div>


<div class="viewcode-block" id="BaseModel.outsolve">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.outsolve">[docs]</a>
    <span class="k">def</span> <span class="nf">outsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns a string with a function which calculates a </span>
<span class="sd">        Gauss-Seidle iteration of a model</span>
<span class="sd">        exclude is list of endogeneous variables not to be solved </span>
<span class="sd">        uses: </span>
<span class="sd">        model.solveorder the order in which the variables is calculated</span>
<span class="sd">        model.allvar[v][&quot;gauss&quot;] the ccalculation </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">short</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">longer</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span>
        <span class="n">solveorder</span> <span class="o">=</span> <span class="n">order</span> <span class="k">if</span> <span class="n">order</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span>
        <span class="n">fib1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;def make(funks=[]):&#39;</span><span class="p">]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modeluserfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">userfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modelBLfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">BLfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">funktext</span> <span class="o">=</span> <span class="p">[</span><span class="n">short</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; = funks[&#39;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funktext</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def los(a,alfa):&#39;</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="p">(</span><span class="n">long</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gaussline</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">solveorder</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]))</span>
        <span class="n">fib2</span> <span class="o">=</span> <span class="p">[</span><span class="n">long</span> <span class="o">+</span> <span class="s1">&#39;return a &#39;</span><span class="p">]</span>
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;return los&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">fib2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BaseModel.make_solver">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.make_solver">[docs]</a>
    <span class="k">def</span> <span class="nf">make_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; makes a function which performs a Gaus-Seidle iteration</span>
<span class="sd">        if ljit=True a Jittet function will also be created.</span>
<span class="sd">        The functions will be placed in: </span>
<span class="sd">        model.solve </span>
<span class="sd">        model.solve_jit &#39;&#39;&#39;</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outsolve</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>  <span class="c1"># find the text of the solve</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>  <span class="c1"># make the factory defines</span>
        <span class="c1"># using the factory create the function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time for a cup of coffee&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_jit</span> <span class="o">=</span> <span class="n">jit</span><span class="p">(</span>
                <span class="s2">&quot;f8[:](f8[:],f8)&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">solve</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="BaseModel.base_sim">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.base_sim">[docs]</a>
    <span class="k">def</span> <span class="nf">base_sim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">max_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[],</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">conv</span><span class="o">=</span><span class="p">[],</span> <span class="n">samedata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dumpvar</span><span class="o">=</span><span class="p">[],</span> <span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lcython</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">setbase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">setlast</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">sim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">relconv</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
                 <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; solves a model with data from a databank if the model has a solve function else it will be created.</span>

<span class="sd">        The default options are resonable for most use:</span>

<span class="sd">        :parameter start,end: Start and end of simulation, default as much as possible taking max lag into acount  </span>
<span class="sd">        :parameter max_iterations: Max interations</span>
<span class="sd">        :parameter first_test: First iteration where convergence is tested</span>
<span class="sd">        :parameter ljit: If True Numba is used to compile just in time - takes time but speeds solving up </span>
<span class="sd">        :parameter new: Force creation a new version of the solver (for testing)</span>
<span class="sd">        :parameter exclude: Don&#39;t use use theese foormulas</span>
<span class="sd">        :parameter silent: Suppres solving informations </span>
<span class="sd">        :parameter conv: Variables on which to measure if convergence has been achived </span>
<span class="sd">        :parameter samedata: If False force a remap of datatrframe to solving vector (for testing) </span>
<span class="sd">        :parameter dumpvar: Variables to dump </span>
<span class="sd">        :parameter ldumpvar: toggels dumping of dumpvar </span>
<span class="sd">        :parameter dumpwith: with of dumps</span>
<span class="sd">        :parameter dumpdecimal: decimals in dumps </span>
<span class="sd">        :parameter lcython: Use Cython to compile the model (experimental )</span>
<span class="sd">        :parameter alfa: Dampning of formulas marked for dampning (&lt;Z&gt; in frml name)</span>
<span class="sd">        :parameter sim: For later use</span>
<span class="sd">        :parameter absconv: Treshold for applying relconv to test convergence </span>
<span class="sd">        :parameter relconv: Test for convergence </span>
<span class="sd">        :parameter debug:  Output debug information </span>
<span class="sd">        :parameter stats:  Output solving statistics</span>
<span class="sd">        :return outdf: A dataframe with the solution </span>


<span class="sd">       &#39;&#39;&#39;</span>

        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
        <span class="c1"># fill all Missing value with 0.0</span>
        <span class="n">databank</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;create stuffer and gauss lines &#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stuff3&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simcolumns</span><span class="p">,</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stuff3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createstuff3</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Create solver function&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;solve_jit&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">make_solver</span><span class="p">(</span><span class="n">ljit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
                <span class="n">this_solve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_jit</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;solve&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">make_solver</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
                <span class="n">this_solve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1">#        columsnr=self.get_columnsnr(databank)</span>
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># total iteration counter</span>
 <span class="c1">#       convvar = [conv] if isinstance(conv,str) else conv if conv != [] else list(self.endogene)</span>
        <span class="n">convvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>

        <span class="n">convplace</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>  <span class="c1"># this is how convergence is measured</span>
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">convvar</span> <span class="k">if</span> <span class="n">dumpvar</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dump</span><span class="p">]</span>
            <span class="n">dumphead</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[(</span><span class="s1">&#39;{:&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dumpwith</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dump</span><span class="p">])</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">periode</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;stuffing&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span> <span class="k">as</span> <span class="n">tt</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuff3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">ljit</span><span class="p">)</span>
<span class="c1">#                b=self.stuff2(values,row,columsnr)</span>
<span class="c1">#                assert all(a == b)</span>

            <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Start solving&#39;</span><span class="p">,</span> <span class="n">periode</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;             &#39;</span><span class="o">+</span><span class="n">dumphead</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start        &#39;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[(</span><span class="s1">&#39;{:&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dumpwith</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dumpdecimal</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;f}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">]))</span>
            <span class="n">jjj</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
                <span class="n">jjj</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;iteration :&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;iteration &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jjj</span><span class="p">),</span> <span class="n">debug</span><span class="p">)</span> <span class="k">as</span> <span class="n">tttt</span><span class="p">:</span>
                    <span class="n">itbefore</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">convplace</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">this_solve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alfa</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Iteration </span><span class="si">{:&gt;3}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([(</span><span class="s1">&#39;{:&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dumpwith</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dumpdecimal</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;f}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">]))</span>

                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">first_test</span><span class="p">:</span>
                    <span class="n">itafter</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">convplace</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itafter</span><span class="p">,</span> <span class="n">itbefore</span><span class="p">):</span>
                        <span class="c1">#                        print(before,after)</span>
                        <span class="k">if</span> <span class="n">before</span> <span class="o">&gt;</span> <span class="n">absconv</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">after</span><span class="o">-</span><span class="n">before</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">before</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">relconv</span><span class="p">:</span>
                            <span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">convergence</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">periode</span><span class="p">,</span> <span class="s1">&#39;Solved in &#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s1">&#39;iterations&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">itbefore</span> <span class="o">=</span> <span class="n">itafter</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No convergence &#39;</span><span class="p">,</span> <span class="n">periode</span><span class="p">,</span> <span class="s1">&#39; after&#39;</span><span class="p">,</span> <span class="n">jjj</span><span class="p">,</span> <span class="s1">&#39; iterations&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;saving&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="c1">#                self.saveeval2(values,row,columsnr,a) # save the result</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>  <span class="c1"># save the result</span>
            <span class="n">ittotal</span> <span class="o">=</span> <span class="n">ittotal</span><span class="o">+</span><span class="n">jjj</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;: Solving finish from &#39;</span><span class="p">,</span>
                  <span class="n">sol_periode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">sol_periode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;40}</span><span class="s1">:  </span><span class="si">{:&gt;15,}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Floating point operations :&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;40}</span><span class="s1">:  </span><span class="si">{:&gt;15,}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Total iterations :&#39;</span><span class="p">,</span> <span class="n">ittotal</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;40}</span><span class="s1">:  </span><span class="si">{:&gt;15,}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Total floating point operations&#39;</span><span class="p">,</span> <span class="n">numberfloats</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;40}</span><span class="s1">:  </span><span class="si">{:&gt;15,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;Simulation time (seconds) &#39;</span><span class="p">,</span> <span class="n">simtime</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&lt;40}</span><span class="s1">:  </span><span class="si">{:&gt;15,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="s1">&#39;Floating point operations per second&#39;</span><span class="p">,</span> <span class="n">numberfloats</span><span class="o">/</span><span class="n">simtime</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="BaseModel.outres">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.outres">[docs]</a>
    <span class="k">def</span> <span class="nf">outres</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns a string with a function which calculates a </span>
<span class="sd">        calculation for residual check </span>
<span class="sd">        exclude is list of endogeneous variables not to be solved </span>
<span class="sd">        uses: </span>
<span class="sd">        model.solveorder the order in which the variables is calculated</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">short</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">longer</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span>
        <span class="n">solveorder</span> <span class="o">=</span> <span class="n">order</span> <span class="k">if</span> <span class="n">order</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span>
        <span class="n">fib1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;def make(funks=[]):&#39;</span><span class="p">]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modeluserfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">userfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modelBLfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">BLfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from numpy import zeros,float64&#39;</span><span class="p">)</span>
        <span class="n">funktext</span> <span class="o">=</span> <span class="p">[</span><span class="n">short</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; = funks[&#39;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funktext</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def los(a):&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;b=zeros(len(a),dtype=float64)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="p">[</span><span class="n">long</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_resline</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">solveorder</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">])]</span>
        <span class="n">fib2</span> <span class="o">=</span> <span class="p">[</span><span class="n">long</span> <span class="o">+</span> <span class="s1">&#39;return b &#39;</span><span class="p">]</span>
        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="s1">&#39;return los&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">fib2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="BaseModel.make_res">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.make_res">[docs]</a>
    <span class="k">def</span> <span class="nf">make_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&#39;&#39;&#39; makes a function which performs a Gaus-Seidle iteration</span>
<span class="sd">        if ljit=True a Jittet function will also be created.</span>
<span class="sd">        The functions will be placed in: </span>
<span class="sd">            </span>
<span class="sd">        - model.solve </span>
<span class="sd">        - model.solve_jit </span>
<span class="sd">         </span>
<span class="sd">         &#39;&#39;&#39;</span>

        <span class="n">xxx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outres</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">exclude</span><span class="p">)</span>  <span class="c1"># find the text of the solve</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>  <span class="c1"># make the factory defines</span>
        <span class="c1"># using the factory create the function</span>
        <span class="n">res_calc</span> <span class="o">=</span> <span class="n">make</span><span class="p">(</span><span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res_calc</span></div>


<div class="viewcode-block" id="BaseModel.base_res">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.BaseModel.base_res">[docs]</a>
    <span class="k">def</span> <span class="nf">base_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; calculates a model with data from a databank</span>
<span class="sd">        Used for check wether each equation gives the same result as in the original databank&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;res_calc&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">res_calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_res</span><span class="p">()</span>
        <span class="n">databank</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>   <span class="c1"># kan man det her? I b</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span>
        <span class="n">bvalues</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="n">stuff3</span><span class="p">,</span> <span class="n">saveeval3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createstuff3</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">per</span><span class="p">)</span>
            <span class="n">aaaa</span> <span class="o">=</span> <span class="n">stuff3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_calc</span><span class="p">(</span><span class="n">aaaa</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">per</span><span class="p">,</span> <span class="s1">&#39;Calculated&#39;</span><span class="p">)</span>
            <span class="n">saveeval3</span><span class="p">(</span><span class="n">bvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">xxxx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">bvalues</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                            <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;: Res calculation finish from &#39;</span><span class="p">,</span>
                  <span class="n">sol_periode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;to&#39;</span><span class="p">,</span> <span class="n">sol_periode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">xxxx</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:40}</span><span class="s1">: </span><span class="si">{:&gt;20}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Model name&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Model structure &#39;</span><span class="p">,</span>
                          <span class="s1">&#39;Recursive&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istopo</span> <span class="k">else</span> <span class="s1">&#39;Simultaneous&#39;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Number of variables &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Number of exogeneous  variables &#39;</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Number of endogeneous variables &#39;</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">out</span><span class="o">+</span><span class="s1">&#39;&gt;&#39;</span></div>



<span class="c1">#</span>


<div class="viewcode-block" id="Org_model_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Org_model_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; This mixin enrich the Basemodel class with different utility methods. </span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lister</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">       lists used in the equations</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary of lists defined in the input equations.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">pt</span><span class="o">.</span><span class="n">list_extract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">)</span>   <span class="c1"># lists used in the equations</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">listud</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a string of the models listdefinitions \n</span>
<span class="sd">        used when ceating (small) models based on this model &#39;&#39;&#39;</span>
        <span class="n">udlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lister</span><span class="p">:</span>
            <span class="n">udlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;list &#39;</span><span class="o">+</span><span class="n">l</span><span class="o">+</span><span class="s1">&#39; =  &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lister</span><span class="p">[</span><span class="n">l</span><span class="p">]):</span>
                <span class="n">lensl</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sl</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">udlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; / &#39;</span><span class="p">)</span>
                <span class="n">udlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;{:&lt;&#39;</span><span class="o">+</span><span class="n">lensl</span><span class="o">+</span><span class="s1">&#39;}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="o">+</span><span class="n">sl</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
                <span class="n">udlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lister</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">sl</span><span class="p">]:</span>
                    <span class="n">udlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>

            <span class="n">udlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; $ </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">udlist</span><span class="p">)</span>
    
    <span class="c1"># @lru_cache(maxsize=2048)</span>
<div class="viewcode-block" id="Org_model_Mixin.vlist">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.vlist">[docs]</a>
    <span class="k">def</span> <span class="nf">vlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a list of variable in the model matching the pattern, the pattern can be a list of patterns</span>

<span class="sd">        Args:</span>
<span class="sd">            pat (string or list of strings): One or more pattern seperated by space wildcards * and ?, special pattern: #ENDO  </span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            out (list): list of variable names matching the pat.</span>

<span class="sd">        &#39;&#39;&#39;</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">upat</span> <span class="o">=</span> <span class="n">pat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">upat</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pat</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;#ENDO&#39;</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">out</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="o">...</span> 
                
            <span class="k">if</span> <span class="n">pat</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
                     <span class="n">upat</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span><span class="p">[</span><span class="n">pat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]]</span> 
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">lf</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No grouping like this. Select from: </span><span class="si">{</span><span class="n">lf</span><span class="si">}{</span><span class="n">lf</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Try with a correct group name&#39;</span><span class="p">)</span>

        <span class="n">ipat</span> <span class="o">=</span> <span class="n">upat</span>
        <span class="c1"># breakpoint() </span>
        <span class="n">patlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">apat</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ipat</span> <span class="k">for</span> <span class="n">apat</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span> <span class="p">)]</span> 
        <span class="c1"># patlist = [self.var_groups[apat[1:]] if apat.startswith(&#39;#&#39;) else apat for apat in patlist0]</span>
        <span class="c1"># print(f&#39;{patlist=}&#39;) </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span>  <span class="n">up</span> <span class="ow">in</span> <span class="n">patlist</span>  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deslist</span><span class="p">(</span><span class="n">up</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span> <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
                <span class="k">else</span> 
                <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">up</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>                
                <span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; in case the model instance is an empty instance around datatframes, typical for visualization&#39;&#39;&#39;</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ipat</span> <span class="k">for</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                
                <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> 
                <span class="p">)</span>
                <span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>

    
    
<div class="viewcode-block" id="Org_model_Mixin.vlist_names">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.vlist_names">[docs]</a>
    <span class="k">def</span> <span class="nf">vlist_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a list of variable in input  matching the pattern&#39;&#39;&#39;</span>
        <span class="n">gross_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gross_list</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">input</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="Org_model_Mixin.list_names">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.list_names">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">list_names</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a list of variable in input  matching the pattern&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                   <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">upper</span><span class="p">()))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                   <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">upper</span><span class="p">())]</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Org_model_Mixin.exodif">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.exodif">[docs]</a>
    <span class="k">def</span> <span class="nf">exodif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Finds the differences between two dataframes in exogeneous variables for the model</span>
<span class="sd">        Defaults to getting the two dataframes (basedf and lastdf) internal to the model instance </span>

<span class="sd">        Exogeneous with a name ending in &lt;endo&gt;__RES are not taken in, as they are part of a un_normalized model</span>

<span class="sd">        Args:</span>
<span class="sd">            a (TYPE, optional): DESCRIPTION. Defaults to None. If None model.basedf will be used.</span>
<span class="sd">            b (TYPE, optional): DESCRIPTION. Defaults to None. If None model.lastdf will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataFrame: the difference between the models exogenous variables in a and b.</span>

<span class="sd">        &#39;&#39;&#39;</span>


        <span class="n">selected</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exogene_true</span><span class="p">)</span>
        <span class="n">aexo</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">selected</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">selected</span><span class="p">]</span>
        <span class="n">bexo</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">selected</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">selected</span><span class="p">]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;bexo-aexo&#39;</span><span class="p">)</span>
        <span class="n">out2</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">diff</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">out2</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>


<div class="viewcode-block" id="Org_model_Mixin.get_eq_values">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.get_eq_values">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eq_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">databank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nolag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alsoendo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Returns a dataframe with values from a frml determining a variable </span>


<span class="sd">         options: </span>
<span class="sd">             :last:  the lastdf is used else baseline dataframe</span>
<span class="sd">             :nolag:  only line for each variable &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">varnavn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span> <span class="k">if</span> <span class="n">last</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">databank</span>

            <span class="k">if</span> <span class="n">per</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_per</span> <span class="o">=</span> <span class="n">per</span>

            <span class="n">varterms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="c1">#                            for term in self.allvar[varnavn.upper()][&#39;terms&#39;] if term.var]</span>
                        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">var</span> <span class="o">==</span> <span class="n">varnavn</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
            <span class="c1"># now we have droped dublicate terms and sorted</span>
            <span class="n">sterms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">varterms</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">nolag</span><span class="p">:</span>
                <span class="n">sterms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({(</span><span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">sterms</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">showvar</span><span class="p">:</span>
                <span class="n">sterms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">varnavn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="n">sterms</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[[</span><span class="n">get_a_value</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">lag</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current_per</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">sterms</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">breakpoint</span><span class="p">()</span>
                
            <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">current_per</span><span class="p">,</span>
                               <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">sterms</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Org_model_Mixin.get_eq_dif">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.get_eq_dif">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eq_dif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nolag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showvar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns a dataframe with difference of values from formula&#39;&#39;&#39;</span>
        <span class="n">out0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_eq_values</span><span class="p">(</span><span class="n">varnavn</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nolag</span><span class="o">=</span><span class="n">nolag</span><span class="p">,</span> <span class="n">showvar</span><span class="o">=</span><span class="n">showvar</span><span class="p">)</span> <span class="o">-</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_eq_values</span><span class="p">(</span><span class="n">varnavn</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nolag</span><span class="o">=</span><span class="n">nolag</span><span class="p">,</span> <span class="n">showvar</span><span class="o">=</span><span class="n">showvar</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">out0</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">0.00000001</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out0</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out0</span>
        <span class="k">return</span> <span class="n">out</span></div>

    
<div class="viewcode-block" id="Org_model_Mixin.get_var_growth">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.get_var_growth">[docs]</a>
    <span class="k">def</span> <span class="nf">get_var_growth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">showname</span><span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the  growth rate of this variable in the base and the last dataframe&#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl_relative</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">basevalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span> <span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
            <span class="n">basevalues</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">varname</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">showname</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">Base growth&#39;</span>
            <span class="n">lastvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span> <span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
            <span class="n">lastvalues</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">varname</span><span class="w"> </span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">showname</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">Last growth&#39;</span>
            <span class="n">diffvalues</span> <span class="o">=</span> <span class="n">lastvalues</span><span class="o">-</span><span class="n">basevalues</span> 
            <span class="n">diffvalues</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">varname</span><span class="w"> </span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">showname</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">Diff growth&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">basevalues</span><span class="p">,</span><span class="n">lastvalues</span><span class="p">,</span><span class="n">diffvalues</span><span class="p">])</span> <span class="k">if</span> <span class="n">diff</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">basevalues</span><span class="p">,</span><span class="n">lastvalues</span><span class="p">])</span>  
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span></div>

    
<div class="viewcode-block" id="Org_model_Mixin.get_values">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.get_values">[docs]</a>
    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns a dataframe with the data points for a node,  including lags &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">var</span>
        <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">bvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">]</span>
        <span class="n">lvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span>
                   <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">]</span>
        <span class="n">dvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">)</span> <span class="o">-</span>
                         <span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span> <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pct</span><span class="p">:</span>
            <span class="n">pvalues</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">100</span><span class="o">*</span><span class="n">d</span><span class="o">/</span><span class="n">b</span> <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">NAN</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bvalues</span><span class="p">,</span> <span class="n">dvalues</span><span class="p">)]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">bvalues</span><span class="p">,</span> <span class="n">lvalues</span><span class="p">,</span> <span class="n">dvalues</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                              <span class="s1">&#39;Base&#39;</span><span class="p">,</span> <span class="s1">&#39;Last&#39;</span><span class="p">,</span> <span class="s1">&#39;Diff&#39;</span><span class="p">,</span> <span class="s1">&#39;Pct&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">bvalues</span><span class="p">,</span> <span class="n">lvalues</span><span class="p">,</span> <span class="n">dvalues</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span>
                              <span class="s1">&#39;Base&#39;</span><span class="p">,</span> <span class="s1">&#39;Last&#39;</span><span class="p">,</span> <span class="s1">&#39;Diff&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Org_model_Mixin.__getitem__">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.__getitem__">[docs]</a>
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        To execute the index operator []</span>
<span class="sd">        </span>
<span class="sd">        Uses the :any:`modelvis.vis` operator        </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># This will catch any exception</span>
           <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
           <span class="n">a</span> <span class="o">=</span> <span class="n">mv</span><span class="o">.</span><span class="n">DummyVis</span><span class="p">()</span> 
           <span class="k">return</span> <span class="n">a</span></div>


<div class="viewcode-block" id="Org_model_Mixin.__getattr__">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.__getattr__">[docs]</a>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;To execute the . operator</span>
<span class="sd">        </span>
<span class="sd">       </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;model_var_&#39;</span><span class="p">):</span>
            <span class="n">wishfor</span><span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;model_var_&#39;</span><span class="p">):]</span>
            <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_with_frmlname</span><span class="p">(</span><span class="n">wishfor</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;model_eq_&#39;</span><span class="p">):</span>
            <span class="n">wishfor</span><span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;model_eq_&#39;</span><span class="p">):]</span>
            <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frml_with_frmlname</span><span class="p">(</span><span class="n">wishfor</span><span class="p">))</span>


        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar_set</span><span class="p">:</span> 
                <span class="k">return</span> <span class="n">mv</span><span class="o">.</span><span class="n">varvis</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The specification:&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; did not match a method, property or variable name&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Org_model_Mixin.__dir__">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.__dir__">[docs]</a>
    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabcomplete</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_res&#39;</span><span class="p">):</span>
                <span class="c1"># self._res = sorted(list(self.allvar.keys()) + list(self.__dict__.keys()) + list(type(self).__dict__.keys()))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_res</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span>
                <span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span> <span class="n">_res</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Org_model_Mixin.todynare">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Org_model_Mixin.todynare">[docs]</a>
    <span class="k">def</span> <span class="nf">todynare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paravars</span><span class="o">=</span><span class="p">[],</span> <span class="n">paravalues</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; This is a function which converts a Modelflow  model instance to Dynare .mod format</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">totext</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span>
            <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="o">+</span><span class="p">((</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">content</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;//  Dropped &#39;</span><span class="o">+</span><span class="n">v</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span>
                   <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">totext</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]))</span>
                   <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">)</span>

        <span class="n">paraout</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;parameters </span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">paravars</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">paravalues</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#        print(paraout)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;@#define &#39;</span><span class="o">+</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39; = [&#39;</span> <span class="o">+</span> <span class="s1">&#39; , &#39;</span><span class="o">.</span><span class="n">join</span>
                          <span class="p">([</span><span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">d</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">kdic</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">dic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lister</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">kdic</span> <span class="ow">in</span> <span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
               <span class="s1">&#39;var    </span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
               <span class="s1">&#39;varexo </span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">paravars</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
               <span class="n">paraout</span> <span class="o">+</span>
               <span class="s1">&#39;model; </span><span class="se">\n</span><span class="s1">  &#39;</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; </span><span class="se">\n</span><span class="s1"> end; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>
</div>



<div class="viewcode-block" id="Model_help_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Model_help_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Helpers to model&#39;&#39;&#39;</span>
    
<div class="viewcode-block" id="Model_help_Mixin.var_with_frmlname">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.var_with_frmlname">[docs]</a>
    <span class="k">def</span> <span class="nf">var_with_frmlname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kwname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns endogenous variables where the frmlname contains kwname&#39;&#39;&#39;</span> 
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span> <span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">],</span><span class="n">kwname</span><span class="p">)}</span></div>

    
<div class="viewcode-block" id="Model_help_Mixin.frml_with_frmlname">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.frml_with_frmlname">[docs]</a>
    <span class="k">def</span> <span class="nf">frml_with_frmlname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kwname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns equations where the frmlname contains kwname&#39;&#39;&#39;</span> 

        <span class="n">relevant_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_with_frmlname</span><span class="p">(</span><span class="n">kwname</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">relevant_var</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">out</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_exogene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; True model exogeneous </span>
<span class="sd">        </span>
<span class="sd">         - all exogenous excluding _D _A and _X variables </span>
<span class="sd">        &#39;&#39;&#39;</span> 
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_add_factor</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
    
    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">model_endogene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;True endogenous, for normalized models</span>
<span class="sd">        </span>
<span class="sd">        all endogenoue - fitted variables</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span> 
        
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_with_frmlname</span><span class="p">(</span><span class="s1">&#39;fit&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
    
<div class="viewcode-block" id="Model_help_Mixin.timer">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.timer">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A timer context manager, implemented using a</span>
<span class="sd">        generator function. This one will report time even if an exception occurs</span>
<span class="sd">        the time in seconds can be retrieved by &lt;retunr value&gt;.seconds &quot;&quot;&quot;    </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        input : string, optional</span>
<span class="sd">            a name. The default is &#39;test&#39;.</span>
<span class="sd">        show : bool, optional</span>
<span class="sd">            show the results. The default is True.</span>
<span class="sd">        short : bool, optional</span>
<span class="sd">            . The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">time</span>

        <span class="k">class</span> <span class="nc">xtime</span><span class="p">():</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;A help class to retrieve the time outside the with statement&#39;&#39;&#39;</span>

            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="nb">input</span>

            <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">minutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span><span class="o">/</span><span class="mf">60.</span>
                <span class="n">seconds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seconds</span>
                <span class="k">if</span> <span class="n">minutes</span> <span class="o">&lt;</span> <span class="mf">2.</span><span class="p">:</span>
                    <span class="n">afterdec</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">seconds</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="p">(</span>
                        <span class="mi">3</span> <span class="k">if</span> <span class="n">seconds</span> <span class="o">&gt;=</span> <span class="mf">1.01</span> <span class="k">else</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">afterdec</span><span class="p">)</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="si">}</span><span class="s1"> took       : </span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">afterdec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1"> Seconds&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">afterdec</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">minutes</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">4</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">afterdec</span><span class="p">)</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="si">}</span><span class="s1"> took       : </span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="n">width</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">afterdec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1"> Minutes&#39;</span>

        <span class="n">cxtime</span> <span class="o">=</span> <span class="n">xtime</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">show</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">short</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s1"> started at : </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">yield</span> <span class="n">cxtime</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">cxtime</span><span class="o">.</span><span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                <span class="n">cxtime</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">error</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="Model_help_Mixin.update_from_list">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.update_from_list">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_from_list</span><span class="p">(</span><span class="n">indf</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">indf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">basis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># print(f&#39;line:{l}:&#39;)</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
           <span class="c1"># print(var,op,value,arg,sep=&#39;|&#39;)</span>
            <span class="n">update_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span>
                       <span class="n">arg</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="n">lprint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Model_help_Mixin.update_from_list_new">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.update_from_list_new">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_from_list_new</span><span class="p">(</span><span class="n">indf</span><span class="p">,</span> <span class="n">basis</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">indf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">basis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># print(f&#39;line:{l}:&#39;)</span>
            <span class="n">var</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">istart</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">iend</span><span class="p">]</span>
           <span class="c1"># print(var,op,value,arg,sep=&#39;|&#39;)</span>
            <span class="n">update_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span>
                       <span class="n">arg</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="n">lprint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

    
<div class="viewcode-block" id="Model_help_Mixin.update_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.update_old">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_old</span><span class="p">(</span><span class="n">indf</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">keep_growth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Updates a dataframe and returns a dataframe</span>
<span class="sd">        </span>
<span class="sd">    Args:</span>
<span class="sd">            indf (DataFrame): input dataframe.</span>
<span class="sd">            basis (string): lines with variable updates look below.</span>
<span class="sd">            lprint (bool, optional): if True each update is printed  Defaults to False.</span>
<span class="sd">            scale (float, optional): A multiplier used on all update input . Defaults to 1.0.</span>
<span class="sd">            create (bool, optional): Creates a variables if not in the dataframe . Defaults to True.</span>
<span class="sd">            keep_growth(bool, optional): Keep the growth rate after the update time frame. Defaults to False.</span>
<span class="sd">            start (string, optional): Global start</span>
<span class="sd">            end (string, optional): Global end</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (TYPE): the updated dataframe .</span>
<span class="sd">            </span>
<span class="sd">        A line in updates looks like this:     </span>
<span class="sd">            </span>
<span class="sd">        &lt;`[[start] end]`&gt;` &lt;var&gt; &lt;=|+|*|%|=growth|+growth|=diff&gt; &lt;value&gt;... [/ [[start] end] [--keep_growth_rate|--no_keep_growth_rate]]       </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># start experiments for including pattern and wildcards in an updateline to update several variables in one line  </span>
        
        <span class="c1"># operatorpat  = &#39;(&#39;+ (&#39;|&#39;.join(f&#39; {o} &#39; for o in r&#39;\=|\+|\*|%|\=growth|\+growth|\=diff&#39;.split(&#39;|&#39;))) + &#39;)&#39;</span>
        <span class="c1"># testline = &#39; PAKGGREVCO2CE* PAKGGREVCO2CER PAKGGREVCO2CER = 29 &#39;</span>
        <span class="c1"># re.split(operatorpat,testline)</span>
         
        <span class="n">df</span> <span class="o">=</span> <span class="n">indf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">whole_line</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">stripped0</span> <span class="o">=</span> <span class="n">whole_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">stripped0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="sa">r</span><span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">stripped</span><span class="p">:</span>
                <span class="o">...</span>
            <span class="k">elif</span> <span class="s1">&#39;--&#39;</span> <span class="ow">in</span> <span class="n">stripped</span><span class="p">:</span>
                <span class="n">stripped</span> <span class="o">=</span> <span class="n">stripped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s1">&#39;/ --&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stripped</span> <span class="o">=</span> <span class="n">stripped</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;/&#39;</span>

            <span class="n">l0</span><span class="p">,</span><span class="n">loptions</span> <span class="o">=</span> <span class="n">stripped</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">loptions</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
            <span class="n">time_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">options</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">o</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)]</span>
            <span class="n">other_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">options</span> <span class="k">if</span>  <span class="n">o</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To many options</span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
            <span class="n">other_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;--keep_growth&#39;</span> <span class="k">if</span> <span class="n">other_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span><span class="s1">&#39;--KG&#39;</span> <span class="k">else</span>  <span class="n">other_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     
            <span class="c1"># print(f&#39;{time_options=}&#39;)</span>
            
            <span class="n">l</span><span class="o">=</span><span class="p">(</span><span class="n">timesplit</span> <span class="o">:=</span> <span class="n">l0</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timesplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">whole_line</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Do not specify time in both ends of update line</span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">time_options</span> <span class="o">=</span> <span class="n">timesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">time_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">time_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">time_options</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span> 
    
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To many times</span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>   <span class="c1"># if wo only want to set time </span>
                    <span class="k">continue</span> 
                    
                
                
                <span class="c1"># breakpoint()</span>
                

            <span class="c1"># breakpoint()    </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">arg1</span><span class="p">,</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">time_options</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>  
                <span class="n">arg1</span> <span class="o">=</span> <span class="n">arg2</span> <span class="o">=</span> <span class="n">time_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">start</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">arg1</span><span class="o">=</span><span class="n">start</span>
                <span class="n">arg2</span><span class="o">=</span><span class="n">end</span> 
            <span class="k">elif</span>  <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">arg1</span> <span class="o">=</span> <span class="n">arg2</span> <span class="o">=</span> <span class="n">start</span>
            <span class="k">elif</span>  <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">end</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;When end is set start should also be set </span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span> 
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">arg1</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">arg2</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problems with timesetting</span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span> 
                
            <span class="c1"># print(f&#39;{start=},{end=}&#39;)    </span>
            <span class="c1"># print(f&#39;line:{l}:{time_options=}  :{arg1=} {arg2=}&#39;)</span>
            <span class="k">if</span> <span class="s1">&#39;--&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;--&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg2</span><span class="p">):</span>
                
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Probably no blank after time </span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

                
            <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span>
            <span class="n">time1</span><span class="p">,</span><span class="n">time2</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="n">var</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">update_growth</span> <span class="o">=</span> <span class="kc">False</span>
            

            <span class="k">if</span> <span class="p">(</span><span class="n">keep_growth</span> <span class="ow">or</span> <span class="s1">&#39;--KEEP_GROWTH&#39;</span> <span class="ow">in</span> <span class="n">other_options</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;--NO_KEEP_GROWTH&#39;</span> <span class="ow">in</span> <span class="n">other_options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Can not keep growth for created variable</span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

                <span class="n">resttime</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">iend</span><span class="p">:]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resttime</span><span class="p">):</span>
                    <span class="n">update_growth</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">growth_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">())[</span><span class="n">resttime</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                    <span class="n">multiplier</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accumulate</span><span class="p">([(</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">growth_rate</span><span class="p">],</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">))</span>
           
           <span class="c1"># print(var,op,value,arg,sep=&#39;|&#39;)</span>
            <span class="n">update_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span> <span class="p">,</span> 
                       <span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="n">lprint</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">update_growth</span><span class="p">:</span>
                <span class="n">lastvalue</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time2</span><span class="p">,</span><span class="n">var</span><span class="p">]</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resttime</span><span class="p">,</span><span class="n">var</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="n">lastvalue</span> <span class="o">*</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">multiplier</span><span class="p">]</span>
                <span class="c1"># breakpoint()</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="Model_help_Mixin.update">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">indf</span><span class="p">,</span> <span class="n">updates</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">keep_growth</span><span class="o">=</span><span class="kc">False</span><span class="p">,):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         Updates a dataframe and returns a dataframe</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            indf (DataFrame): input dataframe.</span>
<span class="sd">            basis (string): lines with variable updates look below.</span>
<span class="sd">            lprint (bool, optional): if True each update is printed  Defaults to False.</span>
<span class="sd">            scale (float, optional): A multiplier used on all update input . Defaults to 1.0.</span>
<span class="sd">            create (bool, optional): Creates a variables if not in the dataframe . Defaults to True.</span>
<span class="sd">            keep_growth(bool, optional): Keep the growth rate after the update time frame. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (TYPE): the updated dataframe .</span>
<span class="sd">            </span>
<span class="sd">        A line in updates looks like this::    </span>
<span class="sd">            </span>
<span class="sd">          [&lt;[[start] end]&gt;] &lt;var&gt; &lt;=|+|*|%|=growth|+growth|=diff&gt; &lt;value&gt;... [--keep_growth_rate|--kg|--no_keep_growth_rate|--nkg]       </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># start experiments for including pattern and wildcards in an updateline to update several variables in one line  </span>
        
        <span class="n">operatorpat</span>  <span class="o">=</span> <span class="s1">&#39;(&#39;</span><span class="o">+</span> <span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="sa">r</span><span class="s1">&#39;=|\+|\*|%|=growth|\+growth|=diff&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="c1"># testline = &#39; PAKGGREVCO2CE* PAKGGREVCO2CER PAKGGREVCO2CER = 29 &#39;</span>
        <span class="c1"># re.split(operatorpat,testline)</span>
        
        <span class="n">legal_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;--KEEP_GROWTH&#39;</span><span class="p">,</span><span class="s1">&#39;--NO_KEEP_GROWTH&#39;</span><span class="p">,</span><span class="s1">&#39;--KG&#39;</span><span class="p">,</span><span class="s1">&#39;--NKG&#39;</span><span class="p">}</span>
        <span class="n">start</span> <span class="o">=</span> <span class="s1">&#39;-0&#39;</span> <span class="c1"># start of dataframe </span>
        <span class="n">end</span>   <span class="o">=</span> <span class="s1">&#39;-1&#39;</span> <span class="c1"># end of dataframe  </span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">indf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">whole_line</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="n">stripped0</span> <span class="o">=</span> <span class="n">whole_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">stripped0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stripped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">if</span>  <span class="s1">&#39;--&#39;</span> <span class="ow">in</span> <span class="n">stripped</span><span class="p">:</span>
                <span class="n">stripped</span> <span class="o">=</span> <span class="n">stripped</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="s1">&#39;/ --&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># The first option </span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stripped</span> <span class="o">=</span> <span class="n">stripped</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;/&#39;</span>
            <span class="k">try</span><span class="p">:</span>     
                <span class="n">l0</span><span class="p">,</span><span class="n">loptions</span> <span class="o">=</span> <span class="n">stripped</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Probably to many /</span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

            <span class="n">options</span> <span class="o">=</span> <span class="n">loptions</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To many options :</span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">legal_options</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Illegal option:</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s1">, legal is:</span><span class="si">{</span><span class="n">legal_options</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">l</span><span class="o">=</span><span class="p">(</span><span class="n">timesplit</span> <span class="o">:=</span> <span class="n">l0</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">timesplit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">time_options</span> <span class="o">=</span> <span class="n">timesplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">time_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">time_options</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_options</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">start</span><span class="p">,</span><span class="n">end</span> <span class="o">=</span> <span class="n">time_options</span>
                <span class="k">else</span><span class="p">:</span> 
    
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;To many times </span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>   <span class="c1"># if wo only want to set time </span>
                    <span class="k">continue</span> 

            <span class="c1"># breakpoint()    </span>
            <span class="n">arg1</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;-0&#39;</span> <span class="k">else</span> <span class="n">start</span> 
            <span class="n">arg2</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">end</span> <span class="o">==</span>  <span class="s1">&#39;-1&#39;</span> <span class="k">else</span> <span class="n">end</span> 
                
            <span class="c1"># print(f&#39;{start=},{end=}&#39;)    </span>
            <span class="c1"># print(f&#39;line:{l}:{time_options=}  :{arg1=} {arg2=}&#39;)</span>
                
            <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">istart</span><span class="p">:</span><span class="n">iend</span><span class="p">]</span>
            <span class="c1"># print(f&#39;{current=}&#39;)    </span>

            <span class="n">time1</span><span class="p">,</span><span class="n">time2</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">current</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="n">varstring</span><span class="p">,</span><span class="n">opstring</span><span class="p">,</span><span class="n">valuestring</span> <span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">operatorpat</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
                 
            <span class="n">value</span><span class="o">=</span><span class="n">valuestring</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">op</span><span class="o">=</span> <span class="n">opstring</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="n">varstring</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">varlist</span><span class="p">):</span>
                  <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No variables to update </span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">varname0</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">:</span> 
                <span class="n">varname</span> <span class="o">=</span> <span class="n">varname0</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">varname</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No variable name  </span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">update_growth</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">keep_growth</span> <span class="ow">or</span> <span class="s1">&#39;--KEEP_GROWTH&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">or</span> <span class="s1">&#39;--KG&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">)</span> <span class="ow">and</span> \
                  <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;--NO_KEEP_GROWTH&#39;</span> <span class="ow">in</span> <span class="n">options</span> <span class="ow">or</span> <span class="s1">&#39;--NKG&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">varname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Can not keep growth for created variable</span><span class="se">\n</span><span class="s1">Offending:&quot;</span><span class="si">{</span><span class="n">whole_line</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
    
                    <span class="n">resttime</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">iend</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resttime</span><span class="p">):</span>
                        <span class="n">update_growth</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">growth_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">varname</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">())[</span><span class="n">resttime</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                        <span class="n">multiplier</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">accumulate</span><span class="p">([(</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">growth_rate</span><span class="p">],</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">))</span>
               
               <span class="c1"># print(varname,op,value,arg,sep=&#39;|&#39;)</span>
                <span class="n">update_var</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">varname</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">op</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">time1</span><span class="p">,</span><span class="n">time2</span> <span class="p">,</span> 
                           <span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="n">lprint</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">update_growth</span><span class="p">:</span>
                    <span class="n">lastvalue</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">time2</span><span class="p">,</span><span class="n">varname</span><span class="p">]</span>
                    <span class="c1"># assert 1==2</span>

                    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">resttime</span><span class="p">,</span><span class="n">varname</span><span class="p">]</span><span class="o">=</span> <span class="p">[</span><span class="n">lastvalue</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">multiplier</span><span class="p">]</span>
                    <span class="c1"># breakpoint()</span>
        <span class="k">return</span> <span class="n">df</span></div>




<div class="viewcode-block" id="Model_help_Mixin.insertModelVar">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.insertModelVar">[docs]</a>
    <span class="k">def</span> <span class="nf">insertModelVar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">addmodel</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Inserts all variables from this model, not already in the dataframe.</span>
<span class="sd">        If model is specified, the dataframw will contain all variables from this and model models.  </span>

<span class="sd">        also located at the module level for backward compability </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addmodel</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">moremodels</span> <span class="o">=</span> <span class="n">addmodel</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">moremodels</span> <span class="o">=</span> <span class="p">[</span><span class="n">addmodel</span><span class="p">]</span>

        <span class="n">imodel</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="p">]</span><span class="o">+</span><span class="n">moremodels</span>
        <span class="n">myList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">imodel</span><span class="p">:</span>
            <span class="n">myList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">manglervars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">myList</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">manglervars</span><span class="p">):</span>
            <span class="n">extradf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="mf">0.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">manglervars</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">extradf</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataframe</span></div>


<div class="viewcode-block" id="Model_help_Mixin.in_notebook">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.in_notebook">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">in_notebook</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">get_ipython</span>
            <span class="k">if</span> <span class="s1">&#39;IPythonKernel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">kernel</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    
<div class="viewcode-block" id="Model_help_Mixin.is_running_in_jupyter">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.is_running_in_jupyter">[docs]</a>
    <span class="nd">@staticmethod</span>   
    <span class="k">def</span> <span class="nf">is_running_in_jupyter</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Check if the &#39;get_ipython&#39; function is available</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">shell</span> <span class="o">==</span> <span class="s1">&#39;ZMQInteractiveShell&#39;</span><span class="p">:</span>
                <span class="c1"># Running in Jupyter Notebook or JupyterLab</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="c1"># &#39;get_ipython&#39; function not found, not running in Jupyter Notebook</span>
            <span class="k">pass</span>
    
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Model_help_Mixin.defsub">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.defsub">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">class</span> <span class="nc">defsub</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;A subclass of dict.</span>
<span class="sd">        if a *defsub* is indexed by a nonexisting keyword it just return the keyword &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">key</span></div>


<div class="viewcode-block" id="Model_help_Mixin.test_model">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.test_model">[docs]</a>
    <span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_input</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxvar</span><span class="o">=</span><span class="mi">1_000_000</span><span class="p">,</span> <span class="n">maxerr</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">showall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ref_df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compares a straight calculation with the input dataframe. </span>

<span class="sd">        shows which variables dont have the same value </span>

<span class="sd">        Very useful when implementing a model where the results are known </span>

<span class="sd">        Args:</span>
<span class="sd">            df (DataFrame): dataframe to run.</span>
<span class="sd">            start (index, optional): start period. Defaults to None.</span>
<span class="sd">            end (index, optional): end period. Defaults to None.</span>
<span class="sd">            maxvar (int, optional): how many variables are to be chekked. Defaults to 1_000_000.</span>
<span class="sd">            maxerr (int, optional): how many errors to check Defaults to 100.</span>
<span class="sd">            tol (float, optional): check for absolute value of difference. Defaults to 0.0001.</span>
<span class="sd">            showall (bolean, optional): show more . Defaults to False.</span>
<span class="sd">            ref_df (DataFrame, optional): this dataframe is used for reference, used if add_factors has been calculated </span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">_start</span> <span class="o">=</span> <span class="n">start</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_end</span> <span class="o">=</span> <span class="n">end</span> <span class="k">if</span> <span class="n">end</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span> <span class="o">=</span> <span class="n">ref_df</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ref_df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="n">base_input</span>
        <span class="n">resresult</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">base_input</span><span class="p">,</span> <span class="n">_start</span><span class="p">,</span> <span class="n">_end</span><span class="p">,</span>
                         <span class="n">reset_options</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;base_res&#39;</span><span class="p">)</span>

        <span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">:.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">f</span><span class="se">}}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
        <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Chekking residuals for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">_start</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">_end</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">maxvar</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="n">maxerr</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">check</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Before check&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;After calculation&#39;</span><span class="p">,</span> <span class="s1">&#39;Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;Pct&#39;</span><span class="p">]</span>
            <span class="c1"># breakpoint()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">check</span><span class="o">.</span><span class="n">Difference</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">err</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">maxdiff</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">Difference</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">maxpct</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">Pct</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="c1"># breakpoint()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">, Max difference:</span><span class="si">{</span><span class="n">maxdiff</span><span class="si">:{</span><span class="n">width</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2"> Max Pct </span><span class="si">{</span><span class="n">maxpct</span><span class="si">:{</span><span class="n">width</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s2">f</span><span class="si">}</span><span class="s2">% It is number </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in the solveorder and error number </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">showall</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s2">&quot;frml&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">check</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Values: </span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_eq_values</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">showvar</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span> <span class="o">=</span> <span class="p">{}</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">print_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">print_model_latex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mj</span><span class="o">.</span><span class="n">get_frml_latex</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    
    <span class="c1"># @staticmethod</span>
    <span class="c1"># def get_a_repo_yaml(owner: str = &quot;IbHansen&quot;,</span>
    <span class="c1">#                    repo_name: str = &quot;modelflow-manual&quot;,</span>
    <span class="c1">#                    branch: str = &#39;main&#39;, </span>
    <span class="c1">#                    file:  str = r&#39;papers/mfbook/repo_def.yaml&#39;,</span>
    <span class="c1">#                    **kwargs): </span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1"># Retrieve and load a YAML file from a specified GitHub repository.</span>

    <span class="c1"># Parameters:</span>
    <span class="c1"># - owner (str): The owner of the GitHub repository. Default is &quot;IbHansen&quot;.</span>
    <span class="c1"># - repo_name (str): The name of the GitHub repository. Default is &quot;modelflow-manual&quot;.</span>
    <span class="c1"># - branch (str): The branch where the file is located. Default is &quot;main&quot;.</span>
    <span class="c1"># - file (str): The path to the file within the GitHub repository. Default is &quot;papers/mfbook/repo_def.yaml&quot;.</span>

    <span class="c1"># Returns:</span>
    <span class="c1"># - dict or list: A dictionary or list containing the loaded YAML data.</span>

    <span class="c1"># Exceptions:</span>
    <span class="c1"># - Raises an exception if there is an error retrieving or loading the file, </span>
    <span class="c1">#   with the exception message printed to the console.</span>
    <span class="c1">#     &quot;&quot;&quot;  </span>
       
    <span class="c1">#     from urllib.request import urlopen</span>
    <span class="c1">#     import yaml </span>
        
    <span class="c1">#     url = Path(rf&quot;https://raw.githubusercontent.com/{owner}/{repo_name}/{branch}/{file}&quot;).as_posix().replace(&#39;https:/&#39;,&#39;https://&#39;)</span>
    <span class="c1">#   #  print(f&#39;Open file from URL:  {url}&#39;)  </span>
    <span class="c1">#     try:</span>
    <span class="c1">#         with urlopen(url) as f:            </span>
    <span class="c1">#                 res = yaml.safe_load(f)</span>
    <span class="c1">#     except Exception as e:</span>
    <span class="c1">#         print(f&#39;{e}&#39;)</span>
    
    <span class="c1">#     return res </span>
    
    
<div class="viewcode-block" id="Model_help_Mixin.get_a_repo_yaml">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.get_a_repo_yaml">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_a_repo_yaml</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IbHansen&quot;</span><span class="p">,</span>
                        <span class="n">repo_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;modelflow-manual&quot;</span><span class="p">,</span>
                        <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> 
                        <span class="n">file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;papers/mfbook/repo_def.yaml&#39;</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve and load a YAML file from a specified GitHub repository.</span>

<span class="sd">        args:</span>
<span class="sd">            owner (str): The owner of the GitHub repository. Default is &quot;IbHansen&quot;.</span>
<span class="sd">            repo_name (str): The name of the GitHub repository. Default is &quot;modelflow-manual&quot;.</span>
<span class="sd">            branch (str): The branch where the file is located. Default is &quot;main&quot;.</span>
<span class="sd">            file (str): The path to the file within the GitHub repository. Default is &quot;papers/mfbook/repo_def.yaml&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict or list: A dictionary or list containing the loaded YAML data.</span>

<span class="sd">        Exceptions:</span>
<span class="sd">            Raises an exception if there is an error retrieving or loading the file, </span>
<span class="sd">              with the exception message printed to the console.</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>
        <span class="kn">import</span> <span class="nn">yaml</span> 

        <span class="n">url</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">rf</span><span class="s2">&quot;https://raw.githubusercontent.com/</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;https:/&#39;</span><span class="p">,</span><span class="s1">&#39;https://&#39;</span><span class="p">)</span>
        <span class="c1"># print(f&#39;Open file from URL: {url}&#39;)  </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>            
                <span class="n">res</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">res</span>         </div>

    
    
<div class="viewcode-block" id="Model_help_Mixin.download_github_repo_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.download_github_repo_old">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">download_github_repo_old</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IbHansen&quot;</span><span class="p">,</span>
                             <span class="n">repo_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;wb-repos&#39;</span><span class="p">,</span>
                             <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> 
                             <span class="n">destination</span>  <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
                             <span class="n">go</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                             <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                            <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download an entire GitHub repository and extract it to a specified location.</span>
<span class="sd">    </span>
<span class="sd">        args:</span>
<span class="sd">          owner: The owner of the GitHub repository.</span>
<span class="sd">          repo_name: The name of the repository.</span>
<span class="sd">          branch: The branch to download.</span>
<span class="sd">          destination: The local path where the repository should be extracted.</span>
<span class="sd">          go: display toc of notebooks </span>
<span class="sd">          silent: keep silent </span>
<span class="sd">          description:optional description which will be used as folder name </span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">          A message indicating whether the download was successful or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construct the URL to download the zip file of the entire repository</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://github.com/</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s1">/archive/refs/heads/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s1">.zip&#39;</span>
    
        <span class="k">try</span><span class="p">:</span>  
            <span class="n">extract_to</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>  <span class="c1"># Using pathlib.Path here</span>
            <span class="n">extract_to</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Create the directory if it doesn&#39;t exist</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;An error occurred creating </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># breakpoint()</span>
            <span class="c1"># urllib.request.urlopen(urlfile) as f</span>
            
            
            <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                    <span class="c1"># Extract all contents of the zip file to the specified location</span>
                    <span class="n">location</span> <span class="o">=</span> <span class="n">extract_to</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">new_location</span> <span class="o">=</span> <span class="n">extract_to</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span><span class="n">repo_name</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    
                    <span class="k">if</span> <span class="n">reset</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="n">new_location</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">new_location</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_location</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">new_location</span><span class="si">}</span><span class="s1">&quot; is reset, that is deletet &#39;</span> <span class="p">)</span>
                    
                    
                    <span class="k">if</span> <span class="n">new_location</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">go</span><span class="p">:</span> 
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">new_location</span><span class="si">}</span><span class="s2">&#39; already exist. Can&#39;t download to the same location twice. &quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Consider reset=1. &quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;** Warning reset=1 deletes all file in &#39;</span><span class="si">{</span><span class="n">new_location</span><span class="si">}</span><span class="s2">&#39; &quot;</span><span class="p">)</span>
                            <span class="n">model</span><span class="o">.</span><span class="n">display_toc</span><span class="p">(</span><span class="s1">&#39;**Avaiable notebooks**&#39;</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="n">new_location</span><span class="p">)</span>
                            <span class="k">return</span>  
                        <span class="k">else</span><span class="p">:</span>
                        
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Can&#39;t download to the same location twice, consider reset=1  when retrying :</span><span class="se">\n</span><span class="si">{</span><span class="n">new_location</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> 

                    <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_to</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">location</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">new_location</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Can&#39;t rename </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2"> to &#39;</span><span class="si">{</span><span class="n">new_location</span><span class="si">}</span><span class="s2">&#39; you are probably using the folder just now&quot;</span><span class="p">)</span>
                        
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Repo downloaded to &quot;</span><span class="si">{</span><span class="n">new_location</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="n">go</span><span class="p">:</span>
                        <span class="n">model</span><span class="o">.</span><span class="n">display_toc</span><span class="p">(</span><span class="s1">&#39;**Avaiable notebooks**&#39;</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="n">new_location</span><span class="p">)</span>
                    <span class="k">return</span> 
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;No download of </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span><span class="n">repo_name</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span> 
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span></div>

        
<div class="viewcode-block" id="Model_help_Mixin.download_github_repo">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.download_github_repo">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">download_github_repo</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IbHansen&quot;</span><span class="p">,</span>
                             <span class="n">repo_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;wb-repos&#39;</span><span class="p">,</span>
                             <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> 
                             <span class="n">destination</span>  <span class="o">=</span> <span class="s1">&#39;./wb-repos&#39;</span><span class="p">,</span>
                             <span class="n">go</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                             <span class="n">colab</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download an entire GitHub repository and extract it to a specified location.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">          owner: The owner of the GitHub repository.</span>
<span class="sd">          repo_name: The name of the repository.</span>
<span class="sd">          branch: The branch to download.</span>
<span class="sd">          destination: The local path where the repository should be extracted.</span>
<span class="sd">          go: display toc of notebooks </span>
<span class="sd">          silent: keep silent </span>
<span class="sd">          replace: if True replace existing files with the files from repo </span>
<span class="sd">          description:optional description which will be used as folder name </span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">          A message indicating whether the download was successful or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Construct the URL to download the zip file of the entire repository</span>
        <span class="kn">import</span> <span class="nn">shutil</span>
        <span class="kn">import</span> <span class="nn">tempfile</span>

        

        <span class="k">def</span> <span class="nf">copy_new_files_only</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Copy files from src to dst if they do not already exist in dst.</span>
<span class="sd">            src and dst are Path objects or strings representing the source and destination directories.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">src_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            <span class="n">dst_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">src_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/*&#39;</span><span class="p">):</span>  <span class="c1"># **/* means all files and directories recursively</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>  <span class="c1"># Only proceed if it&#39;s a file</span>
                    <span class="n">relative_path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">src_path</span><span class="p">)</span>
                    <span class="n">relative_path_parts_except_first</span> <span class="o">=</span> <span class="n">relative_path</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">relative_path_except_first</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="o">*</span><span class="n">relative_path_parts_except_first</span><span class="p">)</span>
                    <span class="n">destination_file</span> <span class="o">=</span> <span class="n">dst_path</span> <span class="o">/</span> <span class="n">relative_path_except_first</span>
                    <span class="c1"># print(&#39; &#39;)</span>
                    <span class="c1"># print(f&quot;{item=} to \n{destination_file=}&quot;)</span>
                    <span class="c1"># print(f&quot;{relative_path=}\n{relative_path_except_first=}&quot;)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">destination_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">destination_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Ensure the destination directory exists</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">destination_file</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copied                      : </span><span class="si">{</span><span class="n">relative_path_except_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">replace</span><span class="p">:</span> 
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">destination_file</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copied file overwritten: </span><span class="si">{</span><span class="n">relative_path_except_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> 
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already exists, skipped: </span><span class="si">{</span><span class="n">relative_path_except_first</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://github.com/</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s1">/archive/refs/heads/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s1">.zip&#39;</span>
    
        <span class="k">try</span><span class="p">:</span>  
            <span class="n">extract_to</span> <span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">())</span>  <span class="c1"># Using pathlib.Path here</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Temporary directory created at: </span><span class="si">{</span><span class="n">extract_to</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;An error occurred creating temporary download location: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
    
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                    <span class="c1"># Extract all contents of the zip file to the specified location</span>
                    
                    <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_to</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Repo downloaded to &quot;</span><span class="si">{</span><span class="n">extract_to</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="p">)</span>
                    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;No download of </span><span class="si">{</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span><span class="n">repo_name</span><span class="p">)</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span> 
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                   
                    
        <span class="n">new_location</span> <span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span> 
        
        <span class="c1"># if reset: </span>
        <span class="c1">#     if new_location.exists() and new_location.is_dir():</span>
        <span class="c1">#         shutil.rmtree(new_location)</span>
        <span class="c1">#         print( f&#39;&quot;{new_location}&quot; is reset, that is deletet &#39; )</span>
        
        
        <span class="n">copy_new_files_only</span><span class="p">(</span><span class="n">extract_to</span><span class="p">,</span><span class="n">new_location</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">extract_to</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">go</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colab</span><span class="p">:</span> 
                <span class="n">model</span><span class="o">.</span><span class="n">display_toc_github</span><span class="p">(</span><span class="s1">&#39;**Avaiable notebooks github**&#39;</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="n">new_location</span><span class="p">,</span>
                <span class="n">colab</span><span class="o">=</span><span class="n">colab</span><span class="p">,</span>
                <span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">,</span>
                <span class="n">repo_name</span> <span class="o">=</span> <span class="n">repo_name</span><span class="p">,</span>
                <span class="n">branch</span> <span class="o">=</span> <span class="n">branch</span><span class="p">,</span> 
                                        
                                         <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>            
                <span class="n">model</span><span class="o">.</span><span class="n">display_toc_github</span><span class="p">(</span><span class="s1">&#39;**Avaiable notebooks**&#39;</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="n">new_location</span><span class="p">,</span><span class="n">colab</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            

        <span class="k">return</span> </div>

     
<div class="viewcode-block" id="Model_help_Mixin.display_toc_github">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.display_toc_github">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">display_toc_github</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;**Jupyter notebooks**&#39;</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nocwd</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">colab</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">owner</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;IbHansen&quot;</span><span class="p">,</span>
                               <span class="n">repo_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;wb-repos&#39;</span><span class="p">,</span>
                               <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> 
                               <span class="n">destination</span>  <span class="o">=</span> <span class="s1">&#39;./wb-repos&#39;</span><span class="p">,</span>                     
                           
                           <span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;In a jupyter notebook this function displays a clickable table of content of all </span>
<span class="sd">        jupyter notebooks in this and sub folders&#39;&#39;&#39;</span>
        
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">HTML</span>
        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
        <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">)):</span>
            <span class="c1"># print(f&#39;{dir=} {nocwd=}&#39;)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nocwd</span> <span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">filelist</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*readme.ipynb&#39;</span><span class="p">))</span> 
                    <span class="o">+</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.ipynb&#39;</span><span class="p">))</span> 
                       <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;readme&#39;</span><span class="p">)])</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">notebook</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filelist</span><span class="p">):</span>
                <span class="c1"># print(notebook)    </span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">notebook</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">notebook</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Overview&#39;</span><span class="p">)):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">blanks</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="s1">&#39;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">):</span>
                        <span class="n">thisdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="o">*</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1">&lt;b&gt;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">thisdir</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">display</span><span class="p">(</span>
                            <span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1">&lt;b&gt;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1"> (.)&lt;/b&gt;&#39;</span><span class="p">))</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">notebook</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print(notebook)</span>
                <span class="n">notebookshort</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="o">*</span><span class="n">notebook</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="c1"># print(notebookshort.as_posix())</span>

                <span class="k">if</span> <span class="n">colab</span><span class="p">:</span> 
                    <span class="n">githubname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://colab.research.google.com/github/</span><span class="si">{</span><span class="n">owner</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">repo_name</span><span class="si">}</span><span class="s1">/blob/</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">notebookshort</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="c1"># print(githubname)</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1"> &lt;a href=&quot;</span><span class="si">{</span><span class="n">githubname</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot;&gt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1"> &lt;a href=&quot;</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot;&gt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="p">))</span></div>

                    

        

<div class="viewcode-block" id="Model_help_Mixin.Worldbank_Models">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.Worldbank_Models">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">Worldbank_Models</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;worldbank&quot;</span><span class="p">,</span>
                             <span class="n">repo_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;MFMod-ModelFlow&#39;</span><span class="p">,</span>
                             <span class="n">branch</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span><span class="p">,</span> 
                             <span class="n">destination</span>  <span class="o">=</span> <span class="s1">&#39;./WorldbankModels&#39;</span><span class="p">,</span>
                             <span class="n">go</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                             <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">replace</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">,</span>
                            <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download an entire GitHub repository and extract it to a specified location.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">          owner: The owner of the GitHub repository.</span>
<span class="sd">          repo_name: The name of the repository.</span>
<span class="sd">          branch: The branch to download.</span>
<span class="sd">          destination: The local path where the repository should be extracted.</span>
<span class="sd">          go: display toc of notebooks </span>
<span class="sd">          silent: keep silent </span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">          A message indicating whether the download was successful or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span>  <span class="n">model</span><span class="o">.</span><span class="n">download_github_repo</span><span class="p">(</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">,</span>
                                     <span class="n">repo_name</span> <span class="o">=</span> <span class="n">repo_name</span><span class="p">,</span>
                                     <span class="n">branch</span>  <span class="o">=</span> <span class="n">branch</span><span class="p">,</span> 
                                     <span class="n">destination</span>  <span class="o">=</span> <span class="n">destination</span> <span class="p">,</span>
                                     <span class="n">go</span> <span class="o">=</span> <span class="n">go</span> <span class="p">,</span> 
                                     <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span>
                                     <span class="n">replace</span> <span class="o">=</span> <span class="n">replace</span>  
                                    <span class="p">)</span></div>





<div class="viewcode-block" id="Model_help_Mixin.load_repo_widget">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Model_help_Mixin.load_repo_widget">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_repo_widget</span><span class="p">(</span><span class="n">loadspec</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">nocwd</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an interactive widget for selecting and downloading repositories from GitHub.</span>
<span class="sd">        </span>
<span class="sd">        This function displays a list of repositories in a SelectMultiple widget, allowing the user to select one or more </span>
<span class="sd">        repositories. Upon clicking the &quot;Submit&quot; button, the selected repositories are downloaded, and a confirmation </span>
<span class="sd">        message is displayed for each successful download.</span>
<span class="sd">        </span>
<span class="sd">        Finaly a clicable toc of all notebooks is displayed</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">          loadspec (list of dict, optional): A list of dictionaries containing repository information. Each dictionary </span>
<span class="sd">          should have keys like &#39;description&#39; and &#39;repo_name&#39;. If not provided, the function will call `model.get_a_repo_yaml()` </span>
<span class="sd">          which retrives the default list from github,to retrieve the repository data. Default is None.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">          None: The function displays widgets and handles user interactions but does not return a value.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">          Exception: Prints exception messages to the output widget if errors occur during the download process.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        
        <span class="c1"># Create a SelectMultiple widget with descriptions as options</span>
 
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">loadspec</span><span class="p">)</span>  <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_a_repo_yaml</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">loadspec</span><span class="p">[:]</span>
        

    
        <span class="n">label</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;strong&gt;Select the repositories to download:&lt;/strong&gt;&quot;</span><span class="p">)</span>
        
        <span class="n">select_multiple</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">SelectMultiple</span><span class="p">(</span>
            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="n">this</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">this</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">this</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span>
            <span class="n">value</span><span class="o">=</span><span class="p">(),</span>  <span class="c1"># default selected value</span>
            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select from:&#39;</span><span class="p">,</span>
            <span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;50%&#39;</span><span class="p">},</span>
            <span class="n">rows</span><span class="o">=</span><span class="mi">10</span>  <span class="c1"># Adjust as needed to change the height of the list</span>
        <span class="p">)</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
    
        <span class="c1"># Create a button</span>
        <span class="n">button</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Submit&quot;</span><span class="p">)</span>
    
        <span class="c1"># Function to handle button click</span>
        <span class="k">def</span> <span class="nf">on_button_click</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">clear_output</span><span class="p">()</span>  <span class="c1"># Clear the output</span>
                <span class="n">selected_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">select_multiple</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">repo_ident</span> <span class="ow">in</span> <span class="n">selected_options</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">repo_ident</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">repo_ident</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
                            <span class="o">...</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">download_github_repo</span><span class="p">(</span><span class="o">**</span><span class="n">repo_ident</span><span class="p">,</span><span class="n">go</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># Assuming &#39;model&#39; is defined elsewhere</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully downloaded </span><span class="si">{</span><span class="n">repo_ident</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span><span class="n">repo_ident</span><span class="p">[</span><span class="s1">&#39;repo_name&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">display_toc</span><span class="p">(</span><span class="s1">&#39;**Avaiable notebooks**&#39;</span><span class="p">,</span><span class="n">nocwd</span><span class="o">=</span><span class="n">nocwd</span><span class="p">)</span>
                
        <span class="c1"># Attach the function to the button&#39;s click event</span>
        <span class="n">button</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_button_click</span><span class="p">)</span>
    
        <span class="c1"># Display the widgets</span>
        <span class="n">display</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">select_multiple</span><span class="p">,</span> <span class="n">button</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span></div>
</div>






<div class="viewcode-block" id="Dekomp_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Dekomp_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This class defines methods and properties related to equation attribution analyses (dekomp)</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Dekomp_Mixin.dekomp">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.dekomp">[docs]</a>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">2048</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dekomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">basedf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">altdf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Print all variables that determines input variable (varnavn)</span>
<span class="sd">        optional -- enter period and databank to get var values for chosen period</span>
<span class="sd">        Optionally, enter the period and databank to get variable values for the chosen period.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        varnavn : str</span>
<span class="sd">            Input variable name.</span>
<span class="sd">        start : str, optional</span>
<span class="sd">            Start period for retrieving variable values (default is &#39;&#39;).</span>
<span class="sd">        end : str, optional</span>
<span class="sd">            End period for retrieving variable values (default is &#39;&#39;).</span>
<span class="sd">        basedf : pd.DataFrame, optional</span>
<span class="sd">            Base dataframe to use (default is None).</span>
<span class="sd">        altdf : pd.DataFrame, optional</span>
<span class="sd">            Alternative dataframe to use (default is None).</span>
<span class="sd">        lprint : bool, optional</span>
<span class="sd">            Flag to print the results (default is True).</span>
<span class="sd">        time_att : bool, optional</span>
<span class="sd">            Flag to do a timewise attribute (default is False).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        namedtuple</span>
<span class="sd">            A named tuple containing the following decomposition results:</span>
<span class="sd">            - diff_level : pd.DataFrame</span>
<span class="sd">                DataFrame with level differences.</span>
<span class="sd">            - att_level : pd.DataFrame</span>
<span class="sd">                DataFrame with attributions to the level difference.</span>
<span class="sd">            - att_pct : pd.DataFrame</span>
<span class="sd">                DataFrame with the share of attributions to the difference in level.</span>
<span class="sd">            - diff_growth : pd.DataFrame</span>
<span class="sd">                DataFrame with differences in growth rate.</span>
<span class="sd">            - att_growth : pd.DataFrame</span>
<span class="sd">                DataFrame with attributions to the difference in growth rate.</span>
<span class="sd">    </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">basedf_</span> <span class="o">=</span> <span class="n">basedf</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">basedf</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span>
        <span class="n">altdf_</span> <span class="o">=</span> <span class="n">altdf</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">altdf</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span>
        <span class="n">start_</span> <span class="o">=</span> <span class="n">start</span> <span class="k">if</span> <span class="n">start</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_</span> <span class="o">=</span> <span class="n">end</span> <span class="k">if</span> <span class="n">end</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">mfrml</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">],</span>
                      <span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>   <span class="c1"># calculate the formular</span>
        <span class="n">print_per</span> <span class="o">=</span> <span class="n">mfrml</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start_</span><span class="p">,</span> <span class="n">end_</span><span class="p">,</span> <span class="n">altdf_</span><span class="p">)</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="n">mfrml</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">varterms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">mfrml</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">term</span><span class="o">.</span><span class="n">var</span> <span class="o">==</span> <span class="n">varnavn</span> <span class="ow">and</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
        <span class="c1"># now we have droped dublicate terms and sorted</span>
        <span class="n">sterms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">varterms</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">varterms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1"># find all the eksperiments to be performed</span>
        <span class="n">eksperiments</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vt</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">vt</span> <span class="ow">in</span> <span class="n">sterms</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">print_per</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">time_att</span><span class="p">:</span>
            <span class="o">...</span>
            <span class="n">smallalt</span> <span class="o">=</span> <span class="n">altdf_</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># for speed</span>
            <span class="n">smallbase</span> <span class="o">=</span> <span class="n">smallalt</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># for speed</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">smallalt</span> <span class="o">=</span> <span class="n">altdf_</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># for speed</span>
            <span class="n">smallbase</span> <span class="o">=</span> <span class="n">basedf_</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="nb">vars</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># for speed</span>
        <span class="c1"># make a dataframe for each experiment</span>
        <span class="n">alldf</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">smallalt</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">:</span>
            <span class="p">(</span><span class="n">var_</span><span class="p">,</span> <span class="n">lag_</span><span class="p">),</span> <span class="n">per_</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">set_a_value</span><span class="p">(</span><span class="n">alldf</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">per_</span><span class="p">,</span> <span class="n">var_</span><span class="p">,</span> <span class="n">lag_</span><span class="p">,</span>
                        <span class="n">get_a_value</span><span class="p">(</span><span class="n">smallbase</span><span class="p">,</span> <span class="n">per_</span><span class="p">,</span> <span class="n">var_</span><span class="p">,</span> <span class="n">lag_</span><span class="p">))</span>
<span class="c1">#              alldf[e].loc[e[1]+e[0][1],e[0][0]] = smallbase.loc[e[1]+e[0][1],e[0][0]] # update the variable in each eksperiment</span>

        <span class="c1"># to inspect the updates</span>
        <span class="n">difdf</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">smallalt</span> <span class="o">-</span> <span class="n">alldf</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">}</span>
        <span class="c1"># allres       = {e : mfrml.xgenr(alldf[e],str(e[1]),str(e[1]),silent= True ) for e in eksperiments} # now evaluate each experiment</span>
        <span class="c1"># now evaluate each experiment</span>
        <span class="n">allres</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">mfrml</span><span class="o">.</span><span class="n">xgenr</span><span class="p">(</span>
            <span class="n">alldf</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">}</span>
        <span class="c1"># dataframes with the effect of each update</span>
        <span class="n">diffres</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">smallalt</span> <span class="o">-</span> <span class="n">allres</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">}</span>
        <span class="n">diffres_growth</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">smallalt</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">-</span> <span class="n">allres</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">}</span>
        <span class="c1"># we are only interested in the efect on the left hand variable</span>
        <span class="n">res</span>        <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">diffres</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">varnavn</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">}</span>
        <span class="n">res_growth</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">diffres_growth</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">varnavn</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">}</span>
    <span class="c1"># the resulting dataframe</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span>
                                          <span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;lag&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        
        <span class="n">att_level</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">multi</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">print_per</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">:</span>
            <span class="n">att_level</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
            
        <span class="n">att_growth</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">multi</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">print_per</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eksperiments</span><span class="p">:</span>
            <span class="n">att_growth</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res_growth</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">*</span><span class="mf">100.</span>

    <span class="c1">#  a dataframe with some summaries</span>
        <span class="n">diff_level</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">multi</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">print_per</span><span class="p">)</span>
        <span class="n">diff_level</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;t-1&#39;</span> <span class="k">if</span> <span class="n">time_att</span> <span class="k">else</span> <span class="s1">&#39;Base&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">smallbase</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">]</span>
        <span class="n">diff_level</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;t&#39;</span> <span class="k">if</span> <span class="n">time_att</span> <span class="k">else</span> <span class="s1">&#39;Alternative&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span>
                   <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">smallalt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">]</span>
        <span class="n">diff_level</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Difference&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">difendo</span> <span class="o">=</span> <span class="n">smallalt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">,</span>
                                                                            <span class="n">varnavn</span><span class="p">]</span> <span class="o">-</span> <span class="n">smallbase</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">]</span>
        <span class="n">diff_level</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Percent   &#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">smallalt</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">,</span>
                                                                       <span class="n">varnavn</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.0000001</span><span class="o">+</span><span class="n">smallbase</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">diff_level</span> <span class="o">=</span> <span class="n">diff_level</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
    <span class="c1"># a dataframe  with summaries of growth</span>
        <span class="n">diff_growth_index</span> <span class="o">=</span> <span class="n">diff_level</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">diff_growth</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">diff_growth_index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">print_per</span><span class="p">)</span>
        <span class="n">diff_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">smallbase</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">varnavn</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span>
        <span class="n">diff_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">smallalt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">varnavn</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">print_per</span><span class="p">]</span> <span class="o">*</span> <span class="mf">100.</span> 
        <span class="n">diff_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">print_per</span><span class="p">]</span><span class="o">-</span>
                                                         <span class="n">diff_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">print_per</span><span class="p">])</span>
        
        <span class="n">growth_residual</span> <span class="o">=</span> <span class="n">att_growth</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">diff_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">print_per</span><span class="p">]</span>
        <span class="n">att_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">att_growth</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">att_growth</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">growth_residual</span>


    
    <span class="c1">#</span>
        <span class="n">att_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">att_level</span> <span class="o">/</span> <span class="p">(</span><span class="n">difendo</span><span class="p">[</span><span class="n">print_per</span><span class="p">])</span> <span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">difendo</span><span class="p">[</span><span class="n">print_per</span><span class="p">])</span><span class="o">&gt;</span><span class="mf">0.000001</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="n">print_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>       <span class="c1"># each contrinution in pct of total change</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">att_pct</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">100</span>
        <span class="n">att_pct</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">att_pct</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">att_pct</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="s1">&#39;Residual&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">print_per</span><span class="p">]</span> <span class="o">=</span> <span class="n">residual</span>
        <span class="k">if</span> <span class="n">lprint</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Formula        :&#39;</span><span class="p">,</span> <span class="n">mfrml</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">diff_level</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span>
                <span class="n">float_format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0:10.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Contributions to differende for &#39;</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">att_level</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span>
                <span class="n">float_format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0:10.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Share of contributions to differende for &#39;</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">att_pct</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span>
                <span class="n">float_format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0:10.0f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Difference in growth rate&#39;</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">print</span><span class="p">(</span><span class="n">diff_growth</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span>
                <span class="n">float_format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0:10.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Contribution to growth rate&#39;</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">att_growth</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span>
                <span class="n">float_format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{0:10.1f}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

        <span class="n">att_pct</span> <span class="o">=</span> <span class="n">att_pct</span><span class="p">[</span><span class="n">att_pct</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dekomp_res_name</span>  <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;dekompres&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_level, att_level, att_pct, ,diff_growth , att_growth&#39;</span><span class="p">)</span>
        <span class="n">dekomp_res</span> <span class="o">=</span> <span class="n">dekomp_res_name</span><span class="p">(</span><span class="n">diff_level</span><span class="p">,</span> <span class="n">att_level</span><span class="p">,</span> <span class="n">att_pct</span><span class="p">,</span> <span class="n">diff_growth</span><span class="p">,</span> <span class="n">att_growth</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">dekomp_res</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.impact">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.impact">[docs]</a>
    <span class="k">def</span> <span class="nf">impact</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">ldekomp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">leq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">adverse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxlevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">treewalk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">parent</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">lpre</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxlevel</span><span class="o">=</span><span class="n">maxlevel</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lev</span> <span class="o">&lt;=</span> <span class="n">maxlevel</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">leq</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">lev</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">print_eq</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">,</span>
                                  <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="n">lev</span><span class="o">+</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">ldekomp</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dekomp</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.dekomp_plot_per">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.dekomp_plot_per">[docs]</a>
    <span class="k">def</span> <span class="nf">dekomp_plot_per</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span>
                         <span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="kc">True</span>
                         <span class="p">,</span><span class="n">nametrans</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">varnames</span><span class="p">,</span><span class="n">thismodel</span> <span class="p">:</span> <span class="n">varnames</span>
                         <span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ysize</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns  a waterfall diagram with attribution for a variable in one time frame </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        varnavn : TYPE</span>
<span class="sd">            variable name.</span>
<span class="sd">        sort : TYPE, optional</span>
<span class="sd">            . The default is False.</span>
<span class="sd">        pct : TYPE, optional</span>
<span class="sd">            display pct contribution . The default is True.</span>
<span class="sd">        per : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is &#39;&#39;.</span>
<span class="sd">        threshold : TYPE, optional</span>
<span class="sd">            cutoff. The default is 0.0.</span>
<span class="sd">        rename : TYPE, optional</span>
<span class="sd">            Use descriptions instead of variable names. The default is True.</span>
<span class="sd">        time_att : TYPE, optional</span>
<span class="sd">            Do time attribution . The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        a matplotlib figure instance . </span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">thisper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">per</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">per</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dekomp</span><span class="p">(</span><span class="n">varnavn</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">lprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="n">time_att</span><span class="p">)</span>
        <span class="n">ddf</span> <span class="o">=</span> <span class="n">join_name_lag</span><span class="p">(</span><span class="n">xx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">pct</span> <span class="k">else</span> <span class="n">xx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rename</span><span class="p">:</span>
            <span class="n">ddf</span> <span class="o">=</span> <span class="n">ddf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ddf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nametrans</span><span class="p">(</span><span class="n">ddf</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>

<span class="c1">#        tempdf = pd.DataFrame(0,columns=ddf.columns,index=[&#39;Start&#39;]).append(ddf)</span>
        <span class="n">tempdf</span> <span class="o">=</span> <span class="n">ddf</span>
        <span class="n">per_loc</span> <span class="o">=</span> <span class="n">tempdf</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">per</span><span class="p">)</span>
        <span class="n">nthreshold</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">threshold</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;, threshold = </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">ntitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Decomposition in </span><span class="si">{</span><span class="n">per</span><span class="si">}</span><span class="s1">, pct</span><span class="si">{</span><span class="n">nthreshold</span><span class="si">}</span><span class="s1">:&#39;</span> <span class="k">if</span> <span class="n">pct</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;Decomposition in </span><span class="si">{</span><span class="n">per</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">nthreshold</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">plotdf</span> <span class="o">=</span> <span class="n">tempdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tempdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(</span>
        <span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;Total&#39;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">per_loc</span><span class="p">]]</span>
        <span class="n">plotdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span>  <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varnavn</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">varnavn</span><span class="o">.</span><span class="n">upper</span><span class="p">())]</span> <span class="k">if</span> <span class="n">rename</span> <span class="k">else</span> <span class="p">[</span><span class="n">varnavn</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
<span class="c1">#        waterdf = self.cutout(plotdf,threshold</span>
        <span class="n">waterdf</span> <span class="o">=</span> <span class="n">plotdf</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">mv</span><span class="o">.</span><span class="n">waterplot</span><span class="p">(</span><span class="n">waterdf</span><span class="p">,</span> <span class="n">autosum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">allsort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.86</span><span class="p">,</span>
                           <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">ntitle</span><span class="p">,</span> <span class="n">bartype</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span><span class="n">ysize</span><span class="o">=</span><span class="n">ysize</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

    
     
<div class="viewcode-block" id="Dekomp_Mixin.get_att_diff">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.get_att_diff">[docs]</a>
    <span class="k">def</span> <span class="nf">get_att_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;pct&#39;</span><span class="p">,</span>  <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
        
        <span class="n">tstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">start</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">end</span>
        
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dekomp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">tend</span><span class="p">,</span> <span class="n">time_att</span><span class="o">=</span><span class="n">time_att</span><span class="p">)</span>
   
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">{</span> <span class="s1">&#39;level&#39;</span> <span class="p">,</span> <span class="s1">&#39;pct&#39;</span><span class="p">}:</span>
            <span class="n">diffdf</span>  <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;diff_level&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diffdf</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;diff_</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            
        <span class="k">return</span> <span class="n">diffdf</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>    </div>


    
<div class="viewcode-block" id="Dekomp_Mixin.get_att">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.get_att">[docs]</a>
    <span class="k">def</span> <span class="nf">get_att</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;pct&#39;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                <span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Calculate the attribution percentage for a variable.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">            n (str): Name of the variable to calculate attribution for.</span>
<span class="sd">            type (str): Type of attribution calculation. Options: &#39;pct&#39; (percentage), &#39;level&#39;, &#39;growth&#39;. Default: &#39;pct&#39;.</span>
<span class="sd">            filter (bool): [Deprecated] Use threshold instead of filter. Default: False.</span>
<span class="sd">            lag (bool): Flag to indicate whether to include lag information in the output. Default: True.</span>
<span class="sd">            start (str): Start period for calculation. If not provided, uses the first period in the model instance. Default: &#39;&#39;.</span>
<span class="sd">            end (str): End period for calculation. If not provided, uses the last period in the model instance. Default: &#39;&#39;.</span>
<span class="sd">            time_att (bool): Flag to indicate time attribute calculation. Default: False.</span>
<span class="sd">            threshold (float): Threshold value for excluding rows with values close to zero. Default: 0.0.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: DataFrame containing the calculated attribution results.</span>
<span class="sd">    </span>
<span class="sd">        Raises:</span>
<span class="sd">            Exception: If an invalid type is provided.</span>
<span class="sd">        &#39;&#39;&#39;</span>
    
        <span class="n">legal_types</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pct&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="s1">&#39;growth&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">legal_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid type provided. Type must be one of </span><span class="si">{</span><span class="n">legal_types</span><span class="si">}</span><span class="s1">, not </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The &#39;filter&#39; parameter is deprecated. Use &#39;threshold&#39; instead.&quot;</span><span class="p">)</span>
    
        <span class="n">tstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">start</span>
        <span class="n">tend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">end</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dekomp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">tend</span><span class="p">,</span> <span class="n">time_att</span><span class="o">=</span><span class="n">time_att</span><span class="p">)</span>
        
    
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;level&#39;</span><span class="p">:</span>
            <span class="n">res_relevant</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;att_</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_relevant</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;att_</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> 
            
    
        <span class="k">if</span> <span class="n">lag</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_relevant</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">res_relevant</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                               <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_relevant</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">res_relevant</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
        <span class="n">out</span> <span class="o">=</span> <span class="n">cutout</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.get_att_pct">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.get_att_pct">[docs]</a>
    <span class="k">def</span> <span class="nf">get_att_pct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; det attribution pct for a variable.</span>
<span class="sd">         I little effort to change from multiindex to single node name&#39;&#39;&#39;</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">start</span> <span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">start</span>
        <span class="n">tend</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">end</span> <span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">end</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dekomp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">tend</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="n">time_att</span><span class="p">)</span>
        <span class="n">res_pct</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">lag</span><span class="p">:</span>
            <span class="n">out_pct</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_pct</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">res_pct</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                   <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_pct</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_pct</span> <span class="o">=</span> <span class="n">res_pct</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out_pct</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">out_pct</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">:]</span> <span class="k">if</span> <span class="nb">filter</span> <span class="k">else</span> <span class="n">out_pct</span>
        <span class="n">out</span><span class="o">=</span><span class="n">cutout</span><span class="p">(</span><span class="n">out_pct</span><span class="p">,</span><span class="n">threshold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.get_att_pct_to_from">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.get_att_pct_to_from">[docs]</a>
    <span class="k">def</span> <span class="nf">get_att_pct_to_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">to_var</span><span class="p">,</span><span class="n">from_var</span><span class="p">,</span><span class="n">lag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Get the  attribution for a singel variable&#39;&#39;&#39;</span>
        <span class="n">outdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct</span><span class="p">(</span><span class="n">to_var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">lag</span><span class="o">=</span><span class="n">lag</span><span class="p">,</span><span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="n">time_att</span><span class="p">)</span>
        <span class="c1"># print(f&#39;{to_var=} {from_var=} {outdf.loc[from_var.upper(),:].abs().max()}&#39;)</span>
        
        <span class="k">return</span> <span class="n">outdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">from_var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),:]</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.get_att_level">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.get_att_level">[docs]</a>
    <span class="k">def</span> <span class="nf">get_att_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; det attribution pct for a variable.</span>
<span class="sd">         I little effort to change from multiindex to single node name&#39;&#39;&#39;</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">start</span> <span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">start</span>
        <span class="n">tend</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">end</span> <span class="o">==</span><span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="n">end</span>
         
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dekomp</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">tend</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="n">time_att</span><span class="p">)</span>
        <span class="n">res_level</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:]</span>
        <span class="k">if</span> <span class="n">lag</span><span class="p">:</span>
            <span class="n">out_pct</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">res_level</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">res_level</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                   <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res_level</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_pct</span> <span class="o">=</span> <span class="n">res_level</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out_pct</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">out_pct</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">:]</span> <span class="k">if</span> <span class="nb">filter</span> <span class="k">else</span> <span class="n">out_pct</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.dekomp_plot">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.dekomp_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">dekomp_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">lag</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">,</span><span class="n">rename</span><span class="o">=</span><span class="kc">True</span> 
                    <span class="p">,</span><span class="n">nametrans</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">varnames</span><span class="p">,</span><span class="n">thismodel</span> <span class="p">:</span> <span class="n">varnames</span>
                    <span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns  a chart with attribution for a variable over the smpl  </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        varnavn : TYPE</span>
<span class="sd">            variable name.</span>
<span class="sd">        sort : TYPE, optional</span>
<span class="sd">            . The default is False.</span>
<span class="sd">        pct : TYPE, optional</span>
<span class="sd">            display pct contribution . The default is True.</span>
<span class="sd">        per : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is &#39;&#39;.</span>
<span class="sd">        threshold : TYPE, optional</span>
<span class="sd">            cutoff. The default is 0.0.</span>
<span class="sd">        rename : TYPE, optional</span>
<span class="sd">            Use descriptions instead of variable names. The default is True.</span>
<span class="sd">        time_att : TYPE, optional</span>
<span class="sd">            Do time attribution . The default is False.</span>
<span class="sd">        lag : TYPE, optional</span>
<span class="sd">           separete by lags The default is True.           </span>
<span class="sd">        top : TYPE, optional</span>
<span class="sd">          where to place the title </span>
<span class="sd">           </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        a matplotlib figure instance .</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c1"># xx = self.dekomp(varnavn,self.current_per[0],self.current_per[-1],lprint=False)</span>
        <span class="c1"># # breakpoint()</span>
        <span class="c1"># ddf0 = join_name_lag(xx[2] if pct else xx[1]).pipe(</span>
        <span class="c1">#     lambda df: df.loc[[i for i in df.index if i != &#39;Total&#39;], :])</span>
        <span class="n">ddf0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct</span><span class="p">(</span><span class="n">varnavn</span><span class="p">,</span><span class="n">lag</span><span class="o">=</span><span class="n">lag</span><span class="p">,</span><span class="n">time_att</span><span class="o">=</span><span class="n">time_att</span><span class="p">)</span> <span class="k">if</span> <span class="n">pct</span> <span class="k">else</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_att_level</span><span class="p">(</span><span class="n">varnavn</span><span class="p">,</span><span class="n">lag</span><span class="o">=</span><span class="n">lag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rename</span><span class="p">:</span>
            <span class="n">ddf0</span> <span class="o">=</span> <span class="n">ddf0</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ddf0</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">nametrans</span><span class="p">(</span><span class="n">ddf0</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ddf</span> <span class="o">=</span> <span class="n">cutout</span><span class="p">(</span><span class="n">ddf0</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
            <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>
        <span class="n">ddf</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">varnavn</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ddf</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                          <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-large&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">nthreshold</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">threshold</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;, threshold = </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">ntitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Decomposition</span><span class="si">{</span><span class="n">nthreshold</span><span class="si">}</span><span class="s1">&#39;</span> 
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">ntitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="c1"># fig.subplots_adjust(top=top)</span>

        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.get_dekom_gui">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.get_dekom_gui">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dekom_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Interactive wrapper around :any:`dekomp_plot` and :any:`dekomp_plot_per`</span>

<span class="sd">        Args:</span>
<span class="sd">            var (TYPE, optional): start variable . Defaults to &#39;&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            show (TYPE): dict of matplotlib figs .</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">show_dekom</span><span class="p">(</span><span class="n">Variable</span><span class="p">,</span> <span class="n">Pct</span><span class="p">,</span> <span class="n">Periode</span><span class="p">,</span> <span class="n">Threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">Variable</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dekomp_plot</span><span class="p">(</span><span class="n">Variable</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="n">Pct</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">Threshold</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dekomp_plot_per</span><span class="p">(</span>
                <span class="n">Variable</span><span class="p">,</span> <span class="n">pct</span><span class="o">=</span><span class="n">Pct</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">Threshold</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="n">Periode</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">xvar</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">show</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">interactive</span><span class="p">(</span><span class="n">show_dekom</span><span class="p">,</span>
                              <span class="n">Variable</span><span class="o">=</span><span class="n">ip</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="n">xvar</span><span class="p">),</span>
                              <span class="n">Pct</span><span class="o">=</span><span class="n">ip</span><span class="o">.</span><span class="n">Checkbox</span><span class="p">(</span>
                                  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Percent growth&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                              <span class="n">Periode</span><span class="o">=</span><span class="n">ip</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">),</span>
                              <span class="n">Threshold</span><span class="o">=</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">show</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.totexplain">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.totexplain">[docs]</a>
    <span class="k">def</span> <span class="nf">totexplain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        makes a total explanation for the variables defined by pat </span>

<span class="sd">        Args:</span>
<span class="sd">            pat (TYPE, optional): DESCRIPTION. Defaults to &#39;*&#39;.</span>
<span class="sd">            vtype (TYPE, optional): DESCRIPTION. Defaults to &#39;all&#39;.</span>
<span class="sd">            stacked (TYPE, optional): DESCRIPTION. Defaults to True.</span>
<span class="sd">            kind (TYPE, optional): DESCRIPTION. Defaults to &#39;bar&#39;.</span>
<span class="sd">            per (TYPE, optional): DESCRIPTION. Defaults to &#39;&#39;.</span>
<span class="sd">            top (TYPE, optional): DESCRIPTION. Defaults to 0.9.</span>
<span class="sd">            title (TYPE, optional): DESCRIPTION. Defaults to &#39;&#39;.</span>
<span class="sd">            use (TYPE, optional): DESCRIPTION. Defaults to &#39;level&#39;.</span>
<span class="sd">            threshold (TYPE, optional): DESCRIPTION. Defaults to 0.0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            fig (TYPE): DESCRIPTION.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;totdekomp&#39;</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">modeldekom</span> <span class="kn">import</span> <span class="n">totdif</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span> <span class="o">=</span> <span class="n">totdif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summaryvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">desdic</span><span class="o">=</span><span class="p">{})</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span><span class="o">.</span><span class="n">totexplain</span><span class="p">(</span><span class="n">pat</span><span class="o">=</span><span class="n">pat</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="n">stacked</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                                        <span class="n">per</span><span class="o">=</span><span class="n">per</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.totdif">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.totdif">[docs]</a>
    <span class="k">def</span> <span class="nf">totdif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">summaryvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">desdic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">experiments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span> <span class="o">=</span> <span class="n">totdif</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">summaryvar</span><span class="o">=</span><span class="n">summaryvar</span><span class="p">,</span> 
                               <span class="n">desdic</span><span class="o">=</span><span class="n">desdic</span> <span class="k">if</span> <span class="n">desdic</span> <span class="o">!=</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">,</span>
                               <span class="n">experiments</span><span class="o">=</span><span class="n">experiments</span><span class="p">)</span>  
       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span></div>


<div class="viewcode-block" id="Dekomp_Mixin.get_att_gui">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dekomp_Mixin.get_att_gui">[docs]</a>
    <span class="k">def</span> <span class="nf">get_att_gui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="s1">&#39;FY&#39;</span><span class="p">,</span> <span class="n">spat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">desdic</span><span class="o">=</span><span class="p">{},</span> <span class="n">use</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="n">ysize</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Creates a jupyter ipywidget to display model level </span>
<span class="sd">        attributions &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;totdekomp&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span> <span class="o">=</span> <span class="n">totdif</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">summaryvar</span><span class="o">=</span><span class="n">spat</span><span class="p">,</span> <span class="n">desdic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TOTDEKOMP made&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span><span class="o">.</span><span class="n">go</span><span class="p">:</span>
            <span class="n">xvar</span> <span class="o">=</span> <span class="n">var</span> <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">mj</span><span class="o">.</span><span class="n">get_att_gui</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">xvar</span><span class="p">,</span>
                                <span class="n">spat</span><span class="o">=</span><span class="n">spat</span><span class="p">,</span> <span class="n">desdic</span><span class="o">=</span><span class="n">desdic</span><span class="p">,</span> <span class="n">use</span><span class="o">=</span><span class="n">use</span><span class="p">,</span><span class="n">ysize</span><span class="o">=</span><span class="n">ysize</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">totdekomp</span>
            <span class="k">return</span> <span class="s1">&#39;Nothing to attribute&#39;</span></div>
</div>



<div class="viewcode-block" id="Description_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Description_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This Class defines description related methods and properties</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nd">@property</span> 
    <span class="k">def</span> <span class="nf">var_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;A dictionary with variable descriptions, if no value matching the key the variable name is returned &#39;&#39;&#39;</span> 
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_description</span>
    
    <span class="nd">@var_description</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">var_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a_dict</span><span class="p">):</span>
        <span class="n">allvarset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">_var_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defsub</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">a_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allvarset</span><span class="p">})</span>
    
    <span class="nd">@property</span>    
    <span class="k">def</span> <span class="nf">var_description_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span>  <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    
<div class="viewcode-block" id="Description_Mixin.set_var_description">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.set_var_description">[docs]</a>
    <span class="k">def</span> <span class="nf">set_var_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; sets var_description **Obsolete** now just use = to set a new var_description&#39;&#39;&#39;</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="o">=</span> <span class="n">a_dict</span></div>

        
<div class="viewcode-block" id="Description_Mixin.var_description_add">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.var_description_add">[docs]</a>
    <span class="k">def</span> <span class="nf">var_description_add</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; adds a dict with var_descriptions to the var_description, new will overwrite old values&#39;&#39;&#39;</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_var_description</span><span class="p">,</span> <span class="o">**</span><span class="n">a_dict</span><span class="p">}</span> </div>

        
<div class="viewcode-block" id="Description_Mixin.set_var_description_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.set_var_description_old">[docs]</a>
    <span class="k">def</span> <span class="nf">set_var_description_old</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_dict</span><span class="p">):</span>
        <span class="n">allvarset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defsub</span><span class="p">({</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">a_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allvarset</span><span class="p">})</span></div>


<div class="viewcode-block" id="Description_Mixin.html_replace">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.html_replace">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">html_replace</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Replace special characters in html &#39;&#39;&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;#38;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#10;&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#230;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#248;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#229;&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#198;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#216;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#197;&#39;</span><span class="p">)</span>
               <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;&amp;#36;&#39;</span><span class="p">)</span>
               <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Description_Mixin.var_des">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.var_des">[docs]</a>
    <span class="k">def</span> <span class="nf">var_des</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns blank if no description&#39;&#39;&#39;</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">des</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">var</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">des</span> <span class="k">if</span> <span class="n">des</span> <span class="o">!=</span> <span class="n">var</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="Description_Mixin.get_eq_des">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.get_eq_des">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eq_des</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">show_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns a string of descriptions for all variables in an equation:&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">:</span>
            <span class="n">rhs_var</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">start</span> <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">this</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph_nolag</span><span class="o">.</span><span class="n">in_edges</span><span class="p">(</span>
                <span class="n">var</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_des</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="ow">or</span> <span class="n">show_all</span><span class="p">])</span>
            <span class="n">all_var</span> <span class="o">=</span> <span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhs_var</span>
            <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">all_var</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_var</span><span class="p">)</span> <span class="k">else</span> <span class="mi">10</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">rhs</span><span class="si">:{</span><span class="n">maxlen</span><span class="si">}}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_des</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">all_var</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="Description_Mixin.get_des_html">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.get_des_html">[docs]</a>
    <span class="k">def</span> <span class="nf">get_des_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_des</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="c1"># breakpoint()</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">html_replace</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">&#39;</span></div>

        
        
<div class="viewcode-block" id="Description_Mixin.read_wb_xml_var_des">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.read_wb_xml_var_des">[docs]</a>
    <span class="nd">@staticmethod</span>    
    <span class="k">def</span> <span class="nf">read_wb_xml_var_des</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Read a xml file with variable description world bank style &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">xml</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">xmltext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">ElementTree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">xmltext</span><span class="p">)</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)</span>
        <span class="n">vardes</span><span class="o">=</span> <span class="p">{</span> <span class="n">v</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Mnem&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="p">:</span>  <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Languages&#39;</span><span class="p">)}</span>  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">des</span><span class="o">:=</span> <span class="n">v</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Languages&#39;</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="p">}</span>    
        <span class="n">description_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="p">:</span> <span class="n">vardes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vardes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="p">}</span>
        <span class="k">return</span> <span class="n">description_dic</span> </div>

    
<div class="viewcode-block" id="Description_Mixin.languages_wb_xml_var_des">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.languages_wb_xml_var_des">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">languages_wb_xml_var_des</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Find languages in a xml file with variable description world bank style&#39;&#39;&#39;</span>
        <span class="n">description_dic</span>  <span class="o">=</span> <span class="n">mmodel</span><span class="o">.</span><span class="n">read_wb_xml_var_des</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">languages</span> <span class="o">=</span> <span class="p">{</span><span class="n">l</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span><span class="n">descriptions</span> <span class="ow">in</span> <span class="n">description_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">languages</span> </div>

    
    
<div class="viewcode-block" id="Description_Mixin.set_wb_xml_var_description">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.set_wb_xml_var_description">[docs]</a>
    <span class="k">def</span> <span class="nf">set_wb_xml_var_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">language</span><span class="o">=</span><span class="s1">&#39;English&#39;</span><span class="p">):</span>  
<span class="w">        </span><span class="sd">&#39;&#39;&#39; set variable descriptions from a xml file with variable description world bank style&#39;&#39;&#39;</span>
        <span class="n">description_dic</span>  <span class="o">=</span> <span class="n">mmodel</span><span class="o">.</span><span class="n">read_wb_xml_var_des</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">this_description</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span> <span class="p">:</span> <span class="n">descriptions</span><span class="p">[</span><span class="s1">&#39;English&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span><span class="n">descriptions</span> <span class="ow">in</span> <span class="n">description_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">language</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">enriched_var_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enrich_var_description</span><span class="p">(</span><span class="n">this_description</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_var_description</span><span class="p">(</span><span class="n">enriched_var_description</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="Description_Mixin.enrich_var_description">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.enrich_var_description">[docs]</a>
    <span class="k">def</span> <span class="nf">enrich_var_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var_description</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Takes a dict of variable descriptions and enhance it for the standard suffixes for generated variables&#39;&#39;&#39;</span> 
        
        <span class="n">add_d</span> <span class="o">=</span>   <span class="p">{</span> <span class="n">newname</span> <span class="p">:</span> <span class="s1">&#39;Add factor:&#39;</span><span class="o">+</span> <span class="n">var_description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span>  <span class="p">(</span><span class="n">newname</span> <span class="o">:=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;_A&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="p">}</span>
        <span class="n">dummy_d</span> <span class="o">=</span> <span class="p">{</span> <span class="n">newname</span> <span class="p">:</span> <span class="s1">&#39;Fix dummy:&#39;</span><span class="o">+</span> <span class="n">var_description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>         <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span>  <span class="p">(</span><span class="n">newname</span> <span class="o">:=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;_D&#39;</span><span class="p">)</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="p">}</span>
        <span class="n">fix_d</span> <span class="o">=</span>   <span class="p">{</span> <span class="n">newname</span> <span class="p">:</span> <span class="s1">&#39;Fix value:&#39;</span><span class="o">+</span> <span class="n">var_description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>         <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span>  <span class="p">(</span><span class="n">newname</span> <span class="o">:=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;_X&#39;</span><span class="p">)</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="p">}</span>
        <span class="n">fitted_d</span> <span class="o">=</span>   <span class="p">{</span> <span class="n">newname</span> <span class="p">:</span> <span class="s1">&#39;Fitted  value:&#39;</span><span class="o">+</span> <span class="n">var_description</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span>  <span class="p">(</span><span class="n">newname</span> <span class="o">:=</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;_FITTED&#39;</span><span class="p">)</span>  <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="p">}</span>
        <span class="c1"># breakpoint() </span>
        <span class="n">var_description_new</span> <span class="o">=</span>  <span class="p">{</span><span class="o">**</span><span class="n">var_description</span><span class="p">,</span><span class="o">**</span><span class="n">add_d</span><span class="p">,</span><span class="o">**</span><span class="n">dummy_d</span><span class="p">,</span><span class="o">**</span><span class="n">fix_d</span><span class="p">,</span><span class="o">**</span><span class="n">fitted_d</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">var_description_new</span></div>

        
<div class="viewcode-block" id="Description_Mixin.deslist">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Description_Mixin.deslist">[docs]</a>
    <span class="k">def</span> <span class="nf">deslist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a list of variable where the description in the model matching the pattern, the pattern can be a list of patterns</span>

<span class="sd">        Args:</span>
<span class="sd">            pat (string or list of strings): One or more pattern seperated by space wildcards * and ?, special pattern: #ENDO  </span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            out (list): list of variable names where the description matching the pat.</span>

<span class="sd">        &#39;&#39;&#39;</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;&#39;&#39;&#39;</span>
        <span class="c1"># breakpoint() </span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">upat</span> <span class="o">=</span> <span class="n">pat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">upat</span> <span class="o">=</span> <span class="p">[</span><span class="n">pat</span><span class="p">]</span>

        <span class="n">ipat</span> <span class="o">=</span> <span class="n">upat</span>

        
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">ipat</span> <span class="k">for</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description_reverse</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> 
                 <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description_reverse</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">up</span><span class="o">.</span><span class="n">upper</span><span class="p">())])]</span>

        <span class="k">return</span> <span class="n">out</span></div>
</div>

        


<div class="viewcode-block" id="Modify_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Modify_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Modify_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Class to modify a model with new equations, (later alse delete, and new normalization)&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">another_model</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">endooverlab</span><span class="o">:=</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="o">&amp;</span> <span class="n">another_model</span><span class="o">.</span><span class="n">endogene</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No overlab in endogenous allowed. Fix it.</span><span class="se">\n</span><span class="s1">Offending variables: </span><span class="se">\n</span><span class="si">{</span><span class="n">endooverlab</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;When adding two models, no overlab in endogenous allowed &#39;</span><span class="p">)</span>
        <span class="n">mnew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">+</span><span class="n">another_model</span><span class="o">.</span><span class="n">equations</span><span class="p">,</span>
        <span class="n">modelname</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Combined </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">another_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="n">var_description</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="p">,</span> <span class="o">**</span><span class="n">another_model</span><span class="o">.</span><span class="n">var_description</span><span class="p">},</span>
        <span class="n">var_groups</span>  <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span>      <span class="p">,</span> <span class="o">**</span><span class="n">another_model</span><span class="o">.</span><span class="n">var_groups</span> <span class="p">},</span>
        <span class="n">reports</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="o">|</span> <span class="n">another_model</span><span class="o">.</span><span class="n">reports</span> <span class="p">,</span>
        <span class="n">equations_latex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations_latex</span><span class="o">+</span> <span class="n">another_model</span><span class="o">.</span><span class="n">equations_latex</span> <span class="p">,</span>
        <span class="n">eviews_dict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">eviews_dict</span><span class="p">,</span><span class="o">**</span><span class="n">another_model</span><span class="o">.</span><span class="n">eviews_dict</span><span class="p">},</span>
        <span class="n">model_description</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;This model was created by combining the two models:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">another_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span>
<span class="s1">        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> description:</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_description</span><span class="si">}</span><span class="se">\n</span>
<span class="s1">        </span><span class="si">{</span><span class="n">another_model</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> description:</span><span class="se">\n</span><span class="si">{</span><span class="n">another_model</span><span class="o">.</span><span class="n">model_description</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">mnew</span><span class="o">.</span><span class="n">lastdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">,</span><span class="n">another_model</span><span class="o">.</span><span class="n">lastdf</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span> <span class="p">)</span>
        <span class="n">mnew</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span>
        <span class="k">return</span> <span class="n">mnew</span>     
    
    
<div class="viewcode-block" id="Modify_Mixin.copy_properties">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Modify_Mixin.copy_properties">[docs]</a>
    <span class="k">def</span> <span class="nf">copy_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mmodel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Transfer useful propoerties from self to a new model&#39;&#39;&#39;</span> </div>

        
        


<div class="viewcode-block" id="Modify_Mixin.eqflip">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Modify_Mixin.eqflip">[docs]</a>
    <span class="k">def</span> <span class="nf">eqflip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">flip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">calc_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">newname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        newnormalisation : TYPE, optional</span>
<span class="sd">            Not implementet yet . The default is None.</span>
<span class="sd">        newfunks : TYPE, optional</span>
<span class="sd">            Additional userspecified functions. The default is [].</span>
<span class="sd">        calc_add : bool, optional</span>
<span class="sd">            Additional userspecified functions. The default is [].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        newmodel : TYPE</span>
<span class="sd">            The new  model with the new and deleted equations .</span>
<span class="sd">        newdf : TYPE</span>
<span class="sd">            a dataframe with calculated add factors. Origin is the original models lastdf.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">newmodelname</span> <span class="o">=</span> <span class="n">newname</span> <span class="k">if</span> <span class="n">newname</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; flipped&#39;</span>      
        <span class="n">updatefunks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span> <span class="c1"># </span>
        <span class="c1"># breakpoint() </span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">flip</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">newnormalisation</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">vars_before_normalization</span> <span class="o">=</span> <span class="p">{</span><span class="n">beforeendo</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span>  <span class="n">beforeendo</span><span class="p">,</span><span class="n">afterendo</span> <span class="ow">in</span> <span class="n">newnormalisation</span>  <span class="p">}</span>
        <span class="n">frml_normalize_strip</span> <span class="o">=</span> <span class="p">{(</span><span class="n">beforeendo</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">afterendo</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">beforeendo</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>   <span class="k">for</span> <span class="n">beforeendo</span><span class="p">,</span><span class="n">afterendo</span> <span class="ow">in</span> <span class="n">newnormalisation</span> <span class="p">}</span>
        <span class="n">frml_normalize_gross</span> <span class="o">=</span> <span class="p">{(</span><span class="n">beforeendo</span><span class="p">,</span><span class="n">afterendo</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">fname</span> <span class="p">,</span><span class="n">normal</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span><span class="n">the_endo</span> <span class="o">=</span> <span class="n">afterendo</span><span class="p">,</span><span class="n">endo_lhs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">add_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  <span class="k">for</span> <span class="p">(</span><span class="n">beforeendo</span><span class="p">,</span><span class="n">afterendo</span><span class="p">),(</span><span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">expression</span><span class="p">)</span>  <span class="ow">in</span> <span class="n">frml_normalize_strip</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
        <span class="n">frmldict_normalized</span> <span class="o">=</span> <span class="p">{</span><span class="n">afterendo</span> <span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;FRML </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">normalized</span><span class="si">}</span><span class="s1">$&#39;</span>
                               <span class="k">for</span> <span class="p">(</span><span class="n">beforeendo</span><span class="p">,</span><span class="n">afterendo</span><span class="p">),(</span><span class="n">fname</span><span class="p">,</span><span class="n">nexpression</span><span class="p">)</span>  <span class="ow">in</span> <span class="n">frml_normalize_gross</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
<span class="c1">#        breakpoint() </span>
            
        <span class="n">frmldict</span>    <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vars_before_normalization</span> <span class="p">}</span> <span class="c1"># frml&#39;s in the existing model </span>
        <span class="n">newfrmldict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">frmldict</span><span class="p">,</span><span class="o">**</span><span class="n">frmldict_normalized</span><span class="p">}</span> <span class="c1"># frml&#39;s in the new model </span>
            
        <span class="n">newfrml</span>     <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">newfrmldict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">newmodel</span>    <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">newfrml</span><span class="p">,</span><span class="n">modelname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;updated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                      <span class="n">funks</span><span class="o">=</span><span class="n">updatefunks</span><span class="p">,</span>
                          <span class="n">var_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">,</span> 
                          <span class="n">model_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_description</span><span class="p">,</span> 
                          <span class="n">var_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span> <span class="p">,</span> 
                          <span class="n">reports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="p">,</span> 
                          <span class="n">equations_latex</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                             
                                      
                                      <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The model:&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; Has endogeneous variable flipped, new model name is:&quot;</span><span class="si">{</span><span class="n">newmodelname</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span>  <span class="p">(</span><span class="n">beforeendo</span><span class="p">,</span><span class="n">afterendo</span><span class="p">),(</span><span class="n">fname</span><span class="p">,</span><span class="n">nexpression</span><span class="p">)</span>  <span class="ow">in</span> <span class="n">frml_normalize_gross</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Endogeneous flip for </span><span class="si">{</span><span class="n">beforeendo</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">afterendo</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Old frml   :FRML </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">original</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New frml   :FRML </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">normalized</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="n">newdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newmodel</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">newmodel</span><span class="p">,</span><span class="n">newdf</span> 
        <span class="o">...</span> </div>



<div class="viewcode-block" id="Modify_Mixin.eqdelete">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Modify_Mixin.eqdelete">[docs]</a>
    <span class="k">def</span> <span class="nf">eqdelete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">deleteeq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">newname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        deleteeq : TYPE, optional</span>
<span class="sd">            Variables where equations are to be deleted. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        newmodel : TYPE</span>
<span class="sd">            The new  model with the new and deleted equations .</span>
<span class="sd">        newdf : TYPE</span>
<span class="sd">            a dataframe with calculated add factors. Origin is the original models lastdf.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">vars_todelete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">deleteeq</span><span class="p">)</span>
        <span class="n">newmodelname</span> <span class="o">=</span> <span class="n">newname</span> <span class="k">if</span> <span class="n">newname</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; with deleted eq&#39;</span>      
            
            
        <span class="n">newfrmldict</span>    <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">vars_todelete</span><span class="p">}</span> <span class="c1"># frml&#39;s in the existing model </span>
        <span class="n">neweviewsdict</span>  <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eviews_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>  <span class="k">if</span> <span class="ow">not</span>  <span class="n">k</span> <span class="ow">in</span> <span class="n">vars_todelete</span><span class="p">}</span>    
        <span class="n">newfrml</span>     <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">newfrmldict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">newmodel</span>    <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">newfrml</span><span class="p">,</span><span class="n">modelname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;updated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                                      <span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span>
                          <span class="n">var_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">,</span> 
                          <span class="n">model_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_description</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">With deledet variables: </span><span class="si">{</span><span class="n">vars_todelete</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> 
                          <span class="n">var_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span> <span class="p">,</span> 
                          <span class="n">reports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="p">,</span> 
                          <span class="n">eviews_dict</span> <span class="o">=</span> <span class="n">neweviewsdict</span> <span class="p">,</span>
                          <span class="n">equations_latex</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                      
                                      <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The model:&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; Has equations deleted, new model name is:&quot;</span><span class="si">{</span><span class="n">newmodelname</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The following equations are deleted&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vars_todelete</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">  :deleted &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">  :  is exogenous and not deleted &#39;</span><span class="p">)</span>
                
  
        <span class="n">newdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            
        <span class="n">newmodel</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newmodel</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">newmodelname</span> 

        <span class="k">return</span> <span class="n">newmodel</span><span class="p">,</span><span class="n">newdf</span> 
        <span class="o">...</span> </div>


        
<div class="viewcode-block" id="Modify_Mixin.equpdate">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Modify_Mixin.equpdate">[docs]</a>
    <span class="k">def</span> <span class="nf">equpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">updateeq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">newfunks</span><span class="o">=</span><span class="p">[],</span><span class="n">add_add_factor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">calc_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">do_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">newname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        updateeq : TYPE</span>
<span class="sd">            new equations seperated by newline . </span>
<span class="sd">        newfunks : TYPE, optional</span>
<span class="sd">            Additional userspecified functions. The default is [].</span>
<span class="sd">        calc_add : bool, optional</span>
<span class="sd">            Additional userspecified functions. The default is [].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        newmodel : TYPE</span>
<span class="sd">            The new  model with the new and deleted equations .</span>
<span class="sd">        newdf : TYPE</span>
<span class="sd">            a dataframe with calculated add factors. Origin is the original models lastdf.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
            
        <span class="n">updatefunks</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="o">+</span><span class="n">newfunks</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># </span>
        
        <span class="n">newmodelname</span> <span class="o">=</span> <span class="n">newname</span> <span class="k">if</span> <span class="n">newname</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; Updated&#39;</span>      
    
        <span class="n">dfvars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>    
    
        <span class="n">updatemodel</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">tofrml</span><span class="p">(</span><span class="n">updateeq</span><span class="p">)</span>   <span class="c1"># create the moedl with the usual processing of frml&#39;s </span>
        <span class="k">while</span> <span class="s1">&#39;  &#39;</span> <span class="ow">in</span> <span class="n">updatemodel</span><span class="p">:</span>
            <span class="n">updatemodel</span> <span class="o">=</span> <span class="n">updatemodel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">frml2</span>   <span class="o">=</span> <span class="n">updatemodel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">)</span> 
        <span class="n">frml2_strip</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp</span><span class="o">.</span><span class="n">split_frml</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frml2</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">frml2_normal</span> <span class="o">=</span> <span class="p">[[</span><span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span> 
                         <span class="n">normal</span><span class="p">(</span><span class="n">expression</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">do_preprocess</span><span class="o">=</span><span class="n">do_preprocess</span><span class="p">,</span><span class="n">add_add_factor</span><span class="o">=</span><span class="n">add_add_factor</span><span class="p">,</span>
                                <span class="n">make_fixable</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="n">fname</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="s1">&#39;FIXABLE&#39;</span><span class="p">))]</span>
                           <span class="k">for</span> <span class="n">allfrml</span><span class="p">,</span><span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">expression</span> <span class="ow">in</span> <span class="n">frml2_strip</span><span class="p">]</span> 
        <span class="n">frmldict_update</span> <span class="o">=</span> <span class="p">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">endo_var</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frml</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">normalized</span><span class="si">}</span><span class="s1">$&#39;</span> <span class="k">for</span> 
                           <span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">nexpression</span> <span class="ow">in</span> <span class="n">frml2_normal</span><span class="p">}</span> 
        
        
        <span class="k">if</span> <span class="n">add_add_factor</span><span class="p">:</span>
            <span class="n">frmldict_calc_add</span> <span class="o">=</span> <span class="p">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">endo_var</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frml</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">calc_add_factor</span><span class="si">}</span><span class="s1">$&#39;</span> <span class="k">for</span> 
                    <span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">nexpression</span> <span class="ow">in</span> <span class="n">frml2_normal</span> <span class="k">if</span> <span class="n">nexpression</span><span class="o">.</span><span class="n">endo_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="o">|</span><span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="o">|</span><span class="n">dfvars</span> <span class="p">}</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">frmldict_calc_add</span><span class="o">=</span><span class="p">{}</span>
        <span class="c1"># breakpoint()</span>
            
        <span class="n">frmldict</span>    <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="p">}</span> <span class="c1"># frml&#39;s in the existing model </span>
        <span class="n">newfrmldict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">frmldict</span><span class="p">,</span><span class="o">**</span><span class="n">frmldict_update</span><span class="p">}</span> <span class="c1"># frml&#39;s in the new model </span>
            
        <span class="n">newfrml</span>     <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">newfrmldict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">newmodel</span>    <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">newfrml</span><span class="p">,</span><span class="n">modelname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;updated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                      <span class="n">funks</span><span class="o">=</span><span class="n">updatefunks</span><span class="p">,</span>
                                 <span class="n">var_description</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">,</span> 
                                 <span class="n">model_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_description</span><span class="p">,</span> 
                                 <span class="n">var_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span> <span class="p">,</span> 
                                 <span class="n">reports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="p">,</span> 

                                 <span class="n">equations_latex</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               
                                      
                                      <span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frmldict_calc_add</span><span class="p">)</span> <span class="ow">and</span> <span class="n">calc_add</span><span class="p">:</span>          

            <span class="n">calc_add_frml</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frmldict_calc_add</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">calc_add_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">calc_add_frml</span><span class="p">,</span><span class="n">modelname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;adjustment calculation for updated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">updatefunks</span><span class="p">)</span>
            <span class="n">var_add</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">calc_add_model</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The model:&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; got new equations, new model name is:&quot;</span><span class="si">{</span><span class="n">newmodelname</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">varname</span><span class="p">,</span><span class="n">frml</span>  <span class="ow">in</span> <span class="n">frmldict_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New equation for For </span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Old frml   :</span><span class="si">{</span><span class="n">frmldict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="s2">&quot;new endogeneous variable &quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="o">|</span><span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="ow">and</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">dfvars</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This new endogeneous variable is no an existing exogeneous, but is in .lastdf&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New frml   :</span><span class="si">{</span><span class="n">frml</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjust calc:</span><span class="si">{</span><span class="n">frmldict_calc_add</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="s2">&quot;No frml for adjustment calc  &quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
        <span class="c1"># breakpoint()</span>
        
        <span class="n">thisdf</span> <span class="o">=</span> <span class="n">newmodel</span><span class="o">.</span><span class="n">insertModelVar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">)</span>
        
        <span class="c1"># breakpoint() </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frmldict_calc_add</span><span class="p">)</span> <span class="ow">and</span> <span class="n">calc_add</span><span class="p">:</span>
            <span class="n">calc_add_model</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span>
            <span class="n">newdf</span> <span class="o">=</span> <span class="n">calc_add_model</span><span class="p">(</span><span class="n">thisdf</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">New add factors to get the same results for existing variables:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">newdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">var_add</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">newdf</span> <span class="o">=</span> <span class="n">thisdf</span>
            
        <span class="n">newmodel</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">newmodel</span><span class="p">,</span><span class="n">newdf</span> 
        <span class="o">...</span> </div>

        
<div class="viewcode-block" id="Modify_Mixin.equpdate_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Modify_Mixin.equpdate_old">[docs]</a>
    <span class="k">def</span> <span class="nf">equpdate_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">updateeq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">newfunks</span><span class="o">=</span><span class="p">[],</span><span class="n">add_adjust</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">calc_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">do_preprocess</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">newname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        updateeq : TYPE</span>
<span class="sd">            new equations seperated by newline . </span>
<span class="sd">        newfunks : TYPE, optional</span>
<span class="sd">            Additional userspecified functions. The default is [].</span>
<span class="sd">        calc_add : bool, optional</span>
<span class="sd">            Additional userspecified functions. The default is [].</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        newmodel : TYPE</span>
<span class="sd">            The new  model with the new and deleted equations .</span>
<span class="sd">        newdf : TYPE</span>
<span class="sd">            a dataframe with calculated add factors. Origin is the original models lastdf.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
            
        <span class="n">updatefunks</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="o">+</span><span class="n">newfunks</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># </span>
        
        <span class="n">newmodelname</span> <span class="o">=</span> <span class="n">newname</span> <span class="k">if</span> <span class="n">newname</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39; Updated&#39;</span>      
    
        <span class="n">dfvars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>    
    
        <span class="n">updatemodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">from_eq</span><span class="p">(</span><span class="n">updateeq</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">updatefunks</span><span class="p">)</span>   <span class="c1"># create the moedl with the usual processing of frml&#39;s </span>
        <span class="n">frmldict2</span>   <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">updatemodel</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">updatemodel</span><span class="o">.</span><span class="n">endogene</span><span class="p">}</span> <span class="c1"># A dict with the frml&#39;s of the modify </span>

        <span class="n">frmldic2_strip</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">frmldict2</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span> <span class="c1"># {endovariabbe :  [FRML, FRMLNAME, EXPRESSION]...} </span>
        <span class="n">frmldic2_normal</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="p">:</span> <span class="p">[</span><span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">normal</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span><span class="n">do_preprocess</span><span class="o">=</span><span class="n">do_preprocess</span><span class="p">,</span>
                                                  <span class="n">add_adjust</span><span class="o">=</span><span class="n">add_adjust</span><span class="p">)]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,(</span><span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">expression</span><span class="p">)</span> 
                           <span class="ow">in</span> <span class="n">frmldic2_strip</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> 
        <span class="n">frmldict_update</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frml</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">normalized</span><span class="si">}</span><span class="s1">$&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,(</span><span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">nexpression</span><span class="p">)</span> 
                           <span class="ow">in</span> <span class="n">frmldic2_normal</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> 
        <span class="k">if</span> <span class="n">add_adjust</span><span class="p">:</span>
            <span class="n">frmldict_calc_add</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">frml</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nexpression</span><span class="o">.</span><span class="n">calc_adjustment</span><span class="si">}</span><span class="s1">$&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,(</span><span class="n">frml</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">nexpression</span><span class="p">)</span> 
                           <span class="ow">in</span> <span class="n">frmldic2_normal</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="o">|</span><span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="o">|</span><span class="n">dfvars</span> <span class="p">}</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">frmldict_calc_add</span><span class="o">=</span><span class="p">{}</span>
        <span class="c1"># breakpoint()</span>
            
        <span class="n">frmldict</span>    <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="p">}</span> <span class="c1"># frml&#39;s in the existing model </span>
        <span class="n">newfrmldict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">frmldict</span><span class="p">,</span><span class="o">**</span><span class="n">frmldict_update</span><span class="p">}</span> <span class="c1"># frml&#39;s in the new model </span>
            
        <span class="n">newfrml</span>     <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">newfrmldict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">newmodel</span>    <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">newfrml</span><span class="p">,</span><span class="n">modelname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;updated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">updatefunks</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frmldict_calc_add</span><span class="p">)</span> <span class="ow">and</span> <span class="n">add_adjust</span><span class="p">:</span>          

            <span class="n">calc_add_frml</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">frmldict_calc_add</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">calc_add_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">calc_add_frml</span><span class="p">,</span><span class="n">modelname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;adjustment calculation for updated </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">updatefunks</span><span class="p">)</span>
            <span class="n">var_add</span> <span class="o">=</span> <span class="n">calc_add_model</span><span class="o">.</span><span class="n">endogene</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The model:&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot; got new equations, new model name is:&quot;</span><span class="si">{</span><span class="n">newmodelname</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">varname</span><span class="p">,</span><span class="n">frml</span>  <span class="ow">in</span> <span class="n">frmldict_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New equation for For </span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Old frml   :</span><span class="si">{</span><span class="n">frmldict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="s2">&quot;new endogeneous variable &quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="o">|</span><span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="ow">and</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">dfvars</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This new endogeneous variable is no an existing exogeneous, but is in .lastdf&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;New frml   :</span><span class="si">{</span><span class="n">frml</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Adjust calc:</span><span class="si">{</span><span class="n">frmldict_calc_add</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="s2">&quot;No frml for adjustment calc  &quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
        <span class="c1"># breakpoint()</span>
        
        <span class="n">thisdf</span> <span class="o">=</span> <span class="n">newmodel</span><span class="o">.</span><span class="n">insertModelVar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frmldict_calc_add</span> <span class="ow">and</span> <span class="n">calc_add</span><span class="p">):</span>
            <span class="n">calc_add_model</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span>
            <span class="n">newdf</span> <span class="o">=</span> <span class="n">calc_add_model</span><span class="p">(</span><span class="n">thisdf</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">New add factors to get the same results for existing variables:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">newdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">var_add</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">newdf</span> <span class="o">=</span> <span class="n">thisdf</span>
            
        <span class="n">newmodel</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newmodel</span><span class="o">.</span><span class="n">var_description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span>
        <span class="n">newmodel</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">newmodelname</span> 

        <span class="k">return</span> <span class="n">newmodel</span><span class="p">,</span><span class="n">newdf</span> 
        <span class="o">...</span> </div>
</div>

        
            
    
<div class="viewcode-block" id="Graph_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Graph_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class defines graph related methods and properties</span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Graph_Mixin.create_strong_network">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Mixin.create_strong_network">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_strong_network</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Network&#39;</span><span class="p">,</span> <span class="n">typeout</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; create a solveorder and   blockordering of af graph </span>
<span class="sd">        uses networkx to find the core of the model</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">strong_condensed</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">condensation</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">strong_topo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">strong_condensed</span><span class="p">))</span>
        <span class="n">solveorder</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">v</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strong_topo</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">strong_condensed</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">typeout</span><span class="p">:</span>
            <span class="n">block</span> <span class="o">=</span> <span class="p">[[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">strong_condensed</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;members&#39;</span><span class="p">]]</span>
                     <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strong_topo</span><span class="p">]</span>
            <span class="c1"># count the simultaneous blocks so they do not get lumped together</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Simultaneous&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Recursiv &#39;</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block</span><span class="p">)]</span>
    <span class="c1"># we want to lump recursive equations in sequense together</span>
            <span class="n">strongblock</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                           <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="n">strongtype</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Blockstructure of:&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">Counter</span><span class="p">(</span><span class="n">strongtype</span><span class="p">)</span><span class="o">.</span><span class="n">most_common</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">strongtype</span><span class="p">,</span> <span class="n">strongblock</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> </span><span class="si">{:&lt;15}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">type</span><span class="p">),</span> <span class="n">block</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">solveorder</span><span class="p">,</span> <span class="n">strongblock</span><span class="p">,</span> <span class="n">strongtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">solveorder</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strongorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_strongorder&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strongorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_strong_network</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strongorder</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strongblock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_strongblock&#39;</span><span class="p">):</span>
            <span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strongblock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strongtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_strong_network</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="p">,</span> <span class="n">typeout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strongblock</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strongtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_strongtype&#39;</span><span class="p">):</span>
            <span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strongblock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strongtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_strong_network</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="p">,</span> <span class="n">typeout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strongtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">strongfrml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; To search simultaneity (circularity) in a model </span>
<span class="sd">        this function returns the equations in each strong block</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">simul</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span> <span class="k">for</span> <span class="n">block</span><span class="p">,</span> <span class="nb">type</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strongblock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strongtype</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Simultaneous&#39;</span><span class="p">)]</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span>
                          <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">block</span><span class="p">])</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">simul</span><span class="p">])</span>
        <span class="k">return</span> <span class="s1">&#39;Equations with feedback in this model:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">out</span>

<div class="viewcode-block" id="Graph_Mixin.superblock">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Mixin.superblock">[docs]</a>
    <span class="k">def</span> <span class="nf">superblock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; finds prolog, core and epilog variables &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_prevar&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prevar</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_epivar</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">this</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">indegree</span> <span class="ow">in</span> <span class="n">this</span><span class="o">.</span><span class="n">in_degree</span><span class="p">()</span> <span class="k">if</span> <span class="n">indegree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prevar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prevar</span><span class="o">+</span><span class="n">new</span>
                <span class="n">this</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">outdegree</span> <span class="ow">in</span> <span class="n">this</span><span class="o">.</span><span class="n">out_degree</span><span class="p">()</span> <span class="k">if</span> <span class="n">outdegree</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_epivar</span> <span class="o">=</span> <span class="n">new</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epivar</span>
                <span class="n">this</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

            <span class="n">episet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_epivar</span><span class="p">)</span>
            <span class="n">preset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prevar</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">common_pre_epi_set</span> <span class="o">=</span> <span class="n">episet</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">preset</span><span class="p">)</span>
            <span class="n">noncore</span> <span class="o">=</span> <span class="n">episet</span> <span class="o">|</span> <span class="n">preset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coreorder</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrorder</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">noncore</span><span class="p">]</span>

            <span class="n">xx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corestrongblock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corestrongtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_strong_network</span><span class="p">(</span>
                <span class="n">this</span><span class="p">,</span> <span class="n">typeout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_superstrongblock</span> <span class="o">=</span> <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_prevar</span><span class="p">]</span> <span class="o">+</span>
                                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corestrongblock</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_corestrongblock</span><span class="p">)</span> <span class="k">else</span> <span class="p">[[]])</span>
                                      <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_epivar</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_superstrongtype</span> <span class="o">=</span> <span class="p">([</span><span class="s1">&#39;Recursiv&#39;</span><span class="p">]</span> <span class="o">+</span>
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_corestrongtype</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_corestrongtype</span><span class="p">)</span> <span class="k">else</span> <span class="p">[[]])</span>
                                     <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Recursiv&#39;</span><span class="p">])</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">coregraph</span> <span class="o">=</span> <span class="n">this</span>                   
            
            <span class="bp">self</span><span class="o">.</span><span class="n">fblist</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">daglist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_minimal_feedback_set</span><span class="p">(</span><span class="n">this</span><span class="p">)</span>
            <span class="c1"># Find the feedback graph</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">FVS_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        
                    <span class="c1"># Add only the feedback vertices to the new graph</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">FVS_graph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fblist</span><span class="p">)</span>
                    
                    <span class="c1"># Optionally, add edges between these vertices if they exist in the original graph</span>
                    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fblist</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fblist</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coregraph</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">FVS_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                    
                    <span class="n">h</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">hits</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FVS_graph</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fbhubs</span> <span class="o">=</span>  <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">h</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fbaut</span>    <span class="o">=</span>  <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">a</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">fblist</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fbhubs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="k">except</span><span class="p">:</span>    
                    <span class="o">...</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">use_fbmin</span><span class="p">:</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">_corevar</span> <span class="o">=</span>   <span class="bp">self</span><span class="o">.</span><span class="n">daglist</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">fblist</span> 
            <span class="k">else</span><span class="p">:</span>                     
                <span class="bp">self</span><span class="o">.</span><span class="n">_corevar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">((</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrorder</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corestrongblock</span><span class="p">))</span></div>

                                 



    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prevar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; returns a set with names of endogenopus variables which do not depend </span>
<span class="sd">        on current endogenous variables &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_prevar&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">superblock</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prevar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epivar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; returns a set with names of endogenopus variables which do not influence </span>
<span class="sd">        current endogenous variables &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_epivar&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">superblock</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_epivar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">preorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; the endogenous variables which can be calculated in advance &#39;&#39;&#39;</span>
<span class="c1">#        return [v for v in self.nrorder if v in self.prevar]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">epiorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; the endogenous variables which can be calculated in advance &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">epivar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coreorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; the solution order of the endogenous variables in the simultaneous core of the model &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_coreorder&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">superblock</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_corevar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coreset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;The set of variables of the endogenous variables in the simultaneous core of the model &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_coreset&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coreset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coreset</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">precoreepiorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">preorder</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">epiorder</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prune_endograph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_endograph&#39;</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endograph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_endograph</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_endograph</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epivar</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endograph</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_preorder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_preorder</span>

    <span class="nd">@use_preorder</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">use_preorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_preorder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">use_preorder</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istopo</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">straight</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># print(f&quot;You can&#39;t use preorder in this model, it is topological or straight&quot;)</span>
                <span class="c1"># print(f&quot;We pretend you did not try to set the option&quot;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_use_preorder</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_use_preorder</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_oldsolveorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">[:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precoreepiorder</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_use_preorder</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_oldsolveorder&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_oldsolveorder</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">totgraph_nolag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; The graph of all variables, lagged variables condensed&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgraph_nolag&#39;</span><span class="p">):</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;endo&#39;</span><span class="p">])</span>

            <span class="n">rhss</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">term</span><span class="p">[</span><span class="n">term</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aequalterm</span><span class="p">):])</span>
                    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">)</span>
            <span class="n">rhsvar</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="o">!=</span> <span class="n">var</span><span class="p">})</span>
                      <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhss</span><span class="p">)</span>

    <span class="c1">#            print(list(rhsvar))</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="p">(((</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhsvar</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_totgraph_nolag</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_totgraph_nolag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">totgraph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Returns the total graph of the model, including leads and lags &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgraph&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_totgraph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph_get</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_totgraph</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">endograph_nolag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Dependencygraph for all periode endogeneous variable, shows total dependencies &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_endograph_nolag&#39;</span><span class="p">):</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;endo&#39;</span><span class="p">])</span>

            <span class="n">rhss</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">term</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]:])</span>
                    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">)</span>
            <span class="n">rhsvar</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="o">!=</span> <span class="n">var</span><span class="p">})</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhss</span><span class="p">)</span>

            <span class="n">edges</span> <span class="o">=</span> <span class="p">((</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhsvar</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">)</span>
<span class="c1">#            print(edges)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endograph_nolag</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endograph_nolag</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endograph_nolag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">endograph_lag_lead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Returns the graph of all endogeneous variables including lags and leads&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_endograph_lag_lead&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endograph_lag_lead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph_get</span><span class="p">(</span><span class="n">onlyendo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_endograph_lag_lead</span>

<div class="viewcode-block" id="Graph_Mixin.totgraph_get">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Mixin.totgraph_get">[docs]</a>
    <span class="k">def</span> <span class="nf">totgraph_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onlyendo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; The graph of all variables including and seperate lagged and leaded variable </span>

<span class="sd">        onlyendo : only endogenous variables are part of the graph </span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">lagvar</span><span class="p">(</span><span class="n">xlag</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; makes a string with lag &#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">xlag</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">xlag</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">lagleadvar</span><span class="p">(</span><span class="n">xlag</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; makes a string with lag or lead &#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">xlag</span><span class="p">)</span><span class="si">:</span><span class="s1">+</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">xlag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">terms</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;terms&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                 <span class="k">if</span> <span class="n">inf</span><span class="p">[</span><span class="s1">&#39;endo&#39;</span><span class="p">])</span>

        <span class="n">rhss</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="n">term</span><span class="p">[</span><span class="n">term</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aequalterm</span><span class="p">):])</span>
                <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">onlyendo</span><span class="p">:</span>
            <span class="n">rhsvar</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="p">{(</span><span class="n">v</span><span class="o">.</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">})</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhss</span><span class="p">)</span>
            <span class="n">edgeslag</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lag</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inf</span><span class="p">[</span><span class="s1">&#39;maxlag&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
            <span class="n">edgeslead</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lead</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lead</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                         <span class="k">for</span> <span class="n">lead</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inf</span><span class="p">[</span><span class="s1">&#39;maxlead&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rhsvar</span> <span class="o">=</span> <span class="p">((</span><span class="n">var</span><span class="p">,</span> <span class="p">{(</span><span class="n">v</span><span class="o">.</span><span class="n">var</span><span class="o">+</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">v</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">var</span><span class="p">})</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhss</span><span class="p">)</span>
            <span class="n">edgeslag</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lag</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inf</span><span class="p">[</span><span class="s1">&#39;maxlag&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="n">edgeslead</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lead</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">v</span><span class="o">+</span><span class="n">lagleadvar</span><span class="p">(</span><span class="n">lead</span><span class="p">))</span>
                         <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">inf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">lead</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">inf</span><span class="p">[</span><span class="s1">&#39;maxlead&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

    <span class="c1">#            print(list(rhsvar))</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">(((</span><span class="n">v</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="n">rhsvar</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">))</span>
    <span class="c1">#        edgeslag = [(v,v+lagvar(lag)) for v,inf in m2test.allvar.items() for lag in range(inf[&#39;maxlag&#39;],0)]</span>
        <span class="n">totgraph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">edgeslag</span><span class="p">,</span> <span class="n">edgeslead</span><span class="p">))</span>
        <span class="n">totgraph</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">totgraph</span></div>


<div class="viewcode-block" id="Graph_Mixin.graph_remove">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Mixin.graph_remove">[docs]</a>
    <span class="k">def</span> <span class="nf">graph_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paralist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Removes a list of variables from the totgraph and totgraph_nolag </span>
<span class="sd">        mostly used to remove parmeters from the graph, makes it less crowded&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgraph&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgraph_nolag&#39;</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph_nolag</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_totgraph</span><span class="o">.</span><span class="n">remove_nodes_from</span><span class="p">(</span><span class="n">paralist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_totgraph_nolag</span><span class="o">.</span><span class="n">remove_edges_from</span><span class="p">(</span><span class="n">paralist</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Graph_Mixin.graph_restore">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Mixin.graph_restore">[docs]</a>
    <span class="k">def</span> <span class="nf">graph_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; If nodes has been removed by the graph_remove, calling this function will restore them &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgraph&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgraph_nolag&#39;</span><span class="p">):</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgraph&#39;</span><span class="p">)</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_totgrapH_nolag&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Graph_Mixin.get_minimal_feedback_set">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Mixin.get_minimal_feedback_set">[docs]</a>
    <span class="nd">@staticmethod</span> 
    <span class="k">def</span> <span class="nf">get_minimal_feedback_set</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute an approximate minimal feedback vertex set for a directed graph and perform</span>
<span class="sd">        a topological sort on the resulting acyclic graph.</span>
<span class="sd">    </span>
<span class="sd">        This function attempts to make the input directed graph acyclic by removing a minimal</span>
<span class="sd">        set of vertices (feedback vertex set). It does so by iteratively finding and removing</span>
<span class="sd">        vertices from cycles, preferring those with the highest degree (number of edges). After</span>
<span class="sd">        removing sufficient vertices to break all cycles, it performs a topological sort on the</span>
<span class="sd">        modified graph.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">        G (nx.DiGraph): A directed graph represented as a NetworkX DiGraph.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">        tuple: A tuple containing two elements:</span>
<span class="sd">               - A set of vertices constituting the approximate minimal feedback vertex set.</span>
<span class="sd">               - A list representing the topological sort order of the modified graph.</span>
<span class="sd">               If the input graph G is already acyclic, the feedback vertex set will be empty,</span>
<span class="sd">               and the topological sort order will be of the original graph G.</span>
<span class="sd">    </span>
<span class="sd">        Note:</span>
<span class="sd">        This function does not guarantee the absolute minimal feedback vertex set due to the</span>
<span class="sd">        NP-hard nature of the problem. The topological sort is only valid if the resulting graph</span>
<span class="sd">        is acyclic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># Create a copy of the graph to avoid modifying the original graph</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fvs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    
        <span class="c1"># Function to calculate the degree of a vertex in the cycle</span>
        <span class="k">def</span> <span class="nf">vertex_degree</span><span class="p">(</span><span class="n">vertex</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">H</span><span class="o">.</span><span class="n">degree</span><span class="p">(</span><span class="n">vertex</span><span class="p">)</span>
    
        <span class="c1"># Iterate until the graph becomes acyclic</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Find a cycle in the graph</span>
                <span class="n">cycle</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">find_cycle</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;original&#39;</span><span class="p">)</span>
                <span class="c1"># Find the vertex in the cycle with the highest degree</span>
                <span class="n">vertex_to_remove</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vertex_degree</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># Add the vertex to the feedback vertex set</span>
                <span class="n">fvs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">vertex_to_remove</span><span class="p">)</span>
                <span class="c1"># Remove the vertex from the graph</span>
                <span class="n">H</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">vertex_to_remove</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">nx</span><span class="o">.</span><span class="n">NetworkXNoCycle</span><span class="p">:</span>
                <span class="c1"># If no cycle is found, the graph is now acyclic, and we break the loop</span>
                <span class="k">break</span>
    
        <span class="c1"># Perform a topological sort on the modified graph</span>
        <span class="n">topological_sorted_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">H</span><span class="p">))</span>
    
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">fvs</span><span class="p">)</span> <span class="p">,</span> <span class="n">topological_sorted_order</span></div>
</div>


   

<div class="viewcode-block" id="Graph_Draw_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Graph_Draw_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class defines methods and properties which draws and vizualize using different</span>
<span class="sd">    graphs of the model</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Graph_Draw_Mixin.treewalk">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.treewalk">[docs]</a>
    <span class="k">def</span> <span class="nf">treewalk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="n">maxlevel</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">lpre</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Traverse the call tree from name, and returns a generator \n</span>
<span class="sd">        to get a list just write: list(treewalk(...)) </span>
<span class="sd">        maxlevel determins the number of generations to back up </span>

<span class="sd">        lpre=0 we walk the dependent</span>
<span class="sd">        lpre=1 we walk the precednc nodes  </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">maxlevel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="s1">&#39;Start&#39;</span><span class="p">:</span>
                <span class="c1"># return level=0 in order to prune dublicates</span>
                <span class="k">yield</span> <span class="n">node</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">navn</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpre</span> <span class="k">else</span> <span class="n">g</span><span class="p">[</span><span class="n">navn</span><span class="p">]):</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">treewalk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">maxlevel</span><span class="p">,</span> <span class="n">lpre</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.drawendo">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.drawendo">[docs]</a>
    <span class="k">def</span> <span class="nf">drawendo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;draws a graph of of the whole model&#39;&#39;&#39;</span>
        <span class="n">alllinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">todot2</span><span class="p">(</span><span class="n">alllinks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.drawendo_lag_lead">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.drawendo_lag_lead">[docs]</a>
    <span class="k">def</span> <span class="nf">drawendo_lag_lead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;draws a graph of of the whole model&#39;&#39;&#39;</span>
        <span class="n">alllinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endograph_lag_lead</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">todot2</span><span class="p">(</span><span class="n">alllinks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.drawmodel">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.drawmodel">[docs]</a>
    <span class="k">def</span> <span class="nf">drawmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;draws a graph of of the whole model&#39;&#39;&#39;</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph</span> <span class="k">if</span> <span class="n">lag</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph_nolag</span>
        <span class="n">alllinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">todot2</span><span class="p">(</span><span class="n">alllinks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.plotadjacency">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.plotadjacency">[docs]</a>
    <span class="k">def</span> <span class="nf">plotadjacency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Structure&#39;</span><span class="p">,</span> <span class="n">nolag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Draws an adjacendy matrix </span>

<span class="sd">        Args:</span>
<span class="sd">            size (TYPE, optional): DESCRIPTION. Defaults to (5, 5).</span>
<span class="sd">            title (TYPE, optional): DESCRIPTION. Defaults to &#39;Structure&#39;.</span>
<span class="sd">            nolag (TYPE, optional): DESCRIPTION. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            fig (matplotlib figure): A adjacency matrix drawing.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">nolag</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endograph_nolag</span>
            <span class="n">order</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">blocktype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_strong_network</span><span class="p">(</span>
                <span class="n">G</span><span class="p">,</span> <span class="n">typeout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">draw_adjacency_matrix</span><span class="p">(</span>
                <span class="n">G</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">blocks</span><span class="p">,</span> <span class="n">blocktype</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">draw_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endograph</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">precoreepiorder</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_superstrongblock</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_superstrongtype</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


    
<div class="viewcode-block" id="Graph_Draw_Mixin.draw">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.draw">[docs]</a>
    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">down</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">endo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;draws a graph of dependensies of navn up to maxlevel</span>

<span class="sd">        :lag: show the complete graph including lagged variables else only variables. </span>
<span class="sd">        :endo: Show only the graph for current endogenous variables </span>
<span class="sd">        :down: level downstream</span>
<span class="sd">        :up: level upstream </span>


<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">filter</span> <span class="ow">and</span> <span class="n">lag</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No lagged nodes when using filter&#39;</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph</span> <span class="k">if</span> <span class="p">(</span><span class="n">lag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">filter</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph_nolag</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endograph</span> <span class="k">if</span> <span class="n">endo</span> <span class="k">else</span> <span class="n">graph</span>
        <span class="n">uplinks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">navn</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">maxlevel</span><span class="o">=</span><span class="n">up</span><span class="p">,</span> <span class="n">lpre</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span> <span class="p">)</span>
        <span class="n">downlinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">(</span><span class="o">-</span><span class="n">level</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">navn</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">navn</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">maxlevel</span><span class="o">=</span><span class="n">down</span><span class="p">,</span> <span class="n">lpre</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">))</span>
        <span class="n">alllinks</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">uplinks</span><span class="p">,</span> <span class="n">downlinks</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">todot2</span><span class="p">(</span><span class="n">alllinks</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="n">navn</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">down</span><span class="o">=</span><span class="n">down</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="n">up</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.trans">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.trans">[docs]</a>
    <span class="k">def</span> <span class="nf">trans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">transdic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; as there are many variable starting with SHOCK, the can renamed to save nodes&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
        <span class="n">ud</span> <span class="o">=</span> <span class="n">ind</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="n">root</span> <span class="ow">or</span> <span class="n">transdic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pat</span><span class="p">,</span> <span class="n">to</span> <span class="ow">in</span> <span class="n">transdic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trans &#39;</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">ind</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;trans match </span><span class="si">{</span><span class="n">ind</span><span class="si">}</span><span class="s1"> with </span><span class="si">{</span><span class="n">pat</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">to</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;trans&#39;</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">ud</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ud</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.color">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.color">[docs]</a>
    <span class="k">def</span> <span class="nf">color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="n">navn</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;steelblue1&#39;</span>
        <span class="k">elif</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">namepart</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;springgreen&#39;</span> <span class="k">if</span> <span class="n">namepart</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">else</span> <span class="s1">&#39;olivedrab1&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.upwalk">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.upwalk">[docs]</a>
    <span class="k">def</span> <span class="nf">upwalk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="n">maxlevel</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">lpre</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">         </span><span class="sd">&#39;&#39;&#39; Traverse the call tree from name, and returns a generator \n</span>
<span class="sd">         to get a list just write: list(upwalk(...)) </span>
<span class="sd">         maxlevel determins the number</span>
<span class="sd">         of generations to back maxlevel </span>
<span class="sd">    </span>
<span class="sd">         &#39;&#39;&#39;</span>
         <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">maxlevel</span><span class="p">:</span>
                <span class="c1"># print(level,parent,navn)</span>
                <span class="c1"># print(f&#39;upwalk {level=} {parent=} {navn=}&#39;)</span>
       
                <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="s1">&#39;Start&#39;</span><span class="p">:</span>
                    <span class="c1"># print(f&#39;Look at  {parent=}  {navn=}&#39; )</span>
                    <span class="k">try</span><span class="p">:</span>
                         <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct_to_from</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">navn</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpre</span> 
                             <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct_to_from</span><span class="p">(</span><span class="n">navn</span><span class="p">,</span><span class="n">parent</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nb">filter</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                           <span class="c1"># print(f&#39;yield {parent=}  {navn=}&#39; )</span>
                                <span class="k">yield</span> <span class="n">node</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                        <span class="c1"># yield node(level, parent, navn)</span>

                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">navn</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpre</span> <span class="k">else</span> <span class="n">g</span><span class="p">[</span><span class="n">navn</span><span class="p">]):</span>
                        <span class="c1"># breakpoint()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct_to_from</span><span class="p">(</span><span class="n">navn</span><span class="p">,</span><span class="n">child</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpre</span> 
                                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct_to_from</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">navn</span><span class="p">))</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nb">filter</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                    <span class="c1"># print(f&#39;yield from {child=} {navn=}&#39;)</span>
                                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">maxlevel</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span><span class="n">lpre</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">maxlevel</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span><span class="n">lpre</span><span class="p">)</span>
                            <span class="k">pass</span>
  
         <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">maxlevel</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="s1">&#39;Start&#39;</span><span class="p">:</span>
                    <span class="c1"># return level=0 in order to prune dublicates</span>
                    <span class="k">yield</span> <span class="n">node</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">navn</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpre</span> <span class="k">else</span> <span class="n">g</span><span class="p">[</span><span class="n">navn</span><span class="p">]):</span>
                    <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">maxlevel</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">lpre</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.upwalk_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.upwalk_old">[docs]</a>
    <span class="k">def</span> <span class="nf">upwalk_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">lpre</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">     </span><span class="sd">&#39;&#39;&#39; Traverse the call tree from name, and returns a generator \n</span>
<span class="sd">     to get a list just write: list(upwalk(...)) </span>
<span class="sd">     up determins the number</span>
<span class="sd">     of generations to back up </span>

<span class="sd">     &#39;&#39;&#39;</span>
     <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">up</span><span class="p">:</span>
             <span class="c1"># print(level,parent,navn)</span>
             <span class="c1"># print(f&#39;upwalk {level=} {parent=} {navn=}&#39;)</span>

             <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="s1">&#39;Start&#39;</span><span class="p">:</span>
                 <span class="c1"># print(level,parent,navn,&#39;\n&#39;,(g[navn][parent][&#39;att&#39;]))</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">navn</span><span class="p">][</span><span class="n">parent</span><span class="p">][</span><span class="s1">&#39;att&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                     <span class="c1"># return level=0 in order to prune dublicates</span>
                     <span class="c1"># print(f&#39;Yield {level=} {parent=} {navn=}&#39;)</span>
                     <span class="k">yield</span> <span class="n">node</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">navn</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpre</span> <span class="k">else</span> <span class="n">g</span><span class="p">[</span><span class="n">navn</span><span class="p">]):</span>

                 <span class="k">try</span><span class="p">:</span>
                     <span class="c1"># print(&#39;vvv&#39;,level,parent,navn)</span>
                     <span class="k">if</span>  <span class="n">parent</span> <span class="o">==</span> <span class="s1">&#39;Start&#39;</span><span class="p">:</span> <span class="c1"># (g[parent][navn][&#39;att&#39;].abs() &gt;= select).any(axis=1).any():</span>
                         <span class="c1"># print(f&#39;Yield upwalk {(level+1)=} {child=} {navn=}&#39;)</span>

                         <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span><span class="n">lpre</span><span class="p">)</span>
                     <span class="k">elif</span> <span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">navn</span><span class="p">][</span><span class="n">parent</span><span class="p">][</span><span class="s1">&#39;att&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span> 
                         <span class="c1"># print(f&#39;yield  {level=} {parent=} {navn=} &#39;)</span>

                         <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span><span class="n">lpre</span><span class="p">)</span>
                     <span class="k">else</span><span class="p">:</span>
                         <span class="c1"># print(f&#39;UPS  {level=} {parent=} {navn=} &#39;)</span>
                         <span class="k">pass</span>
                 <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># breakpoint() </span>
                    <span class="c1"># print(f&#39;Exception {e}&#39;)</span>
                    <span class="c1"># print(&#39;Problem &#39;,level,parent,navn,&#39;\n&#39;,g[navn][parent][&#39;att&#39;])</span>
                     
                    <span class="k">pass</span>
     <span class="k">else</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">up</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="s1">&#39;Start&#39;</span><span class="p">:</span>
                 <span class="c1"># return level=0 in order to prune dublicates</span>
                 <span class="k">yield</span> <span class="n">node</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">navn</span><span class="p">)</span> <span class="k">if</span> <span class="n">lpre</span> <span class="k">else</span> <span class="n">g</span><span class="p">[</span><span class="n">navn</span><span class="p">]):</span>
                 <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">select</span><span class="p">,</span> <span class="n">lpre</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.explain">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.explain">[docs]</a>
    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">up</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nb">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">showatt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">noshow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Walks a tree to explain the difference between basedf and lastdf</span>

<span class="sd">        Parameters:</span>
<span class="sd">        :var:  the variable we are looking at</span>
<span class="sd">        :up:  how far up the tree will we climb</span>
<span class="sd">        :select: Only show the nodes which contributes </span>
<span class="sd">        :showatt: Show the explanation in pct </span>
<span class="sd">        :lag:  If true, show all lags, else aggregate lags for each variable. </span>
<span class="sd">        :HR: if true make horisontal graph</span>
<span class="sd">        :title: Title </span>
<span class="sd">        :saveas: Filename </span>
<span class="sd">        :pdf: open the pdf file</span>
<span class="sd">        :svg: display the svg file</span>
<span class="sd">        :browser: if true open the svg file in browser </span>
<span class="sd">        :noshow: Only return the resulting graph </span>
<span class="sd">        :dot: Return the dot file only </span>


<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">up</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Get totgraph&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">startgraph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph</span>   <span class="k">if</span> <span class="n">lag</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">totgraph_nolag</span>
            <span class="n">edgelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span>
                <span class="n">startgraph</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">maxlevel</span><span class="o">=</span><span class="n">up</span><span class="p">)})</span>
            <span class="n">nodelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">v</span><span class="o">.</span><span class="n">child</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">edgelist</span><span class="p">})</span> <span class="o">+</span> \
                <span class="p">[</span><span class="n">var</span><span class="p">]</span>  <span class="c1"># remember the starting node</span>
            <span class="n">nodestodekomp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodelist</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">})</span>
            <span class="c1"># print(nodelist)</span>
            <span class="c1"># print(nodestodekomp)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Dekomp&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">pctdic2</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct</span><span class="p">(</span>
                    <span class="n">n</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">lag</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodestodekomp</span><span class="p">}</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="p">{(</span><span class="n">r</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;att&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="n">r</span><span class="p">],</span> <span class="p">:]}</span>
                     <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">pctdic2</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">localgraph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">localgraph</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">edgelist</span><span class="p">])</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">set_edge_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localgraph</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upwalk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localgraph</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">maxlevel</span><span class="o">=</span><span class="n">up</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">):</span>
                <span class="c1">#                print(f&#39;{&quot;-&quot;*v.lev} {v.child} {v.parent} \n&#39;,self.localgraph[v.child][v.parent].get(&#39;att&#39;,&#39;**&#39;))</span>
                <span class="c1">#                print(f&#39;{&quot;-&quot;*v.lev} {v.child} {v.parent} \n&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">att</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">localgraph</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">][</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;att&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">nodeatt</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;att&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pctdic2</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="p">,</span> <span class="n">nodeatt</span><span class="p">)</span>
            <span class="n">nodevalues</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span>
                <span class="n">n</span><span class="p">)}</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="o">.</span><span class="n">nodes</span><span class="p">}</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="p">,</span> <span class="n">nodevalues</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">([(</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">)])</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="p">,</span> <span class="p">{</span><span class="n">var</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">var</span><span class="p">)}})</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">set_node_attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="p">,</span> <span class="p">{</span>
                                   <span class="n">var</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;att&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="n">lag</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)}})</span>
        <span class="k">if</span> <span class="n">noshow</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span>
        <span class="k">if</span> <span class="n">dot</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">todot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">showatt</span><span class="o">=</span><span class="n">showatt</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gdraw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">showatt</span><span class="o">=</span><span class="n">showatt</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">newgraph</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.dftodottable">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.dftodottable">[docs]</a>
    <span class="k">def</span> <span class="nf">dftodottable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&lt;TR </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&lt;TD ALIGN=&#39;LEFT&#39; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&quot;</span> <span class="o">+</span>
                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&lt;TD ALIGN=&#39;RIGHT&#39;&gt;&quot;</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                 <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">xx</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.todot">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.todot">[docs]</a>
    <span class="k">def</span> <span class="nf">todot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">browser</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; makes a drawing of subtree originating from navn</span>
<span class="sd">        all is the edges</span>
<span class="sd">        attributex can be shown</span>

<span class="sd">        :sink: variale to use as sink </span>
<span class="sd">        :svg: Display the svg image </span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">alledges</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">edges</span><span class="p">())</span>

        <span class="k">if</span> <span class="s1">&#39;transdic&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">alllinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transdic&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transdic&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">alledges</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;transdic&#39;</span><span class="p">):</span>
            <span class="n">alllinks</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transdic</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transdic</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">alledges</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alllinks</span> <span class="o">=</span> <span class="n">alledges</span>

        <span class="n">ibh</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">child</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">alllinks</span><span class="p">}</span>  <span class="c1"># To weed out multible  links</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;showatt&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">att_dic</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;att&#39;</span><span class="p">)</span>
            <span class="n">values_dic</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">get_node_attributes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">)</span>
            <span class="n">showatt</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">showatt</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1">#</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">nodelist</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">ibh</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">child</span><span class="p">)}</span>

        <span class="k">def</span> <span class="nf">dftotable</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&lt;TR </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&lt;TD ALIGN=&#39;LEFT&#39; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&quot;</span> <span class="o">+</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&lt;TD ALIGN=&#39;RIGHT&#39;&gt;&quot;</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                     <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">xx</span>

        <span class="k">def</span> <span class="nf">makenode</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="c1">#            tip= f&#39;{pt.split_frml(self.allvar[v][&quot;frml&quot;])[3][:-1]}&#39; if v in self.endogene else f&#39;{v}&#39;</span>
            <span class="k">if</span> <span class="n">showatt</span><span class="p">:</span>
                <span class="n">dfval</span> <span class="o">=</span> <span class="n">values_dic</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="n">dflen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfval</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="n">lper</span> <span class="o">=</span> <span class="s2">&quot;&lt;TR&gt;&lt;TD ALIGN=&#39;LEFT&#39;&gt;Per&lt;/TD&gt;&quot;</span> <span class="o">+</span> \
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&lt;TD&gt;&#39;</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dfval</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span>
                <span class="n">hval</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TR&gt;&lt;TD COLSPAN = &#39;</span><span class="si">{</span><span class="n">dflen</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&lt;/TR&gt;&quot;</span>
                <span class="n">lval</span> <span class="o">=</span> <span class="n">dftotable</span><span class="p">(</span><span class="n">dfval</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">latt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TR&gt;&lt;TD COLSPAN = &#39;</span><span class="si">{</span><span class="n">dflen</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&#39;&gt; % Explained by&lt;/TD&gt;&lt;/TR&gt;</span><span class="si">{</span><span class="n">dftotable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="p">],</span><span class="n">dec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">latt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="c1"># breakpoint()</span>
                <span class="n">linesout</span> <span class="o">=</span> <span class="n">hval</span><span class="o">+</span><span class="n">lper</span><span class="o">+</span><span class="n">lval</span><span class="o">+</span><span class="n">latt</span>
                <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot; [shape=box fillcolor= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">navn</span><span class="p">)</span><span class="si">}</span><span class="s1"> margin=0.025 fontcolor=blue style=filled  &#39;</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; label=&lt;&lt;TABLE BORDER=&#39;1&#39; CELLBORDER = &#39;1&#39;  &gt; </span><span class="si">{</span><span class="n">linesout</span><span class="si">}</span><span class="s2"> &lt;/TABLE&gt;&gt; ]&quot;</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot; [shape=box fillcolor= </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">navn</span><span class="p">)</span><span class="si">}</span><span class="s1"> margin=0.025 fontcolor=blue style=filled  &#39;</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; label=&lt;&lt;TABLE BORDER=&#39;0&#39; CELLBORDER = &#39;0&#39;  &gt; &lt;TR&gt;&lt;TD&gt;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&lt;/TR&gt; &lt;/TABLE&gt;&gt; ]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;digraph TD { rankdir =&quot;HR&quot; </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;HR&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;digraph TD { rankdir =&quot;LR&quot; </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="s1">&#39;{node  [margin=0.025 fontcolor=blue style=filled ] </span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">makenode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; </span><span class="se">\n</span><span class="s1">} </span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">def</span> <span class="nf">getpw</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;Define pennwidth based on explanation in the last period &#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">5.</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">][</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">][</span><span class="s1">&#39;att&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">20.</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.5</span>

        <span class="k">if</span> <span class="n">showatt</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="p">[</span><span class="n">getpw</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ibh</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pw</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ibh</span><span class="p">]</span>

        <span class="n">links</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="si">}</span><span class="s1">&quot; -&gt; &quot;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s1">&quot; [penwidth=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">]&#39;</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ibh</span><span class="p">,</span> <span class="n">pw</span><span class="p">)])</span>

        <span class="n">psink</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{ rank = sink; &quot;&#39;</span> <span class="o">+</span> \
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sink&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&quot;  ; }&#39;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sink&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">psource</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{ rank = source; &quot;&#39;</span> <span class="o">+</span> \
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&quot;  ; }&#39;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span>
                                                            <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;saveas&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">navn</span><span class="si">}</span><span class="s1"> explained&#39;</span> <span class="k">if</span> <span class="n">navn</span> <span class="k">else</span> <span class="s2">&quot;A_model_graph&quot;</span><span class="p">)</span>

        <span class="n">ptitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> label = &quot;&#39;</span><span class="o">+</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;;&#39;</span>
        <span class="n">post</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">}&#39;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">pre</span><span class="o">+</span><span class="n">nodes</span><span class="o">+</span><span class="n">links</span><span class="o">+</span><span class="n">psink</span><span class="o">+</span><span class="n">psource</span><span class="o">+</span><span class="n">ptitle</span><span class="o">+</span><span class="n">post</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_graph</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.gdraw">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.gdraw">[docs]</a>
    <span class="k">def</span> <span class="nf">gdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;draws a graph of of the whole model&#39;&#39;&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">todot</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.maketip">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.maketip">[docs]</a>
    <span class="k">def</span> <span class="nf">maketip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">html</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tooltip for variable v. </span>

<span class="sd">        For use when generating .dot files for Graphviz</span>

<span class="sd">        If html==True it can be incorporated into html string&#39;&#39;&#39;</span>

        <span class="n">var_name</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">des0</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var_name</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">var_name</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;Exogen&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">des</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">html_replace</span><span class="p">(</span><span class="n">des0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">html</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;TOOLTIP=&quot;</span><span class="si">{</span><span class="n">des</span><span class="si">}</span><span class="s1">&quot; href=&quot;bogus&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;tooltip=&quot;</span><span class="si">{</span><span class="n">des</span><span class="si">}</span><span class="s1">&quot;&#39;</span></div>



<div class="viewcode-block" id="Graph_Draw_Mixin.makedotnew">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.makedotnew">[docs]</a>
    <span class="k">def</span> <span class="nf">makedotnew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alledges</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; makes a drawing of all edges in list alledges</span>
<span class="sd">        all is the edges</span>

<span class="sd">        this can handle both attribution and plain </span>

<span class="sd">        :all: show values for .dfbase and .lastdf</span>
<span class="sd">        :last: show the values for .lastdf</span>
<span class="sd">        :growthshow: Show growthrates </span>
<span class="sd">        :attshow: Show attributiuons</span>
<span class="sd">        :filter: Prune tree branches where all(abs(attribution)&lt;filter value)</span>
<span class="sd">        :sink: variale to use as sink </span>
<span class="sd">        :source: variale to use as ssource </span>
<span class="sd">        :svg: Display the svg image in browser</span>
<span class="sd">        :pdf: display the pdf result in acrobat reader </span>
<span class="sd">        :saveas: Save the drawing as name </span>
<span class="sd">        :size: figure size default (6,6)</span>
<span class="sd">        :warnings: warnings displayed in command console, default =False </span>
<span class="sd">        :invisible: set of invisible nodes </span>
<span class="sd">        :labels: dict of labels for edges </span>
<span class="sd">        :transdic: dict of translations for consolidation of nodes {&#39;SHOCK[_A-Z]*__J&#39;:&#39;SHOCK__J&#39;,&#39;DEV__[_A-Z]*&#39;:&#39;DEV&#39;}</span>
<span class="sd">        :dec: decimal places in numbers</span>
<span class="sd">        :HR: horisontal orientation default = False </span>
<span class="sd">        :des: inject variable descriptions </span>
<span class="sd">        :fokus2: Variable for which values are shown </span>
<span class="sd">        :fokus2all: Show values for all variables </span>


<span class="sd">&#39;&#39;&#39;</span>
        <span class="n">invisible</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;invisible&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

        <span class="n">des</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;des&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># breakpoint() </span>
        <span class="n">attshow</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attshow&#39;</span><span class="p">,</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ats&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">growthshow</span>  <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;growthshow&#39;</span><span class="p">,</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gs&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">))</span>

        <span class="n">showdata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;showdata&#39;</span><span class="p">,</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span>
        
        <span class="n">fokus2</span><span class="o">=</span> <span class="p">[]</span>
        <span class="n">fokus2all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># breakpoint() </span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">showdata</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">int</span><span class="p">,</span><span class="nb">bool</span><span class="p">}:</span>

            <span class="n">fokus2all</span> <span class="o">=</span> <span class="n">showdata</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">showdata</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>

            <span class="n">fokus2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">showdata</span><span class="p">))</span> 
        <span class="k">else</span><span class="p">:</span> 

            <span class="c1"># for legacy </span>
            <span class="n">fokus200</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fokus2&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        
            <span class="n">fokus2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">fokus200</span><span class="p">))</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">fokus200</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">fokus200</span>
            <span class="n">fokus2all</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fokus2all&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">dec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">att</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;att&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">filter</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">color</span><span class="p">(</span> <span class="n">v</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
              <span class="c1"># breakpoint()</span>
              <span class="k">if</span> <span class="n">navn</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                  <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
                  <span class="k">return</span> <span class="n">out</span>
              <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fokus2</span><span class="p">:</span>
                  <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;chocolate1&#39;</span>
                  <span class="k">return</span> <span class="n">out</span>
              <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">:</span>
                  <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;steelblue1&#39;</span>
              <span class="k">elif</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="p">:</span>
                  <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span>
              <span class="k">elif</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                  <span class="n">namepart</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;springgreen&#39;</span> <span class="k">if</span> <span class="n">namepart</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">else</span> <span class="s1">&#39;olivedrab1&#39;</span>
              <span class="k">else</span><span class="p">:</span>
                  <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
              <span class="k">return</span> <span class="n">out</span>
        
        <span class="k">def</span> <span class="nf">dftotable</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;&lt;TR </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;&lt;TD ALIGN=&#39;LEFT&#39; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&quot;</span> <span class="o">+</span>
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&lt;TD ALIGN=&#39;RIGHT&#39;&gt;&quot;</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                     <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">()])</span>
            <span class="k">return</span> <span class="n">xx</span>

        <span class="k">def</span> <span class="nf">getpw</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;Define pennwidth based on max explanation over the period &#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># breakpoint()</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="mf">8.</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mf">10.</span><span class="p">))</span><span class="si">:</span><span class="s1">2</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="c1"># return f&#39;{max(1., min(8., self.get_att_pct_to_from(v.parent,v.child).abs().max()/10.)):.2}&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;0.5&#39;</span>
            
        <span class="k">def</span> <span class="nf">getpct</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;Define pennwidth based on explanation in the last period &#39;&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># breakpoint()</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&quot; </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s1"> Min. att. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%  max: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1">%&quot;&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NA&#39;</span>

        <span class="k">def</span> <span class="nf">stylefunk</span><span class="p">(</span><span class="n">n1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invisible</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="ow">in</span> <span class="n">invisible</span> <span class="ow">or</span> <span class="n">n2</span> <span class="ow">in</span> <span class="n">invisible</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;style = invisible arrowhead=none &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;style = invisible &#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#                return &#39;&#39;</span>
                <span class="k">return</span> <span class="s1">&#39;style = filled&#39;</span>

        <span class="k">def</span> <span class="nf">stylefunkhtml</span><span class="p">(</span><span class="n">n1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invisible</span><span class="o">=</span><span class="nb">set</span><span class="p">()):</span>
            <span class="c1">#            return &#39;&#39;</span>
            <span class="k">if</span> <span class="n">n1</span> <span class="ow">in</span> <span class="n">invisible</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;style = &quot;invisible&quot; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;style = &quot;filled&quot;&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;transdic&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">alllinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transdic&#39;</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;transdic&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">alledges</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;transdic&#39;</span><span class="p">):</span>
            <span class="n">alllinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transdic</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span>
                <span class="n">x</span><span class="o">.</span><span class="n">child</span><span class="p">,</span> <span class="n">navn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">transdic</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">alledges</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alllinks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">alledges</span><span class="p">)</span>

        <span class="n">labelsdic</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defsub</span><span class="p">(</span><span class="n">labelsdic</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">alllinks</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No graph </span><span class="si">{</span><span class="n">navn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> 

        <span class="n">maxlevel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alllinks</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">att</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">to_att</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alllinks</span> <span class="p">}</span><span class="o">|</span><span class="p">{</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alllinks</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_pct</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">to_att</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">att_dic_level</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_att_level</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">to_att</span><span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">att_dic_leve</span> <span class="o">=</span><span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="o">=</span><span class="p">{}</span>
                 
        <span class="n">ibh</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">child</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">alllinks</span><span class="p">}</span>  <span class="c1"># To weed out multible  links</span>
    <span class="c1">#</span>
        <span class="n">nodelist</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span> <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">ibh</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">child</span><span class="p">)}</span>
        
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_dic</span> <span class="o">=</span>  <span class="p">{</span><span class="n">v</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodelist</span> <span class="p">}</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># breakpoint()</span>
<span class="c1">#        print(nodelist)</span>

        <span class="k">def</span> <span class="nf">makenode</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">navn</span><span class="p">):</span>
            <span class="c1"># print(v,fokus2all)</span>
            <span class="n">show</span>  <span class="o">=</span> <span class="p">(</span><span class="n">v</span>  <span class="ow">in</span> <span class="n">fokus2</span><span class="p">)</span>  <span class="ow">or</span> <span class="n">fokus2all</span>
            <span class="c1"># print(f&#39;{v=}, {show=}  {fokus2=}&#39;)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> 
                <span class="n">attshow</span> <span class="ow">or</span> <span class="n">growthshow</span><span class="p">)</span> <span class="ow">and</span> <span class="n">show</span> <span class="p">:</span>
                <span class="c1"># breakpoint()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">udtryk_parse</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="p">[])</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">var</span>
                    <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">try</span><span class="p">:</span> 
                        <span class="n">bvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span><span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">]</span>
                        <span class="n">base</span> <span class="o">=</span> <span class="s2">&quot;&lt;TR&gt;&lt;TD ALIGN=&#39;LEFT&#39; TOOLTIP=&#39;Baseline values&#39; href=&#39;bogus&#39;&gt;Base&lt;/TD&gt;&quot;</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&lt;TD ALIGN=&#39;RIGHT&#39;  TOOLTIP=&#39;Baseline values&#39; href=&#39;bogus&#39; &gt;&quot;</span><span class="o">+</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bvalues</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">base</span><span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">lvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span> <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">]</span> 
                        <span class="n">last</span> <span class="o">=</span> <span class="s2">&quot;&lt;TR&gt;&lt;TD ALIGN=&#39;LEFT&#39; TOOLTIP=&#39;Latest run values&#39; href=&#39;bogus&#39;&gt;Last&lt;/TD&gt;&quot;</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&lt;TD ALIGN=&#39;RIGHT&#39; &gt;&quot;</span><span class="o">+</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">lvalues</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span>
                    <span class="k">except</span><span class="p">:</span> 
                        <span class="n">last</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                    
                    <span class="k">try</span><span class="p">:</span>                     
                        <span class="n">dvalues</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">)</span><span class="o">-</span><span class="n">get_a_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span>
                                   <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">]</span> 
                        <span class="n">dif</span> <span class="o">=</span> <span class="s2">&quot;&lt;TR&gt;&lt;TD ALIGN=&#39;LEFT&#39; TOOLTIP=&#39;Difference between baseline and latest run&#39; href=&#39;bogus&#39;&gt;Diff&lt;/TD&gt;&quot;</span> <span class="o">+</span> \
                            <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;&lt;TD ALIGN=&#39;RIGHT&#39;&gt;&quot;</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">b</span><span class="si">:{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
                            <span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">dvalues</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span> 
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">dif</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    
                    <span class="k">if</span> <span class="n">attshow</span><span class="p">:</span>
                       <span class="k">try</span><span class="p">:</span>
                           <span class="c1"># breakpoint()</span>
                           <span class="n">attvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> 
                           <span class="c1"># attvalues = self.get_att_pct(v.split(&#39;(&#39;)[0], lag=False, start=&#39;&#39;, end=&#39;&#39;)</span>
                           <span class="k">if</span> <span class="nb">filter</span><span class="p">:</span> 
                               <span class="n">attvalues</span> <span class="o">=</span> <span class="n">cutout</span><span class="p">(</span><span class="n">attvalues</span><span class="p">,</span><span class="nb">filter</span><span class="p">)</span>
                           <span class="c1"># attvalues2 = self.att_dic_level[v]</span>
                           <span class="n">dflen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attvalues</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                           <span class="n">latt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TR&gt;&lt;TD COLSPAN = &#39;</span><span class="si">{</span><span class="n">dflen</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&#39;&gt; % Explained by&lt;/TD&gt;&lt;/TR&gt;</span><span class="si">{</span><span class="n">dftotable</span><span class="p">(</span><span class="n">attvalues</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                       <span class="k">except</span><span class="p">:</span>
                            <span class="n">latt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">latt</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        
                    <span class="k">if</span> <span class="n">growthshow</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span> 
                            <span class="n">growthdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_var_growth</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">dflen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">growthdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                            <span class="n">lgrowth</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;TR&gt;&lt;TD COLSPAN = &#39;</span><span class="si">{</span><span class="n">dflen</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&#39;&gt; Growth rate in %&lt;/TD&gt;&lt;/TR&gt;</span><span class="si">{</span><span class="n">dftotable</span><span class="p">(</span><span class="n">growthdf</span><span class="p">,</span><span class="n">dec</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">att_dic</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">except</span><span class="p">:</span> 
                            <span class="n">lgrowth</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lgrowth</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                       

                    <span class="n">per</span> <span class="o">=</span> <span class="s2">&quot;&lt;TR&gt;&lt;TD ALIGN=&#39;LEFT&#39;&gt;Per&lt;/TD&gt;&quot;</span> <span class="o">+</span> \
                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&lt;TD&gt;&#39;</span><span class="o">+</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/TD&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;&lt;/TR&gt;&#39;</span>
<span class="c1">#                    tip= f&#39; tooltip=&quot;{self.allvar[var][&quot;frml&quot;]}&quot;&#39; if self.allvar[var][&#39;endo&#39;] else f&#39; tooltip = &quot;{v}&quot; &#39;</span>
                    <span class="c1"># out = f&#39;&quot;{v}&quot; [shape=box fillcolor= {color(v,navn)}  margin=0.025 fontcolor=blue {stylefunk(var,invisible=invisible)} &#39; + (</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot; [shape=box style=filled  fillcolor=None  margin=0.025 fontcolor=blue &#39;</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot; label=&lt;&lt;TABLE BORDER=&#39;1&#39; CELLBORDER = &#39;1&#39;  </span><span class="si">{</span><span class="n">stylefunkhtml</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">invisible</span><span class="o">=</span><span class="n">invisible</span><span class="p">)</span><span class="si">}</span><span class="s2">    &gt; &lt;TR&gt;&lt;TD COLSPAN =&#39;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lvalues</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&#39; bgcolor=&#39;</span><span class="si">{</span><span class="n">color</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">navn</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2"> &gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_des_html</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">des</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&lt;/TR&gt;</span><span class="si">{</span><span class="n">per</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">base</span><span class="si">}{</span><span class="n">last</span><span class="si">}{</span><span class="n">dif</span><span class="si">}{</span><span class="n">lgrowth</span><span class="si">}{</span><span class="n">latt</span><span class="si">}</span><span class="s2"> &lt;/TABLE&gt;&gt; ]&quot;</span><span class="p">)</span>
                    <span class="k">pass</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inst</span><span class="p">:</span>
                    <span class="c1"># breakpoint()</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot; [shape=box fillcolor= </span><span class="si">{</span><span class="n">color</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">navn</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s1"> margin=0.025 fontcolor=blue </span><span class="si">{</span><span class="n">stylefunk</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">invisible</span><span class="o">=</span><span class="n">invisible</span><span class="p">)</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot; label=&lt;&lt;TABLE BORDER=&#39;0&#39; CELLBORDER = &#39;0&#39; </span><span class="si">{</span><span class="n">stylefunkhtml</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">invisible</span><span class="o">=</span><span class="n">invisible</span><span class="p">)</span><span class="si">}</span><span class="s2"> &gt; &lt;TR&gt;&lt;TD&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_des_html</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&lt;/TR&gt; &lt;TR&gt;&lt;TD&gt; Condensed&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;&gt; ]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&quot; [ shape=box fillcolor= </span><span class="si">{</span><span class="n">color</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">navn</span><span class="p">)</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s1">  margin=0.025 fontcolor=blue </span><span class="si">{</span><span class="n">stylefunk</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">invisible</span><span class="o">=</span><span class="n">invisible</span><span class="p">)</span><span class="si">}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; label=&lt;&lt;TABLE BORDER=&#39;0&#39; CELLBORDER = &#39;0&#39; </span><span class="si">{</span><span class="n">stylefunkhtml</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">invisible</span><span class="o">=</span><span class="n">invisible</span><span class="p">)</span><span class="si">}</span><span class="s2">  &gt; &lt;TR&gt;&lt;TD </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">maketip</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&gt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_des_html</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">des</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/TD&gt;&lt;/TR&gt; &lt;/TABLE&gt;&gt; ]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">pre</span> <span class="o">=</span> <span class="s1">&#39;digraph TD {rankdir =&quot;HR&quot; </span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;HR&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;digraph TD { rankdir =&quot;LR&quot; </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="s1">&#39;{node  [margin=0.025 fontcolor=blue style=filled ] </span><span class="se">\n</span><span class="s1"> &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">makenode</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">navn</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodelist</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; </span><span class="se">\n</span><span class="s1">} </span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">links</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="si">}</span><span class="s1">&quot; -&gt; &quot;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="si">}</span><span class="s1">&quot; [ </span><span class="si">{</span><span class="n">stylefunk</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">child</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span><span class="n">invisible</span><span class="o">=</span><span class="n">invisible</span><span class="p">)</span><span class="si">}</span><span class="s1"> tooltip=</span><span class="si">{</span><span class="n">getpct</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1"> href=&quot;bogus&quot; penwidth = </span><span class="si">{</span><span class="n">getpw</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1"> ]&#39;</span>
                           <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ibh</span><span class="p">])</span>
        <span class="c1"># breakpoint()</span>
        <span class="c1"># links = &#39;\n&#39;.join(</span>
        <span class="c1">#     [f&#39;&quot;{v.child}&quot; -&gt; &quot;{v.parent}&quot; [penwidth={p}]&#39; for v, p in zip(ibh, pw)])</span>

        <span class="n">psink</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{ rank = sink; &quot;&#39;</span> <span class="o">+</span> \
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sink&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;  ; }&#39;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sink&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">psource</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">{ rank = source; &quot;&#39;</span> <span class="o">+</span> \
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&quot;  ; }&#39;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">clusterout</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># expect a dict with clustername as key and a list of nodes as content</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">clusterdic</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clusterdic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">varincluster</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&quot;&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cl</span><span class="p">])</span>
                <span class="n">clusterout</span> <span class="o">=</span> <span class="n">clusterout</span> <span class="o">+</span> \
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> subgraph cluster</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> </span><span class="se">{{</span><span class="s1"> </span><span class="si">{</span><span class="n">varincluster</span><span class="si">}</span><span class="s1"> ; label = &quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">&quot; ; color=lightblue ; style = filled ;fontcolor = yellow</span><span class="se">}}</span><span class="s1">&#39;</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saveas&#39;</span><span class="p">,</span> <span class="n">navn</span> <span class="k">if</span> <span class="n">navn</span> <span class="k">else</span> <span class="s2">&quot;A_model_graph&quot;</span><span class="p">)</span>
        <span class="n">ptitle</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> label = &quot;&#39;</span><span class="o">+</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;;&#39;</span>
        <span class="n">post</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">}&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pre</span><span class="o">+</span><span class="n">nodes</span><span class="o">+</span><span class="n">links</span><span class="o">+</span><span class="n">psink</span><span class="o">+</span><span class="n">psource</span><span class="o">+</span><span class="n">clusterout</span><span class="o">+</span><span class="n">ptitle</span><span class="o">+</span><span class="n">post</span>
        <span class="c1"># self.display_graph(out,fname,**kwargs)</span>

        <span class="c1"># run(&#39;%windir%\system32\mspaint.exe &#39;+ pngname,shell=True) # display the drawing</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.todot2">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.todot2">[docs]</a>
    <span class="k">def</span> <span class="nf">todot2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alledges</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; makes a drawing of all edges in list alledges</span>
<span class="sd">        all is the edges</span>


<span class="sd">        :all: show values for .dfbase and .dflaste</span>
<span class="sd">        :last: show the values for .dflast </span>
<span class="sd">        :sink: variale to use as sink </span>
<span class="sd">        :source: variale to use as ssource </span>
<span class="sd">        :svg: Display the svg image in browser</span>
<span class="sd">        :pdf: display the pdf result in acrobat reader </span>
<span class="sd">        :saveas: Save the drawing as name </span>
<span class="sd">        :size: figure size default (6,6)</span>
<span class="sd">        :warnings: warnings displayed in command console, default =False </span>
<span class="sd">        :invisible: set of invisible nodes </span>
<span class="sd">        :labels: dict of labels for edges </span>
<span class="sd">        :transdic: dict of translations for consolidation of nodes {&#39;SHOCK[_A-Z]*__J&#39;:&#39;SHOCK__J&#39;,&#39;DEV__[_A-Z]*&#39;:&#39;DEV&#39;}</span>
<span class="sd">        :dec: decimal places in numbers</span>
<span class="sd">        :HR: horisontal orientation default = False </span>
<span class="sd">        :des: inject variable descriptions </span>


<span class="sd">&#39;&#39;&#39;</span>

        <span class="n">dot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makedotnew</span><span class="p">(</span><span class="n">alledges</span><span class="p">,</span> <span class="n">navn</span><span class="o">=</span><span class="n">navn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The graph is empty&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Perhaps filter prunes to much&#39;</span><span class="p">)</span>
            <span class="k">return</span> 
        <span class="n">fname</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saveas&#39;</span><span class="p">,</span> <span class="n">navn</span> <span class="k">if</span> <span class="n">navn</span> <span class="k">else</span> <span class="s2">&quot;A_model_graph&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">dot</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">display_graph</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.display_graph_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.display_graph_old">[docs]</a>
    <span class="k">def</span> <span class="nf">display_graph_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dot</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">browser</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="n">tpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s1">&#39;graph&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tpath</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tpath</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ModelFlow: Can&#39;t create folder for graphs&quot;</span><span class="p">)</span>
                <span class="k">return</span>
    <span class="c1">#    filename = os.path.join(r&#39;graph&#39;,navn+&#39;.gv&#39;)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.gv&#39;</span><span class="p">)</span>
        <span class="n">pngname</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>
        <span class="n">svgname</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.svg&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>
        <span class="n">pdfname</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>
        <span class="n">epsname</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tpath</span><span class="p">,</span> <span class="n">fname</span><span class="o">+</span><span class="s1">&#39;.eps&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;-q&quot;</span>
<span class="c1">#        run(&#39;dot -Tsvg  -Gsize=9,9  -o&#39;+svgname+&#39; &quot;&#39;+filename+&#39;&quot;&#39;,shell=True) # creates the drawing</span>
        <span class="c1"># creates the drawing</span>
        <span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dot -Tsvg  -Gsize=</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">  -o</span><span class="si">{</span><span class="n">svgname</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;   </span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># creates the drawing</span>
        <span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dot -Tpng  -Gsize=</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">  -Gdpi=300 -o</span><span class="si">{</span><span class="n">pngname</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;  </span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># creates the drawing</span>
        <span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dot -Tpdf  -Gsize=</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">  -o</span><span class="si">{</span><span class="n">pdfname</span><span class="si">}</span><span class="s1"> &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;  </span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># run(&#39;dot -Tpdf  -Gsize=9,9  -o&#39;+pdfname+&#39; &quot;&#39;+filename+&#39;&quot;&#39;,shell=True) # creates the drawing</span>
        <span class="c1"># run(&#39;dot -Teps  -Gsize=9,9  -o&#39;+epsname+&#39; &quot;&#39;+filename+&#39;&quot;&#39;,shell=True) # creates the drawing</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">pngname</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">SVG</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">svgname</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">pngname</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="n">browser</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">svgname</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;close PDF file before continue&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">pdfname</span><span class="p">)</span></div>


<div class="viewcode-block" id="Graph_Draw_Mixin.display_graph">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Graph_Draw_Mixin.display_graph">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">display_graph</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Generates a graphviz file from the commands in out. </span>

<span class="sd">        The file is placed in cwd/graph</span>

<span class="sd">        A png and a svg file is generated, and the svg file is displayed if possible. </span>

<span class="sd">        options pdf and eps determins if a pdf and an eps file is genrated.</span>

<span class="sd">        option fpdf will cause the graph displayed in a seperate pdf window </span>

<span class="sd">        option browser determins if a seperate browser window is open&#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">IPython.core.magic</span> <span class="kn">import</span> <span class="n">register_line_magic</span><span class="p">,</span> <span class="n">register_cell_magic</span>
        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
        <span class="kn">import</span> <span class="nn">webbrowser</span> <span class="k">as</span> <span class="nn">wb</span>
        <span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">tsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">tsize</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tsize</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                                                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tsize</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>  <span class="c1"># if size is a string</span>

        <span class="n">lpdf</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">fpdf</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fpdf&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">lpng</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">leps</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eps&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">browser</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;browser&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;-q&quot;</span>

        <span class="c1"># path = Path.cwd() / &#39;graph&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;graph&#39;</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span> <span class="o">/</span> <span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;.gv&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">pngname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>
        <span class="n">svgname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">)</span>
        <span class="n">pdfname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span>
        <span class="n">epsname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.eps&#39;</span><span class="p">)</span>

        <span class="n">xx0</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dot -Tsvg  -Gsize=</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">  -o&quot;</span><span class="si">{</span><span class="n">svgname</span><span class="si">}</span><span class="s1">&quot; &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot; -q  </span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span>
                  <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stderr</span>  <span class="c1"># creates the drawing</span>
        <span class="n">xx1</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dot -Tpng  -Gsize=</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">  -Gdpi=300 -o&quot;</span><span class="si">{</span><span class="n">pngname</span><span class="si">}</span><span class="s1">&quot; &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;  </span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span>
                  <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stderr</span>  <span class="c1"># creates the drawing</span>
        <span class="n">xx2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lpdf</span> <span class="ow">or</span> <span class="n">fpdf</span><span class="p">)</span> <span class="k">else</span> <span class="n">run</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;dot -Tpdf  -Gsize=</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">  -o&quot;</span><span class="si">{</span><span class="n">pdfname</span><span class="si">}</span><span class="s1">&quot; &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;  </span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stderr</span>  <span class="c1"># creates the drawing</span>
        <span class="n">xx3</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">leps</span> <span class="k">else</span> <span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dot -Teps  -Gsize=</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">,</span><span class="si">{</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">  -o&quot;</span><span class="si">{</span><span class="n">epsname</span><span class="si">}</span><span class="s1">&quot; &quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&quot;  </span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span>
                                      <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">stderr</span>  <span class="c1"># creates the drawing</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xx0</span><span class="p">,</span> <span class="n">xx1</span><span class="p">,</span> <span class="n">xx2</span><span class="p">,</span> <span class="n">xx3</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Error in generation graph picture:</span><span class="se">\n</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="se">\n</span><span class="s1">Perhaps it is already open - then close the application&#39;</span><span class="p">)</span>
                <span class="c1"># return</span>

        <span class="k">if</span> <span class="n">lpng</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">pngname</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">lpdf</span><span class="p">:</span>
            <span class="n">display</span><span class="p">(</span><span class="n">IFrame</span><span class="p">(</span><span class="n">pdfname</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">SVG</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">svgname</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">display</span><span class="p">(</span><span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">pngname</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">browser</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file://</span><span class="si">{</span><span class="n">svgname</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fpdf</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file://</span><span class="si">{</span><span class="n">pdfname</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
           <span class="c1"># display(IFrame(pdfname,width=500,height=500))</span>
         <span class="c1"># os.system(pdfname)</span>
        <span class="k">return</span></div>
</div>



<div class="viewcode-block" id="Display_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Display_Mixin</span><span class="p">():</span>

<div class="viewcode-block" id="Display_Mixin.vis">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.vis">[docs]</a>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Visualize the data of this model instance </span>
<span class="sd">        if the user has another vis class she can place it in _vis, then that will be used&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_vis&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span> <span class="o">=</span> <span class="n">mv</span><span class="o">.</span><span class="n">vis</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    </div>


<div class="viewcode-block" id="Display_Mixin.varvis">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.varvis">[docs]</a>
    <span class="k">def</span> <span class="nf">varvis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mv</span><span class="o">.</span><span class="n">varvis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Display_Mixin.compvis">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.compvis">[docs]</a>
    <span class="k">def</span> <span class="nf">compvis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mv</span><span class="o">.</span><span class="n">compvis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="Display_Mixin.ibsstyle_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.ibsstyle_old">[docs]</a>
    <span class="k">def</span> <span class="nf">ibsstyle_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">description_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">transpose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Args:</span>
<span class="sd">            df (TYPE): Dataframe.</span>
<span class="sd">            description_dict (TYPE, optional):  Defaults to None then the var_description else this dict .</span>
<span class="sd">            dec (TYPE, optional): decimals. Defaults to 2. Deciu</span>
<span class="sd">            transpose (TYPE, optional): if Trus then rows are time else thje. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TYPE: DESCRIPTION.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_notebook</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">transpose</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">xtranspose</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xtranspose</span> <span class="o">=</span> <span class="n">transpose</span> 
            <span class="n">des</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">description_dict</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">description_dict</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">xtranspose</span><span class="p">:</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">des</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">des</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> 
            <span class="n">xdec</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;{:.&#39;</span><span class="o">+</span><span class="n">xdec</span><span class="o">+</span><span class="s1">&#39;f}&#39;</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">set_tooltips</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;visibility: hidden; position: absolute; z-index: 1; border: 1px solid #000066;&#39;</span>
                            <span class="s1">&#39;background-color: white; color: #000066; font-size: 0.8em;width:100%&#39;</span>
                            <span class="s1">&#39;transform: translate(0px, -24px); padding: 0.6em; border-radius: 0.5em;&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">df</span></div>


    <span class="k">def</span> <span class="nf">ibsstyle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">description_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">transpose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">use_tooltip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">percent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Args:</span>
<span class="sd">            df (TYPE): Dataframe.</span>
<span class="sd">            description_dict (TYPE, optional):  Defaults to None then the var_description else this dict .</span>
<span class="sd">            dec (TYPE, optional): decimals. Defaults to 2. Deciu</span>
<span class="sd">            transpose (TYPE, optional): if Trus then rows are time else thje. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TYPE: DESCRIPTION.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># breakpoint()</span>
        <span class="c1"># breakpoint()    </span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># self.in_notebook():</span>
            <span class="n">des</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">description_dict</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">description_dict</span>
            <span class="n">keys</span><span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">des</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">def</span> <span class="nf">get_des</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">des</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">return</span> <span class="n">des</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>


            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">transpose</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">xtranspose</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xtranspose</span> <span class="o">=</span> <span class="n">transpose</span> 
                
                
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">])</span> <span class="p">:</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">get_des</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">get_des</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> 
            <span class="n">xdec</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">xpct</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span> <span class="k">if</span> <span class="n">percent</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span>\
            <span class="o">.</span><span class="n">set_sticky</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">set_sticky</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s1">&#39;class=&quot;table&quot;&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;{:,.&#39;</span><span class="o">+</span><span class="n">xdec</span><span class="o">+</span><span class="s1">&#39;f}&#39;</span><span class="o">+</span><span class="n">xpct</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">use_tooltip</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">set_tooltips</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;visibility: hidden; position: absolute; z-index: 1; border: 1px solid #000066;&#39;</span>
                                    <span class="s1">&#39;background-color: white; color: #000066; font-size: 0.8em;width:100%&#39;</span>
                                    <span class="s1">&#39;transform: translate(0px, -24px); padding: 0.6em; border-radius: 0.5em;&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="o">...</span>
                
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="Display_Mixin.ibsstyle">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.ibsstyle">[docs]</a>
    <span class="k">def</span> <span class="nf">ibsstyle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">description_dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">transpose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">use_tooltip</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">percent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Args:</span>
<span class="sd">            df (TYPE): Dataframe.</span>
<span class="sd">            description_dict (TYPE, optional):  Defaults to None then the var_description else this dict .</span>
<span class="sd">            dec (TYPE, optional): decimals. Defaults to 2. Deciu</span>
<span class="sd">            transpose (TYPE, optional): if Trus then rows are time else thje. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TYPE: DESCRIPTION.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># breakpoint()</span>
        <span class="c1"># breakpoint()    </span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span> <span class="c1"># self.in_notebook():</span>
            <span class="n">des</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">description_dict</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">description_dict</span>
            <span class="n">keys</span><span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">des</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">def</span> <span class="nf">get_des</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="ow">and</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">des</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">return</span> <span class="n">des</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>


            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">transpose</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                <span class="n">xtranspose</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xtranspose</span> <span class="o">=</span> <span class="n">transpose</span> 
                
                
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">])</span> <span class="p">:</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">get_des</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([[</span><span class="n">get_des</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> 
            <span class="n">xdec</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dec</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">xpct</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span> <span class="k">if</span> <span class="n">percent</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">styles</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;.row_heading, .corner&#39;</span><span class="p">,</span>
             <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;sticky&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)]},</span>
            <span class="p">{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;.col_heading&#39;</span><span class="p">,</span>
             <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;sticky&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span> <span class="s1">&#39;white&#39;</span><span class="p">)]}</span>
              <span class="p">]</span>
            
            <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span><span class="n">styles</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;{:,.&#39;</span><span class="o">+</span><span class="n">xdec</span><span class="o">+</span><span class="s1">&#39;f}&#39;</span><span class="o">+</span><span class="n">xpct</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">use_tooltip</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">set_tooltips</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="s1">&#39;visibility: hidden; position: absolute; z-index: 1; border: 1px solid #000066;&#39;</span>
                                    <span class="s1">&#39;background-color: white; color: #000066; font-size: 0.8em;width:100%&#39;</span>
                                    <span class="s1">&#39;transform: translate(0px, -24px); padding: 0.6em; border-radius: 0.5em;&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="o">...</span>
                
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="n">df</span></div>

    
<div class="viewcode-block" id="Display_Mixin.compstyle">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.compstyle">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compstyle</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        returns a styled dataframe of complex numners </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : dataframe .</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="s1">&#39; &#39;</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.00000000001</span> <span class="k">else</span> 
                    <span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">real</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">imag</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> ~ </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">))</span>   
        <span class="k">return</span> <span class="n">out</span> </div>

     


<span class="c1">##xx = mpak.ibsstyle(mpak.get_att_pct(&#39;PAKNYGDPMKTPKN&#39;,lag=True,threshold=0),dec=0,percent=1)       </span>
 <span class="c1">##display(HTML(&quot;&lt;div style=&#39;min-width: 80%; max-width: 600%; width: 600%; overflow: auto;&#39;&gt;&quot; +</span>
             <span class="c1"># xx.to_html() +</span>
             <span class="c1"># &quot;&lt;/div&gt;&quot;))</span>

<div class="viewcode-block" id="Display_Mixin.write_eq">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.write_eq">[docs]</a>
    <span class="k">def</span> <span class="nf">write_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;My_model.fru&#39;</span><span class="p">,</span> <span class="n">lf</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; writes the formulas to file, can be input into model </span>

<span class="sd">        lf=True -&gt; new lines are put after each frml &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">outfrml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="s1">&#39;$</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">lf</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations</span>

            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfrml</span><span class="p">)</span></div>


<div class="viewcode-block" id="Display_Mixin.print_eq">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.print_eq">[docs]</a>
    <span class="k">def</span> <span class="nf">print_eq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1">#from pandabank import get_var</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Print all variables that determines input variable (varnavn)</span>
<span class="sd">        optional -- enter period and databank to get var values for chosen period&#39;&#39;&#39;</span>
        <span class="n">print_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">minliste</span> <span class="o">=</span> <span class="p">[(</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:50}{1:&gt;5}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Variabel&#39;</span><span class="p">,</span> <span class="s1">&#39;Lag&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:&gt;20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">per</span><span class="p">))</span> <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">print_per</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">minliste</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">minliste</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">endoexo</span> <span class="o">=</span> <span class="s1">&#39;E&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;X&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">endoexo</span><span class="o">+</span><span class="s1">&#39;: </span><span class="si">{0:50}{1:&gt;5}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:&gt;20.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">per</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">lag</span><span class="p">),</span> <span class="n">var</span><span class="p">])</span> <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">print_per</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Display_Mixin.print_eq_values">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.print_eq_values">[docs]</a>
    <span class="k">def</span> <span class="nf">print_eq_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">databank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; for an endogeneous variable, this function prints out the frml and input variale</span>
<span class="sd">        for each periode in the current_per. </span>
<span class="sd">        The function takes special acount of dataframes and series &#39;&#39;&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eq_values</span><span class="p">(</span>
            <span class="n">varname</span><span class="p">,</span> <span class="n">showvar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">databank</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="n">per</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">varlist</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculations of </span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varname</span><span class="p">][</span><span class="s2">&quot;frml&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">Looking at period:</span><span class="si">{</span><span class="n">per</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">varlist</span><span class="p">:</span>
                    <span class="n">this</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">per</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
                        <span class="n">vv</span> <span class="o">=</span> <span class="n">this</span> <span class="k">if</span> <span class="nb">all</span> <span class="k">else</span> <span class="n">this</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">this</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">this</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
                        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">: </span><span class="si">{</span><span class="n">v</span><span class="si">:{</span><span class="n">maxlen</span><span class="si">}}</span><span class="s1"> = </span><span class="se">\n</span><span class="si">{</span><span class="n">vv</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
                        <span class="n">ff</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                        <span class="n">vv</span> <span class="o">=</span> <span class="n">ff</span> <span class="k">if</span> <span class="nb">all</span> <span class="k">else</span> <span class="n">ff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ff</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">v</span><span class="si">:{</span><span class="n">maxlen</span><span class="si">}}</span><span class="s1"> = </span><span class="se">\n</span><span class="si">{</span><span class="n">ff</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">v</span><span class="si">:{</span><span class="n">maxlen</span><span class="si">}}</span><span class="s1"> = </span><span class="si">{</span><span class="n">this</span><span class="si">:</span><span class="s1">&gt;20</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="k">if</span> <span class="n">lprint</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Display_Mixin.print_all_eq_values">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.print_all_eq_values">[docs]</a>
    <span class="k">def</span> <span class="nf">print_all_eq_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_eq_values</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span></div>


<div class="viewcode-block" id="Display_Mixin.print_eq_mul">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.print_eq_mul">[docs]</a>
    <span class="k">def</span> <span class="nf">print_eq_mul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varnavn</span><span class="p">,</span> <span class="n">grund</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">impact</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#from pandabank import get_var</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Print all variables that determines input variable (varnavn)</span>
<span class="sd">          optional -- enter period and databank to get var values for chosen period&#39;&#39;&#39;</span>
        <span class="n">grund</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="n">minliste</span> <span class="o">=</span> <span class="p">[[</span><span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">var</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnavn</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:50}{1:&gt;5}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Variabel&#39;</span><span class="p">,</span> <span class="s1">&#39;Lag&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">grund</span><span class="o">.</span><span class="n">current_per</span><span class="p">:</span>
            <span class="n">per</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">per</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&gt;20}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">per</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">mul</span><span class="o">.</span><span class="n">data</span><span class="o">-</span><span class="n">grund</span><span class="o">.</span><span class="n">data</span>
        <span class="n">endo</span> <span class="o">=</span> <span class="n">minliste</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">minliste</span><span class="p">:</span>
            <span class="n">target_column</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:50}{1:&gt;5}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">per</span> <span class="ow">in</span> <span class="n">grund</span><span class="o">.</span><span class="n">current_per</span><span class="p">:</span>
                <span class="n">target_index</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">tal</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">target_index</span><span class="p">,</span> <span class="n">target_column</span><span class="p">]</span>
                <span class="n">tal2</span> <span class="o">=</span> <span class="n">tal</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">diffvalue_d3d</span> <span class="k">if</span> <span class="n">impact</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:&gt;20.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tal2</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Display_Mixin.print_all_equations">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.print_all_equations">[docs]</a>
    <span class="k">def</span> <span class="nf">print_all_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputdata</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Print values and formulas for alle equations in the model, based input database and period \n</span>
<span class="sd">        Example: stress.print_all_equations(bankdata,&#39;2013Q3&#39;)&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">:</span>
            <span class="c1"># if var.find(&#39;DANSKE&#39;)&lt;&gt;-2:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">print_eq</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">inputdata</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="Display_Mixin.print_lister">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.print_lister">[docs]</a>
    <span class="k">def</span> <span class="nf">print_lister</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; prints the lists used in defining the model &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lister</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lister</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
                      <span class="p">[</span><span class="n">xx</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lister</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]])</span></div>


   

<div class="viewcode-block" id="Display_Mixin.keep_print">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_print">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; prints variables from experiments look at keep_get_dict for options</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_get_dict</span><span class="p">(</span>
                <span class="n">pat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_ofset</span><span class="p">,</span> <span class="n">end_ofset</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">outdf</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Variable </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> Difference to first column&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Variable </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">outdf</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no keept solutions&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Display_Mixin.keep_get_df">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_get_df">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_get_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No keept solutions&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">allvars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">c</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="n">allvars</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
            <span class="n">outv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">solution</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">solver</span><span class="p">,</span> <span class="n">solution</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outv</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outv</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="s1">&#39;Experiment&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

    
    <span class="c1"># def var_get_df(self, pat=&#39;*&#39;, start=&#39;&#39;, end=&#39;&#39;, start_ofset=0, end_ofset=0):</span>
    <span class="c1">#     varlist  = self.vlist(pat)</span>
    <span class="c1">#     res = {}</span>
    <span class="c1">#     with self.set_smpl(start, end) as a, self.set_smpl_relative(start_ofset, end_ofset):res = []</span>
    <span class="c1">#         res[&#39;basedf&#39;] = self.basedf.loc[self.current_per,varlist]</span>
    <span class="c1">#         res[&#39;lastdf&#39;] = self.lastdf.loc[self.current_per,varlist]</span>
    <span class="c1">#     return out</span>

<div class="viewcode-block" id="Display_Mixin.keep_var_dict">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_var_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_var_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">trans</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Returns a dict of the keept experiments. Key is the scrnario names, values are a dataframe with  values for each variable</span>



<span class="sd">        Args:</span>
<span class="sd">            pat (TYPE, optional): variable selection. Defaults to &#39;*&#39;.</span>
<span class="sd">            start (TYPE, optional): start period. Defaults to &#39;&#39;.</span>
<span class="sd">            end (TYPE, optional): end period. Defaults to &#39;&#39;.</span>
<span class="sd">            start_ofset (TYPE, optional): start ofset period. Defaults to 0.</span>
<span class="sd">            end_ofset (TYPE, optional): end ofste period. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            res (dictionary): a dict with a dataframe for each experiment </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No keept solutions&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">allvars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">c</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist_names</span><span class="p">(</span><span class="n">allvars</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl_relative</span><span class="p">(</span><span class="n">start_ofset</span><span class="p">,</span> <span class="n">end_ofset</span><span class="p">):</span>
            <span class="c1"># print(f&#39;{self.current_per[-1]=}&#39;)</span>
            <span class="k">for</span> <span class="n">solver</span><span class="p">,</span> <span class="n">solution</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">outv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">solution</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span> <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trans</span><span class="p">:</span> 
                    <span class="n">outv</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span>  <span class="ow">in</span> <span class="nb">vars</span><span class="p">]</span>
                <span class="n">outv</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Variable&#39;</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="n">solver</span><span class="p">]</span> <span class="o">=</span> <span class="n">outv</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Display_Mixin.keep_get_dict">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_get_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_get_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">trans</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Returns a dict of the keept experiments. Key is the variable names, values are a dataframe with variable values for each experiment</span>



<span class="sd">        Args:</span>
<span class="sd">            pat (TYPE, optional): variable selection. Defaults to &#39;*&#39;.</span>
<span class="sd">            start (TYPE, optional): start period. Defaults to &#39;&#39;.</span>
<span class="sd">            end (TYPE, optional): end period. Defaults to &#39;&#39;.</span>
<span class="sd">            start_ofset (TYPE, optional): start ofset period. Defaults to 0.</span>
<span class="sd">            end_ofset (TYPE, optional): end ofste period. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            res (dictionary): a dict with a dataframe for each experiment </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No keept solutions&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">allvars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">c</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">})</span>
        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist_names</span><span class="p">(</span><span class="n">allvars</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl_relative</span><span class="p">(</span><span class="n">start_ofset</span><span class="p">,</span> <span class="n">end_ofset</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
                <span class="c1"># print(f&#39;{v=}&#39;)</span>
                <span class="n">outv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">solution</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">solver</span><span class="p">,</span> <span class="n">solution</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">outv</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">outv</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Experiment&#39;</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">outv</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                    <span class="n">outv</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">diff</span> <span class="k">else</span> <span class="n">outv</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Display_Mixin.keep_get_plotdict">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_get_plotdict">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_get_plotdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                          <span class="n">showtype</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span>
                   <span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">diffpct</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">by_var</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            returns </span>
<span class="sd">            - a dict of {variable in pat :dfs scenarios as columnns } if by_var = 1</span>
<span class="sd">            - a dict of {scenarios       :dfs with variables in pat as columnns } if by_var = 1</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                pat (string, optional): Variable selection. Defaults to &#39;*&#39;.</span>
<span class="sd">                start (TYPE, optional): start periode. Defaults to &#39;&#39;.</span>
<span class="sd">                end (TYPE, optional): end periode. Defaults to &#39;&#39;.</span>
<span class="sd">                showtype (str, optional): &#39;level&#39;,&#39;growth&#39; or change&#39; transformation of data. Defaults to &#39;level&#39;.</span>
<span class="sd">                diff (Logical, optional): if True shows the difference to the</span>
<span class="sd">                                          first experiment or the first scenario. Defaults to False.</span>
<span class="sd">                diffpct (logical,optional) : if True shows the difference in percent instead of level</span>
<span class="sd">                mul (float, optional): multiplier of data. Defaults to 1.0.</span>
<span class="sd">                </span>
<span class="sd">            Returns:</span>
<span class="sd">                figs :a dict with data</span>
<span class="sd">    &quot;&quot;&quot;</span>
            <span class="c1"># breakpoint()</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="ow">and</span> <span class="n">diffpct</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;keep_plot can&#39;t be called with both diff and diffpct&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">by_var</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_get_dict</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_ofset</span><span class="p">,</span> <span class="n">end_ofset</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_var_dict</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_ofset</span><span class="p">,</span> <span class="n">end_ofset</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">showtype</span> <span class="o">==</span> <span class="s1">&#39;growth&#39;</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">vdf</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">*</span><span class="mf">100.</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
            <span class="k">elif</span> <span class="n">showtype</span> <span class="o">==</span> <span class="s1">&#39;change&#39;</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">vdf</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
            <span class="k">else</span><span class="p">:</span>
                <span class="o">...</span> 
            
            <span class="k">if</span> <span class="n">by_var</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">vdf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                        <span class="n">vdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>  <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">elif</span> <span class="n">diffpct</span><span class="p">:</span> 
                    <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span>  <span class="p">(</span><span class="n">vdf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                        <span class="n">vdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                        <span class="n">vdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>  <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                   
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dfsres</span> <span class="o">=</span> <span class="n">dfs</span>
            <span class="k">else</span><span class="p">:</span>          
               <span class="n">first_scenario</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
               <span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
                   <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">vdf</span> <span class="o">-</span> <span class="n">first_scenario</span> 
                        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">v</span><span class="p">,</span> <span class="n">vdf</span><span class="p">)</span>  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>  <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">}</span>
               <span class="k">elif</span> <span class="n">diffpct</span><span class="p">:</span> 
                   <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span>  <span class="p">(</span><span class="n">vdf</span><span class="o">/</span><span class="n">first_scenario</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">v</span><span class="p">,</span> <span class="n">vdf</span><span class="p">)</span>  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">}</span>
                  
               <span class="k">else</span><span class="p">:</span>
                   <span class="n">dfsres</span> <span class="o">=</span> <span class="n">dfs</span>
                   
            <span class="k">assert</span> <span class="ow">not</span><span class="p">(</span><span class="n">diff</span> <span class="ow">and</span> <span class="n">diffpct</span><span class="p">)</span> <span class="p">,</span><span class="s2">&quot;keep_plot can&#39;t be called with both diff and diffpct&quot;</span>
     
            <span class="k">return</span> <span class="n">dfsres</span></div>

    
          
<div class="viewcode-block" id="Display_Mixin.keep_get_plotdict_new">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_get_plotdict_new">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_get_plotdict_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                          <span class="n">showtype</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span><span class="n">diftype</span><span class="o">=</span><span class="s1">&#39;nodif&#39;</span><span class="p">,</span> <span class="n">by_var</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            returns </span>
<span class="sd">            - a dict of {variable in pat :dfs scenarios as columnns } if by_var = 1</span>
<span class="sd">            - a dict of {scenarios       :dfs with variables in pat as columnns } if by_var = 0</span>
<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                pat (string, optional): Variable selection. Defaults to &#39;*&#39;.</span>
<span class="sd">                start (TYPE, optional): start periode. Defaults to &#39;&#39;.</span>
<span class="sd">                end (TYPE, optional): end periode. Defaults to &#39;&#39;.</span>
<span class="sd">                start_ofset (integer,optional ): relativ start ofset </span>
<span class="sd">                end_ofset (integer,optional ): relativ end ofset                 </span>
<span class="sd">                showtype (str, optional): &#39;level&#39;,&#39;growth&#39;, &#39;gdppct&#39; or change&#39; transformation of data. Defaults to &#39;level&#39;.</span>
<span class="sd">                diftype (str, optional): &#39;nodif&#39;,&#39;dif&#39; or &#39;difpct&#39; transformation of data. </span>
<span class="sd">                </span>
<span class="sd">    &quot;&quot;&quot;</span>
            <span class="c1"># breakpoint()</span>
            <span class="k">if</span> <span class="n">showtype</span> <span class="o">==</span> <span class="s1">&#39;growth&#39;</span><span class="p">:</span>
                <span class="n">start_ofset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_ofset</span> <span class="o">=</span> <span class="mi">0</span> 
                
            <span class="k">if</span> <span class="n">by_var</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_get_dict</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_ofset</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">dfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_var_dict</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_ofset</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                
            <span class="k">if</span> <span class="n">showtype</span> <span class="o">==</span> <span class="s1">&#39;growth&#39;</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">vdf</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span><span class="o">*</span><span class="mf">100.</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="k">elif</span> <span class="n">showtype</span> <span class="o">==</span>  <span class="s1">&#39;qoq_ar&#39;</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">((</span><span class="mf">1.</span><span class="o">+</span><span class="n">vdf</span><span class="o">.</span><span class="n">pct_change</span><span class="p">())</span><span class="o">**</span><span class="mf">4.</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        
            <span class="k">elif</span> <span class="n">showtype</span> <span class="o">==</span> <span class="s1">&#39;change&#39;</span><span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">vdf</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

            <span class="k">elif</span> <span class="n">showtype</span> <span class="ow">in</span>  <span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span>  <span class="p">:</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="n">dfs</span> 
        
            <span class="k">elif</span> <span class="n">showtype</span> <span class="o">==</span>  <span class="s1">&#39;gdppct&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">by_var</span><span class="p">:</span> 
                    <span class="n">linevars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">gdpvars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">findgdpvar</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">linevars</span><span class="p">]</span>
                    <span class="n">dfgdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_get_dict</span><span class="p">(</span><span class="n">gdpvars</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_ofset</span><span class="p">,</span><span class="n">trans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">denominvalues</span>    <span class="o">=</span> <span class="p">[</span><span class="n">dfgdp</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">gdpvars</span> <span class="p">]</span>

                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">firstdf</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                    <span class="n">linevars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">firstdf</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                    <span class="n">gdpvars</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">findgdpvar</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">linevars</span><span class="p">]</span>
                    <span class="n">dfgdp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_var_dict</span><span class="p">(</span><span class="n">gdpvars</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">start_ofset</span><span class="p">,</span><span class="n">trans</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">denominvalues</span>    <span class="o">=</span> <span class="p">[</span><span class="n">df</span>  <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfgdp</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">]</span>

                <span class="n">nummeratorvalues</span> <span class="o">=</span> <span class="p">[</span><span class="n">df</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">]</span>
                <span class="n">in_percent</span>       <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">values</span><span class="o">/</span> <span class="n">d</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> 
                                    <span class="n">n</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nummeratorvalues</span><span class="p">,</span><span class="n">denominvalues</span><span class="p">)]</span> 
                <span class="n">indexnames</span>       <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">]</span>
                <span class="n">colnames</span>         <span class="o">=</span> <span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">]</span>
                <span class="n">dfs</span> <span class="o">=</span> <span class="p">{</span> <span class="n">v</span><span class="p">:</span>  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_percent</span><span class="p">,</span><span class="n">indexnames</span><span class="p">,</span><span class="n">colnames</span><span class="p">,</span><span class="n">dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)}</span>
                    

        
        
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Wrong showtype in keep_get&#39;</span><span class="p">)</span> 
            
            <span class="k">if</span> <span class="n">by_var</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">diftype</span> <span class="o">==</span> <span class="s1">&#39;dif&#39;</span><span class="p">:</span>
                    <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">vdf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                        <span class="n">vdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>  <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">elif</span> <span class="n">diftype</span> <span class="o">==</span> <span class="s1">&#39;difpct&#39;</span><span class="p">:</span> 
                    <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span>  <span class="p">(</span><span class="n">vdf</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                        <span class="n">vdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
                        <span class="n">vdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>  <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">vdf</span> <span class="ow">in</span> <span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">elif</span> <span class="n">diftype</span> <span class="ow">in</span>  <span class="p">[</span><span class="s1">&#39;nodif&#39;</span><span class="p">,</span> <span class="s1">&#39;basedf&#39;</span><span class="p">,</span> <span class="s1">&#39;lastdf&#39;</span><span class="p">]:</span>  <span class="c1"># for use in tabledf</span>
                     <span class="n">dfsres</span> <span class="o">=</span> <span class="n">dfs</span>
 
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Wrong diftype in keep_get-&#39;</span><span class="p">)</span> 

            <span class="k">else</span><span class="p">:</span>          
               <span class="n">first_scenario</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>
               <span class="k">if</span> <span class="n">diftype</span> <span class="o">==</span> <span class="s1">&#39;dif&#39;</span><span class="p">:</span>
                   <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">vdf</span> <span class="o">-</span> <span class="n">first_scenario</span> 
                        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">v</span><span class="p">,</span> <span class="n">vdf</span><span class="p">)</span>  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>  <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">}</span>
               <span class="k">elif</span> <span class="n">diftype</span> <span class="o">==</span> <span class="s1">&#39;difpct&#39;</span><span class="p">:</span> 
                   <span class="n">dfsres</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span>  <span class="p">(</span><span class="n">vdf</span><span class="o">/</span><span class="n">first_scenario</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">v</span><span class="p">,</span> <span class="n">vdf</span><span class="p">)</span>  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">}</span>
               <span class="k">elif</span> <span class="n">diftype</span> <span class="o">==</span> <span class="n">diftype</span> <span class="ow">in</span>   <span class="p">[</span><span class="s1">&#39;nodif&#39;</span><span class="p">,</span> <span class="s1">&#39;basedf&#39;</span><span class="p">,</span> <span class="s1">&#39;lastdf&#39;</span><span class="p">]:</span>  <span class="c1"># for use in tabledf</span>
                     <span class="n">dfsres</span> <span class="o">=</span> <span class="n">dfs</span>
 
               <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Wrong diftype in keep_get-&#39;</span><span class="p">)</span> 
                   
     
            <span class="k">return</span> <span class="n">dfsres</span></div>

    
<div class="viewcode-block" id="Display_Mixin.findgdpvar">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.findgdpvar">[docs]</a>
    <span class="k">def</span> <span class="nf">findgdpvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">varname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Find matching  GDP variable - for worldbank models </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">gdpname</span> <span class="o">=</span> <span class="n">varname</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;NYGDPMKTP&#39;</span><span class="o">+</span><span class="n">varname</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">gdpname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="p">:</span> 
            <span class="k">return</span> <span class="n">gdpname</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s2"> don&#39;t have a matching GDP variable &quot;</span><span class="p">)</span></div>

    
    

<div class="viewcode-block" id="Display_Mixin.inputwidget">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.inputwidget">[docs]</a>
    <span class="k">def</span> <span class="nf">inputwidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">basedf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; calls modeljupyter input widget, and keeps the period scope &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">basedf</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mj</span><span class="o">.</span><span class="n">inputwidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tempdf</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">basedf</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span> <span class="o">=</span> <span class="n">tempdf</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mj</span><span class="o">.</span><span class="n">inputwidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    
<div class="viewcode-block" id="Display_Mixin.plot_basis">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.plot_basis">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_basis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="p">{},</span> <span class="n">dec</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span><span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ibs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;self&#39;</span><span class="p">}}</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="c1"># print(ibs)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_basis_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="o">**</span><span class="n">ibs</span><span class="p">)</span>
        <span class="c1"># fig.suptitle(suptitle, fontsize=16)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    
<div class="viewcode-block" id="Display_Mixin.plot_basis_ax">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.plot_basis_ax">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_basis_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">var</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">ax_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="n">suptitle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="p">{},</span> <span class="n">dec</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">yunit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span><span class="n">samefig</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
        <span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
        <span class="kn">import</span> <span class="nn">matplotlib.cbook</span> <span class="k">as</span> <span class="nn">cbook</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="kn">from</span> <span class="nn">modelhelp</span> <span class="kn">import</span> <span class="n">finddec</span>
        <span class="c1"># print(f&#39;{legend=}&#39;)</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">()</span>   <span class="c1"># every year</span>
        <span class="n">months</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MonthLocator</span><span class="p">()</span>  <span class="c1"># every month</span>
        <span class="n">years_fmt</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%Y&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;int64&#39;</span><span class="p">:</span>
            <span class="n">fmtr</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">StrMethodFormatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{x:.0f}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">fmtr</span><span class="p">)</span>

        <span class="n">this_title</span> <span class="o">=</span> <span class="n">ax_title</span> <span class="k">if</span> <span class="n">ax_title</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">trans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">var</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">this_title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">index_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">xlabel__</span> <span class="o">=</span> <span class="n">xlabel</span> <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">or</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1">#df.set_index(pd.date_range(&#39;2020-1-1&#39;,periods = index_len,freq = &#39;q&#39;))</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">-1-1&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">index_len</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">years</span><span class="p">)</span>

        <span class="c1"># df.index = [20 + i for i in range(index_len)]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">xval</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">xval</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>


        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;line&#39;</span><span class="p">:</span>    
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]):</span>
                <span class="n">yval</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xval</span><span class="p">,</span> <span class="n">yval</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">legend</span><span class="p">:</span>
                        <span class="n">x_pos</span> <span class="o">=</span> <span class="n">xval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">yval</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar_stacked&#39;</span><span class="p">:</span>   
            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span>   
            <span class="n">df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error illegal kind:</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            
            
        <span class="k">if</span> <span class="n">legend</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">samefig</span><span class="p">:</span> 
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="c1"># ax.xaxis.set_minor_locator(ticker.MultipleLocator(years))</span>
        <span class="c1"># breakpoint()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xlabel__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ylabel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                      <span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;baseline&#39;</span><span class="p">)</span>
        <span class="n">xdec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span> <span class="k">if</span> <span class="n">dec</span> <span class="k">else</span> <span class="n">finddec</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">number</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s1">,.</span><span class="si">{</span><span class="n">xdec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">yunit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">()</span>
            <span class="n">formatter</span><span class="o">.</span><span class="n">set_scientific</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax</span></div>

    
<div class="viewcode-block" id="Display_Mixin.savefigs">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.savefigs">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">savefigs</span><span class="p">(</span><span class="n">figs</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;./graph&#39;</span><span class="p">,</span> <span class="n">experimentname</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;experiment1&#39;</span><span class="p">,</span> <span class="n">addname</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;svg&#39;</span><span class="p">],</span> <span class="n">xopen</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves a collection of matplotlib figures to a specified directory.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - figs (dict): A dictionary of matplotlib figures where the key is the figure name.</span>
<span class="sd">        - location (str): The base folder in which to save the charts. Defaults to &#39;./graph&#39;.</span>
<span class="sd">        - experimentname (str): A subfolder under &#39;location&#39; where charts are saved. Defaults to &#39;experiment1&#39;.</span>
<span class="sd">        - addname (str): An additional name added to each figure filename. Defaults to an empty string.</span>
<span class="sd">        - extensions (list): A list of string file extensions for saving the figures. Defaults to [&#39;svg&#39;].</span>
<span class="sd">        - xopen (bool): If True, open the saved figure locations in a web browser.</span>

<span class="sd">        Returns:</span>
<span class="sd">        str: The absolute path to the folder where figures are saved.</span>

<span class="sd">        Raises:</span>
<span class="sd">        Exception: If the folder cannot be created or a figure cannot be saved/opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">/</span> <span class="n">experimentname</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">folder</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;!!!Can&#39;t create folder: </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">variable</span><span class="si">}{</span><span class="n">addname</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">/</span> <span class="n">filename</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">xopen</span><span class="p">:</span>
                        <span class="n">wb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file://</span><span class="si">{</span><span class="n">file_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;!!!Can&#39;t save/open file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xopen</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file://</span><span class="si">{</span><span class="n">folder</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Saved at: </span><span class="si">{</span><span class="n">folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span></div>


        
    
 

        
<div class="viewcode-block" id="Display_Mixin.keep_plot">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">start_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end_ofset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">showtype</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span>
          <span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">diffpct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Scenarios&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
          <span class="n">yunit</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">showfig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
          <span class="n">vline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">by_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">samefig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">         </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate and display plots for specified scenarios and variables.</span>

<span class="sd">    Args:</span>
<span class="sd">        pat (str, optional): Pattern to select variables for plotting. Defaults to &#39;*&#39;.</span>
<span class="sd">        start (str, optional): Start period for the plot. Defaults to &#39;&#39; .</span>
<span class="sd">        end (str, optional): End period for the plot. Defaults to &#39;&#39; .</span>
<span class="sd">        start_ofset (int, optional): Offset to shift the start period, relative to current. Defaults to 0.</span>
<span class="sd">        end_ofset (int, optional): Offset to shift the end period, relative to current. Defaults to 0.</span>
<span class="sd">        showtype (str, optional): Type of data transformation for plotting (&#39;level&#39;, &#39;growth&#39;, &#39;change&#39;). Defaults to &#39;level&#39;.</span>
<span class="sd">        diff (bool, optional): If True, shows the difference relative to the first experiment. Defaults to False.</span>
<span class="sd">        diffpct (bool, optional): If True, shows the percentage difference relative to the first experiment. Defaults to False.</span>
<span class="sd">        mul (float, optional): Multiplier to scale the data. Defaults to 1.0.</span>
<span class="sd">        title (str, optional): Title of the plot. Defaults to &#39;Scenarios&#39;.</span>
<span class="sd">        legend (bool, optional): If True, displays a legend. Defaults to False.</span>
<span class="sd">        scale (str, optional): Y-axis scale (&#39;linear&#39; or &#39;log&#39;). Defaults to &#39;linear&#39;.</span>
<span class="sd">        yunit (str, optional): Units for the Y-axis. Defaults to &#39;&#39;.</span>
<span class="sd">        ylabel (str, optional): Label for the Y-axis. Defaults to &#39;&#39;.</span>
<span class="sd">        dec (str, optional): String format for decimal places. If &#39;&#39; then automatically determined. Defaults to &#39;&#39;.</span>
<span class="sd">        trans (dict, optional): Alternative dictionary for translating variable names to desciptions. Defaults to None.</span>
<span class="sd">        showfig (bool, optional): If True, displays the figure. Defaults to True.</span>
<span class="sd">        kind (str, optional): Type of plot (&#39;line&#39;, &#39;bar&#39;, etc.). Defaults to &#39;line&#39;.</span>
<span class="sd">        size (tuple, optional): Figure size as (width, height). Defaults to (10, 6).</span>
<span class="sd">        vline (list, optional): List of tuples (time, text) for vertical lines in the plot. vline is persistent, to reset vline=None. Defaults to an empty list.</span>
<span class="sd">        by_var (bool, optional): If True, each line represents a scenario, else each line represents a variable. Defaults to True.</span>
<span class="sd">        dataonly (bool, optional): If True, only the dataframes are returned, no plot is generated. Defaults to False.</span>
<span class="sd">        samefig (bool, optional): If True, all plots are displayed in the same figure. Defaults to False.</span>
<span class="sd">        ncol (int, optional): Number of columns for subplots when using samefig. Defaults to 2.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary of Matplotlib figures, with keys being the variable names and values being the figure objects.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ZeroDivisionError: If no kept solution is available for plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Function implementation...</span>

    <span class="c1"># Function implementation...</span>

         <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
         <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span> 

        <span class="c1"># print(f&#39;{self.current_per[-1]=}&#39;)</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No keept solution&#39;</span><span class="p">)</span>
            
         <span class="n">dfsres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_get_plotdict</span><span class="p">(</span><span class="n">pat</span><span class="o">=</span><span class="n">pat</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> 
                              <span class="n">start_ofset</span> <span class="o">=</span> <span class="n">start_ofset</span><span class="p">,</span> <span class="n">end_ofset</span> <span class="o">=</span> <span class="n">end_ofset</span><span class="p">,</span> 
                                <span class="n">showtype</span><span class="o">=</span><span class="n">showtype</span><span class="p">,</span>
                         <span class="n">diff</span><span class="o">=</span><span class="n">diff</span><span class="p">,</span> <span class="n">diffpct</span> <span class="o">=</span> <span class="n">diffpct</span><span class="p">,</span> <span class="n">by_var</span><span class="o">=</span><span class="n">by_var</span><span class="p">)</span>
    
         
         <span class="k">if</span> <span class="n">dataonly</span><span class="p">:</span> 
             <span class="k">return</span> <span class="n">dfsres</span>
         
         <span class="n">aspct</span> <span class="o">=</span> <span class="s1">&#39; as pct &#39;</span> <span class="k">if</span> <span class="n">diffpct</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
         <span class="n">dftype</span> <span class="o">=</span> <span class="n">showtype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>

         <span class="n">xtrans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">trans</span> 
         <span class="n">number</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">dfsres</span><span class="p">)</span>
        
         <span class="k">if</span> <span class="n">samefig</span><span class="p">:</span>
             <span class="o">...</span>
             <span class="n">xcol</span> <span class="o">=</span> <span class="n">ncol</span> 
             <span class="n">xrow</span><span class="o">=-</span><span class="p">((</span><span class="o">-</span><span class="n">number</span> <span class="p">)</span><span class="o">//</span><span class="n">ncol</span><span class="p">)</span>
             <span class="n">figsize</span> <span class="o">=</span>  <span class="p">(</span><span class="n">xcol</span><span class="o">*</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xrow</span><span class="o">*</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
             <span class="c1"># print(f&#39;{size=}  {figsize=}&#39;)</span>
             <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
             <span class="c1">#gs = gridspec.GridSpec(xrow + 1, xcol, figure=fig)  # One additional row for the legend</span>
             <span class="n">row_heights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xrow</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span>  <span class="c1"># Assuming equal height for all plot rows, and half for the legend</span>
             <span class="k">if</span> <span class="n">legend</span><span class="p">:</span> 
                 <span class="n">row_heights</span> <span class="o">=</span> <span class="n">row_heights</span><span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span>
                 <span class="n">extra_row</span> <span class="o">=</span> <span class="mi">1</span> 
                 <span class="n">row_heights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xrow</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span>  <span class="c1"># Assuming equal height for all plot rows, and half for the legend</span>

             <span class="k">else</span><span class="p">:</span> 
                 <span class="n">extra_row</span> <span class="o">=</span> <span class="mi">0</span> 
                 <span class="n">row_heights</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xrow</span>  <span class="c1"># Assuming equal height for all plot rows,</span>

                 
             <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">xrow</span> <span class="o">+</span> <span class="n">extra_row</span> <span class="p">,</span> <span class="n">xcol</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">height_ratios</span><span class="o">=</span><span class="n">row_heights</span><span class="p">)</span>

             <span class="n">fig</span><span class="o">.</span><span class="n">set_constrained_layout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create axes for the plots</span>
             <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xrow</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xcol</span><span class="p">)]</span>
             <span class="k">if</span> <span class="n">legend</span><span class="p">:</span> 
                 <span class="n">legend_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>  <span class="c1"># Span the legend axis across the bottom</span>
             
             <span class="n">figs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;onefig&#39;</span> <span class="p">:</span> <span class="n">fig</span><span class="p">}</span>

         <span class="k">else</span><span class="p">:</span>
             <span class="o">...</span> 
             <span class="n">figs_and_ax</span>  <span class="o">=</span> <span class="p">{</span><span class="n">v</span> <span class="p">:</span>  <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span>  <span class="ow">in</span> <span class="n">dfsres</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
             <span class="n">figs</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span> <span class="p">:</span> <span class="n">fig</span> <span class="k">for</span> <span class="n">v</span><span class="p">,(</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="p">)</span>   <span class="ow">in</span> <span class="n">figs_and_ax</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span> 
             <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>    <span class="n">ax</span>  <span class="k">for</span> <span class="n">fig</span><span class="p">,</span><span class="n">ax</span>    <span class="ow">in</span> <span class="n">figs_and_ax</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">]</span> 
         
         
         <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">v</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dfsres</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
              <span class="n">ax_title</span><span class="o">=</span>  <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Difference</span><span class="si">{</span><span class="n">aspct</span><span class="si">}</span><span class="s1">to &quot;</span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">by_var</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="si">}</span><span class="s1">&quot; for </span><span class="si">{</span><span class="n">dftype</span><span class="si">}</span><span class="s1">:&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="ow">or</span> <span class="n">diffpct</span><span class="p">)</span> <span class="k">else</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dftype</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">xtrans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">plot_basis_ax</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span> <span class="p">,</span> <span class="n">df</span><span class="o">*</span><span class="n">mul</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span>
                                     <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="n">xtrans</span><span class="p">,</span>
                                     <span class="n">ax_title</span><span class="o">=</span><span class="n">ax_title</span><span class="p">,</span>
                                     <span class="n">yunit</span><span class="o">=</span><span class="n">yunit</span><span class="p">,</span>
                                     <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Percent&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">showtype</span> <span class="o">==</span> <span class="s1">&#39;growth&#39;</span> <span class="ow">or</span> <span class="n">diffpct</span> <span class="o">==</span> <span class="kc">True</span> <span class="p">)</span><span class="k">else</span> <span class="n">ylabel</span><span class="p">,</span>
                                     <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span><span class="p">,</span><span class="n">samefig</span><span class="o">=</span><span class="n">samefig</span><span class="p">,</span>
                                     <span class="n">dec</span><span class="o">=</span><span class="mi">2</span> <span class="k">if</span> <span class="p">(</span><span class="n">showtype</span> <span class="o">==</span> <span class="s1">&#39;growth&#39;</span>   <span class="ow">or</span> <span class="n">diffpct</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dec</span> <span class="k">else</span> <span class="n">dec</span><span class="p">)</span>

         <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="n">number</span><span class="p">:]:</span>
             <span class="n">ax</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

         
         <span class="k">if</span> <span class="n">samefig</span><span class="p">:</span> 
             <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span> <span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> 

             <span class="k">if</span> <span class="n">legend</span><span class="p">:</span> 
                 <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>  <span class="c1"># Assuming the first ax has the handles and labels</span>
                 <span class="n">legend_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span> <span class="k">if</span> <span class="kc">True</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">)</span>
                 <span class="n">legend_ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>  <span class="c1"># Hide the axis</span>

         <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">vline</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># to delete vline</span>
             <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;vline&#39;</span><span class="p">):</span>
                 <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">vline</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">vline</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;vline&#39;</span><span class="p">):</span>
                 <span class="k">if</span> <span class="n">vline</span><span class="p">:</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">vline</span> <span class="o">=</span> <span class="n">vline</span>
                 <span class="k">for</span> <span class="n">xtime</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vline</span><span class="p">:</span>
                     <span class="n">model</span><span class="o">.</span><span class="n">keep_add_vline</span><span class="p">(</span><span class="n">figs</span><span class="p">,</span> <span class="n">xtime</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
         
         
         <span class="k">if</span> <span class="n">showfig</span><span class="p">:</span>
             <span class="o">...</span>
             <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">figs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> 
                 <span class="n">display</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                 <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
         <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span> 

         <span class="k">return</span> <span class="n">figs</span></div>




<div class="viewcode-block" id="Display_Mixin.keep_add_vline">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_add_vline">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">keep_add_vline</span><span class="p">(</span><span class="n">figs</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;  Calibration time&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; adds a vertical line with text to figs a dict with matplotlib figures) from keep_plot&#39;&#39;&#39;</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">for</span> <span class="n">keep</span><span class="p">,</span> <span class="n">fig</span> <span class="ow">in</span> <span class="n">figs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span> 
                <span class="n">ymax</span> <span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">ymax</span><span class="p">),</span>
                                         <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                        <span class="n">time</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="n">text</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="n">ymax</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Display_Mixin.keep_viz">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_viz">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_viz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">smpl</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">selectfrom</span><span class="o">=</span><span class="p">{},</span> <span class="n">legend</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">use_descriptions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">select_width</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">select_height</span><span class="o">=</span><span class="s1">&#39;200px&#39;</span><span class="p">,</span> <span class="n">vline</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Plots the keept dataframes</span>

<span class="sd">         Args:</span>
<span class="sd">             pat (str, optional): a string of variables to select pr default. Defaults to &#39;*&#39;.</span>
<span class="sd">             smpl (tuple with 2 elements, optional): the selected smpl, has to match the dataframe index used. Defaults to (&#39;&#39;,&#39;&#39;).</span>
<span class="sd">             selectfrom (list, optional): the variables to select from, Defaults to [] -&gt; all endogeneous variables .</span>
<span class="sd">             legend (bool, optional)c: DESCRIPTION. legends or to the right of the curve. Defaults to 1.</span>
<span class="sd">             dec (string, optional): decimals on the y-axis. Defaults to &#39;0&#39;.</span>
<span class="sd">             use_descriptions : Use the variable descriptions from the model </span>

<span class="sd">         Returns:</span>
<span class="sd">             None.</span>

<span class="sd">         self.keep_wiz_figs is set to a dictionary containing the figures. Can be used to produce publication</span>
<span class="sd">         quality files. </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">Dropdown</span><span class="p">,</span> <span class="n">Checkbox</span><span class="p">,</span> <span class="n">IntRangeSlider</span><span class="p">,</span> <span class="n">SelectMultiple</span><span class="p">,</span> <span class="n">Layout</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">ToggleButtons</span><span class="p">,</span> <span class="n">SelectionRangeSlider</span><span class="p">,</span> <span class="n">RadioButtons</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive_output</span><span class="p">,</span> <span class="n">HBox</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">Dropdown</span><span class="p">,</span><span class="n">Output</span>

        <span class="n">minper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maxper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ind</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span> <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="o">*</span><span class="n">smpl</span><span class="p">):</span>
            <span class="n">show_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[:]</span>
        <span class="n">init_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">show_per</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">init_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">show_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">defaultvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
        <span class="n">_selectfrom</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selectfrom</span><span class="p">]</span> <span class="k">if</span> <span class="n">selectfrom</span> <span class="k">else</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="n">var_maxlen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_selectfrom</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_descriptions</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">:</span>
            <span class="n">select_display</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">  :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_selectfrom</span><span class="p">]</span>
            <span class="n">defaultvar</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">  :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">pat</span><span class="p">)]</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">select_width</span> <span class="k">if</span> <span class="n">select_width</span> <span class="k">else</span> <span class="s1">&#39;90%&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">select_display</span> <span class="o">=</span> <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_selectfrom</span><span class="p">]</span>
            <span class="n">defaultvar</span> <span class="o">=</span> <span class="p">[</span><span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">pat</span><span class="p">)]</span>
            <span class="n">width</span> <span class="o">=</span> <span class="n">select_width</span> <span class="k">if</span> <span class="n">select_width</span> <span class="k">else</span> <span class="s1">&#39;50%&#39;</span>

        <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="n">i_smpl</span><span class="p">,</span> <span class="n">selected_vars</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">showtype</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">legend</span><span class="p">):</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selected_vars</span><span class="p">)</span>
            <span class="n">smpl</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i_smpl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i_smpl</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">diffpct</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ldiff</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">ldiff</span> <span class="o">=</span> <span class="n">diff</span>
                <span class="n">diffpct</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># print(ldiff,diffpct)    </span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="o">*</span><span class="n">smpl</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keep_wiz_figs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_plot</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">ldiff</span><span class="p">,</span> <span class="n">diffpct</span> <span class="o">=</span> <span class="n">diffpct</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">showtype</span><span class="o">=</span><span class="n">showtype</span><span class="p">,</span>
                                                    <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">vline</span><span class="o">=</span><span class="n">vline</span><span class="p">)</span>
            <span class="c1"># plt.show()    </span>
        <span class="n">description_width</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>
        <span class="n">description_width_long</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>
        <span class="n">keep_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keep_first</span> <span class="o">=</span> <span class="n">keep_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">i_smpl</span> <span class="o">=</span> <span class="n">SelectionRangeSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">init_start</span><span class="p">,</span> <span class="n">init_end</span><span class="p">],</span> <span class="n">continuous_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">minper</span><span class="p">,</span>
                                      <span class="nb">max</span><span class="o">=</span><span class="n">maxper</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Show interval&#39;</span><span class="p">)</span>
        <span class="n">selected_vars</span> <span class="o">=</span> <span class="n">SelectMultiple</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">defaultvar</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">select_display</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">select_height</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;monospace&quot;</span><span class="p">),</span>
                                       <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select one or more&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="n">selected_vars2</span> <span class="o">=</span> <span class="n">SelectMultiple</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">defaultvar</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">select_display</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">select_height</span><span class="p">),</span>
                                        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select one or more&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;In percent&#39;</span><span class="p">,</span> <span class="s1">&#39;pct&#39;</span><span class="p">)],</span> <span class="n">description</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;Difference to: &quot;</span><span class="si">{</span><span class="n">keep_first</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">},</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">))</span>
        <span class="c1"># diff_select = Dropdown(options=keep_keys,value=keep_first, description = fr&#39;to:&#39;)</span>
        <span class="n">showtype</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Level&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Growth&#39;</span><span class="p">,</span> <span class="s1">&#39;growth&#39;</span><span class="p">)],</span>
                                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Data type&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Log&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Y-scale&#39;</span><span class="p">,</span>
                             <span class="n">value</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="c1"># legend = ToggleButtons(options=[(&#39;Yes&#39;,1),(&#39;No&#39;,0)], description = &#39;Legends&#39;,value=1,style={&#39;description_width&#39;: description_width})</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Legends&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                              <span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">link</span><span class="p">((</span><span class="n">selected_vars</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">),</span>
                 <span class="p">(</span><span class="n">selected_vars2</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">))</span>  <span class="c1"># not used</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">selected_vars</span><span class="p">])</span>
        <span class="n">options1</span> <span class="o">=</span> <span class="n">diff</span>
        <span class="n">options2</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">scale</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">showtype</span><span class="p">])</span>
        <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">select</span><span class="p">,</span> <span class="n">options1</span><span class="p">,</span> <span class="n">options2</span><span class="p">,</span> <span class="n">i_smpl</span><span class="p">])</span>

        <span class="n">show</span> <span class="o">=</span> <span class="n">interactive_output</span><span class="p">(</span><span class="n">explain</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;i_smpl&#39;</span><span class="p">:</span> <span class="n">i_smpl</span><span class="p">,</span> <span class="s1">&#39;selected_vars&#39;</span><span class="p">:</span> <span class="n">selected_vars</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">,</span> <span class="s1">&#39;showtype&#39;</span><span class="p">:</span> <span class="n">showtype</span><span class="p">,</span>
                                            <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span> <span class="s1">&#39;legend&#39;</span><span class="p">:</span> <span class="n">legend</span><span class="p">})</span>
        <span class="c1"># display(ui, show)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">show</span><span class="p">)</span>
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="Display_Mixin.keep_viz_prefix">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_viz_prefix">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_viz_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">smpl</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">selectfrom</span><span class="o">=</span><span class="p">{},</span> <span class="n">legend</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">use_descriptions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">select_width</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">select_height</span><span class="o">=</span><span class="s1">&#39;200px&#39;</span><span class="p">,</span> <span class="n">vline</span><span class="o">=</span><span class="p">[],</span><span class="n">prefix_dict</span><span class="o">=</span><span class="p">{},</span><span class="n">add_var_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Plots the keept dataframes</span>

<span class="sd">         Args:</span>
<span class="sd">             pat (str, optional): a string of variables to select pr default. Defaults to &#39;*&#39;.</span>
<span class="sd">             smpl (tuple with 2 elements, optional): the selected smpl, has to match the dataframe index used. Defaults to (&#39;&#39;,&#39;&#39;).</span>
<span class="sd">             selectfrom (list, optional): the variables to select from, Defaults to [] -&gt; all keept  variables .</span>
<span class="sd">             legend (bool, optional)c: DESCRIPTION. legends or to the right of the curve. Defaults to 1.</span>
<span class="sd">             dec (string, optional): decimals on the y-axis. Defaults to &#39;0&#39;.</span>
<span class="sd">             use_descriptions : Use the variable descriptions from the model </span>

<span class="sd">         Returns:</span>
<span class="sd">             None.</span>

<span class="sd">         self.keep_wiz_figs is set to a dictionary containing the figures. Can be used to produce publication</span>
<span class="sd">         quality files. </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">Dropdown</span><span class="p">,</span> <span class="n">Checkbox</span><span class="p">,</span> <span class="n">IntRangeSlider</span><span class="p">,</span> <span class="n">SelectMultiple</span><span class="p">,</span> <span class="n">Layout</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">Select</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">ToggleButtons</span><span class="p">,</span> <span class="n">SelectionRangeSlider</span><span class="p">,</span> <span class="n">RadioButtons</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive_output</span><span class="p">,</span> <span class="n">HBox</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">Dropdown</span><span class="p">,</span><span class="n">Output</span>
        
        
        <span class="n">minper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maxper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ind</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span> <span class="k">for</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="o">*</span><span class="n">smpl</span><span class="p">):</span>
            <span class="n">show_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[:]</span>
        <span class="n">init_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">show_per</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">init_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">show_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">keepvar</span> <span class="o">=</span> <span class="nb">sorted</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">defaultvar</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">keepvar</span><span class="p">]</span> 
        <span class="n">_selectfrom</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selectfrom</span><span class="p">]</span> <span class="k">if</span> <span class="n">selectfrom</span> <span class="k">else</span> <span class="n">keepvar</span>
        
        <span class="n">gross_selectfrom</span> <span class="o">=</span>  <span class="p">[(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">add_var_name</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">use_descriptions</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_selectfrom</span><span class="p">]</span> 
        <span class="n">width</span> <span class="o">=</span> <span class="n">select_width</span> <span class="k">if</span> <span class="n">select_width</span> <span class="k">else</span> <span class="s1">&#39;50%&#39;</span> <span class="k">if</span> <span class="n">use_descriptions</span> <span class="k">else</span> <span class="s1">&#39;50%&#39;</span>

        <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="n">i_smpl</span><span class="p">,</span> <span class="n">selected_vars</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">showtype</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">legend</span><span class="p">):</span>
            <span class="nb">vars</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selected_vars</span><span class="p">)</span>
            <span class="n">smpl</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i_smpl</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i_smpl</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">diffpct</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ldiff</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">ldiff</span> <span class="o">=</span> <span class="n">diff</span>
                <span class="n">diffpct</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="o">*</span><span class="n">smpl</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keep_wiz_figs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_plot</span><span class="p">(</span><span class="nb">vars</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="n">ldiff</span><span class="p">,</span> <span class="n">diffpct</span> <span class="o">=</span> <span class="n">diffpct</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">showtype</span><span class="o">=</span><span class="n">showtype</span><span class="p">,</span>
                                                    <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">vline</span><span class="o">=</span><span class="n">vline</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>    
        <span class="n">description_width</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>
        <span class="n">description_width_long</span> <span class="o">=</span> <span class="s1">&#39;initial&#39;</span>
        <span class="n">keep_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keep_first</span> <span class="o">=</span> <span class="n">keep_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">select_prefix</span> <span class="o">=</span> <span class="p">[(</span><span class="n">c</span><span class="p">,</span><span class="n">iso</span><span class="p">)</span> <span class="k">for</span> <span class="n">iso</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">prefix_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">i_smpl</span> <span class="o">=</span> <span class="n">SelectionRangeSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">init_start</span><span class="p">,</span> <span class="n">init_end</span><span class="p">],</span> <span class="n">continuous_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">minper</span><span class="p">,</span>
                                      <span class="nb">max</span><span class="o">=</span><span class="n">maxper</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;75%&#39;</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Show interval&#39;</span><span class="p">)</span>
        <span class="n">selected_vars</span> <span class="o">=</span> <span class="n">SelectMultiple</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">defaultvar</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">gross_selectfrom</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">select_height</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;monospace&quot;</span><span class="p">),</span>
                                       <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Select one or more&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;In percent&#39;</span><span class="p">,</span> <span class="s1">&#39;pct&#39;</span><span class="p">)],</span> <span class="n">description</span><span class="o">=</span><span class="sa">fr</span><span class="s1">&#39;Difference to: &quot;</span><span class="si">{</span><span class="n">keep_first</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">},</span> <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">))</span>
        <span class="n">showtype</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Level&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Growth&#39;</span><span class="p">,</span> <span class="s1">&#39;growth&#39;</span><span class="p">)],</span>
                                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Data type&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;level&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Log&#39;</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">)],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Y-scale&#39;</span><span class="p">,</span>
                             <span class="n">value</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">RadioButtons</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Yes&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)],</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Legends&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="p">{</span>
                              <span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="n">description_width</span><span class="p">})</span>
        <span class="c1"># breakpoint()</span>
        
        
        <span class="k">def</span> <span class="nf">get_prefix</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_suffix</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;old&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selected_vars</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">current_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                
            <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">]</span>
            <span class="n">selected_prefix_var</span> <span class="o">=</span>  <span class="p">[(</span><span class="n">des</span><span class="p">,</span><span class="n">variable</span><span class="p">)</span> <span class="k">for</span> <span class="n">des</span><span class="p">,</span><span class="n">variable</span> <span class="ow">in</span> <span class="n">gross_selectfrom</span>  
                                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">variable</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_prefix</span><span class="p">])]</span>
                                    
            <span class="n">selected_vars</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">selected_prefix_var</span>
            
            <span class="k">if</span> <span class="n">current_suffix</span><span class="p">:</span>
                <span class="n">new_selection</span>   <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">current_suffix</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_prefix</span>
                                        <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="p">{</span><span class="n">s</span>  <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="n">selected_prefix_var</span><span class="p">}]</span>
                <span class="n">selected_vars</span><span class="o">.</span><span class="n">value</span>  <span class="o">=</span> <span class="n">new_selection</span> 
                <span class="c1"># print(f&quot;{new_selection=}{current_suffix=}{g[&#39;old&#39;]=}&quot;)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">selected_vars</span><span class="o">.</span><span class="n">value</span>  <span class="o">=</span> <span class="p">[</span><span class="n">selected_prefix_var</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                
                   
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix_dict</span><span class="p">):</span> 
            <span class="n">selected_prefix</span> <span class="o">=</span> <span class="n">SelectMultiple</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="n">select_prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="n">options</span><span class="o">=</span><span class="n">select_prefix</span><span class="p">,</span> 
                                             <span class="n">layout</span><span class="o">=</span><span class="n">Layout</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="s1">&#39;25%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">select_height</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="s2">&quot;monospace&quot;</span><span class="p">),</span>
                                       <span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
               
            <span class="n">selected_prefix</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">get_prefix</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;change&#39;</span><span class="p">)</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">selected_vars</span><span class="p">,</span><span class="n">selected_prefix</span><span class="p">])</span>
            <span class="n">get_prefix</span><span class="p">({</span><span class="s1">&#39;new&#39;</span><span class="p">:</span><span class="n">select_prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">select</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">([</span><span class="n">selected_vars</span><span class="p">])</span>
            
        <span class="n">options1</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">diff</span><span class="p">])</span> <span class="k">if</span> <span class="n">short</span> <span class="o">&gt;=</span><span class="mi">2</span> <span class="k">else</span> <span class="n">HBox</span><span class="p">([</span><span class="n">diff</span><span class="p">,</span><span class="n">legend</span><span class="p">])</span>
        <span class="n">options2</span> <span class="o">=</span> <span class="n">HBox</span><span class="p">([</span><span class="n">scale</span><span class="p">,</span> <span class="n">showtype</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">short</span><span class="p">:</span>
            <span class="n">vui</span> <span class="o">=</span> <span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="n">options1</span><span class="p">,</span> <span class="n">i_smpl</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vui</span> <span class="o">=</span> <span class="p">[</span><span class="n">select</span><span class="p">,</span> <span class="n">options1</span><span class="p">,</span> <span class="n">options2</span><span class="p">,</span> <span class="n">i_smpl</span><span class="p">]</span>
        <span class="n">vui</span> <span class="o">=</span>  <span class="n">vui</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">short</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">vui</span>  
        <span class="n">ui</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">(</span><span class="n">vui</span><span class="p">)</span>
        
        <span class="n">show</span> <span class="o">=</span> <span class="n">interactive_output</span><span class="p">(</span><span class="n">explain</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;i_smpl&#39;</span><span class="p">:</span> <span class="n">i_smpl</span><span class="p">,</span> <span class="s1">&#39;selected_vars&#39;</span><span class="p">:</span> <span class="n">selected_vars</span><span class="p">,</span> <span class="s1">&#39;diff&#39;</span><span class="p">:</span> <span class="n">diff</span><span class="p">,</span> <span class="s1">&#39;showtype&#39;</span><span class="p">:</span> <span class="n">showtype</span><span class="p">,</span>
                                            <span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="n">scale</span><span class="p">,</span> <span class="s1">&#39;legend&#39;</span><span class="p">:</span> <span class="n">legend</span><span class="p">})</span>
        <span class="c1"># display(ui, show)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">ui</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">show</span><span class="p">)</span>
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="Display_Mixin.keep_plot_widget">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_plot_widget">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_plot_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">modelwidget_input</span>
        <span class="n">widget</span> <span class="o">=</span> <span class="n">modelwidget_input</span><span class="o">.</span><span class="n">keep_plot_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">widget</span></div>

        
<div class="viewcode-block" id="Display_Mixin.keep_show">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.keep_show">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
       <span class="kn">import</span> <span class="nn">modelwidget_input</span>
       <span class="n">widget</span> <span class="o">=</span> <span class="n">modelwidget_input</span><span class="o">.</span><span class="n">keep_plot_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
       <span class="c1"># print(f&#39;widget called {kwargs=}&#39;)</span>
       <span class="k">return</span> <span class="n">widget</span></div>

       
<div class="viewcode-block" id="Display_Mixin.df_show">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.df_show">[docs]</a>
    <span class="k">def</span> <span class="nf">df_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
       <span class="kn">import</span> <span class="nn">modelwidget_input</span>
       <span class="n">widget</span> <span class="o">=</span> <span class="n">modelwidget_input</span><span class="o">.</span><span class="n">keep_plot_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="n">switch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
       <span class="k">return</span> <span class="n">widget</span></div>

  
<div class="viewcode-block" id="Display_Mixin.df_plot">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.df_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">df_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">keepswitch</span><span class="p">(</span><span class="n">switch</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 
            <span class="n">figs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_plot</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span>    </div>

    

<div class="viewcode-block" id="Display_Mixin.display_toc">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.display_toc">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">display_toc</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;**Jupyter notebooks**&#39;</span><span class="p">,</span><span class="n">folder</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="nb">all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">nocwd</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;In a jupyter notebook this function displays a clickable table of content of all </span>
<span class="sd">        jupyter notebooks in this and sub folders&#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">HTML</span>
        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
        <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**&#39;</span><span class="p">)):</span>
            <span class="c1"># print(f&#39;{dir=} {nocwd=}&#39;)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">nocwd</span> <span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">filelist</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*readme.ipynb&#39;</span><span class="p">))</span> 
                    <span class="o">+</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.ipynb&#39;</span><span class="p">))</span> 
                       <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">stem</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;readme&#39;</span><span class="p">)])</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">notebook</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filelist</span><span class="p">):</span>
                <span class="c1"># print(notebook)    </span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">notebook</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">notebook</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Overview&#39;</span><span class="p">)):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">blanks</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="s1">&#39;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">parts</span><span class="p">):</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1">&lt;b&gt;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span><span class="si">}</span><span class="s1">&lt;/b&gt;&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">display</span><span class="p">(</span>
                            <span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1">&lt;b&gt;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span><span class="o">.</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s1"> (.)&lt;/b&gt;&#39;</span><span class="p">))</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">notebook</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># print(notebook)</span>
                <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;</span><span class="si">{</span><span class="n">blanks</span><span class="si">}</span><span class="s1"> &lt;a href=&quot;</span><span class="si">{</span><span class="n">notebook</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot;&gt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="p">))</span></div>



<div class="viewcode-block" id="Display_Mixin.display_toc_this">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.display_toc_this">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">display_toc_this</span><span class="p">(</span><span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;**Jupyter notebooks**&#39;</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="s1">&#39;ipynb&#39;</span><span class="p">,</span><span class="n">showext</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;In a jupyter notebook this function displays a clickable table of content in the folder pat with name in path&#39;&#39;&#39;</span>

        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">HTML</span>
        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
       <span class="c1"># print(dir,&#39;:&#39;)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pat</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">ext</span><span class="p">)):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">showext</span> <span class="k">else</span> <span class="n">fname</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&amp;nbsp; &amp;nbsp; &lt;a href=&quot;</span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s1">&quot; target=&quot;_blank&quot;&gt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Display_Mixin.widescreen">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.widescreen">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">widescreen</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Makes a jupyter notebook use all the avaiable real estate</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;style&gt;</span>
<span class="s2">            div#notebook-container    { width: 95%; }</span>
<span class="s2">            div#menubar-container     { width: 65%; }</span>
<span class="s2">            div#maintoolbar-container { width: 99%; }</span>
<span class="s2">        &lt;/style&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">))</span></div>


           
<div class="viewcode-block" id="Display_Mixin.scroll_off">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.scroll_off">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">scroll_off</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Javascript</span>
                <span class="n">display</span><span class="p">(</span><span class="n">Javascript</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    IPython.OutputArea.prototype._should_scroll = function(lines){</span>
<span class="s2">                        return false;</span>
<span class="s2">                    }</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">. Unable to turn off scrolling.&#39;</span><span class="p">)</span></div>

        
           
           
<div class="viewcode-block" id="Display_Mixin.scroll_on">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.scroll_on">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">scroll_on</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Javascript</span>
            <span class="n">display</span><span class="p">(</span><span class="n">Javascript</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                IPython.OutputArea.prototype._should_scroll = function(lines){</span>
<span class="s2">                    return true;</span>
<span class="s2">                }</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">. Unable to turn on scrolling.&#39;</span><span class="p">)</span></div>




<div class="viewcode-block" id="Display_Mixin.modelflow_auto">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Display_Mixin.modelflow_auto">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">modelflow_auto</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;In a jupyter notebook this function activate autorun of the notebook. </span>

<span class="sd">        Also it makes Jupyter use a larger portion of the browser width</span>

<span class="sd">        The function should be run before the notebook is saved, and the output should not be cleared</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">run</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>
            <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;style&gt;</span>
<span class="s2">                div#notebook-container    { width: 95%; }</span>
<span class="s2">                div#menubar-container     { width: 65%; }</span>
<span class="s2">                div#maintoolbar-container { width: 99%; }</span>
<span class="s2">            &lt;/style&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">))</span>

            <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">            &lt;script&gt;</span>
<span class="s2">                // AUTORUN ALL CELLS ON NOTEBOOK-LOAD!</span>
<span class="s2">                require(</span>
<span class="s2">                    [&#39;base/js/namespace&#39;, &#39;jquery&#39;], </span>
<span class="s2">                    function(jupyter, $) {</span>
<span class="s2">                        $(jupyter.events).on(&#39;kernel_ready.Kernel&#39;, function () {</span>
<span class="s2">                            console.log(&#39;Auto-running all cells-below...&#39;);</span>
<span class="s2">                            jupyter.actions.call(&#39;jupyter-notebook:run-all-cells-below&#39;);</span>
<span class="s2">                            jupyter.actions.call(&#39;jupyter-notebook:save-notebook&#39;);</span>
<span class="s2">                        });</span>
<span class="s2">                    }</span>
<span class="s2">                );</span>
<span class="s2">            &lt;/script&gt;&quot;&quot;&quot;</span><span class="p">))</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;modelflow_auto not run&#39;</span><span class="p">)</span></div>
</div>

            
<span class="kn">import</span> <span class="nn">modelwidget_input</span>

<span class="n">Display_Mixin</span><span class="o">.</span><span class="n">keep_plot_widget</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span>  <span class="n">modelwidget_input</span><span class="o">.</span><span class="n">keep_plot_widget</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="n">Display_Mixin</span><span class="o">.</span><span class="n">keep_show</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span>  <span class="n">modelwidget_input</span><span class="o">.</span><span class="n">keep_plot_widget</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="n">Display_Mixin</span><span class="o">.</span><span class="n">df_plot</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span>  <span class="n">Display_Mixin</span><span class="o">.</span><span class="n">keep_plot</span><span class="o">.</span><span class="vm">__doc__</span>


<div class="viewcode-block" id="Json_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Json_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Json_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This mixin class can dump a model and solution</span>
<span class="sd">    as json serialiation to a file. </span>

<span class="sd">    allows the precooking of a model and solution, so </span>
<span class="sd">    a user can use a model without specifying it in </span>
<span class="sd">    a session. </span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Json_Mixin.modeldump_base">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Json_Mixin.modeldump_base">[docs]</a>
    <span class="k">def</span> <span class="nf">modeldump_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Dumps a model and its lastdf to a json file</span>
<span class="sd">        </span>
<span class="sd">        if keep=True the model.keep_solutions will alse be dumped&#39;&#39;&#39;</span>
        <span class="c1"># print(&#39;dump ready&#39;)</span>
        <span class="k">def</span> <span class="nf">ibs_to_json</span><span class="p">(</span><span class="n">series</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">period_to_dict</span><span class="p">(</span><span class="n">period</span><span class="p">):</span>
                <span class="c1"># This function converts a pandas Period object to a dictionary similar to the JSON structure</span>
                <span class="c1"># provided in pandas versions before 2.0 when using to_json()</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                    <span class="s2">&quot;day_of_week&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">day_of_week</span><span class="p">,</span>
                    <span class="s2">&quot;day_of_year&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">,</span>
                    <span class="s2">&quot;dayofweek&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">day_of_week</span><span class="p">,</span>
                    <span class="s2">&quot;dayofyear&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">day_of_year</span><span class="p">,</span>
                    <span class="s2">&quot;days_in_month&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">,</span>
                    <span class="s2">&quot;daysinmonth&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">days_in_month</span><span class="p">,</span>
                    <span class="s2">&quot;end_time&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>  <span class="c1"># Convert to milliseconds</span>
                    <span class="s2">&quot;freqstr&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">freqstr</span><span class="p">,</span>
                    <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                    <span class="s2">&quot;is_leap_year&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">is_leap_year</span><span class="p">,</span>
                    <span class="s2">&quot;minute&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                    <span class="s2">&quot;ordinal&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">ordinal</span><span class="p">,</span>
                    <span class="s2">&quot;quarter&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">quarter</span><span class="p">,</span>
                    <span class="s2">&quot;qyear&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">qyear</span><span class="p">,</span>
                    <span class="s2">&quot;second&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="s2">&quot;start_time&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">period</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">),</span>  <span class="c1"># Convert to milliseconds</span>
                    <span class="s2">&quot;week&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">week</span><span class="p">,</span>
                    <span class="s2">&quot;weekday&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">weekday</span><span class="p">,</span>
                    <span class="s2">&quot;weekofyear&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">week</span><span class="p">,</span>
                    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">period</span><span class="o">.</span><span class="n">year</span>
                <span class="p">}</span>
            
            <span class="c1"># Creating a dictionary from the series where each period is converted to a dictionary</span>
            <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span> <span class="n">period_to_dict</span><span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">period</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">series</span><span class="p">)}</span>
            
            <span class="c1"># Converting the dictionary to a JSON string</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result_dict</span><span class="p">)</span>

        <span class="c1"># to manage error in pandas 2. </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_per_json</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span> 
        <span class="k">except</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Pandas 2. error handled &#39;</span><span class="p">)</span>
            <span class="n">current_per_json</span>  <span class="o">=</span> <span class="n">ibs_to_json</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">))</span>


        <span class="n">dumpjson</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="s1">&#39;1.00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;frml&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">,</span>
            <span class="s1">&#39;lastdf&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">double_precision</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
            <span class="s1">&#39;current_per&#39;</span><span class="p">:</span> <span class="n">current_per_json</span> <span class="p">,</span>
            <span class="s1">&#39;modelname&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;oldkwargs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span><span class="p">,</span>
            <span class="s1">&#39;var_description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">,</span>
            <span class="s1">&#39;equations_latex&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations_latex</span> <span class="p">,</span>
            <span class="s1">&#39;keep_solutions&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">double_precision</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">if</span> <span class="n">keep</span> <span class="k">else</span> <span class="p">{},</span>
            <span class="s1">&#39;wb_MFMSAOPTIONS&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb_MFMSAOPTIONS</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;wb_MFMSAOPTIONS&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;var_groups&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_groups</span><span class="p">,</span>
            <span class="s1">&#39;reports&#39;</span>        <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="p">,</span> 

            <span class="s1">&#39;model_description&#39;</span>     <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_description</span><span class="p">,</span>
            <span class="s1">&#39;eviews_dict&#39;</span>           <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eviews_dict</span><span class="p">,</span>

 
        <span class="p">}</span>
        <span class="c1"># print(&#39;dump ready to write&#39;)</span>
        <span class="k">if</span> <span class="n">outfile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">pathname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="n">pathname</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dumpjson</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dumpjson</span><span class="p">)</span></div>


<div class="viewcode-block" id="Json_Mixin.modelload">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Json_Mixin.modelload">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">modelload</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="p">[],</span> <span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_json</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
         <span class="n">default_url</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;https://raw.githubusercontent.com/IbHansen/modelflow-manual/main/model_repo/&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">             </span>

<span class="sd">             Parameters</span>
<span class="sd">             ----------</span>
<span class="sd">             infile : A file name or an url with a .pcim file</span>
<span class="sd">             funks : Functions to use in the resulting model</span>
<span class="sd">             run : simulate the model with the saved time and options </span>
<span class="sd">             keep_json : save a dict (self.json_keep) in the model instance </span>
<span class="sd">             default_url : TYPE, optional</span>
<span class="sd">                 Where to look if the file is not avaiable. The default is r&#39;https://raw.githubusercontent.com/IbHansen/modelflow-manual/main/model_repo/&#39;.</span>
<span class="sd">             **kwargs : These options are used by the simulation if run=True</span>

<span class="sd">             Returns</span>
<span class="sd">             -------</span>
<span class="sd">             (&lt;a model instance&gt;,&lt;a dataframe&gt;) .</span>

<span class="sd">             &#39;&#39;&#39;</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Loads a model and an solution &#39;&#39;&#39;</span>
        <span class="kn">import</span> <span class="nn">io</span>
        <span class="kn">import</span> <span class="nn">urllib.request</span>

        <span class="k">def</span> <span class="nf">make_current_from_quarters</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">json_current_per</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; Handle json for quarterly data to recover the right date index</span>

<span class="sd">            &#39;&#39;&#39;</span>
            <span class="kn">import</span> <span class="nn">datetime</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">json_current_per</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">start_per</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
                <span class="n">start</span><span class="p">[</span><span class="s1">&#39;qyear&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="n">start</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">])</span>
            <span class="n">end_per</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span>
                <span class="n">end</span><span class="p">[</span><span class="s1">&#39;qyear&#39;</span><span class="p">],</span>   <span class="n">end</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span>   <span class="n">end</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">])</span>
            <span class="n">current_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span>
                <span class="n">start_per</span><span class="p">,</span> <span class="n">end_per</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;freqstr&#39;</span><span class="p">])</span>
            <span class="n">base_dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">period_range</span><span class="p">(</span>
                <span class="n">base</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;freqstr&#39;</span><span class="p">])</span>
            <span class="n">base</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">base_dates</span>
            <span class="k">return</span> <span class="n">base</span><span class="p">,</span> <span class="n">current_dates</span>

        <span class="n">pinfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">nname</span><span class="o">:=</span><span class="n">infile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pinfile</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
            <span class="n">pinfile</span> <span class="o">=</span> <span class="n">pinfile</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pcim&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">read_file</span><span class="p">(</span><span class="n">pinfile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># First, try reading the file as a regular text file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pinfile</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">=</span>  <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;file read:  </span><span class="si">{</span><span class="n">pinfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>    
                <span class="k">return</span> <span class="n">out</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="c1"># print(f&#39;An UnicodeDecodeError occurs, it might be a gzip file&#39;)</span>
                <span class="k">pass</span>
        
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try reading the file as a gzip file</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pinfile</span><span class="p">,</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Zipped file read:  </span><span class="si">{</span><span class="n">pinfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>    
                <span class="k">return</span> <span class="n">out</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                <span class="c1"># Handle the case where the file is neither plain text nor gzip</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Error reading the file </span><span class="si">{</span><span class="n">nname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">read_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># Read the content once</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Try to read as a gzip file first</span>
                    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                    <span class="c1"># If not gzip, then read as regular file</span>
                    <span class="k">return</span> <span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pinfile</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">json_string</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">pinfile</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">infile</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;https:&#39;</span><span class="p">):</span>
                <span class="n">urlfile</span> <span class="o">=</span> <span class="n">infile</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">urlfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">default_url</span><span class="p">)</span> <span class="o">/</span> <span class="n">pinfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;https:/&#39;</span><span class="p">,</span><span class="s1">&#39;https://&#39;</span><span class="p">)</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Open file from URL:  </span><span class="si">{</span><span class="n">urlfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>  
            <span class="n">json_string</span> <span class="o">=</span> <span class="n">read_from_url</span><span class="p">(</span><span class="n">urlfile</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
        <span class="n">frml</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span>
        <span class="n">lastdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;lastdf&#39;</span><span class="p">]))</span>
        <span class="n">current_per</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="s1">&#39;current_per&#39;</span><span class="p">]),</span> <span class="n">typ</span><span class="o">=</span><span class="s1">&#39;series&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">modelname</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;modelname&#39;</span><span class="p">]</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">mmodel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">frml</span><span class="p">,</span> <span class="n">modelname</span><span class="o">=</span><span class="n">modelname</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">oldkwargs</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;oldkwargs&#39;</span><span class="p">]</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">json_current_per</span> <span class="o">=</span> <span class="n">current_per</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">set_var_description</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;var_description&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">equations_latex</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;equations_latex&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wb_MFMSAOPTIONS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="p">:</span> <span class="n">mmodel</span><span class="o">.</span><span class="n">wb_MFMSAOPTIONS</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wb_MFMSAOPTIONS&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">keep_solutions</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">jdf</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">jdf</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_solutions&#39;</span><span class="p">,{})</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">var_groups</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;var_groups&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">reports</span>    <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reports&#39;</span><span class="p">,{}</span> <span class="p">)</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">model_description</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_description&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">eviews_dict</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eviews_dict&#39;</span><span class="p">,</span> <span class="p">{})</span>
        
        <span class="c1"># mmodel.json_string = json_string</span>

        <span class="k">if</span> <span class="n">keep_json</span><span class="p">:</span>
            <span class="n">mmodel</span><span class="o">.</span><span class="n">json_keep</span> <span class="o">=</span> <span class="nb">input</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lastdf</span><span class="p">,</span> <span class="n">current_per</span> <span class="o">=</span> <span class="n">make_current_from_quarters</span><span class="p">(</span>
                <span class="n">lastdf</span><span class="p">,</span> <span class="n">current_per</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># print(&#39;makecurrent&#39;,e)</span>
            <span class="k">pass</span>
        
        <span class="k">if</span> <span class="n">mmodel</span><span class="o">.</span><span class="n">model_description</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model:</span><span class="si">{</span><span class="n">mmodel</span><span class="o">.</span><span class="n">model_description</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>    

        <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="o">:=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">end</span><span class="o">:=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">)):</span> 
                <span class="n">current_per</span> <span class="o">=</span> <span class="n">mmodel</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">lastdf</span><span class="p">)</span>
                <span class="c1"># to avoid dublicate start and end </span>
                <span class="n">newkwargs</span> <span class="o">=</span>  <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;start&#39;</span><span class="p">,</span><span class="s1">&#39;end&#39;</span><span class="p">}}</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">newkwargs</span> <span class="o">=</span> <span class="n">kwargs</span>  
                
            <span class="n">res</span> <span class="o">=</span> <span class="n">mmodel</span><span class="p">(</span><span class="n">lastdf</span><span class="p">,</span> <span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">newkwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mmodel</span><span class="p">,</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mmodel</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">current_per</span> 
            <span class="n">mmodel</span><span class="o">.</span><span class="n">basedf</span> <span class="o">=</span> <span class="n">lastdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  
            <span class="k">return</span> <span class="n">mmodel</span><span class="p">,</span> <span class="n">lastdf</span></div>
</div>


<div class="viewcode-block" id="Zip_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Zip_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Zip_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This experimental class zips a dumped file &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Zip_Mixin.modeldump">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Zip_Mixin.modeldump">[docs]</a>
    <span class="k">def</span> <span class="nf">modeldump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">zip_file</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">pathname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pathname</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
            <span class="n">pathname</span> <span class="o">=</span> <span class="n">pathname</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.pcim&#39;</span><span class="p">)</span>

        <span class="n">pathname</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">json_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeldump_base</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="n">keep</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">zip_file</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pathname</span> <span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zipped_file</span><span class="p">:</span>
                <span class="n">zipped_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span></div>
</div>





<div class="viewcode-block" id="Excel_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Excel_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Excel_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This Mixin handels dumps and loads models into excel &#39;&#39;&#39;</span> 

<div class="viewcode-block" id="Excel_Mixin.modeldump_excel">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Excel_Mixin.modeldump_excel">[docs]</a>
    <span class="k">def</span> <span class="nf">modeldump_excel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">fromfile</span><span class="o">=</span><span class="s1">&#39;control.xlsm&#39;</span><span class="p">,</span> <span class="n">keep_open</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Dump model and dataframe to excel workbook</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file : TYPE</span>
<span class="sd">            filename.</span>
<span class="sd">        keep_open : TYPE, optional</span>
<span class="sd">            Keep the workbook open in excel after returning,  The default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wb : TYPE</span>
<span class="sd">            xlwings instance of workbook .</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">thispath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="n">thispath</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.XLSM&#39;</span><span class="p">:</span>
            <span class="n">wb</span> <span class="o">=</span> <span class="n">xw</span><span class="o">.</span><span class="n">Book</span><span class="p">(</span><span class="n">thispath</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="n">Path</span><span class="p">(</span><span class="n">fromfile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wb</span> <span class="o">=</span> <span class="n">xw</span><span class="o">.</span><span class="n">Book</span><span class="p">()</span>

        <span class="n">wb</span><span class="o">.</span><span class="n">sheets</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
        <span class="n">wb</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">screen_updating</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">me</span><span class="o">.</span><span class="n">obj_to_sheet</span><span class="p">(</span><span class="s1">&#39;frml&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span>
                                 <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">]},</span> <span class="n">wb</span><span class="p">)</span>
        <span class="n">me</span><span class="o">.</span><span class="n">obj_to_sheet</span><span class="p">(</span><span class="s1">&#39;var_description&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;empty&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span><span class="p">},</span> <span class="n">wb</span><span class="p">)</span>
        <span class="n">me</span><span class="o">.</span><span class="n">obj_to_sheet</span><span class="p">(</span><span class="s1">&#39;oldkwargs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span><span class="p">,</span> <span class="n">wb</span><span class="p">)</span>
        <span class="n">me</span><span class="o">.</span><span class="n">obj_to_sheet</span><span class="p">(</span><span class="s1">&#39;modelname&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">},</span> <span class="n">wb</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;current_per&#39;</span><span class="p">):</span>
            <span class="n">me</span><span class="o">.</span><span class="n">obj_to_sheet</span><span class="p">(</span><span class="s1">&#39;current_per&#39;</span><span class="p">,</span> <span class="n">me</span><span class="o">.</span><span class="n">indextrans</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">),</span> <span class="n">wb</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="s1">&#39;frml&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lastdf&#39;</span><span class="p">):</span>
            <span class="n">me</span><span class="o">.</span><span class="n">df_to_sheet</span><span class="p">(</span><span class="s1">&#39;lastdf&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">)],</span> <span class="n">wb</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="s1">&#39;frml&#39;</span><span class="p">)</span>

        <span class="n">wb</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">screen_updating</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s1"> not saved</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_open</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">wb</span></div>


<div class="viewcode-block" id="Excel_Mixin.modelload_excel">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Excel_Mixin.modelload_excel">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">modelload_excel</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="s1">&#39;pak&#39;</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="p">[],</span> <span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_open</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loads a model from a excel workbook dumped by :any:`modeldump_excel`</span>

<span class="sd">        Args:</span>
<span class="sd">            cls (TYPE): DESCRIPTION.</span>
<span class="sd">            infile (TYPE, optional): DESCRIPTION. Defaults to &#39;pak&#39;.</span>
<span class="sd">            funks (TYPE, optional): DESCRIPTION. Defaults to [].</span>
<span class="sd">            run (TYPE, optional): DESCRIPTION. Defaults to False.</span>
<span class="sd">            keep_open (TYPE, optional): DESCRIPTION. Defaults to False.</span>
<span class="sd">            **kwargs (TYPE): DESCRIPTION.</span>

<span class="sd">        Returns:</span>
<span class="sd">            mmodel (TYPE): DESCRIPTION.</span>
<span class="sd">            res (TYPE): DESCRIPTION.</span>
<span class="sd">            TYPE: DESCRIPTION.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">xw</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">Book</span><span class="p">):</span>
            <span class="n">wb</span> <span class="o">=</span> <span class="n">infile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wb</span> <span class="o">=</span> <span class="n">xw</span><span class="o">.</span><span class="n">Book</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">())</span>

        <span class="n">wb</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">screen_updating</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">frml</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">me</span><span class="o">.</span><span class="n">sheet_to_dict</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="s1">&#39;frml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">modelname</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">sheet_to_dict</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="s1">&#39;modelname&#39;</span><span class="p">)[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">var_description</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">sheet_to_dict</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="s1">&#39;var_description&#39;</span><span class="p">)</span>
        <span class="n">mmodel</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">frml</span><span class="p">,</span> <span class="n">modelname</span><span class="o">=</span><span class="n">modelname</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">,</span>
                     <span class="n">var_description</span><span class="o">=</span><span class="n">var_description</span><span class="p">)</span>
        <span class="n">mmodel</span><span class="o">.</span><span class="n">oldkwargs</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">sheet_to_dict</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="s1">&#39;oldkwargs&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mmodel</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">sheet_to_df</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="s1">&#39;current_per&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lastdf</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">sheet_to_df</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="s1">&#39;lastdf&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">lastdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">mmodel</span><span class="p">(</span><span class="n">lastdf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">lastdf</span>

        <span class="n">wb</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">screen_updating</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_open</span><span class="p">:</span>
            <span class="n">wb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">mmodel</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mmodel</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">wb</span></div>
</div>





<div class="viewcode-block" id="Solver_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Solver_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This Mixin handels the solving of models. &#39;&#39;&#39;</span>
    <span class="n">DEFAULT_relconv</span> <span class="o">=</span> <span class="mf">0.0000001</span>

<div class="viewcode-block" id="Solver_Mixin.__call__">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Runs a model. </span>

<span class="sd">        Default a straight model is calculated by *xgenr* a simultaneous model is solved by *sim* </span>

<span class="sd">        :sim: If False forces a  model to be calculated (not solved) if True force simulation </span>
<span class="sd">        :setbase: If True, place the result in model.basedf </span>
<span class="sd">        :setlast: if False don&#39;t place the results in model.lastdf</span>

<span class="sd">        if the modelproperty previousbase is true, the previous run is used as basedf. </span>


<span class="sd">       </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sim : bool, optional</span>
<span class="sd">            If False, forces a model to be calculated (not solved); if True, forces simulation. </span>
<span class="sd">            The default behavior is determined by the model&#39;s properties.</span>

<span class="sd">        setbase : bool, optional</span>
<span class="sd">            If True, places the result in model.basedf. Default is determined by the model&#39;s state.</span>

<span class="sd">        setlast : bool, optional</span>
<span class="sd">            If False, doesn&#39;t place the results in model.lastdf. Default is True.</span>

<span class="sd">        antal : not applicable, optional</span>
<span class="sd">            This option is not valid. If provided, an assertion error is raised.</span>

<span class="sd">        do_calc_add_factor : bool, optional</span>
<span class="sd">            Determines whether to calculate the adjustment factor if the calc adjust model is present. </span>
<span class="sd">            Default is True.</span>

<span class="sd">        reset_options : bool, optional</span>
<span class="sd">            If True, the previous options will be reset. Default is False.</span>

<span class="sd">        save : bool, optional</span>
<span class="sd">            If True, saves the current state. The default behavior is determined by the model&#39;s properties.</span>

<span class="sd">        solver : str, optional</span>
<span class="sd">            Specifies the solver to be used. The default solver is chosen based on the model&#39;s properties.</span>

<span class="sd">        silent : bool, optional</span>
<span class="sd">            If True, the solver runs silently without printing output to the console. Default is True.</span>

<span class="sd">        cache_clear : bool, optional</span>
<span class="sd">            If True, clears the cache after solving. Default is True.</span>

<span class="sd">        keep : str, optional</span>
<span class="sd">            If provided, keeps the solutions. The exact behavior depends on the &#39;keep_variables&#39; option.</span>

<span class="sd">        keep_variables : str or list of str, optional</span>
<span class="sd">            Specifies which variables to keep if the &#39;keep&#39; option is provided. Default is to keep all variables.</span>

<span class="sd">        *args</span>
<span class="sd">            Variable length argument list.</span>

<span class="sd">        **kwargs</span>
<span class="sd">            Arbitrary keyword arguments.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        outdf : pandas.DataFrame</span>
<span class="sd">            The DataFrame containing the results of the model run.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        AssertionError</span>
<span class="sd">            If the &#39;antal&#39; option is provided, as it is not a valid simulation option.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        
        
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;antal&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">assert</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Antal is not a valid simulation option, Use max_iterations&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">do_calc_add_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;do_calc_add_factor&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reset_options&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;oldkwargs&#39;</span><span class="p">):</span>
            <span class="n">newkwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newkwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">oldkwargs</span> <span class="o">=</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>
 
                

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previousbase</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lastdf&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlead</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span><span class="p">:</span>
                <span class="n">solverguess</span> <span class="o">=</span> <span class="s1">&#39;newtonstack&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">solverguess</span> <span class="o">=</span> <span class="s1">&#39;newtonstack_un_normalized&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalized</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">istopo</span><span class="p">:</span>
                    <span class="n">solverguess</span> <span class="o">=</span> <span class="s1">&#39;xgenr&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">solverguess</span> <span class="o">=</span> <span class="s1">&#39;sim&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">solverguess</span> <span class="o">=</span> <span class="s1">&#39;newton_un_normalized&#39;</span>

        <span class="n">solver</span> <span class="o">=</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;solver&#39;</span><span class="p">,</span> <span class="n">solverguess</span><span class="p">)</span>
        <span class="n">silent</span> <span class="o">=</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;silent&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_solver</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">)</span>
        
        <span class="c1"># print(f&#39;solver:{solver},solverkwargs:{newkwargs}&#39;)</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">outdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_solver</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">newkwargs</span><span class="p">)</span>
        
        
        <span class="c1"># now calculate adjustment factors if the calc adjust model is there </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_calc_add_factor</span> <span class="ow">and</span> <span class="n">do_calc_add_factor</span><span class="p">:</span> 
            <span class="c1"># breakpoint() </span>
            <span class="n">outdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_add_factor</span><span class="p">(</span><span class="n">outdf</span><span class="p">,</span><span class="n">silent</span><span class="p">)</span> 
            
            <span class="c1"># but only calculate if dummies are set</span>
        <span class="c1"># if exogenizing factors we can calculate an adjust factor model </span>
        
        
        
        
        <span class="k">if</span>  <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache_clear&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">dekomp</span><span class="o">.</span><span class="n">cache_clear</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_variables&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">keepvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlist</span><span class="p">(</span><span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep_variables&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="p">[</span><span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">keepvar</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keep_solutions</span><span class="p">[</span><span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keep&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;basedf&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setbase&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">basedf</span> <span class="o">=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newkwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;setlast&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span> <span class="o">=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outdf</span></div>

    
<div class="viewcode-block" id="Solver_Mixin.calc_add_factor">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.calc_add_factor">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_add_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outdf</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
            <span class="k">if</span> <span class="p">(</span><span class="n">select</span><span class="o">:=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="c1"># breakpoint()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running calc_adjust_model &#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Dummies set </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">find_fix_dummy_fixed</span><span class="p">(</span><span class="n">outdf</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_add_factor_model</span><span class="o">.</span><span class="n">current_per</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span>   
                <span class="n">out_add_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_add_factor_model</span><span class="p">(</span><span class="n">outdf</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span> <span class="c1"># calculate the adjustment factors </span>
                
                <span class="n">calc_add_factordf</span> <span class="o">=</span> <span class="n">out_add_factor</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_add_factor</span><span class="p">]</span> <span class="c1"># new adjust values </span>
                <span class="n">add_factordf</span>      <span class="o">=</span> <span class="n">outdf</span><span class="o">.</span><span class="n">loc</span>         <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_add_factor</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># old adjust values</span>
                <span class="n">new_add_factordf</span>  <span class="o">=</span> <span class="n">add_factordf</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">select</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">calc_add_factordf</span><span class="p">)</span>   <span class="c1"># update the old adjust values with the new ones, only when dummy is != 0</span>
                <span class="n">outdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">new_add_factordf</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_add_factordf</span> <span class="c1"># plug all adjust values into the result         </span>
                
            <span class="k">return</span> <span class="n">outdf</span> </div>




    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">showstartnr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
        <span class="n">variabler</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variabler</span><span class="p">}</span>

<div class="viewcode-block" id="Solver_Mixin.makelos">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.makelos">[docs]</a>
    <span class="k">def</span> <span class="nf">makelos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;sim&#39;</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">jitname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">solvename</span><span class="si">}</span><span class="s1">_jit&#39;</span>
        <span class="n">nojitname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">solvename</span><span class="si">}</span><span class="s1">_nojit&#39;</span>
        <span class="k">if</span> <span class="n">solvename</span> <span class="o">==</span> <span class="s1">&#39;sim&#39;</span><span class="p">:</span>
            <span class="n">solveout</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span>
                               <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">solvename</span> <span class="o">==</span> <span class="s1">&#39;sim1d&#39;</span><span class="p">:</span>
            <span class="n">solveout</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsolve1dcunk</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cache</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache&#39;</span><span class="p">,</span> <span class="s1">&#39;False&#39;</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">solvename</span> <span class="o">==</span> <span class="s1">&#39;newton&#39;</span><span class="p">:</span>
            <span class="n">solveout</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span>
                               <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solvename</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span>
            <span class="n">solveout</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outsolve2dcunk</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span>
                               <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">if</span>  <span class="n">newdata</span> <span class="ow">or</span> <span class="n">transpile_reset</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ljit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;New data or transpile_reset&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Create compiled solving function for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ljit</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">stringjit</span><span class="si">=}</span><span class="s1">  </span><span class="si">{</span><span class="n">transpile_reset</span><span class="si">=}</span><span class="s1">  </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;pro_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reusing the solver as no new data &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="n">transpile_reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">stringjit</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;now makelos makes a </span><span class="si">{</span><span class="n">solvename</span><span class="si">}</span><span class="s1"> jit function&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">make_los_text_jit</span> <span class="o">=</span> <span class="n">solveout</span><span class="p">()</span>
                    <span class="c1"># creates the los function</span>
                    <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">make_los_text_jit</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>
                    <span class="n">pro_jit</span><span class="p">,</span> <span class="n">core_jit</span><span class="p">,</span> <span class="n">epi_jit</span> <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># breakpoint()</span>
                   <span class="c1"># if we import from a cache, we assume that the dataframe is in the same order</span>
                    <span class="k">if</span> <span class="n">transpile_reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                        <span class="n">jitfilename</span><span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;modelsource/</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">_jitsolver.py&#39;</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                        <span class="n">jitfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">jitfilename</span><span class="p">)</span>
                        <span class="n">jitfile</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">transpile_reset</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="sa">f</span><span class="s2">&quot;pro_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="si">=}</span><span class="s1">  </span><span class="si">{</span><span class="n">jitfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">initfile</span> <span class="o">=</span> <span class="n">jitfile</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span><span class="s1">&#39;__init__.py&#39;</span> 
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">initfile</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">initfile</span><span class="p">,</span><span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">i</span><span class="p">:</span> 
                                <span class="n">i</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">transpile_reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">jitfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                            <span class="n">solvetext0</span> <span class="o">=</span> <span class="n">solveout</span><span class="p">()</span>
                            <span class="n">solvetext</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">solvetext0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]])</span>
                            <span class="n">solvetext</span> <span class="o">=</span> <span class="n">solvetext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="s1">&#39;cache=False&#39;</span><span class="p">,</span> <span class="s1">&#39;cache=True&#39;</span><span class="p">)</span>

                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jitfile</span><span class="p">,</span> <span class="s1">&#39;wt&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">solvetext</span><span class="p">)</span>
                            <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>  
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Writes the evaluation functon to </span><span class="si">{</span><span class="n">jitfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
                                
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Importing </span><span class="si">{</span><span class="n">jitfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>    
                        <span class="n">m1</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">jitfile</span><span class="o">.</span><span class="n">stem</span><span class="p">,</span><span class="n">jitfile</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

                        <span class="n">pro_jit</span><span class="p">,</span> <span class="n">core_jit</span><span class="p">,</span> <span class="n">epi_jit</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">prolog</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">core</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">epilog</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pro_jit</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;core_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">core_jit</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;epi_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">epi_jit</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;core_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;epi_</span><span class="si">{</span><span class="n">jitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">newdata</span> <span class="ow">or</span> <span class="n">transpile_reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">nojitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;now makelos makes a </span><span class="si">{</span><span class="n">solvename</span><span class="si">}</span><span class="s1"> solvefunction&#39;</span><span class="p">)</span>
                <span class="n">make_los_text</span> <span class="o">=</span> <span class="n">solveout</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_los_text</span> <span class="o">=</span> <span class="n">make_los_text</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">make_los_text</span><span class="p">,</span> <span class="nb">globals</span><span class="p">())</span>  <span class="c1"># creates the los function</span>
                <span class="n">pro</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">epi</span> <span class="o">=</span> <span class="n">make_los</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">nojitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pro</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;core_</span><span class="si">{</span><span class="n">nojitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">core</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;epi_</span><span class="si">{</span><span class="n">nojitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">epi</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;pro_</span><span class="si">{</span><span class="n">nojitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;core_</span><span class="si">{</span><span class="n">nojitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;epi_</span><span class="si">{</span><span class="n">nojitname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Solver_Mixin.is_newdata">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.is_newdata">[docs]</a>
    <span class="k">def</span> <span class="nf">is_newdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Determins if thius is the same databank as in the previous solution &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="c1"># fill all Missing value with 0.0</span>
            <span class="n">databank</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;matrix&#39;</span><span class="p">]]:</span>
                <span class="c1"># Make sure columns with matrixes are of this type</span>
                <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;O&#39;</span><span class="p">)</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">newdata</span><span class="p">,</span> <span class="n">databank</span></div>


<div class="viewcode-block" id="Solver_Mixin.sim">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.sim">[docs]</a>
    <span class="k">def</span> <span class="nf">sim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_test</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
            <span class="n">max_iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">absconv</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">relconv</span><span class="o">=</span><span class="n">DEFAULT_relconv</span><span class="p">,</span>
            <span class="n">stringjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">dumpvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Evaluates this model on a databank from start to end (means end in Danish). </span>

<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        </span>
<span class="sd">        Then it evaluates the function and returns the values to a the Dataframe in the databank.</span>

<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.      </span>
<span class="sd">        </span>
<span class="sd">        Solves using Gauss-Seidle </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :param databank: Input dataframe </span>
<span class="sd">        :type databank: dataframe</span>
<span class="sd">        :param start: start of simulation, defaults to &#39;&#39;</span>
<span class="sd">        :type start: optional</span>
<span class="sd">        :param end: end of simulation, defaults to &#39;&#39;</span>
<span class="sd">        :type end:  optional</span>
<span class="sd">        :param silent: keep simulation silent , defaults to 1</span>
<span class="sd">        :type silent: bool, optional</span>
<span class="sd">        :param samedata: the inputdata has exactly same structure as last simulation , defaults to 0</span>
<span class="sd">        :type samedata: bool, optional</span>
<span class="sd">        :param alfa: Dampeing factor, defaults to 1.0</span>
<span class="sd">        :type alfa: float, optional</span>
<span class="sd">        :param stats: Show statistic after finish, defaults to False</span>
<span class="sd">        :type stats: bool, optional</span>
<span class="sd">        :param first_test: Start testing af number og simulation, defaults to 5</span>
<span class="sd">        :type first_test: int, optional</span>
<span class="sd">        :param max_iterations: Max iterations, defaults to 200</span>
<span class="sd">        :type max_iterations: int, optional</span>
<span class="sd">        :param conv: variables to test for convergence, defaults to &#39;*&#39;</span>
<span class="sd">        :type conv: str, optional</span>
<span class="sd">        :param absconv: Test convergence for values above this, defaults to 0.01</span>
<span class="sd">        :type absconv: float, optional</span>
<span class="sd">        :param relconv: If relative movement is less, then convergence , defaults to DEFAULT_relconv</span>
<span class="sd">        :type relconv: float, optional</span>
<span class="sd">        :param stringjit: If just in time compilation do it on a string not a file to import, defaults to True</span>
<span class="sd">        :type stringjit: bool, optional</span>
<span class="sd">        :param transpile_reset: Ingnore previous transpiled model, defaults to False</span>
<span class="sd">        :type transpile_reset: bool, optional</span>
<span class="sd">        :param dumpvar: Variables for which to dump the iterations, defaults to &#39;*&#39;</span>
<span class="sd">        :type dumpvar: str, optional</span>
<span class="sd">        :param init: If True take previous periods value as starting value, defaults to False</span>
<span class="sd">        :type init: bool, optional</span>
<span class="sd">        :param ldumpvar: Dump iterations, defaults to False</span>
<span class="sd">        :type ldumpvar: bool, optional</span>
<span class="sd">        :param dumpwith: DESCRIPTION, defaults to 15</span>
<span class="sd">        :type dumpwith: int, optional</span>
<span class="sd">        :param dumpdecimal: DESCRIPTION, defaults to 5</span>
<span class="sd">        :type dumpdecimal: int, optional</span>
<span class="sd">        :param chunk: Chunk size of transpiled model, defaults to 30</span>
<span class="sd">        :type chunk: int, optional</span>
<span class="sd">        :param ljit: Use just in time compilation, defaults to False</span>
<span class="sd">        :type ljit: bool, optional</span>
<span class="sd">        :param timeon: Time the elements, defaults to False</span>
<span class="sd">        :type timeon: bool, optional</span>
<span class="sd">        :param fairopt: Fair taylor options, defaults to {&#39;fair_max_iterations&#39;: 1}</span>
<span class="sd">        :type fairopt: TYPE, optional</span>
<span class="sd">        :param progressbar: Show progress bar , defaults to False</span>
<span class="sd">        :type progressbar: TYPE, optional</span>
<span class="sd">        </span>
<span class="sd">        :return: A dataframe wilt the results </span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">starttimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fair_max_iterations</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span> <span class="o">**</span>
                               <span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Will start solving: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># if not self.eqcolumns(self.genrcolumns,databank.columns):</span>
        <span class="c1">#     databank=insertModelVar(databank,self)   # fill all Missing value with 0.0</span>
        <span class="c1">#     for i in [j for j in self.allvar.keys() if self.allvar[j][&#39;matrix&#39;]]:</span>
        <span class="c1">#         databank.loc[:,i]=databank.loc[:,i].astype(&#39;O&#39;)   #  Make sure columns with matrixes are of this type</span>
        <span class="c1">#     newdata = True</span>
        <span class="c1"># else:</span>
        <span class="c1">#     newdata = False</span>

        <span class="n">newdata</span><span class="p">,</span> <span class="n">databank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_newdata</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pro2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epi2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makelos</span><span class="p">(</span>
            <span class="n">databank</span><span class="p">,</span> <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;sim&#39;</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="n">stringjit</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="n">transpile_reset</span><span class="p">,</span> 
            <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">newdata</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># convvar = [conv.upper()] if isinstance(conv,str) else [c.upper() for c in conv] if conv != [] else list(self.endogene)</span>
        <span class="n">convvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="c1"># this is how convergence is measured</span>
        <span class="n">convplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">endoplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)]</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>

        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">bars</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{desc}</span><span class="s1">: </span><span class="si">{percentage:3.0f}</span><span class="s1">%|</span><span class="si">{bar}</span><span class="s1">| </span><span class="si">{n_fmt}</span><span class="s1">/</span><span class="si">{total_fmt}</span><span class="s1">&#39;</span>

        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fair_max_iterations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sol_periode</span><span class="p">),</span><span class="n">disable</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">progressbar</span><span class="p">,</span><span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Solving </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">bar_format</span><span class="o">=</span><span class="n">bars</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>              
                <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
    
                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">endoplace</span><span class="p">:</span>
                            <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                    <span class="n">itbefore</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">convplace</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pro2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>  <span class="n">row</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluate </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">solve2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                                                  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">first_test</span><span class="p">:</span>
                            <span class="n">itafter</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">convplace</span><span class="p">]</span>
                            <span class="n">select</span> <span class="o">=</span> <span class="n">absconv</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">itbefore</span><span class="p">)</span>
                            <span class="n">convergence</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">itafter</span><span class="o">-</span><span class="n">itbefore</span><span class="p">)[</span><span class="n">select</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">itbefore</span><span class="p">[</span><span class="n">select</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">relconv</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">convergence</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                                <span class="k">break</span>
                            <span class="n">itbefore</span> <span class="o">=</span> <span class="n">itafter</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
    
                    <span class="bp">self</span><span class="o">.</span><span class="n">epi2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flop_get</span><span class="p">[</span><span class="s1">&#39;core&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span><span class="o">+</span>
                 <span class="nb">len</span><span class="p">(</span><span class="n">sol_periode</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flop_get</span><span class="p">[</span><span class="s1">&#39;prolog&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">flop_get</span><span class="p">[</span><span class="s1">&#39;epilog&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Foating point operations  core       :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flop_get</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Foating point operations  prolog     :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flop_get</span><span class="p">[</span><span class="s2">&quot;prolog&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Foating point operations  epilog     :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flop_get</span><span class="p">[</span><span class="s2">&quot;epilog&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Simulation period                    :</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sol_periode</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Floating point operations per second :</span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="Solver_Mixin.grouper">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.grouper">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">grouper</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="s2">&quot;Collect data into fixed-length chunks or blocks&quot;</span>
        <span class="c1"># grouper(&#39;ABCDEFG&#39;, 3, &#39;x&#39;) --&gt; ABC DEF Gxx&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)]</span> <span class="o">*</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">zip_longest</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">fillvalue</span><span class="o">=</span><span class="n">fillvalue</span><span class="p">)</span></div>


<div class="viewcode-block" id="Solver_Mixin.outsolve2dcunk">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.outsolve2dcunk">[docs]</a>
    <span class="k">def</span> <span class="nf">outsolve2dcunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span>
                       <span class="n">debug</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a evaluater function called los</span>

<span class="sd">        The model axcess the data through:Dataframe.value[rowindex+lag,coloumnindex] which is very efficient </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">short</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">longer</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span>
        <span class="n">columnsnr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_columnsnr</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="c1">#print(f&#39;Generating source for {self.name} using ljit = {ljit} &#39;)</span>

        <span class="k">def</span> <span class="nf">make_gaussline2</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a line in a gauss-seidel solver for </span>
<span class="sd">            simultanius models</span>
<span class="sd">            the variables            </span>

<span class="sd">            New version to take hand of several lhs variables. Dampning is not allowed for</span>
<span class="sd">            this. But can easely be implemented by makeing a function to multiply tupels</span>
<span class="sd">            nodamp is for pre and epilog solutions, which should not be dampened. </span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">termer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
            <span class="n">assigpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nodamp</span><span class="p">:</span>
                <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># convention for damping equations</span>
                <span class="k">if</span> <span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">],</span> <span class="s1">&#39;DAMP&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">]:</span>
                    <span class="k">assert</span> <span class="n">assigpos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;You can not dampen equations with several left hand sides:&#39;</span><span class="o">+</span><span class="n">vx</span>
                    <span class="n">endovar</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span> <span class="k">else</span> <span class="p">(</span>
                        <span class="s1">&#39;values[row,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">assigpos</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># to implemet dampning of solution</span>
                    <span class="n">damp</span> <span class="o">=</span> <span class="s1">&#39;(1-alfa)*(&#39;</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">endovar</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)+alfa*(&#39;</span>
                    <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ldamp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># drop the trailing $</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">assigpos</span> <span class="ow">and</span> <span class="n">ldamp</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">damp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">assigpos</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ldamp</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>  <span class="c1"># the last ) in the dampening</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">def</span> <span class="nf">make_resline2</span><span class="p">(</span><span class="n">vx</span><span class="p">,</span> <span class="n">nodamp</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a line calculating linne</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">termer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
            <span class="n">assigpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">termer</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>  <span class="c1"># drop the trailing $</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">:</span>
                    <span class="n">lag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">assigpos</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;outvalues[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;values[row&#39;</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">columnsnr</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">def</span> <span class="nf">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">chunknumber</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">totalchunk</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; creates the source of  an evaluation function </span>
<span class="sd">            keeps tap of how many equations and lines is in the functions abowe. </span>
<span class="sd">            This allows the errorfunction to retriewe the variable for which a math error is thrown </span>

<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">fib1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fib2</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="c1"># fib1.append((short+&#39;print(&quot;&#39;+f&quot;Compiling chunk {chunknumber+1}/{totalchunk}     &quot;+&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) \n&#39;) if ljit else &#39;&#39;)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">short</span><span class="o">+</span><span class="s1">&#39;@jit(&quot;(f8[:,:],f8[:,:],i8,f8)&quot;,fastmath=True,cache=False,nopython=True)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span> <span class="o">+</span>
                        <span class="s1">&#39;(values,outvalues,row,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib1.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;try :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span><span class="o">+</span><span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">newoverhead</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">)</span> <span class="o">+</span> <span class="n">overhead</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">longer</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;pass  # &#39;</span><span class="o">+</span><span class="n">v</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span>
                       <span class="k">else</span> <span class="n">linemake</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">nodamp</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span> <span class="o">+</span> <span class="s1">&#39;except :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">longer</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;errorfunk(values,sys.exc_info()[2].tb_lineno,overhead=</span><span class="si">{</span><span class="n">newoverhead</span><span class="si">}</span><span class="s1">,overeq=</span><span class="si">{</span><span class="n">oldeqs</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span> <span class="o">+</span> <span class="s1">&#39;raise</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">long</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">longer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;return </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">neweq</span> <span class="o">=</span> <span class="n">oldeqs</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">fib2</span><span class="p">)),</span> <span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span> <span class="n">neweq</span>

        <span class="k">def</span> <span class="nf">makechunkedfunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; makes the complete function to evaluate the model. </span>
<span class="sd">            keeps the tab on previous overhead lines and equations, to helt the error function &#39;&#39;&#39;</span>

            <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">overhead</span>
            <span class="n">neweqs</span> <span class="o">=</span> <span class="n">oldeqs</span>
            <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">orderlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orderlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouper</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">chunk</span><span class="p">))</span>
            <span class="n">fib</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fib2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;pbar = tqdm.tqdm(total=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">orderlist</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
                           <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;desc=&#39;Compile </span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">6</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="o">+</span><span class="s2">&quot;,unit=&#39;code chunk&#39;,bar_format =&#39;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> </span><span class="si">{rate_fmt}{postfix}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">eques</span> <span class="o">=</span> <span class="n">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">o</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">newoverhead</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="n">nodamp</span><span class="p">,</span>
                                               <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">neweqs</span><span class="p">,</span> <span class="n">totalchunk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">orderlist</span><span class="p">))</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">head</span>
                <span class="n">neweqs</span> <span class="o">=</span> <span class="n">eques</span>
                <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;pbar.update(1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="c1"># fib2.append((short+&#39;print(&quot;&#39;+f&quot;Compiling a mastersolver     &quot;+&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) \n&#39;) if ljit else &#39;&#39;)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">short</span><span class="o">+</span><span class="s1">&#39;@jit(&quot;(f8[:,:],f8[:,:],i8,f8)&quot;,fastmath=True,cache=False,nopython=True)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;pbar.close()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span> <span class="o">+</span>
                        <span class="s1">&#39;(values,outvalues,row,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib2.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">long</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;(values,outvalues,row,alfa=alfa)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">)]</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;return  </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fib</span><span class="o">+</span><span class="n">fib2</span><span class="p">,</span> <span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span> <span class="n">neweqs</span>

        <span class="n">linemake</span> <span class="o">=</span> <span class="n">make_resline2</span> <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;res&#39;</span> <span class="k">else</span> <span class="n">make_gaussline2</span>
        <span class="n">fib2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fib1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;def make_los(funks=[],errorfunk=None):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;import time&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;import tqdm&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from numba import jit&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modeluserfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">userfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modelBLfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">BLfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">funktext</span> <span class="o">=</span> <span class="p">[</span><span class="n">short</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; = funks[&#39;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funktext</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;make model text&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span><span class="p">:</span>
                <span class="n">procontent</span><span class="p">,</span> <span class="n">prooverhead</span><span class="p">,</span> <span class="n">proeqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span>
                    <span class="n">fib1</span><span class="p">),</span> <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">content</span><span class="p">,</span> <span class="n">conoverhead</span><span class="p">,</span> <span class="n">coneqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                    <span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">epilog</span><span class="p">,</span> <span class="n">epioverhead</span><span class="p">,</span> <span class="n">epieqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                    <span class="s1">&#39;epilog&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epiorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">procontent</span><span class="p">,</span> <span class="n">prooverhead</span><span class="p">,</span> <span class="n">proeqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span>
                    <span class="n">fib1</span><span class="p">),</span> <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">content</span><span class="p">,</span> <span class="n">conoverhead</span><span class="p">,</span> <span class="n">coneqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                    <span class="s1">&#39;core&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
                <span class="n">epilog</span><span class="p">,</span> <span class="n">epioverhead</span><span class="p">,</span> <span class="n">epieqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                    <span class="s1">&#39;epilog&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">)</span>

        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;return prolog,core,epilog</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span> <span class="n">procontent</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">epilog</span><span class="p">,</span> <span class="n">fib2</span><span class="p">))</span></div>


<div class="viewcode-block" id="Solver_Mixin.sim1d">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.sim1d">[docs]</a>
    <span class="k">def</span> <span class="nf">sim1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
              <span class="n">max_iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">absconv</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">relconv</span><span class="o">=</span><span class="n">DEFAULT_relconv</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">dumpvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">timeon</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to end (means end in Danish). </span>

<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>

<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">starttimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fair_max_iterations</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span> <span class="o">**</span>
                               <span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
        <span class="c1"># fill all Missing value with 0.0</span>
        <span class="n">databank</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;create stuffer and gauss lines &#39;</span><span class="p">,</span> <span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stuff3&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">eqcolumns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simcolumns</span><span class="p">,</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stuff3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createstuff3</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">simcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Create solver function&#39;</span><span class="p">,</span> <span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">this_pro1d</span><span class="p">,</span> <span class="n">this_solve1d</span><span class="p">,</span> <span class="n">this_epi1d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makelos</span><span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;sim1d&#39;</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="n">stringjit</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="n">transpile_reset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">values_</span> <span class="o">=</span> <span class="n">values</span>  <span class="c1"># for use in errdump</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">convvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
<span class="c1">#        convplace=[databank.columns.get_loc(c) for c in convvar] # this is how convergence is measured</span>
        <span class="n">convplace</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="o">-</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;maxlead&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>
        <span class="n">endoplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)]</span>

        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;startnr&#39;</span><span class="p">]</span> <span class="o">-</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;maxlead&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>

        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fair_max_iterations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">row_</span> <span class="o">=</span> <span class="n">row</span>
                <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">endoplace</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;stuff </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stuff3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">ljit</span><span class="p">)</span>
<span class="c1">#</span>
                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                                                                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>

                <span class="n">itbeforeold</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span>
                <span class="n">itbefore</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">convplace</span><span class="p">]</span>
                <span class="n">this_pro1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Evaluate </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">,</span> <span class="n">timeon</span><span class="p">)</span> <span class="k">as</span> <span class="n">t</span><span class="p">:</span>
                        <span class="n">this_solve1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                    <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
                                                                                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="n">first_test</span><span class="p">:</span>
                        <span class="n">itafter</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">convplace</span><span class="p">]</span>
                        <span class="c1"># breakpoint()</span>
                        <span class="n">select</span> <span class="o">=</span> <span class="n">absconv</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">itbefore</span><span class="p">)</span>
                        <span class="n">convergence</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">itafter</span><span class="o">-</span><span class="n">itbefore</span><span class="p">)[</span><span class="n">select</span><span class="p">])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">itbefore</span><span class="p">[</span><span class="n">select</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">relconv</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">convergence</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="n">itbefore</span> <span class="o">=</span> <span class="n">itafter</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                    
                <span class="n">this_epi1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_</span>  <span class="c1"># not needed any more</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; finished &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="Solver_Mixin.outsolve1dcunk">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.outsolve1dcunk">[docs]</a>
    <span class="k">def</span> <span class="nf">outsolve1dcunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;False&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; takes a list of terms and translates to a evaluater function called los</span>

<span class="sd">        The model axcess the data through:Dataframe.value[rowindex+lag,coloumnindex] which is very efficient </span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">short</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">longer</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">12</span> <span class="o">*</span> <span class="s1">&#39; &#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">findpos</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">thisdebug</span> <span class="o">=</span> <span class="n">debug</span>

        <span class="k">def</span> <span class="nf">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">chunknumber</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">totalchunk</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; creates the source of  an evaluation function </span>
<span class="sd">            keeps tap of how many equations and lines is in the functions abowe. </span>
<span class="sd">            This allows the errorfunction to retriewe the variable for which a math error is thrown </span>

<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">fib1</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fib2</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="c1"># fib1.append((short+&#39;print(&quot;&#39;+f&quot;Compiling chunk {chunknumber+1}/{totalchunk}     &quot;+&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) \n&#39;) if ljit else &#39;&#39;)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;@jit(&quot;(f8[:],f8)&quot;,fastmath=True,cache=</span><span class="si">{</span><span class="n">cache</span><span class="si">}</span><span class="s1">,nopython=True)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;(a,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib1.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;try :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span><span class="o">+</span><span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">newoverhead</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fib1</span><span class="p">)</span> <span class="o">+</span> <span class="n">overhead</span>
            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span><span class="n">longer</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;pass  # &#39;</span><span class="o">+</span><span class="n">v</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;dropfrml&#39;</span><span class="p">]</span>
                       <span class="k">else</span> <span class="n">linemake</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">nodamp</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span> <span class="o">+</span> <span class="s1">&#39;except :</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">longer</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;errorfunk(a,sys.exc_info()[2].tb_lineno,overhead=</span><span class="si">{</span><span class="n">newoverhead</span><span class="si">}</span><span class="s1">,overeq=</span><span class="si">{</span><span class="n">oldeqs</span><span class="si">}</span><span class="s1">)&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longer</span> <span class="o">+</span> <span class="s1">&#39;raise</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">long</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">longer</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;return </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">neweq</span> <span class="o">=</span> <span class="n">oldeqs</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">fib2</span><span class="p">)),</span> <span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span> <span class="n">neweq</span>

        <span class="k">def</span> <span class="nf">makechunkedfunk</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; makes the complete function to evaluate the model. </span>
<span class="sd">            keeps the tab on previous overhead lines and equations, to helt the error function &#39;&#39;&#39;</span>

            <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">overhead</span>
            <span class="n">neweqs</span> <span class="o">=</span> <span class="n">oldeqs</span>
            <span class="k">if</span> <span class="n">chunk</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">orderlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orderlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grouper</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">chunk</span><span class="p">))</span>
            <span class="n">fib</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fib2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;pbar = tqdm.tqdm(total=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">orderlist</span><span class="p">)</span><span class="si">}</span><span class="s2">,&quot;</span>
                           <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;desc=&#39;Compile </span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">6</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="o">+</span><span class="s2">&quot;,unit=&#39;code chunk&#39;,bar_format =&#39;</span><span class="si">{l_bar}{bar}</span><span class="s2">| </span><span class="si">{n_fmt}</span><span class="s2">/</span><span class="si">{total_fmt}</span><span class="s2"> </span><span class="si">{rate_fmt}{postfix}</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">):</span>
                <span class="n">lines</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">eques</span> <span class="o">=</span> <span class="n">makeafunk</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">o</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">newoverhead</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="n">nodamp</span><span class="p">,</span>
                                               <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">neweqs</span><span class="p">,</span> <span class="n">totalchunk</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">orderlist</span><span class="p">))</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">newoverhead</span> <span class="o">=</span> <span class="n">head</span>
                <span class="n">neweqs</span> <span class="o">=</span> <span class="n">eques</span>
                <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                    <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;pbar.update(1)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">ljit</span><span class="p">:</span>
                <span class="c1"># fib2.append((short+&#39;print(&quot;&#39;+f&quot;Compiling a mastersolver     &quot;+&#39;&quot;,time.strftime(&quot;%H:%M:%S&quot;)) \n&#39;) if ljit else &#39;&#39;)</span>
                <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s1">&#39;@jit(&quot;(f8[:],f8)&quot;,fastmath=True,cache=</span><span class="si">{</span><span class="n">cache</span><span class="si">}</span><span class="s1">,nopython=True)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">fib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;pbar.close()</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;def &#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;(a,alfa=1.0):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">#            fib2.append(long + &#39;outvalues = values \n&#39;)</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="p">[</span><span class="n">long</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;(a,alfa=alfa)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span>
                                                          <span class="n">ch</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orderlist</span><span class="p">)]</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
            <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">long</span><span class="o">+</span><span class="s1">&#39;return  </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fib</span><span class="o">+</span><span class="n">fib2</span><span class="p">,</span> <span class="n">newoverhead</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">fib2</span><span class="p">),</span> <span class="n">neweqs</span>

        <span class="n">linemake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gaussline</span>
        <span class="n">fib2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fib1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;def make_los(funks=[],errorfunk=None):</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;import time&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;import tqdm&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from numba import jit&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modeluserfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">userfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;from modelBLfunk import &#39;</span> <span class="o">+</span>
                    <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">BLfunk</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">funktext</span> <span class="o">=</span> <span class="p">[</span><span class="n">short</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; = funks[&#39;</span> <span class="o">+</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funks</span><span class="p">)]</span>
        <span class="n">fib1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funktext</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span><span class="p">:</span>
            <span class="n">procontent</span><span class="p">,</span> <span class="n">prooverhead</span><span class="p">,</span> <span class="n">proeqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">preorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span>
                <span class="n">fib1</span><span class="p">),</span>   <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>     <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">content</span><span class="p">,</span> <span class="n">conoverhead</span><span class="p">,</span> <span class="n">coneqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                <span class="s1">&#39;core&#39;</span><span class="p">,</span>   <span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">epilog</span><span class="p">,</span> <span class="n">epioverhead</span><span class="p">,</span> <span class="n">epieqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                <span class="s1">&#39;epilog&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epiorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">nodamp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">procontent</span><span class="p">,</span> <span class="n">prooverhead</span><span class="p">,</span> <span class="n">proeqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span><span class="s1">&#39;prolog&#39;</span><span class="p">,</span> <span class="p">[],</span>            <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span>
                <span class="n">fib1</span><span class="p">),</span>  <span class="n">oldeqs</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>      <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">content</span><span class="p">,</span> <span class="n">conoverhead</span><span class="p">,</span> <span class="n">coneqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                <span class="s1">&#39;core&#39;</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">,</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">prooverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">proeqs</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="n">epilog</span><span class="p">,</span> <span class="n">epioverhead</span><span class="p">,</span> <span class="n">epieqs</span> <span class="o">=</span> <span class="n">makechunkedfunk</span><span class="p">(</span>
                <span class="s1">&#39;epilog&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">linemake</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="n">conoverhead</span><span class="p">,</span> <span class="n">oldeqs</span><span class="o">=</span><span class="n">coneqs</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">thisdebug</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>

        <span class="n">fib2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short</span> <span class="o">+</span> <span class="s1">&#39;return prolog,core,epilog</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">fib1</span><span class="p">,</span> <span class="n">procontent</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">epilog</span><span class="p">,</span> <span class="n">fib2</span><span class="p">))</span></div>


<div class="viewcode-block" id="Solver_Mixin.newton">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.newton">[docs]</a>
    <span class="k">def</span> <span class="nf">newton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">newton_absconv</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
               <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">absconv</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">relconv</span><span class="o">=</span><span class="n">DEFAULT_relconv</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">newton_reset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">dumpvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lnjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">newtonalfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newtonnodamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to end (means end in Danish). </span>

<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>

<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>

<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">starttimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fair_max_iterations</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span> <span class="o">**</span>
                               <span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="c1"># if not self.eqcolumns(self.genrcolumns,databank.columns):</span>
        <span class="c1">#     databank=insertModelVar(databank,self)   # fill all Missing value with 0.0</span>
        <span class="c1">#     for i in [j for j in self.allvar.keys() if self.allvar[j][&#39;matrix&#39;]]:</span>
        <span class="c1">#         databank.loc[:,i]=databank.loc[:,i].astype(&#39;O&#39;)   #  Make sure columns with matrixes are of this type</span>
        <span class="c1">#     newdata = True</span>
        <span class="c1"># else:</span>
        <span class="c1">#     newdata = False</span>

        <span class="n">newdata</span><span class="p">,</span> <span class="n">databank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_newdata</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makelos</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;newton&#39;</span><span class="p">,</span>
                                                                     <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="n">stringjit</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="n">transpile_reset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">newdata</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;newton_1per_diff&#39;</span><span class="p">):</span>
            <span class="n">endovar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_preorder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="n">forcenum</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span>
                                                <span class="n">endovar</span><span class="o">=</span><span class="n">endovar</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">lnjit</span><span class="p">,</span> <span class="n">nchunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">onlyendocur</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;newton_1per_solver&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">newton_reset</span><span class="p">:</span>
            <span class="c1"># breakpoint()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">newton_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span>
            <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">convvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="c1"># this is how convergence is measured</span>
        <span class="n">convplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>
        <span class="n">endoplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="p">)]</span>

        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>

        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fair_max_iterations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">endoplace</span><span class="p">:</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>

                <span class="n">itbefore</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>  <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sim per:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                        <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">newton_col</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="n">now</span> <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">newton_col</span><span class="p">]</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span><span class="o">-</span><span class="n">before</span>
                        <span class="n">newton_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;Iteration  </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> Sum of distances </span><span class="si">{</span><span class="n">newton_conv</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="mi">6</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="n">newton_absconv</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="c1"># breakpoint()</span>
                        <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">):</span>
                            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                                    <span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_solver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span>
                                    <span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">]</span>

                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">):</span>
                            <span class="c1">#            update = self.solveinv(distance)</span>
                            <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_1per_solver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                            <span class="n">damp</span> <span class="o">=</span> <span class="n">newtonalfa</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">newtonnodamp</span> <span class="k">else</span> <span class="mf">1.0</span>

                        <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">newton_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">update</span> <span class="o">*</span> <span class="n">damp</span>

                    <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    <span class="c1">#                if iteration &gt; first_test:</span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace]</span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1"># print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break</span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="Solver_Mixin.newtonstack">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.newtonstack">[docs]</a>
    <span class="k">def</span> <span class="nf">newtonstack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">newton_absconv</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                    <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">absconv</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">relconv</span><span class="o">=</span><span class="n">DEFAULT_relconv</span><span class="p">,</span>
                    <span class="n">dumpvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">nchunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">newtonalfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newtonnodamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">newton_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to end (means end in Danish). </span>

<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>

<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>

<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diffcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">starttimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fair_max_iterations</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span> <span class="o">**</span>
                               <span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">newdata</span><span class="p">,</span> <span class="n">databank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_newdata</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makelos</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;newton&#39;</span><span class="p">,</span>
                                                                     <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="n">stringjit</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="n">transpile_reset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">newdata</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;newton_diff_stack&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="n">forcenum</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">nljit</span><span class="p">,</span> <span class="n">nchunk</span><span class="o">=</span><span class="n">nchunk</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stacksolver&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">get_solvestacked</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new derivatives and new solver&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">newton_reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="n">sol_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
            <span class="c1"># breakpoint()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new solver&#39;</span><span class="p">)</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">newton_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span>
            <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">timeit</span> <span class="o">=</span> <span class="n">timeit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">convvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="c1"># this is how convergence is measured</span>
        <span class="n">convplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>

        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">r</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">newton_col</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">newton_col</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="c1"># breakpoint()</span>


<span class="c1">#                if ldumpvar:</span>
<span class="c1">#                    self.dumplist.append([fairiteration,self.periode,int(0)]+[values[row,p]</span>
<span class="c1">#                        for p in dumpplac])</span>

<span class="c1">#        itbefore = values[self.stackrows,convplace]</span>
<span class="c1">#        self.pro2d(values, values,  row ,  alfa )</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Newton it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;calculate new solution&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sol_periode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                                               <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;extract new solution&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>
                    <span class="n">now</span> <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span><span class="o">-</span><span class="n">before</span>
                <span class="n">newton_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Iteration  </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> Sum of distances </span><span class="si">{</span><span class="n">newton_conv</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="mi">6</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="n">newton_absconv</span><span class="p">:</span>
                    <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">):</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsolver</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">)</span>
                        <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">):</span>
                    <span class="c1">#            update = self.solveinv(distance)</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacksolver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                    <span class="n">damp</span> <span class="o">=</span> <span class="n">newtonalfa</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">newtonnodamp</span> <span class="k">else</span> <span class="mf">1.0</span>
                <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">damp</span> <span class="o">*</span> <span class="n">update</span>

    <span class="c1">#                if iteration &gt; first_test:</span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace]</span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1"># print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break</span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
<span class="c1">#                self.epistack2d(values, values, row ,  alfa )</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total model evaluations              :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of solver update              :</span><span class="si">{</span><span class="n">diffcount</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="Solver_Mixin.newton_un_normalized">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.newton_un_normalized">[docs]</a>
    <span class="k">def</span> <span class="nf">newton_un_normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">newton_absconv</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                             <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">absconv</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">relconv</span><span class="o">=</span><span class="n">DEFAULT_relconv</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">newton_reset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">dumpvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lnjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                             <span class="n">newtonalfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newtonnodamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to end (means end in Danish). </span>

<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>

<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>

<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">starttimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fair_max_iterations</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span> <span class="o">**</span>
                               <span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Will start calculating: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">newdata</span><span class="p">,</span> <span class="n">databank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_newdata</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makelos</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;newton&#39;</span><span class="p">,</span>
                                                                     <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="n">stringjit</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="n">transpile_reset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">newdata</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># endovar = self.solveorder</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;newton_diff&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="n">forcenum</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span>
                                           <span class="n">endovar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">lnjit</span><span class="p">,</span> <span class="n">nchunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">onlyendocur</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;newun1persolver&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">newton_reset</span><span class="p">:</span>
            <span class="c1"># breakpoint()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newun1persolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span>
                <span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]])[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="n">newton_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span>
            <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        <span class="n">newton_col_endo</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span>
            <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">convvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="c1"># this is how convergence is measured</span>
        <span class="n">convplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">,</span> <span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">fairiteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fair_max_iterations</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Fair-Taylor iteration: </span><span class="si">{</span><span class="n">fairiteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>

                <span class="n">itbefore</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convplace</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span>  <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sim per:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                        <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">newton_col_endo</span><span class="p">]</span>
                        
                        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        
                        
                        <span class="n">now</span> <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">newton_col</span><span class="p">]</span>
                        <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span>
                        <span class="n">newton_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s1">&#39;Iteration  </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> Sum of distances </span><span class="si">{</span><span class="n">newton_conv</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="mi">6</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="n">newton_absconv</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">):</span>
                            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                                    <span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">newun1persolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff</span><span class="o">.</span><span class="n">get_solve1per</span><span class="p">(</span>
                                    <span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">]</span>
                        <span class="c1"># breakpoint()</span>
                        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="c1">#            update = self.solveinv(distance)</span>
                            <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newun1persolver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                            <span class="c1"># breakpoint()</span>

                        <span class="n">damp</span> <span class="o">=</span> <span class="n">newtonalfa</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">newtonnodamp</span> <span class="k">else</span> <span class="mf">1.0</span>
                        <span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">newton_col_endo</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">damp</span><span class="o">*</span><span class="n">update</span>

                    <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fairiteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                                              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    <span class="c1">#                if iteration &gt; first_test:</span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace]</span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1"># print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break</span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="si">}</span><span class="s1"> Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total iterations                     :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Total floating point operations      :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Floating point operations per second : </span><span class="si">{</span><span class="n">numberfloats</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="Solver_Mixin.newtonstack_un_normalized">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.newtonstack_un_normalized">[docs]</a>
    <span class="k">def</span> <span class="nf">newtonstack_un_normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">first_test</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">newton_absconv</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                                  <span class="n">max_iterations</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">absconv</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">relconv</span><span class="o">=</span><span class="n">DEFAULT_relconv</span><span class="p">,</span>
                                  <span class="n">dumpvar</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">ldumpvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dumpwith</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">dumpdecimal</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">nchunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">fairopt</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">newtonalfa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">newtonnodamp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">newton_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Evaluates this model on a databank from start to end (means end in Danish). </span>

<span class="sd">        First it finds the values in the Dataframe, then creates the evaluater function through the *outeval* function </span>
<span class="sd">        (:func:`modelclass.model.fouteval`) </span>
<span class="sd">        then it evaluates the function and returns the values to a the Dataframe in the databank.</span>

<span class="sd">        The text for the evaluater function is placed in the model property **make_los_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>

<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">diffcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">starttimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">fair_max_iterations</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fairopt</span><span class="p">,</span> <span class="o">**</span>
                               <span class="n">kwargs</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fair_max_iterations &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="n">newdata</span><span class="p">,</span> <span class="n">databank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_newdata</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makelos</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;newton&#39;</span><span class="p">,</span>
                                                                     <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="n">stringjit</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="n">transpile_reset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">newdata</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;newton_diff_stack&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="n">forcenum</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">databank</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="n">nljit</span><span class="p">,</span> <span class="n">nchunk</span><span class="o">=</span><span class="n">nchunk</span><span class="p">,</span> <span class="n">timeit</span><span class="o">=</span><span class="n">timeit</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stackunsolver&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Calculating new derivatives and create new stacked Newton solver&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getstackunsolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">get_solvestacked</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stackunsolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getstackunsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">newton_reset</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="n">sol_periode</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Creating new stacked Newton solver&#39;</span><span class="p">)</span>
            <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stackunsolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getstackunsolver</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old_stack_periode</span> <span class="o">=</span> <span class="n">sol_periode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">newton_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span>
            <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">newton_col_endo</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span>
            <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">timeit</span> <span class="o">=</span> <span class="n">timeit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">convvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coreorder</span><span class="p">,</span> <span class="n">conv</span><span class="p">)</span>
        <span class="c1"># this is how convergence is measured</span>
        <span class="n">convplace</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">convvar</span><span class="p">]</span>
        <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">,</span> <span class="n">dumpvar</span><span class="p">)</span>
            <span class="n">dumpplac</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">]</span>

        <span class="n">ittotal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">endtimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">r</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">newton_col</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">newton_col</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex_endo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">newton_col_endo</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


<span class="c1">#                if ldumpvar:</span>
<span class="c1">#                    self.dumplist.append([fairiteration,self.periode,int(0)]+[values[row,p]</span>
<span class="c1">#                        for p in dumpplac])</span>

<span class="c1">#        itbefore = values[self.stackrows,convplace]</span>
<span class="c1">#        self.pro2d(values, values,  row ,  alfa )</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Newton it:</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
                <span class="n">before</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex_endo</span><span class="p">]</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;calculate new solution&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sol_periode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pronew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">solvenew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">epinew2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                        <span class="n">ittotal</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;extract new solution&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t2</span><span class="p">:</span>
                    <span class="n">now</span> <span class="o">=</span> <span class="n">outvalues</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex</span><span class="p">]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">now</span>
                <span class="n">newton_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="c1"># breakpoint()</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Iteration  </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> Sum of distances </span><span class="si">{</span><span class="n">newton_conv</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">25</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="mi">12</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newton_conv</span> <span class="o">&lt;=</span> <span class="n">newton_absconv</span><span class="p">:</span>
                    <span class="n">convergence</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">iteration</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nonlin</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">%</span> <span class="n">nonlin</span><span class="p">):</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Updating solver&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">t3</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updating solver, iteration </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stackunsolver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getstackunsolver</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_now</span><span class="p">)</span>
                        <span class="n">diffcount</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;Update solution&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">):</span>
                    <span class="c1">#            update = self.solveinv(distance)</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackunsolver</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>
                    <span class="n">damp</span> <span class="o">=</span> <span class="n">newtonalfa</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">newtonnodamp</span> <span class="k">else</span> <span class="mf">1.0</span>
                <span class="n">values</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrowindex</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">stackcolindex_endo</span><span class="p">]</span> <span class="o">=</span> <span class="n">before</span> <span class="o">-</span> <span class="n">damp</span> <span class="o">*</span> <span class="n">update</span>

                <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">periode</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">):</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">periode</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">values</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">p</span><span class="p">]</span>
                                                                             <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">dumpplac</span><span class="p">])</span>
    <span class="c1">#                if iteration &gt; first_test:</span>
    <span class="c1">#                    itafter=[values[row,c] for c in convplace]</span>
    <span class="c1">#                    convergence = True</span>
    <span class="c1">#                    for after,before in zip(itafter,itbefore):</span>
    <span class="c1"># print(before,after)</span>
    <span class="c1">#                        if before &gt; absconv and abs(after-before)/abs(before)  &gt; relconv:</span>
    <span class="c1">#                            convergence = False</span>
    <span class="c1">#                            break</span>
    <span class="c1">#                    if convergence:</span>
    <span class="c1">#                        break</span>
    <span class="c1">#                    else:</span>
    <span class="c1">#                        itbefore=itafter</span>
<span class="c1">#                self.epistack2d(values, values, row ,  alfa )</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">convergence</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Not converged in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Solved in </span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s1"> iterations&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ldumpvar</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span>
            <span class="k">if</span> <span class="n">fair_max_iterations</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">ittotal</span>
            <span class="n">diff_numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newton_diff_stack</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">)</span><span class="o">*</span><span class="n">diffcount</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                       :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Total model evaluations                    :</span><span class="si">{</span><span class="n">ittotal</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Number of solver update                    :</span><span class="si">{</span><span class="n">diffcount</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)                  :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Floating point operations in model         : </span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Floating point operations in jacobi model  : </span><span class="si">{</span><span class="n">diff_numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; solved  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="Solver_Mixin.res">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.res">[docs]</a>
    <span class="k">def</span> <span class="nf">res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">chunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">alfa</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stats</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">samedata</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;calculates the result of a model, no iteration or interaction </span>
<span class="sd">        The text for the evaluater function is placed in the model property **make_res_text** </span>
<span class="sd">        where it can be inspected </span>
<span class="sd">        in case of problems.         </span>

<span class="sd">        &#39;&#39;&#39;</span>
    <span class="c1">#    print(&#39;new nwwton&#39;)</span>
        <span class="n">starttimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">sol_periode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">databank</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_sim_smpl</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="c1"># fill all Missing value with 0.0</span>
        <span class="n">databank</span> <span class="o">=</span> <span class="n">insertModelVar</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">newdata</span><span class="p">,</span> <span class="n">databank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_newdata</span><span class="p">(</span><span class="n">databank</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prores2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveres2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epires2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makelos</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="n">solvename</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">,</span>
                                                                     <span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span><span class="p">,</span> <span class="n">stringjit</span><span class="o">=</span><span class="n">stringjit</span><span class="p">,</span> <span class="n">transpile_reset</span><span class="o">=</span><span class="n">transpile_reset</span><span class="p">,</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunk</span><span class="p">,</span> <span class="n">newdata</span><span class="o">=</span><span class="n">newdata</span><span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outvalues</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">res_col</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">endtimesetup</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span> <span class="o">=</span> <span class="p">[</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sol_periode</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">res calculation&#39;</span><span class="p">,</span> <span class="n">timeit</span><span class="p">)</span> <span class="k">as</span> <span class="n">xxtt</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">periode</span> <span class="o">=</span> <span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prores2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solveres2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">epires2d</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">outvalues</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span>  <span class="n">alfa</span><span class="p">)</span>

        <span class="n">outdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">outvalues</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                             <span class="n">columns</span><span class="o">=</span><span class="n">databank</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">numberfloats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stackrows</span><span class="p">)</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">-</span><span class="n">starttime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span> <span class="o">=</span> <span class="n">endtimesetup</span> <span class="o">-</span> <span class="n">starttimesetup</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Setup time (seconds)                 :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">setuptime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Foating point operations             :</span><span class="si">{</span><span class="n">numberfloats</span><span class="si">:</span><span class="s1">&gt;15,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Simulation time (seconds)            :</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simtime</span><span class="si">:</span><span class="s1">&gt;15,.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; calculated  &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outdf</span></div>


<div class="viewcode-block" id="Solver_Mixin.invert">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.invert">[docs]</a>
    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">databank</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">instruments</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">defaultimpuls</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">defaultconv</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">varimpulse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">progressbar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
               <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">     Solves a target instrument problem </span>
<span class="sd">     </span>
<span class="sd">     Number of targets should be equal to number of instruments </span>
<span class="sd">     </span>
<span class="sd">     An instrument can comprice of severeral variables</span>
<span class="sd">     </span>
<span class="sd">     **Instruments** are inputtet as a list of instruments</span>
<span class="sd">     </span>
<span class="sd">     To calculate the jacobian each instrument variable has a impuls, </span>
<span class="sd">     which is used as delta when evaluating the jacobi matrix:: </span>
<span class="sd">         </span>
<span class="sd">       [ &#39;QO_J&#39;,&#39;TG&#39;]   Simple list each variable are shocked by the default impulse </span>
<span class="sd">       [ (&#39;QO_J&#39;,0.5), &#39;TG&#39;]  Here QO_J is getting its own impuls (0.5)</span>
<span class="sd">       [ [(&#39;QO_J&#39;,0.5),(&#39;ORLOV&#39;,1.)] , (&#39;TG&#39;,0.01)] here an impuls is given for each variable, and the first instrument consiste of two variables </span>
<span class="sd">     </span>
<span class="sd">     **Targets** are list of variables</span>
<span class="sd">     </span>
<span class="sd">     Convergence is achieved when all targets are within convergens distance from the target value</span>
<span class="sd">     </span>
<span class="sd">     Convergencedistance can be set individual for a target variable by setting a value in &lt;modelinstance&gt;.targetconv </span>
<span class="sd">     </span>
<span class="sd">     Targets and target values are provided by a dataframe. </span>

<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">          ----------</span>
<span class="sd">          databank : TYPE</span>
<span class="sd">              values to run on .</span>
<span class="sd">          targets : TYPE</span>
<span class="sd">              dataframe with a column for each target.</span>
<span class="sd">          instruments : TYPE</span>
<span class="sd">              list of instruments .</span>
<span class="sd">          model : TYPE</span>
<span class="sd">              the model to use .</span>
<span class="sd">          DefaultImpuls : TYPE, optional</span>
<span class="sd">              default delta . The default is 0.01.</span>
<span class="sd">          defaultconv : TYPE, optional</span>
<span class="sd">              default convergence . The default is 0.01.</span>
<span class="sd">          delay : TYPE, optional</span>
<span class="sd">              delay in effects . The default is 0.</span>
<span class="sd">          nonlin : TYPE, optional</span>
<span class="sd">              if a number the number of iterations to trigger recalculation of jacobi. The default is False.</span>
<span class="sd">          silent : TYPE, optional</span>
<span class="sd">              show iterations if false. The default is True.</span>
<span class="sd">          maxiter : TYPE, optional</span>
<span class="sd">              max newton iteration. The default is 30.</span>
<span class="sd">          solveopt : TYPE, optional</span>
<span class="sd">              options to bring to the solver. The default is {}.</span>
<span class="sd">          varimpulse : TYPE, optional</span>
<span class="sd">              if True only update the current period, else update into the future. The default is False.</span>

<span class="sd">          Returns</span>
<span class="sd">          -------</span>
<span class="sd">          a dataframe with the result .</span>
<span class="sd">&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">modelinvert</span> <span class="kn">import</span> <span class="n">targets_instruments</span>
        <span class="n">t_i</span> <span class="o">=</span> <span class="n">targets_instruments</span><span class="p">(</span><span class="n">databank</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">instruments</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span><span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span><span class="n">varimpulse</span><span class="o">=</span><span class="n">varimpulse</span><span class="p">,</span>
                                  <span class="n">defaultimpuls</span><span class="o">=</span><span class="n">defaultimpuls</span><span class="p">,</span> <span class="n">defaultconv</span><span class="o">=</span><span class="n">defaultconv</span><span class="p">,</span> <span class="n">nonlin</span><span class="o">=</span><span class="n">nonlin</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
                                  <span class="n">progressbar</span><span class="o">=</span><span class="n">progressbar</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_i</span> <span class="o">=</span> <span class="n">t_i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_i</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="n">t_i</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="Solver_Mixin.errfunk1d">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.errfunk1d">[docs]</a>
    <span class="k">def</span> <span class="nf">errfunk1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">linenr</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">overeq</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Handle errors in sim1d &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveeval3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errfunk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values_</span><span class="p">,</span> <span class="n">linenr</span><span class="p">,</span> <span class="n">overhead</span><span class="p">,</span> <span class="n">overeq</span><span class="p">)</span></div>


<div class="viewcode-block" id="Solver_Mixin.errfunk">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.errfunk">[docs]</a>
    <span class="k">def</span> <span class="nf">errfunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">linenr</span><span class="p">,</span> <span class="n">overhead</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">overeq</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; developement function</span>

<span class="sd">        to handle run time errors in model calculations&#39;&#39;&#39;</span>

<span class="c1">#        winsound.Beep(500,1000)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errdump</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genrcolumns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">genrindex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">errdump</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Error in     :&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; In           :&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Linenr       :&#39;</span><span class="p">,</span> <span class="n">linenr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Overhead   :&#39;</span><span class="p">,</span> <span class="n">overhead</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; over eq   :&#39;</span><span class="p">,</span> <span class="n">overeq</span><span class="p">)</span>
        <span class="n">varposition</span> <span class="o">=</span> <span class="n">linenr</span><span class="o">-</span><span class="n">overhead</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">overeq</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; varposition   :&#39;</span><span class="p">,</span> <span class="n">varposition</span><span class="p">)</span>

        <span class="n">errvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveorder</span><span class="p">[</span><span class="n">varposition</span><span class="p">]</span>
        <span class="n">outeq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">errvar</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt; Equation     :&#39;</span><span class="p">,</span> <span class="n">outeq</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A snapshot of the data at the error point is at .errdump &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Also the .lastdf contains .errdump,  for inspecting &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_eq_values</span><span class="p">(</span><span class="n">errvar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errdump</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">periode</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;dumplist&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumplist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fair&#39;</span><span class="p">,</span> <span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="s1">&#39;iteration&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dump</span></div>


    <span class="k">pass</span>

<div class="viewcode-block" id="Solver_Mixin.show_iterations">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Solver_Mixin.show_iterations">[docs]</a>
    <span class="k">def</span> <span class="nf">show_iterations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">last</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">change</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mf">.9</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        shows the last iterations for the most recent simulation. </span>
<span class="sd">        iterations are dumped if ldumpvar is set to True</span>
<span class="sd">        variables can be selceted by: dumpvar = &#39;&lt;pattern&gt;&#39;</span>


<span class="sd">        Args:</span>
<span class="sd">            pat (TYPE, optional): Variables for which to show iterations . Defaults to &#39;*&#39;.</span>
<span class="sd">            per (TYPE, optional): The time frame for which to show iterations, Defaults to the last projection .</span>
<span class="sd">            last (TYPE, optional): Only show the last iterations . Defaults to 0.</span>
<span class="sd">            change (TYPE, optional): show the changes from iteration to iterations instead of the levels. Defaults to False.</span>
<span class="sd">            top (float,optional): top of chartss between 1 and 0</span>

<span class="sd">        Returns:</span>
<span class="sd">            fig (TYPE): DESCRIPTION.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">per</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">per_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relevantindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="n">per_</span> <span class="o">=</span> <span class="n">relevantindex</span><span class="p">[</span><span class="n">relevantindex</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">per</span><span class="p">)]</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">indf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpdf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;per == @per_&#39;</span><span class="p">)</span>
            <span class="n">out0</span> <span class="o">=</span> <span class="n">indf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;per == @per_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;iteration&#39;</span><span class="p">,</span>
                                                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;per&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out0</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="k">if</span> <span class="n">change</span> <span class="k">else</span> <span class="n">out0</span>
            <span class="n">varnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_names</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varnames</span><span class="p">)</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">tchange</span> <span class="o">=</span> <span class="s1">&#39;delta pr iteration &#39;</span> <span class="k">if</span> <span class="n">change</span> <span class="k">else</span> <span class="s1">&#39; levels &#39;</span>
            <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">last</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">varnames</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">number</span><span class="o">*</span><span class="mi">3</span><span class="p">),</span>
                                                             <span class="n">use_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Iterations in </span><span class="si">{</span><span class="n">per_</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">tchange</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">varnames</span><span class="p">]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">number</span><span class="o">*</span><span class="mi">3</span><span class="p">),</span>
                                                       <span class="n">use_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Iterations in </span><span class="si">{</span><span class="n">per_</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">tchange</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_constrained_layout</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># fig.tight_layout()</span>
            <span class="c1"># fig.subplots_adjust(top=top)</span>
            <span class="k">return</span> <span class="n">fig</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No iteration dump&#39;</span><span class="p">)</span></div>
</div>

<span class="c1"># try:</span>
<span class="c1">#     from modeldashsidebar import Dash_Mixin</span>
<span class="c1"># except: </span>
<span class="c1">#     ...</span>
<span class="c1">#     print(&#39;The DASH dashboard is not loaded&#39;)</span>
<span class="c1">#     class Dash_Mixin:</span>
<span class="c1">#         &#39;&#39;&#39; a dummy class if the dash dependencies are not installed. </span>
<span class="c1">#         remember: </span>
<span class="c1">#         conda install pip --y    </span>
<span class="c1">#         pip install dash_interactive_graphviz </span>
<span class="c1">#         &#39;&#39;&#39;</span>
<span class="c1">#         ...</span>
        
<div class="viewcode-block" id="Dash_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dash_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Dash_Mixin</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This mixin wraps call the Dash dashboard &#39;&#39;&#39;</span>
<div class="viewcode-block" id="Dash_Mixin.modeldash">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Dash_Mixin.modeldash">[docs]</a>
    <span class="k">def</span> <span class="nf">modeldash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">modeldashsidebar</span> <span class="kn">import</span> <span class="n">Dash_graph</span>
            <span class="o">...</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">Dash_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">var</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span> 
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No Dash, </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>

            

<div class="viewcode-block" id="Fix_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Fix_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Fix_Mixin</span><span class="p">():</span>
<span class="w">    </span>
<span class="w">    </span>
<span class="w">    </span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This mixin handles a number of world bank enhancements &#39;&#39;&#39;</span>
    
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">wb_behavioral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns endogeneous where the frml name contains a Z which signals a stocastic equation </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">out1</span> <span class="o">=</span>   <span class="p">{</span><span class="n">vx</span> <span class="k">for</span> <span class="n">vx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">]}</span>
        <span class="n">alt</span>  <span class="o">=</span>   <span class="p">{</span><span class="n">vx</span> <span class="k">for</span> <span class="n">vx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;EXO&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;FIXABLE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;STOC&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">vx</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">])</span>  
                  <span class="ow">and</span>    <span class="n">vx</span><span class="o">+</span><span class="s1">&#39;_X&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="ow">and</span>  <span class="n">vx</span><span class="o">+</span><span class="s1">&#39;_D&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span> <span class="p">}</span>
        <span class="c1"># breakpoint()</span>
        <span class="c1"># assert out1 == alt, &#39;Problems wih wb behavioral &#39;</span>
        <span class="k">return</span>  <span class="n">alt</span>
    
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">wb_ident</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns endogeneous variables not in wb_behavioral &#39;&#39;&#39;</span>
        <span class="k">return</span>  <span class="bp">self</span><span class="o">.</span><span class="n">endogene</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wb_behavioral</span>
    
<div class="viewcode-block" id="Fix_Mixin.fix">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Fix_Mixin.fix">[docs]</a>
    <span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fixes variables to the current values. </span>
<span class="sd">        </span>
<span class="sd">        for variables where the equation looks like::</span>
<span class="sd">        </span>
<span class="sd">          var = (rhs)*(1-var_d)+var_x*var_d</span>
<span class="sd">        </span>
<span class="sd">        The values in the smpl set by *start* and *end* will be set to::</span>
<span class="sd">            </span>
<span class="sd">            var_x = var</span>
<span class="sd">            var_d = 1</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        The variables fulfilling this are elements of .self.fix_endo</span>

<span class="sd">        Args:</span>
<span class="sd">            df (TYPE): Input dataframe should contain a solution and all variables ..</span>
<span class="sd">            pat (TYPE, optional): Select variables to endogenize. Defaults to &#39;*&#39;.</span>
<span class="sd">            start (TYPE, optional):  start periode. Defaults to &#39;&#39;.</span>
<span class="sd">            end (TYPE, optional): end periode. Defaults to &#39;&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataframe (TYPE): the resulting daaframe .</span>

<span class="sd">        &#39;&#39;&#39;</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Fix all  variables which can be exogenized to their value &#39;&#39;&#39;</span>
    
        <span class="n">dataframe</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
        <span class="n">beh</span>   <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_endo</span> <span class="p">)</span>
        <span class="n">selected</span>  <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">beh</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">upper</span><span class="p">())]</span>
        <span class="n">exo</span>   <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;_X&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selected</span> <span class="p">]</span>
        <span class="n">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;_D&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selected</span> <span class="p">]</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">dataframe</span><span class="p">):</span>
            <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">dummy</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> 
            <span class="n">selected_values</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">selected</span><span class="p">]</span>
            <span class="n">selected_values</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">exo</span> 
            <span class="c1"># breakpoint()</span>
            <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">exo</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_values</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">exo</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The folowing variables are fixed&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">selected</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">dataframe</span></div>

    
<div class="viewcode-block" id="Fix_Mixin.unfix">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Fix_Mixin.unfix">[docs]</a>
    <span class="k">def</span> <span class="nf">unfix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Unfix (endogenize) variables </span>

<span class="sd">        Args:</span>
<span class="sd">            df (Dataframe): Input dataframe, should contain a solution and all variables .</span>
<span class="sd">            pat (string, optional): Select variables to endogenize. Defaults to &#39;*&#39;.</span>
<span class="sd">            start (TYPE, optional): start periode. Defaults to &#39;&#39;.</span>
<span class="sd">            end (TYPE, optional): end periode. Defaults to &#39;&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataframe (TYPE): A dratframe with all dummies for the selected variablse set to 0 .</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        
        <span class="n">dataframe</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
    
        <span class="n">beh</span>   <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_endo</span> <span class="p">)</span>
        <span class="n">selected</span>  <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">up</span> <span class="ow">in</span> <span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">beh</span><span class="p">,</span> <span class="n">up</span><span class="o">.</span><span class="n">upper</span><span class="p">())]</span>

        <span class="n">dummy</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">+</span><span class="s1">&#39;_D&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selected</span> <span class="p">]</span>
        
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_smpl</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
            <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="n">dummy</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>      
        <span class="k">return</span> <span class="n">dataframe</span></div>


<div class="viewcode-block" id="Fix_Mixin.find_fix_dummy_fixed">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Fix_Mixin.find_fix_dummy_fixed">[docs]</a>
    <span class="k">def</span> <span class="nf">find_fix_dummy_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns names of actiove exogenizing dummies </span>
<span class="sd">        </span>
<span class="sd">        sets the property self. exodummy_per which defines the time over which the dummies are defined&#39;&#39;&#39;</span>
        <span class="n">dmat</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dmatset</span> <span class="o">=</span> <span class="n">dmat</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dmat</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">dmat</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="c1"># breakpoint() </span>
        <span class="n">dummyselected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmatset</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmatset</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">start</span>  <span class="o">=</span> <span class="n">dmatset</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">dmatset</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">per1</span><span class="p">,</span><span class="n">per2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">per1</span><span class="p">:</span><span class="n">per2</span><span class="p">]</span>
            <span class="c1"># print(self.exodummy_per)</span>
            <span class="k">return</span> <span class="n">dummyselected</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="p">[]</span></div>



   
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fix_dummy_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns names of actiove exogenizing dummies </span>
<span class="sd">        </span>
<span class="sd">        sets the property self. exodummy_per which defines the time over which the dummies are defined&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_fix_dummy_fixed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="p">)</span>

    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fix_dummy_fixed_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; returns names of actiove exogenizing dummies </span>
<span class="sd">        </span>
<span class="sd">        sets the property self. exodummy_per which defines the time over which the dummies are defined&#39;&#39;&#39;</span>
        <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">dmatset</span> <span class="o">=</span> <span class="n">dmat</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dmat</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">dmat</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
        <span class="c1"># breakpoint() </span>
        <span class="n">dummyselected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmatset</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmatset</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">start</span>  <span class="o">=</span> <span class="n">dmatset</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">dmatset</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">per1</span><span class="p">,</span><span class="n">per2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">slice_locs</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_per</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">per1</span><span class="p">:</span><span class="n">per2</span><span class="p">]</span>
            <span class="c1"># print(self.exodummy_per)</span>
            <span class="k">return</span> <span class="n">dummyselected</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">return</span> <span class="p">[]</span>


        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fix_add_factor_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the add factors corrosponding to the active exogenizing dummies&#39;&#39;&#39;</span>
    
        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_A&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_fixed</span> <span class="k">if</span> <span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_A&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exogene</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fix_value_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the exogenizing values corrosponding to the active exogenizing dummies&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_X&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_fixed</span><span class="p">]</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fix_endo_fixed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns the endogeneous variables corrosponding to the active exogenizing dummies&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_fixed</span><span class="p">]</span>
    
<div class="viewcode-block" id="Fix_Mixin.fix_inf">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Fix_Mixin.fix_inf">[docs]</a>
    <span class="k">def</span> <span class="nf">fix_inf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Display information regarding exogenizing </span>
<span class="sd">         &#39;&#39;&#39;</span>
        <span class="n">thisdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdf</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">df</span>  
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_fixed</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No active exogenixed variables &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_add_factor_fixed</span><span class="p">):</span>
            <span class="n">varnameslist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_endo_fixed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_value_fixed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_fixed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_add_factor_fixed</span><span class="p">)</span>   
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">varnameslist</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_endo_fixed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_value_fixed</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_fixed</span><span class="p">)</span>   
            
        <span class="k">for</span> <span class="n">varnames</span> <span class="ow">in</span> <span class="n">varnameslist</span><span class="p">:</span> 
            
            <span class="n">out</span> <span class="o">=</span> <span class="n">thisdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fix_dummy_per</span><span class="p">,</span><span class="n">varnames</span><span class="p">]</span>
            <span class="n">out</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s2">&quot;frml&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">calc_add_factor_model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varnames</span><span class="p">[</span><span class="mi">3</span><span class="p">]][</span><span class="s2">&quot;frml&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="o">...</span>
            <span class="k">try</span><span class="p">:</span>     
                <span class="n">res</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;  &quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="s2">&quot; 1 &quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">value</span>  <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="n">res</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="s2">&quot;  &quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="s2">&quot; 1 &quot;</span> <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mf">1.0</span> <span class="k">else</span> <span class="n">value</span>  <span class="p">)</span>

            <span class="n">display</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ibsstyle</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">)</span>         </div>
</div>

        
<div class="viewcode-block" id="Stability_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Stability_Mixin</span><span class="p">():</span>
    
    
<div class="viewcode-block" id="Stability_Mixin.get_newton">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.get_newton">[docs]</a>
    <span class="k">def</span> <span class="nf">get_newton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

    
<div class="viewcode-block" id="Stability_Mixin.get_eigenvalues">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.get_eigenvalues">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forcenum</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">,</span><span class="n">dropvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">progressbar</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;stability_newton&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="p">,</span><span class="s1">&#39;eigen_values_and_vectors&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finding eigenvalues and vectors&#39;</span><span class="p">)</span>            
            <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forcenum</span> <span class="o">=</span> <span class="n">forcenum</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span>  <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">get_eigenvalues</span><span class="p">(</span><span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span><span class="p">,</span><span class="n">progressbar</span><span class="o">=</span><span class="n">progressbar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="c1"># print(&#39;Eigenvalues and vectors already avaiable&#39;)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">eig_dic</span>  
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigenvalues</span></div>

     
    
<div class="viewcode-block" id="Stability_Mixin.get_eigenvectors">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.get_eigenvectors">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenvectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">forcenum</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span> <span class="p">,</span><span class="n">dropvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">progressbar</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvalues</span><span class="p">(</span><span class="n">forcenum</span> <span class="o">=</span> <span class="n">forcenum</span><span class="p">,</span>  <span class="n">silent</span> <span class="o">=</span><span class="n">silent</span> <span class="p">,</span><span class="n">dropvar</span><span class="o">=</span><span class="n">dropvar</span><span class="p">,</span> <span class="n">progressbar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="p">)</span>           
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">get_df_eigen_dict</span><span class="p">()</span>  </div>


        
<div class="viewcode-block" id="Stability_Mixin.eigenvalues_show">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.eigenvalues_show">[docs]</a>
    <span class="k">def</span> <span class="nf">eigenvalues_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> 
        <span class="n">vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvectors</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">eigenvalues_show</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span></div>

        
     
<div class="viewcode-block" id="Stability_Mixin.eigenvalues_plot">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.eigenvalues_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">eigenvalues_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">maxfig</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
         <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvalues</span><span class="p">(</span><span class="n">progressbar</span><span class="o">=</span><span class="n">progressbar</span><span class="p">)</span>   
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">eigplot_all</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="n">maxfig</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="Stability_Mixin.get_eigen_jackknife_df">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.get_eigen_jackknife_df">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigen_jackknife_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">maxnames</span><span class="o">=</span><span class="mi">200_000</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvalues</span><span class="p">()</span>
        <span class="n">jackdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">get_eigen_jackknife_df</span><span class="p">(</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">maxnames</span><span class="o">=</span><span class="n">maxnames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jackdf</span> </div>

    
<div class="viewcode-block" id="Stability_Mixin.jack_largest_reduction">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.jack_largest_reduction">[docs]</a>
    <span class="k">def</span> <span class="nf">jack_largest_reduction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jackdf</span><span class="p">,</span> <span class="n">eigenvalue_row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imag_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">jack_largest_reduction</span><span class="p">(</span><span class="n">jackdf</span><span class="p">,</span> <span class="n">eigenvalue_row</span><span class="o">=</span><span class="n">eigenvalue_row</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">imag_only</span><span class="o">=</span><span class="n">imag_only</span> <span class="p">)</span>  </div>

    
<div class="viewcode-block" id="Stability_Mixin.jack_largest_reduction_plot">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Stability_Mixin.jack_largest_reduction_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">jack_largest_reduction_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jackdf</span><span class="p">,</span><span class="n">eigenvalue_row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imag_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stability_newton</span><span class="o">.</span><span class="n">jack_largest_reduction_plot</span><span class="p">(</span><span class="n">jackdf</span><span class="p">,</span> <span class="n">eigenvalue_row</span><span class="o">=</span><span class="n">eigenvalue_row</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">imag_only</span><span class="o">=</span><span class="n">imag_only</span> <span class="p">)</span>   </div>
</div>

 
<span class="n">Stability_Mixin</span><span class="o">.</span><span class="n">eigenvalues_plot</span><span class="o">.</span><span class="vm">__doc__</span>       <span class="o">=</span> <span class="n">newton_diff</span><span class="o">.</span><span class="n">eigplot_all</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="n">Stability_Mixin</span><span class="o">.</span><span class="n">eigenvalues_show</span><span class="o">.</span><span class="vm">__doc__</span>       <span class="o">=</span> <span class="n">newton_diff</span><span class="o">.</span><span class="n">eigenvalues_show</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="n">Stability_Mixin</span><span class="o">.</span><span class="n">jack_largest_reduction</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="o">.</span><span class="n">jack_largest_reduction</span><span class="o">.</span><span class="vm">__doc__</span> 
<span class="n">Stability_Mixin</span><span class="o">.</span><span class="n">jack_largest_reduction_plot</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">newton_diff</span><span class="o">.</span><span class="n">jack_largest_reduction_plot</span><span class="o">.</span><span class="vm">__doc__</span> 


  



<div class="viewcode-block" id="Report_Mixin">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Report_Mixin">[docs]</a>
<span class="k">class</span> <span class="nc">Report_Mixin</span><span class="p">:</span> 
    


<div class="viewcode-block" id="Report_Mixin.table">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Report_Mixin.table">[docs]</a>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;#Headline&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Table&#39;</span><span class="p">,</span><span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;growth&#39;</span><span class="p">,</span><span class="n">col_desc</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">custom_description</span> <span class="o">=</span> <span class="p">{},</span><span class="n">dec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">heading</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">mul</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>     
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a table display configuration based on specified parameters and data types, including dynamic </span>
<span class="sd">        adjustments of display options using both standard and keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">          pat (str): Pattern or identifier used to select data for the line, defaulting to &#39;#Headline&#39;.</span>
<span class="sd">          title (str): Title of the table, passed directly to Options, defaulting to &#39;Table&#39;.</span>
<span class="sd">          datatype (str): Type of data transformation to apply (e.g., &#39;growth&#39;, &#39;level&#39;), defaulting to &#39;growth&#39;.</span>
<span class="sd">          custom_description (dict): Custom descriptions to augment or override default descriptions, empty by default.</span>
<span class="sd">          dec (int): Number of decimal places for numerical output, passed directly to Line configuration, defaulting to 2.</span>
<span class="sd">          heading (str): Optional heading line for the table, empty by default.</span>
<span class="sd">          name (str): Name for the display, defaults to &#39;A_small_table&#39;.</span>
<span class="sd">          foot (str): Footer text.</span>
<span class="sd">          rename (bool): Allows renaming of data columns</span>
<span class="sd">          decorate (bool): Decorates row descriptions based on the showtype, defaulting to False.</span>
<span class="sd">          width (int): Specifies the width for formatting output in characters, efaulting to 5.</span>
<span class="sd">          chunk_size (int): Number of columns per chunk in the display output, defaulting to 0.</span>
<span class="sd">          timeslice (List[int]): Time slice for data display, empty by default.</span>
<span class="sd">          max_cols (int): Maximum columns when displayed as a string, faulting to the system wide setting.</span>
<span class="sd">          last_cols (int): Specifies the number of last columns to include in a display slice, particularly in Latex.</span>
<span class="sd">          col_desc  (str): text centered on columns </span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            DisplayVarTableDef: Configured table definition object ready for rendering, which includes detailed specifications</span>
<span class="sd">                        such as units and type of transformation based on the datatype.</span>
<span class="sd">    </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
                 

        <span class="kn">from</span> <span class="nn">modelreport</span> <span class="kn">import</span> <span class="n">DisplayVarTableDef</span><span class="p">,</span> <span class="n">DisplayDef</span><span class="p">,</span> <span class="n">LatexRepo</span><span class="p">,</span> <span class="n">DatatypeAccessor</span>
        <span class="kn">from</span> <span class="nn">modelreport</span> <span class="kn">import</span> <span class="n">Line</span><span class="p">,</span> <span class="n">Options</span><span class="p">,</span><span class="n">DisplaySpec</span><span class="p">,</span><span class="n">DisplayFigWrapDef</span>
        



        <span class="n">config</span> <span class="o">=</span>   <span class="n">DatatypeAccessor</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>    
        <span class="n">this_col_desc</span> <span class="o">=</span> <span class="n">col_desc</span> <span class="k">if</span> <span class="n">col_desc</span> <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">col_desc</span>
        <span class="n">headingline</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line</span><span class="p">(</span><span class="n">textlinetype</span><span class="o">=</span><span class="s1">&#39;textline&#39;</span><span class="p">,</span><span class="n">centertext</span><span class="o">=</span><span class="n">heading</span><span class="p">)]</span> <span class="k">if</span> <span class="n">heading</span> <span class="k">else</span> <span class="p">[]</span> 
        <span class="n">unitline</span>   <span class="o">=</span>  <span class="p">[]</span> <span class="k">if</span> <span class="n">this_col_desc</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="p">[</span> <span class="n">Line</span><span class="p">(</span><span class="n">textlinetype</span><span class="o">=</span><span class="s1">&#39;textline&#39;</span><span class="p">,</span><span class="n">centertext</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;--- </span><span class="si">{</span><span class="n">this_col_desc</span><span class="si">}</span><span class="s1"> ---&#39;</span><span class="p">)]</span>  
               
        <span class="n">tabspec</span> <span class="o">=</span> <span class="n">DisplaySpec</span><span class="p">(</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">decorate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;A_small_table&#39;</span><span class="p">,</span> 
                              <span class="n">custom_description</span><span class="o">=</span><span class="n">custom_description</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">,</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">headingline</span> <span class="o">+</span> <span class="n">unitline</span> <span class="o">+</span> <span class="p">[</span>
                 <span class="n">Line</span><span class="p">(</span><span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span> <span class="p">,</span><span class="n">pat</span><span class="o">=</span><span class="n">pat</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span><span class="n">dec</span><span class="p">,</span> <span class="n">mul</span><span class="o">=</span><span class="n">mul</span> <span class="p">)</span> <span class="p">,</span> 
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">DisplayVarTableDef</span> <span class="p">(</span><span class="n">mmodel</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">tabspec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tab</span></div>


<div class="viewcode-block" id="Report_Mixin.plot">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Report_Mixin.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s1">&#39;#Headline&#39;</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;growth&#39;</span><span class="p">,</span><span class="n">custom_description</span> <span class="o">=</span> <span class="p">{},</span><span class="n">by_var</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">mul</span><span class="o">=</span><span class="mf">1.0</span> <span class="p">,</span> 
             <span class="n">ax_title_template</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>     
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a table display configuration based on specified parameters and data types, including dynamic </span>
<span class="sd">        adjustments of display options using both standard and keyword arguments.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">          pat (str): Pattern or identifier used to select data for the line, defaulting to &#39;#Headline&#39;.</span>
<span class="sd">          datatype (str): Type of data transformation to apply (e.g., &#39;growth&#39;, &#39;level&#39;), defaulting to &#39;growth&#39;.</span>
<span class="sd">          title (str): Title of the table, passed directly to Options, defaulting to &#39;Table&#39;.</span>
<span class="sd">          custom_description (dict): Custom descriptions to augment or override default descriptions, empty by default.</span>
<span class="sd">          ncol  (int):         </span>
<span class="sd">        Returns:</span>
<span class="sd">    DisplayVarTableDef: Configured table definition object ready for rendering, which includes detailed specifications</span>
<span class="sd">                        such as units and type of transformation based on the datatype.</span>
<span class="sd">    </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
                 

        <span class="kn">from</span> <span class="nn">modelreport</span> <span class="kn">import</span> <span class="n">DisplayVarTableDef</span><span class="p">,</span> <span class="n">DisplayDef</span><span class="p">,</span> <span class="n">LatexRepo</span><span class="p">,</span> <span class="n">DatatypeAccessor</span>
        <span class="kn">from</span> <span class="nn">modelreport</span> <span class="kn">import</span> <span class="n">Line</span><span class="p">,</span> <span class="n">Options</span><span class="p">,</span><span class="n">DisplaySpec</span><span class="p">,</span><span class="n">DisplayFigWrapDef</span><span class="p">,</span><span class="n">DisplayKeepFigDef</span>
        



        <span class="n">config</span> <span class="o">=</span>   <span class="n">DatatypeAccessor</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    
        <span class="c1"># print(config.showtype,config.diftype,config.ax_title_template_df)</span>
               
        <span class="n">figspec</span> <span class="o">=</span> <span class="n">DisplaySpec</span><span class="p">(</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">Options</span><span class="p">(</span><span class="n">decorate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;A_plot&#39;</span><span class="p">,</span> 
                              <span class="n">custom_description</span><span class="o">=</span><span class="n">custom_description</span><span class="p">,</span><span class="n">title</span> <span class="o">=</span><span class="n">title</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">,</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line</span><span class="p">(</span><span class="n">pat</span><span class="o">=</span><span class="n">pat</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span>
                          <span class="n">by_var</span> <span class="o">=</span> <span class="n">by_var</span><span class="p">,</span><span class="n">mul</span><span class="o">=</span><span class="n">mul</span><span class="p">,</span><span class="n">ax_title_template</span><span class="o">=</span><span class="n">ax_title_template</span><span class="p">)</span> <span class="p">,</span> 
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="n">DisplayKeepFigDef</span> <span class="p">(</span><span class="n">mmodel</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">figspec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">figs</span></div>


<div class="viewcode-block" id="Report_Mixin.text">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Report_Mixin.text">[docs]</a>
    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">modelreport</span> <span class="kn">import</span> <span class="n">get_DisplayTextDef</span>
        <span class="k">return</span> <span class="n">get_DisplayTextDef</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span></div>


<div class="viewcode-block" id="Report_Mixin.report_from_spec">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Report_Mixin.report_from_spec">[docs]</a>
    <span class="k">def</span> <span class="nf">report_from_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">json_str</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">modelreport</span> <span class="kn">import</span>  <span class="n">create_instance_from_json</span>
        <span class="k">return</span> <span class="n">create_instance_from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">json_str</span><span class="p">)</span></div>


<div class="viewcode-block" id="Report_Mixin.add_report">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Report_Mixin.add_report">[docs]</a>
    <span class="k">def</span> <span class="nf">add_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a_DisplayDef_list</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span> 
        <span class="n">this_DisplayDef_list</span> <span class="o">=</span> <span class="n">a_DisplayDef_list</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a_DisplayDef_list</span><span class="p">)</span> <span class="o">==</span><span class="nb">list</span> <span class="k">else</span> <span class="p">[</span><span class="n">a_DisplayDef_list</span><span class="p">]</span>
        <span class="n">this_DisplayDef_list</span> <span class="o">=</span>  <span class="n">this_DisplayDef_list</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> 
        <span class="n">new_reports</span>  <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">:</span><span class="n">r</span><span class="o">.</span><span class="n">save_spec</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">this_DisplayDef_list</span> <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span> <span class="o">|</span> <span class="n">new_reports</span> 
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reports added to report repo: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">new_reports</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

        
        
<div class="viewcode-block" id="Report_Mixin.get_report">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.Report_Mixin.get_report">[docs]</a>
    <span class="k">def</span> <span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
         <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No stored report with the name </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Possible values:  </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
             <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Wrong report key try again&#39;</span><span class="p">)</span>
         <span class="k">else</span><span class="p">:</span> 
             <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_from_spec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
         
             <span class="k">return</span> <span class="n">out</span> </div>
</div>

             

<div class="viewcode-block" id="model">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.model">[docs]</a>
<span class="k">class</span> <span class="nc">model</span><span class="p">(</span><span class="n">Zip_Mixin</span><span class="p">,</span> <span class="n">Json_Mixin</span><span class="p">,</span> <span class="n">Model_help_Mixin</span><span class="p">,</span> <span class="n">Solver_Mixin</span><span class="p">,</span> <span class="n">Display_Mixin</span><span class="p">,</span> <span class="n">Graph_Draw_Mixin</span><span class="p">,</span> <span class="n">Graph_Mixin</span><span class="p">,</span>
            <span class="n">Dekomp_Mixin</span><span class="p">,</span> <span class="n">Org_model_Mixin</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Description_Mixin</span><span class="p">,</span> <span class="n">Excel_Mixin</span><span class="p">,</span> <span class="n">Dash_Mixin</span><span class="p">,</span> <span class="n">Modify_Mixin</span><span class="p">,</span>
            <span class="n">Fix_Mixin</span><span class="p">,</span><span class="n">Stability_Mixin</span><span class="p">,</span><span class="n">Report_Mixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;This is the main model definition&#39;&#39;&#39;</span>

    <span class="k">pass</span></div>



<span class="c1">#  Functions used in calculating</span>


<span class="c1"># wrapper&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span><span class="s1">&#39;upd&#39;</span><span class="p">):</span>
<div class="viewcode-block" id="upd">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.upd">[docs]</a>
    <span class="nd">@pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">register_dataframe_accessor</span><span class="p">(</span><span class="s2">&quot;upd&quot;</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">upd</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Extend a dataframe to update variables from string </span>
<span class="sd">        </span>
<span class="sd">        look at :any:`Model_help_Mixin.update`  for syntax </span>
<span class="sd">        </span>

<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pandas_obj</span><span class="p">):</span>
    <span class="c1">#        self._validate(pandas_obj)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">pandas_obj</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="vm">__doc__</span>
    <span class="c1">#        print(self._obj)</span>
       
<div class="viewcode-block" id="upd.__call__">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.upd.__call__">[docs]</a>
        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">updates</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">keep_growth</span><span class="o">=</span><span class="kc">False</span><span class="p">,):</span>
    
            <span class="n">indf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span>
            <span class="n">result</span> <span class="o">=</span>   <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">indf</span><span class="p">,</span> <span class="n">updates</span><span class="o">=</span><span class="n">updates</span><span class="p">,</span> <span class="n">lprint</span><span class="o">=</span><span class="n">lprint</span><span class="p">,</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span><span class="n">keep_growth</span><span class="o">=</span><span class="n">keep_growth</span><span class="p">,)</span>   
            <span class="k">return</span> <span class="n">result</span> </div>
</div>


<span class="n">node</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="s1">&#39;lev,parent,child&#39;</span><span class="p">)</span>
<span class="sd">&#39;&#39;&#39;A named tuple used when to drawing the logical structure. Describes an edge of the dependency graph </span>

<span class="sd">:lev: Level from start</span>
<span class="sd">:parent: The parent</span>
<span class="sd">:child: The child  </span>

<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="ttimer">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.ttimer">[docs]</a>
<span class="k">def</span> <span class="nf">ttimer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_model">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.create_model">[docs]</a>
<span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="n">navn</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">finished</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">xmodel</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">straight</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Creates either a model instance or a model and a historic model from formulars. \n</span>
<span class="sd">    The formulars can be in a string or in af file withe the extension .txt </span>

<span class="sd">    if:</span>

<span class="sd">    :navn: The model as text or as a file with extension .txt</span>
<span class="sd">    :name: Name of the model     </span>
<span class="sd">    :new: If True, ! used for comments, else () can also be used. False should be avoided, only for old PCIM models.  </span>
<span class="sd">    :hist: If True, a model with calculations of historic value is also created</span>
<span class="sd">    :xmodel: The model class used for creating model the model instance. Can be used to create models with model subclasses</span>
<span class="sd">    :finished: If True, the model exploder is not used.</span>
<span class="sd">    :straight: If True, the formula sequence in the model will be used.</span>
<span class="sd">    :funks: A list of user defined funktions used in the model </span>




<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">shortname</span> <span class="o">=</span> <span class="n">navn</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span>
                     <span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;.txt&#39;</span> <span class="ow">in</span> <span class="n">navn</span> <span class="k">else</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="s1">&#39;indtastet_udtryk&#39;</span>
    <span class="n">modeltext</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">navn</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;.txt&#39;</span> <span class="ow">in</span> <span class="n">navn</span> <span class="k">else</span> <span class="n">navn</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">modeltext</span> <span class="o">=</span> <span class="n">modeltext</span> <span class="k">if</span> <span class="n">new</span> <span class="k">else</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\(\)&#39;</span><span class="p">,</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="n">modeltext</span><span class="p">)</span>
    <span class="n">udrullet</span> <span class="o">=</span> <span class="n">modeltext</span> <span class="k">if</span> <span class="n">finished</span> <span class="k">else</span> <span class="n">mp</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="n">modeltext</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
    <span class="n">pt</span><span class="o">.</span><span class="n">check_syntax_model</span><span class="p">(</span><span class="n">udrullet</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">hist</span><span class="p">:</span>
        <span class="n">hmodel</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">find_hist_model</span><span class="p">(</span><span class="n">udrullet</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">check_syntax_model</span><span class="p">(</span><span class="n">hmodel</span><span class="p">)</span>
        <span class="n">mp</span><span class="o">.</span><span class="n">modelprint</span><span class="p">(</span><span class="n">hmodel</span><span class="p">,</span> <span class="s1">&#39;Historic calculations &#39;</span> <span class="o">+</span> <span class="n">shortname</span><span class="p">,</span>
                      <span class="n">udfil</span><span class="o">=</span><span class="n">shortname</span> <span class="o">+</span> <span class="s1">&#39;_hist.fru&#39;</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xmodel</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span> <span class="n">shortname</span><span class="p">,</span> <span class="n">straight</span><span class="o">=</span><span class="n">straight</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">),</span> <span class="n">xmodel</span><span class="p">(</span><span class="n">hmodel</span><span class="p">,</span> <span class="n">shortname</span> <span class="o">+</span> <span class="s1">&#39;_hist&#39;</span><span class="p">,</span> <span class="n">straight</span><span class="o">=</span><span class="n">straight</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xmodel</span><span class="p">(</span><span class="n">udrullet</span><span class="p">,</span> <span class="n">shortname</span><span class="p">,</span> <span class="n">straight</span><span class="o">=</span><span class="n">straight</span><span class="p">,</span> <span class="n">funks</span><span class="o">=</span><span class="n">funks</span><span class="p">)</span></div>




<div class="viewcode-block" id="get_a_value">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.get_a_value">[docs]</a>
<span class="k">def</span> <span class="nf">get_a_value</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; returns a value for row=p+lag, column = var </span>

<span class="sd">    to take care of non additive row index&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">per</span><span class="p">)</span><span class="o">+</span><span class="n">lag</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span></div>



<div class="viewcode-block" id="set_a_value">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.set_a_value">[docs]</a>
<span class="k">def</span> <span class="nf">set_a_value</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">per</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">lag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Sets a value for row=p+lag, column = var </span>

<span class="sd">    to take care of non additive row index&#39;&#39;&#39;</span>

    <span class="n">df</span><span class="o">.</span><span class="n">iat</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">per</span><span class="p">)</span><span class="o">+</span><span class="n">lag</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span></div>



<div class="viewcode-block" id="insertModelVar">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.insertModelVar">[docs]</a>
<span class="k">def</span> <span class="nf">insertModelVar</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inserts all variables from model, not already in the dataframe.</span>
<span class="sd">    Model can be a list of models &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">imodel</span> <span class="o">=</span> <span class="n">model</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imodel</span> <span class="o">=</span> <span class="p">[</span><span class="n">model</span><span class="p">]</span>

    <span class="n">myList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">imodel</span><span class="p">:</span>
        <span class="n">myList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">manglervars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">myList</span><span class="p">)</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">manglervars</span><span class="p">):</span>
        <span class="n">extradf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                               <span class="n">columns</span><span class="o">=</span><span class="n">manglervars</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">extradf</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dataframe</span></div>



<div class="viewcode-block" id="lineout">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.lineout">[docs]</a>
<span class="k">def</span> <span class="nf">lineout</span><span class="p">(</span><span class="n">vek</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">endline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Utility to return formated string of vector &#39;&#39;&#39;</span>
    <span class="n">fvek</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vek</span><span class="p">]</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pre</span><span class="si">:</span><span class="s1">&lt;</span><span class="si">{</span><span class="n">pw</span><span class="si">}}</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">f</span><span class="si">:{</span><span class="n">w</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fvek</span><span class="p">])</span><span class="o">+</span><span class="n">endline</span></div>

<span class="c1"># print(lineout([1,2,300000000],&#39;Forspalte&#39;,pw=10))</span>


<div class="viewcode-block" id="dfout">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.dfout">[docs]</a>
<span class="k">def</span> <span class="nf">dfout</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">pw2</span> <span class="o">=</span> <span class="n">pw</span> <span class="k">if</span> <span class="n">pw</span> <span class="k">else</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">lineout</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">pw2</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()])</span></div>


<span class="c1"># print(dfout(df.iloc[:,:4],w=10,d=2,pw=10))</span>


<div class="viewcode-block" id="upddfold">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.upddfold">[docs]</a>
<span class="k">def</span> <span class="nf">upddfold</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">upd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; takes two dataframes. The values from upd is inserted into base &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upd</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

    <span class="n">locb</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">columns</span><span class="p">)}</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">locb</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upd</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">cu</span><span class="p">,</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ru</span><span class="p">,</span> <span class="n">rb</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">upd</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">ru</span><span class="p">,</span> <span class="n">cu</span><span class="p">,</span> <span class="n">takeable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">base</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">rb</span><span class="p">,</span> <span class="n">cb</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
<span class="c1">#            base.set_value(rb,cb,t,takeable=True)</span>
    <span class="k">return</span> <span class="n">base</span></div>



<div class="viewcode-block" id="upddf">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.upddf">[docs]</a>
<span class="k">def</span> <span class="nf">upddf</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">upd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; takes two dataframes. The values from upd is inserted into base &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upd</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

    <span class="n">locb</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">columns</span><span class="p">)}</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">locb</span><span class="p">[</span><span class="n">v</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">upd</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">cu</span><span class="p">,</span> <span class="n">cb</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ru</span><span class="p">,</span> <span class="n">rb</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">upd</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ru</span><span class="p">,</span> <span class="n">cu</span><span class="p">]</span>
            <span class="n">base</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">rb</span><span class="p">,</span> <span class="n">cb</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
    <span class="k">return</span> <span class="n">base</span></div>



<div class="viewcode-block" id="randomdf">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.randomdf">[docs]</a>
<span class="k">def</span> <span class="nf">randomdf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">same</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ran</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cpre</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">rpre</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Randomize and rename the rows and columns of a dataframe, keep the values right:</span>

<span class="sd">    :ran:  If True randomize, if False don&#39;t randomize</span>
<span class="sd">    :col:  The columns are renamed and randdomized</span>
<span class="sd">    :row:  The rows are renamed and randdomized</span>
<span class="sd">    :same:  The row and column index are renamed and randdomized the same way</span>
<span class="sd">    :cpre:  Column name prefix</span>
<span class="sd">    :rpre:  Row name prefix</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">sample</span>
    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log10</span>

    <span class="n">dfout</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ran</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">or</span> <span class="n">same</span><span class="p">:</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="n">dfout</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))))</span>
            <span class="n">rancol</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">colnames</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">colnames</span><span class="p">))</span>
            <span class="n">coldic</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">cpre</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;{0:0&#39;</span><span class="o">+</span><span class="n">dec</span><span class="o">+</span><span class="s1">&#39;d}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rancol</span><span class="p">)}</span>
            <span class="n">dfout</span> <span class="o">=</span> <span class="n">dfout</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">coldic</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">same</span><span class="p">:</span>
                <span class="n">dfout</span> <span class="o">=</span> <span class="n">dfout</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">coldic</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">same</span><span class="p">:</span>
            <span class="n">rownames</span> <span class="o">=</span> <span class="n">dfout</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">log10</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rownames</span><span class="p">))))</span>
            <span class="n">ranrow</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rownames</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">rownames</span><span class="p">))</span>
            <span class="n">rowdic</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">rpre</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;{0:0&#39;</span><span class="o">+</span><span class="n">dec</span><span class="o">+</span><span class="s1">&#39;d}&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranrow</span><span class="p">)}</span>
            <span class="n">dfout</span> <span class="o">=</span> <span class="n">dfout</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">rowdic</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dfout</span></div>



<div class="viewcode-block" id="join_name_lag">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.join_name_lag">[docs]</a>
<span class="k">def</span> <span class="nf">join_name_lag</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;creates a new dataframe where  the name and lag from multiindex is joined</span>
<span class="sd">    as input a dataframe where name and lag are two levels in multiindex </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">xl</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">newindex</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}{</span><span class="n">xl</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">1</span><span class="p">))]</span>
    <span class="n">newdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">newdf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">newindex</span>
    <span class="k">return</span> <span class="n">newdf</span></div>



<div class="viewcode-block" id="timer_old">
<a class="viewcode-back" href="../core/modelclass.html#modelclass.timer_old">[docs]</a>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">timer_old</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">short</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    does not catch exceptrions use model.timer</span>

<span class="sd">    A timer context manager, implemented using a</span>
<span class="sd">    generator function. This one will report time even if an exception occurs&quot;&quot;&quot;    </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input : string, optional</span>
<span class="sd">        a name. The default is &#39;test&#39;.</span>
<span class="sd">    show : bool, optional</span>
<span class="sd">        show the results. The default is True.</span>
<span class="sd">    short : bool, optional</span>
<span class="sd">        . The default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">show</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">short</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s1"> started at : </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}}</span><span class="s1"> &#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">minutes</span> <span class="o">=</span> <span class="n">seconds</span><span class="o">/</span><span class="mf">60.</span>
            <span class="k">if</span> <span class="n">minutes</span> <span class="o">&lt;</span> <span class="mf">2.</span><span class="p">:</span>
                <span class="n">afterdec</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">seconds</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="p">(</span>
                    <span class="s1">&#39;3&#39;</span> <span class="k">if</span> <span class="n">seconds</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;10&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s1"> took       : </span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">afterdec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1"> Seconds&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">afterdec</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span> <span class="k">if</span> <span class="n">minutes</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="s1">&#39;4&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">input</span><span class="si">}</span><span class="s1"> took       : </span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s1">&gt;</span><span class="si">{</span><span class="mi">15</span><span class="si">}</span><span class="s1">,.</span><span class="si">{</span><span class="n">afterdec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1"> Minutes&#39;</span><span class="p">)</span></div>




<span class="kn">import</span> <span class="nn">modelmf</span> 

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

<span class="c1">#%%  test </span>
    <span class="n">smallmodel</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">frml &lt;&gt; a = c + b $ </span>
<span class="s1">frml &lt;&gt; d1 = x + 3 * a(-1)+ c **2 +a  $ </span>
<span class="s1">frml &lt;&gt; d3 = x + 3 * a(-1)+c **3 $  </span>
<span class="s1">Frml &lt;&gt; xx = 0.5 * c +a$</span>
<span class="s1">frml &lt;CALC_ADJUST&gt; a_a = a-(c+b)$</span>
<span class="s1">frml &lt;CALC_ADJUST&gt; b_a = a-(c+b)$&#39;&#39;&#39;</span>
    <span class="n">des</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;Bruttonationalprodukt i faste  priser&#39;</span><span class="p">,</span>
           <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;Eksport &lt;&gt;;&#39;</span><span class="p">,</span>
           <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;Forbrug&#39;</span><span class="p">}</span>
    <span class="n">mmodel</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">smallmodel</span><span class="p">,</span> <span class="n">var_description</span><span class="o">=</span><span class="n">des</span><span class="p">,</span> <span class="n">svg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">browser</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">],</span><span class="s1">&#39;R&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
         <span class="s1">&#39;PPP&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]})</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;C&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
    
    <span class="n">xx</span> <span class="o">=</span> <span class="n">mmodel</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">mmodel</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
    
    <span class="c1"># zz = model.modelload(r&#39;https://raw.githubusercontent.com/IbHansen/Modelflow2/master/Examples/ADAM/baseline.pcim&#39;)</span>
    <span class="n">mpak</span><span class="p">,</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">modelload</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;pak.pcim&#39;</span><span class="p">,</span><span class="n">run</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">use_fbmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">alternative</span>  <span class="o">=</span>  <span class="n">baseline</span><span class="o">.</span><span class="n">upd</span><span class="p">(</span><span class="s2">&quot;&lt;2020 2100&gt; PAKGGREVCO2CER PAKGGREVCO2GER PAKGGREVCO2OER = 30&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">mpak</span><span class="p">(</span><span class="n">alternative</span><span class="p">,</span><span class="mi">2020</span><span class="p">,</span><span class="mi">2100</span><span class="p">,</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;Carbon tax nominal 30&#39;</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># simulates the model </span>
    <span class="n">diff_level</span><span class="p">,</span> <span class="n">att_level</span><span class="p">,</span> <span class="n">att_pct</span><span class="p">,</span> <span class="n">diff_growth</span><span class="p">,</span> <span class="n">att_growth</span> <span class="o">=</span> <span class="n">tup</span> <span class="o">=</span> <span class="n">mpak</span><span class="o">.</span><span class="n">dekomp</span><span class="p">(</span><span class="s1">&#39;PAKNECONOTHRXN&#39;</span><span class="p">,</span><span class="n">lprint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">2020</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="mi">2027</span><span class="p">)</span>


    <span class="n">fb_nodes</span><span class="p">,</span><span class="n">dag_nodes</span> <span class="o">=</span> <span class="n">mpak</span><span class="o">.</span><span class="n">get_minimal_feedback_set</span><span class="p">(</span><span class="n">mpak</span><span class="o">.</span><span class="n">endograph</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of endogenous: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mpak</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span><span class="si">}</span><span class="s1">, Number of variables in  simultaneuous block </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mpak</span><span class="o">.</span><span class="n">coreorder</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of variables in &quot;minimum&quot; feedback set: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fb_nodes</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of variables in &quot;DAG&quot; graph           : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dag_nodes</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># mtest,bk = model.modelload(r&#39;ibstestnozip&#39;)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Ib Hansen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>