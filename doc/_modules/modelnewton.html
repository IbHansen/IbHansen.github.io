

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>modelnewton &mdash; ModelFlow  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../index.html">
            
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">content:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core/Core.html">Core Modules, creates and solves model instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../onboard/onboard.html">Processing model specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../attribution/Attribution.html">Attribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vis/modelvis.html">Quick result visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../report/modelreport.html">Report writing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plotly/modeldashsidebar.html">Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jupyter/jupyter.html">Jupyter Stuff</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelinvert.html">Targets and instruments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelmf.html">Enrich dataframes with modelflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/model_cvx.html">Convex optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../used/modelsandbox.html">Template for a user defined  model class based on the model class</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ModelFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">modelnewton</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for modelnewton</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Jun 19 19:49:50 2020</span>

<span class="sd">@author: IBH</span>

<span class="sd">Module which handles model differentiation, construction of jacobi matrizex, </span>
<span class="sd">companion matrices, eigenvalues and creates dense and sparse solving functions. </span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span>  <span class="k">as</span> <span class="nn">plt</span> 
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">sympify</span> <span class="p">,</span><span class="n">Symbol</span><span class="p">,</span><span class="n">Function</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">run</span> 
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span> 
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">ip</span>
<span class="kn">import</span> <span class="nn">inspect</span> 
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">zip_longest</span>
<span class="kn">import</span> <span class="nn">fnmatch</span> 
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span>  <span class="n">display</span><span class="p">,</span><span class="n">Latex</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">zip_longest</span>
<span class="kn">from</span> <span class="nn">tqdm.notebook</span>  <span class="kn">import</span> <span class="n">tqdm</span> 
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span><span class="p">,</span><span class="n">cached_property</span>

<span class="kn">import</span> <span class="nn">re</span>


<span class="kn">import</span> <span class="nn">modelpattern</span> <span class="k">as</span> <span class="nn">pt</span>
<span class="c1"># from modelclass import model, ttimer, insertModelVar</span>


<span class="kn">from</span> <span class="nn">modelmanipulation</span> <span class="kn">import</span> <span class="n">split_frml</span><span class="p">,</span><span class="n">udtryk_parse</span><span class="p">,</span><span class="n">pastestring</span><span class="p">,</span><span class="n">stripstring</span>
<span class="c1">#import modeljupyter as mj</span>

<span class="kn">from</span> <span class="nn">modelhelp</span> <span class="kn">import</span> <span class="n">tovarlag</span><span class="p">,</span> <span class="n">ttimer</span><span class="p">,</span> <span class="n">insertModelVar</span>   
<span class="kn">import</span> <span class="nn">modeljupyter</span> <span class="k">as</span> <span class="nn">mj</span>

 
<div class="viewcode-block" id="diff_value_base">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.diff_value_base">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">diff_value_base</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; class define columns in database with values from differentiation&#39;&#39;&#39;</span>
    
    <span class="n">var</span>       <span class="p">:</span> <span class="nb">str</span>         <span class="c1"># lhs var </span>
    <span class="n">pvar</span>      <span class="p">:</span> <span class="nb">str</span>         <span class="c1"># rhs var</span>
    <span class="n">lag</span>       <span class="p">:</span> <span class="nb">int</span>         <span class="c1"># lag of rhs var</span>
    <span class="n">var_plac</span>  <span class="p">:</span> <span class="nb">int</span>         <span class="c1"># placement of lhs in array of endogeneous</span>
    <span class="n">pvar_plac</span> <span class="p">:</span> <span class="nb">int</span>         <span class="c1"># placement of lhs in array of endogeneous </span>
    <span class="n">pvar_endo</span> <span class="p">:</span> <span class="nb">bool</span>        <span class="c1"># is pvar an endogeneous variable </span>
    <span class="n">pvar_exo_plac</span> <span class="p">:</span> <span class="nb">int</span>         <span class="c1"># placement of lhs in array of endogeneous </span></div>

    
<div class="viewcode-block" id="diff_value_col">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.diff_value_col">[docs]</a>
<span class="nd">@dataclass</span><span class="p">(</span><span class="n">unsafe_hash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">diff_value_col</span><span class="p">(</span><span class="n">diff_value_base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; The hash able class which can be used as pandas columns&#39;&#39;&#39;</span></div>



<div class="viewcode-block" id="diff_value">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.diff_value">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">diff_value</span><span class="p">(</span><span class="n">diff_value_base</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; class to contain values from differentiation&#39;&#39;&#39;</span>

    <span class="n">number</span>    <span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>     <span class="c1"># index relativ to start in current_per </span>
    <span class="n">date</span>      <span class="p">:</span> <span class="nb">any</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>    <span class="c1"># index in dataframe </span></div>

               

<div class="viewcode-block" id="newton_diff">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff">[docs]</a>
<span class="k">class</span> <span class="nc">newton_diff</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">    Class to handle Newton solving for un-normalized or normalized models, i.e., models of the form:</span>
<span class="sd">    </span>
<span class="sd">    0 = G(y,x)</span>
<span class="sd">    y = F(y,x)</span>
<span class="sd">    </span>
<span class="sd">    This class provides functionalities to differentiate model equations, analyze eigenvalues and eigenvectors, </span>
<span class="sd">    and provide utilities for solving dynamic systems through various approaches.</span>
<span class="sd">    </span>
<span class="sd">    Provided Functions:</span>
<span class="sd">    - eigenvector_plot: Plot eigenvectors for a specified period.</span>
<span class="sd">    - eigplot: Plot eigenvalues for a specific period in polar coordinates.</span>
<span class="sd">    - eigplot_all: Plot all eigenvalues for specified periods in polar coordinates.</span>
<span class="sd">    - eigplot_all0: Alternative method to plot all eigenvalues in polar coordinates.</span>
<span class="sd">    - get_df_comp_dict: Get a dictionary of DataFrames representing companion matrices.</span>
<span class="sd">    - get_df_eigen_dict: Get a dictionary of DataFrames containing eigenvalues and eigenvectors.</span>
<span class="sd">    - get_diff_df_1per: Get a DataFrame of derivatives for one period.</span>
<span class="sd">    - get_diff_df_tot: Get a DataFrame of stacked Jacobian matrices for the entire period range.</span>
<span class="sd">    - get_diff_mat_1per: Get a dictionary of sparse matrices representing the Jacobian for one period.</span>
<span class="sd">    - get_diff_mat_all_1per: Get a dictionary of all derivative matrices for one period, including all lags.</span>
<span class="sd">    - get_diff_mat_tot: Get a sparse matrix representing the stacked Jacobian for the entire period range.</span>
<span class="sd">    - get_diff_melted: Get a &quot;melted&quot; DataFrame of derivatives suitable for creating sparse matrices.</span>
<span class="sd">    - get_diff_melted_var: Get a melted DataFrame of derivatives including variable information.</span>
<span class="sd">    - get_diff_values_all: Get all derivative values in a structured format.</span>
<span class="sd">    - get_diffmodel: Generate a model which calculates the partial derivatives of the original model.</span>
<span class="sd">    - get_eigen_jackknife: Perform a jackknife analysis by computing eigenvalues with each variable excluded one at a time.</span>
<span class="sd">    - get_eigen_jackknife_abs: Compute the absolute values of the largest eigenvalues from the jackknife analysis.</span>
<span class="sd">    - get_eigen_jackknife_abs_select: Summarize the absolute largest eigenvalues for a specific year from the jackknife analysis.</span>
<span class="sd">    - get_eigen_jackknife_df: Convert jackknife eigenvalue data into a DataFrame.</span>
<span class="sd">    - get_eigenvalues: Calculate and return the eigenvectors based on the companion matrix for a dynamic system.</span>
<span class="sd">    - get_feedback: Static method to return feedback on the max absolute eigenvector and its sign.</span>
<span class="sd">    - get_solve1per: Get a solving function for one period using precomputed Jacobian matrices.</span>
<span class="sd">    - get_solve1perlu: Get a LU decomposition-based solving function for one period.</span>
<span class="sd">    - get_solvestacked: Get a solving function for the stacked system of equations.</span>
<span class="sd">    - get_solvestacked_it: Get an iterative solving function for the stacked system using a specified solver.</span>
<span class="sd">    - modeldiff: Differentiate model equations with respect to endogenous variables.</span>
<span class="sd">    - show_diff: Display expressions for differential coefficients for specified variables.</span>
<span class="sd">    - show_diff_latex: Display LaTeX-formatted differential expressions and possibly their values.</span>
<span class="sd">    - show_stacked_diff: Show selected rows and columns of the stacked Jacobian as a DataFrame.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmodel</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endovar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">onlyendocur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">per</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endoandexo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="c1"># [Methods implementations]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mmodel</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">,</span> <span class="n">endovar</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="n">onlyendocur</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">timeit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">forcenum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nchunk</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">endoandexo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>

<span class="sd">        Args:</span>
<span class="sd">            mmodel (TYPE): Model to analyze.</span>
<span class="sd">            df (TYPE, optional): Dataframe. if None mmodel.lastdf will be used </span>
<span class="sd">            endovar (TYPE, optional): if set defines which endogeneous to include . Defaults to None.</span>
<span class="sd">            onlyendocur (TYPE, optional): Only calculate for the curren endogeneous variables. Defaults to False.</span>
<span class="sd">            timeit (TYPE, optional): writeout time informations . Defaults to False.</span>
<span class="sd">            silent (TYPE, optional):  Defaults to True.</span>
<span class="sd">            forcenum (TYPE, optional): Force differentiation to be numeric else try sumbolic (slower)  Defaults to False.</span>
<span class="sd">            per (TYPE, optional): Period for which to calculte the jacobi . Defaults to &#39;&#39;.</span>
<span class="sd">            ljit (TYPE, optional): Trigger just in time compilation of the differential coiefficient. Defaults to 0.</span>
<span class="sd">            nchunk (TYPE, optional): Chunks for which the model is written  - relevant if ljit == True. Defaults to None.</span>
<span class="sd">            endoandexo (TYPE, optional): Calculate for both endogeneous and exogeneous . Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span>          <span class="o">=</span> <span class="n">df</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="k">else</span> <span class="n">mmodel</span><span class="o">.</span><span class="n">lastdf</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">endovar</span>     <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mmodel</span><span class="o">.</span><span class="n">endogene</span> <span class="k">if</span> <span class="n">endovar</span> <span class="o">==</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">endovar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endoandexo</span> <span class="o">=</span> <span class="n">endoandexo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span>      <span class="o">=</span> <span class="n">mmodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onlyendocur</span> <span class="o">=</span> <span class="n">onlyendocur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxdif</span> <span class="o">=</span> <span class="mi">9999999999999</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcenum</span> <span class="o">=</span> <span class="n">forcenum</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="o">=</span> <span class="n">timeit</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">per</span><span class="o">=</span><span class="n">per</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ljit</span><span class="o">=</span><span class="n">ljit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchunk</span> <span class="o">=</span> <span class="n">nchunk</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prepare model for calculate derivatives for Newton solver&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list0</span> <span class="o">=</span>  <span class="p">[</span><span class="n">pt</span><span class="o">.</span><span class="n">kw_frml_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frmlname&#39;</span><span class="p">],</span> <span class="s1">&#39;ENDO&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> 
           <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endovar</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;___RES&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list0</span><span class="p">]</span> <span class="c1"># real endogeneous variables </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">placdic</span>   <span class="o">=</span> <span class="p">{</span><span class="n">v</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endovar</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newmodel</span> <span class="o">=</span> <span class="n">mmodel</span><span class="o">.</span><span class="vm">__class__</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endoandexo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exovar</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mmodel</span><span class="o">.</span><span class="n">exogene</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_set</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exoplacdic</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exovar</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exoplacdic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># breakpoint()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diffendocur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeldiff</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diffmodel</span><span class="p">()</span>
        
           
<div class="viewcode-block" id="newton_diff.modeldiff">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.modeldiff">[docs]</a>
    <span class="k">def</span> <span class="nf">modeldiff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Differentiate relations for self.enovar with respect to endogeneous variable </span>
<span class="sd">        The result is placed in a dictory in the model instanse: model.diffendocur</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">numdif</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">rhv</span><span class="p">,</span><span class="n">delta</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1">#        print(&#39;**&#39;,model.allvar[v][&#39;terms&#39;][&#39;frml&#39;])</span>
                <span class="k">def</span> <span class="nf">tout</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="p">:</span>
                        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">(</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">lag</span><span class="si">}</span><span class="s1">)&#39;</span>
                    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">op</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">number</span><span class="o">+</span><span class="n">t</span><span class="o">.</span><span class="n">var</span>
        
                <span class="c1"># breakpoint()      </span>
                <span class="n">nt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">]</span>
                <span class="n">assignpos</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">aequalterm</span><span class="p">)</span>                        <span class="c1"># find the position of = </span>
                <span class="n">rhsterms</span> <span class="o">=</span> <span class="n">nt</span><span class="p">[</span><span class="n">assignpos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">vterm</span> <span class="o">=</span> <span class="n">udtryk_parse</span><span class="p">(</span><span class="n">rhv</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">plusterm</span> <span class="o">=</span>  <span class="n">udtryk_parse</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">rhv</span><span class="si">}</span><span class="s1">+</span><span class="si">{</span><span class="n">delta</span><span class="o">/</span><span class="mi">2</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
                <span class="n">minusterm</span> <span class="o">=</span> <span class="n">udtryk_parse</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">rhv</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">delta</span><span class="o">/</span><span class="mi">2</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
                <span class="n">plus</span>  <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">plusterm</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">vterm</span> <span class="k">else</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rhsterms</span><span class="p">])</span>
                <span class="n">minus</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([</span><span class="n">minusterm</span> <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">vterm</span> <span class="k">else</span> <span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rhsterms</span><span class="p">])</span>
                <span class="n">eplus</span>  <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tout</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">plus</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="n">eminus</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tout</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">minus</span><span class="p">)</span><span class="si">}</span><span class="s1">)&#39;</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;(</span><span class="si">{</span><span class="n">eplus</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">eminus</span><span class="si">}</span><span class="s1">)/</span><span class="si">{</span><span class="n">delta</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">silent</span><span class="p">)</span> <span class="ow">and</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">expression</span> 
                
        
        <span class="k">def</span> <span class="nf">findallvar</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;Finds all endogenous variables which is on the right side of = in the expresion for variable v</span>
<span class="sd">            lagged variables are included if self.onlyendocur == False &#39;&#39;&#39;</span>
            <span class="c1"># print(v)</span>
            <span class="n">terms</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;terms&#39;</span><span class="p">][</span><span class="n">model</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;assigpos&#39;</span><span class="p">]:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endoandexo</span><span class="p">:</span>
                <span class="n">rhsvar</span><span class="o">=</span><span class="p">{(</span><span class="n">nt</span><span class="o">.</span><span class="n">var</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="o">+</span><span class="n">nt</span><span class="o">.</span><span class="n">lag</span><span class="o">+</span><span class="s1">&#39;)&#39;</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">lag</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span><span class="p">}</span>
                <span class="n">rhsvar</span><span class="o">=</span><span class="p">{</span><span class="n">tovarlag</span><span class="p">(</span><span class="n">nt</span><span class="o">.</span><span class="n">var</span><span class="p">,</span><span class="n">nt</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span>    <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyendocur</span> <span class="p">:</span>
                    <span class="n">rhsvar</span><span class="o">=</span><span class="p">{</span><span class="n">tovarlag</span><span class="p">(</span><span class="n">nt</span><span class="o">.</span><span class="n">var</span><span class="p">,</span><span class="n">nt</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span>   <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">.</span><span class="n">lag</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_set</span><span class="p">}</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rhsvar</span><span class="o">=</span><span class="p">{</span><span class="n">tovarlag</span><span class="p">(</span><span class="n">nt</span><span class="o">.</span><span class="n">var</span><span class="p">,</span><span class="n">nt</span><span class="o">.</span><span class="n">lag</span><span class="p">)</span>  <span class="k">for</span> <span class="n">nt</span> <span class="ow">in</span> <span class="n">terms</span> <span class="k">if</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">and</span> <span class="n">nt</span><span class="o">.</span><span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_set</span><span class="p">}</span>
            <span class="n">var2</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rhsvar</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">var2</span>

        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Find espressions for partial derivatives&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="n">clash</span> <span class="o">=</span> <span class="p">{</span><span class="n">var</span> <span class="p">:</span> <span class="n">Symbol</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="c1"># clash = {var :None for var in self.mmodel.allvar.keys()}</span>
            <span class="n">diffendocur</span><span class="o">=</span><span class="p">{}</span> <span class="c1">#defaultdict(defaultdict) #here we wanmt to store the derivativs</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">nvar</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endovar</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nvar</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxdif</span><span class="p">:</span>
                    <span class="k">break</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now differentiating </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">nvar</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    
                <span class="n">endocur</span> <span class="o">=</span> <span class="n">findallvar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                    
                <span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>
                <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">a</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">udtryk</span><span class="o">=</span><span class="n">split_frml</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">udtryk</span><span class="o">=</span><span class="n">udtryk</span>
                <span class="n">udtryk</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;LOG\(&#39;</span><span class="p">,</span><span class="s1">&#39;log(&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span> <span class="c1"># sympy uses lover case for log and exp </span>
                <span class="n">udtryk</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;EXP\(&#39;</span><span class="p">,</span><span class="s1">&#39;exp(&#39;</span><span class="p">,</span><span class="n">udtryk</span><span class="p">)</span>
                <span class="n">lhs</span><span class="p">,</span><span class="n">rhs</span><span class="o">=</span><span class="n">udtryk</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">post</span> <span class="o">=</span> <span class="s1">&#39;_____XXYY&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcenum</span><span class="p">:</span>
                        <span class="c1"># kat=sympify(rhs[0:-1], md._clash) # we take the the $ out _clash1 makes I is not taken as imiganary </span>
                        <span class="n">lookat</span> <span class="o">=</span> <span class="n">pastestring</span><span class="p">(</span><span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">post</span><span class="p">,</span><span class="n">onlylags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
                        <span class="n">kat</span><span class="o">=</span><span class="n">sympify</span><span class="p">(</span><span class="n">lookat</span><span class="p">,</span><span class="n">clash</span><span class="p">)</span> <span class="c1"># we take the the $ out _clash1 makes I is not taken as imiganary </span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">inst</span><span class="p">:</span>
                    <span class="c1"># breakpoint()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">lookat</span><span class="p">)</span>
                    <span class="c1"># print({c:type(s) for c,s in clash.items()})</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* Problem sympify &#39;</span><span class="p">,</span><span class="n">lhs</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="n">rhs</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">rhv</span> <span class="ow">in</span> <span class="n">endocur</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># breakpoint()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcenum</span><span class="p">:</span>
                            <span class="c1"># ud=str(kat.diff(sympify(rhv,md._clash)))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">ud</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">kat</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sympify</span><span class="p">(</span><span class="n">pastestring</span><span class="p">(</span><span class="n">rhv</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="n">onlylags</span><span class="o">=</span><span class="kc">True</span> <span class="p">),</span><span class="n">clash</span><span class="p">)))</span>
                                <span class="c1"># print(v,rhv,ud)</span>
                                <span class="n">ud</span> <span class="o">=</span> <span class="n">stripstring</span><span class="p">(</span><span class="n">ud</span><span class="p">,</span><span class="n">post</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">funks</span><span class="p">)</span>
                                <span class="n">ud</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">namepat</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;(?:(\()([0-9]*)(\)))&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;\g&lt;1&gt;\g&lt;2&gt;+\g&lt;3&gt;\g&lt;4&gt;&#39;</span><span class="p">,</span><span class="n">ud</span><span class="p">)</span> 
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">ud</span> <span class="o">=</span> <span class="n">numdif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">rhv</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">)</span>
                                

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcenum</span> <span class="ow">or</span> <span class="s1">&#39;DERIVATIVE(&#39;</span> <span class="ow">in</span> <span class="n">ud</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="p">:</span>
                            <span class="n">ud</span> <span class="o">=</span> <span class="n">numdif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">rhv</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;numdif of </span><span class="si">{rhv}</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">diffendocur</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">upper</span><span class="p">()][</span><span class="n">rhv</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span><span class="o">=</span><span class="n">ud</span>
        
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;we have a serious problem deriving:&#39;</span><span class="p">,</span><span class="n">lhs</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">,</span><span class="n">rhv</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">lhs</span><span class="p">,</span><span class="s1">&#39;=&#39;</span><span class="p">,</span><span class="n">rhs</span><span class="p">)</span>
                        <span class="c1"># breakpoint()</span>

                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>        
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model                           :&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of endogeneus variables  :&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">diffendocur</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of derivatives           :&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> 
        <span class="k">return</span> <span class="n">diffendocur</span></div>

    
<div class="viewcode-block" id="newton_diff.show_diff">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.show_diff">[docs]</a>
    <span class="k">def</span> <span class="nf">show_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Displays espressions for differential koifficients for a variable</span>
<span class="sd">        if var ends with * all matchning variables are displayes&#39;&#39;&#39;</span>
        <span class="n">l</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">maxnavlen</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_values_all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span>  <span class="p">[</span><span class="n">var</span> <span class="k">for</span>  <span class="n">p</span> <span class="ow">in</span> <span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_set</span><span class="p">,</span><span class="n">p</span><span class="p">)]:</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">thisvar</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">endogene</span> <span class="k">else</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">thisvar</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">thisvar</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;d</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">/d( </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1"> ) = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">thisvar</span><span class="p">][</span><span class="n">e</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&amp; = &amp; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">diffvalues</span><span class="p">[</span><span class="n">thisvar</span><span class="p">][</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="newton_diff.show_stacked_diff">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.show_stacked_diff">[docs]</a>
    <span class="k">def</span> <span class="nf">show_stacked_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lhs</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">rhs</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : list, optional</span>
<span class="sd">            DESCRIPTION. The default is None. Time for which to retrieve stacked jacobi</span>
<span class="sd">        lhs : string, optional</span>
<span class="sd">            DESCRIPTION. The default is &#39;&#39;. Left hand side variables </span>
<span class="sd">        rhs : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is &#39;&#39;. Right hand side variabnles </span>
<span class="sd">        dec : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is 2.</span>
<span class="sd">        show : TYPE, optional</span>
<span class="sd">            DESCRIPTION. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        selected rows and columns of stacked jacobi as dataframe .</span>

<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>

        <span class="n">stacked_df_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_df_tot</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">perslice</span> <span class="o">=</span>  <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># [stacked_df_all.index[0][0],stacked_df_all.index[0][-1]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perslice</span> <span class="o">=</span>  <span class="n">time</span>
            
        <span class="k">if</span> <span class="n">lhs</span><span class="p">:</span>
            <span class="n">lhsslice</span> <span class="o">=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">lhsslice</span> <span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#  [stacked_df_all.index[0][1],stacked_df_all.index[0][-1]]</span>

        <span class="k">if</span> <span class="n">rhs</span><span class="p">:</span>
            <span class="n">rhsslice</span> <span class="o">=</span> <span class="n">rhs</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">rhsslice</span> <span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#  [stacked_df_all.index[0][1],stacked_df_all.index[0][-1]]</span>
 
        
 <span class="c1"># breakpoint() </span>
        <span class="c1"># slices = idx[perslice,varslice]</span>
        <span class="n">stacked_df</span> <span class="o">=</span> <span class="n">stacked_df_all</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">perslice</span><span class="p">,</span><span class="n">lhsslice</span><span class="p">),</span>
                                        <span class="p">(</span><span class="n">perslice</span><span class="p">,</span><span class="n">rhsslice</span><span class="p">)]</span>    
        
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">sdec</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">display</span><span class="p">(</span> <span class="n">HTML</span><span class="p">(</span><span class="n">stacked_df</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">,.</span><span class="si">{</span><span class="n">sdec</span><span class="si">}</span><span class="s1">f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="s1">&#39;        &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_html</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">stacked_df</span></div>

                
<div class="viewcode-block" id="newton_diff.show_diff_latex">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.show_diff_latex">[docs]</a>
    <span class="k">def</span> <span class="nf">show_diff_latex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pat</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">show_expression</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">show_values</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">maxper</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">varpat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;(?P&lt;var&gt;[a-zA-Z_]\w*)\((?P&lt;lag&gt;[+-][0-9]+)\)&#39;</span>
        <span class="c1"># varlatex = &#39;\g&lt;var&gt;_{t\g&lt;lag&gt;}&#39;</span>
        
        
        <span class="k">def</span> <span class="nf">partial_to_latex</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>
            <span class="n">udtryk</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;\frac{\partial &#39;</span><span class="o">+</span> <span class="n">mj</span><span class="o">.</span><span class="n">an_expression_to_latex</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;}{\partial &#39;</span><span class="o">+</span><span class="n">mj</span><span class="o">.</span><span class="n">an_expression_to_latex</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}&#39;</span>
            <span class="k">return</span> <span class="n">udtryk</span>
         
        <span class="k">if</span> <span class="n">show_values</span><span class="p">:</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_values_all</span><span class="p">()</span>
            
        
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span>  <span class="p">[</span><span class="n">var</span> <span class="k">for</span>  <span class="n">p</span> <span class="ow">in</span> <span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_set</span><span class="p">,</span><span class="n">p</span><span class="p">)]:</span>
            <span class="n">thisvar</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">endogene</span> <span class="k">else</span> <span class="n">v</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span>
            
            <span class="n">_</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">mj</span><span class="o">.</span><span class="n">frml_as_latex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">thisvar</span><span class="p">][</span><span class="s2">&quot;frml&quot;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="c1"># display(Latex(r&#39;$&#39;+frmlud+r&#39;$&#39;))</span>

            
            <span class="k">if</span> <span class="n">show_expression</span><span class="p">:</span>
                <span class="n">totud</span> <span class="o">=</span> <span class="p">[</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">partial_to_latex</span><span class="p">(</span><span class="n">thisvar</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="si">}</span><span class="s1"> &amp; = &amp; </span><span class="si">{</span><span class="n">mj</span><span class="o">.</span><span class="n">an_expression_to_latex</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> 
                         <span class="k">for</span>  <span class="n">i</span><span class="p">,</span><span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">thisvar</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
                <span class="n">ud</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">totud</span><span class="p">)</span>    
                <span class="n">display</span><span class="p">(</span><span class="n">Latex</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\begin{eqnarray*}&#39;</span><span class="o">+</span><span class="n">ud</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39;\end{eqnarray*} &#39;</span><span class="p">))</span>
                <span class="c1">#display(Latex(f&#39;{ud}&#39;))</span>
            
            
            <span class="k">if</span> <span class="n">show_values</span><span class="p">:</span>
                <span class="c1"># breakpoint()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffvalues</span><span class="p">[</span><span class="n">thisvar</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                    <span class="n">resdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffvalues</span><span class="p">[</span><span class="n">thisvar</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:</span><span class="n">maxper</span><span class="p">]</span>
                    <span class="n">resdf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$&#39;</span><span class="o">+</span><span class="n">partial_to_latex</span><span class="p">(</span><span class="n">thisvar</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;$&#39;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffvalues</span><span class="p">[</span><span class="n">thisvar</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                    <span class="n">markout</span> <span class="o">=</span> <span class="n">resdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,:]</span><span class="o">.</span><span class="n">to_markdown</span><span class="p">()</span>
                    <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">markout</span><span class="p">))</span>     </div>

         <span class="c1">#  print(       (r&#39;\begin{eqnarray}&#39;+ud+r&#39;\end{eqnarray} &#39;))</span>

<div class="viewcode-block" id="newton_diff.get_diffmodel">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diffmodel">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diffmodel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Returns a model which calculates the partial derivatives of a model&#39;&#39;&#39;</span>
        
        <span class="k">def</span> <span class="nf">makelag</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="n">vterm</span> <span class="o">=</span> <span class="n">udtryk_parse</span><span class="p">(</span><span class="n">var</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vterm</span><span class="o">.</span><span class="n">lag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vterm</span><span class="o">.</span><span class="n">lag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vterm</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">___lag___</span><span class="si">{</span><span class="n">vterm</span><span class="o">.</span><span class="n">lag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">elif</span> <span class="n">vterm</span><span class="o">.</span><span class="n">lag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vterm</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">___lead___</span><span class="si">{</span><span class="n">vterm</span><span class="o">.</span><span class="n">lag</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vterm</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">___per___</span><span class="si">{</span><span class="n">vterm</span><span class="o">.</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">vterm</span><span class="o">.</span><span class="n">var</span><span class="si">}</span><span class="s1">___lag___0&#39;</span>
            
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Generates a model which calculatews the derivatives for a model&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lhsvar</span><span class="si">}</span><span class="s1">__P__</span><span class="si">{</span><span class="n">makelag</span><span class="p">(</span><span class="n">rhsvar</span><span class="p">)</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">lhsvar</span><span class="p">][</span><span class="n">rhsvar</span><span class="p">]</span><span class="si">}</span><span class="s1">  &#39;</span>
                    <span class="k">for</span> <span class="n">lhsvar</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">rhsvar</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffendocur</span><span class="p">[</span><span class="n">lhsvar</span><span class="p">])</span>
                    <span class="p">]</span> <span class="p">)</span>
            <span class="n">dmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">newmodel</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="n">funks</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">funks</span><span class="p">,</span><span class="n">straight</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="n">modelname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span><span class="s1">&#39; Derivatives &#39;</span><span class="o">+</span> <span class="s1">&#39; no lags and leads&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onlyendocur</span> <span class="k">else</span> <span class="s1">&#39; all lags and leads&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dmodel</span> </div>

 


<div class="viewcode-block" id="newton_diff.get_diff_melted">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_melted">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_melted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;returns a tall matrix with all values to construct jacobimatrix(es)  &#39;&#39;&#39;</span>
        
        <span class="k">def</span> <span class="nf">get_lagnr</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; extract lag/lead from variable name and returns a signed lag (leads are positive&#39;&#39;&#39;</span>
            <span class="c1"># breakpoint()</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;AG&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        
        
        <span class="k">def</span> <span class="nf">get_elm</span><span class="p">(</span><span class="n">vartuples</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39; returns a list of lags  list of tupels &#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vartuples</span><span class="p">]</span>
            
        <span class="n">_per_first</span> <span class="o">=</span> <span class="n">periode</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">periode</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">current_per</span>  
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_per_first</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">_per</span>  <span class="o">=</span> <span class="n">_per_first</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_per</span> <span class="o">=</span> <span class="p">[</span><span class="n">_per_first</span><span class="p">]</span>
            
        <span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>  <span class="o">!=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="k">else</span> <span class="n">df</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">_df</span>
        <span class="n">_df</span> <span class="o">=</span> <span class="n">_df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df0</span><span class="p">:</span> <span class="n">df0</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df0</span><span class="o">.</span><span class="n">columns</span><span class="p">}))</span>
   
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">_per</span>     
        <span class="c1"># breakpoint()</span>
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;calculate derivatives&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">res</span><span class="p">(</span><span class="n">_df</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ljit</span><span class="p">,</span>
                                              <span class="n">chunk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nchunk</span><span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_per</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">endogene</span><span class="p">)]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Prepare wide input to sparse matrix&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">cname</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;cname&#39;</span><span class="p">,</span><span class="s1">&#39;var,pvar,lag&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coltup</span> <span class="o">=</span> <span class="p">[</span><span class="n">cname</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__P__&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> 
                            <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__P__&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___L&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">get_lagnr</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__P__&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___L&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span> 
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">difres</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="c1"># breakpoint()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coltupnum</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">placdic</span><span class="p">[</span><span class="n">var</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">placdic</span><span class="p">[</span><span class="n">pvar</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">pvar</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span> <span class="k">else</span> <span class="n">pvar</span><span class="p">],</span><span class="n">lag</span><span class="p">)</span> 
                               <span class="k">for</span> <span class="n">var</span><span class="p">,</span><span class="n">pvar</span><span class="p">,</span><span class="n">lag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coltup</span><span class="p">]</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">difres</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coltupnum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">difres</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maxnumber</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numbers_to_date</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">n</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">difres</span><span class="o">.</span><span class="n">index</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nvar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endovar</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">difres</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">numbers</span>
            
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;melt the wide input to sparse matrix&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="n">dmelt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">difres</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>
            <span class="n">dmelt</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">dmelt</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>

            
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;assign tall input to sparse matrix&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="c1"># breakpoint()</span>
            <span class="n">dmelt</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">var</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_elm</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                          <span class="n">pvar</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_elm</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                                          <span class="n">lag</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_elm</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> 
        <span class="k">return</span> <span class="n">dmelt</span></div>

    
  

<div class="viewcode-block" id="newton_diff.get_diff_mat_tot">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_mat_tot">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_mat_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Fetch a stacked jacobimatrix for the whole model.current_per</span>
<span class="sd">        </span>
<span class="sd">        Returns a sparse matrix.&#39;&#39;&#39;</span> 
        <span class="n">dmelt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_melted</span><span class="p">(</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="n">dmelt</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">        keep = (@self.maxnumber &gt;= lag+number) &amp; (lag+number  &gt;=0)</span>
<span class="s1">        row = number * @self.nvar + var</span>
<span class="s1">        col = (number+lag) *@self.nvar +pvar &#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">dmelt</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;keep&#39;</span><span class="p">)</span>

<span class="c1">#csc_matrix((data, (row_ind, col_ind)), [shape=(M, N)]) </span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvar</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span>  <span class="n">dmelt</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span> 
        <span class="n">indicies</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmelt</span><span class="o">.</span><span class="n">row</span><span class="p">,</span><span class="n">dmelt</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stacked</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">values</span><span class="p">,</span><span class="n">indicies</span> <span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">normalized</span><span class="p">:</span>
            <span class="n">this</span> <span class="o">=</span> <span class="n">raw</span> <span class="o">-</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">this</span> <span class="o">=</span> <span class="n">raw</span>
        <span class="k">return</span> <span class="n">this</span> </div>

    
<div class="viewcode-block" id="newton_diff.get_diff_df_tot">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_df_tot">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_df_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#breakpoint()</span>
        <span class="n">stacked_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_mat_tot</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
        <span class="n">colindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">],</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="n">rowindex</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">current_per</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">],</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;per&#39;</span><span class="p">,</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stacked_mat</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">rowindex</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">colindex</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

    
    
<div class="viewcode-block" id="newton_diff.get_diff_mat_1per">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_mat_1per">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_mat_1per</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; fetch a dict of one periode sparse jacobimatrices &#39;&#39;&#39;</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">dmelt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_melted</span><span class="p">(</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

        <span class="n">dmelt</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">        keep = lag == 0</span>
<span class="s1">        row =  var</span>
<span class="s1">        col = pvar &#39;&#39;&#39;</span><span class="p">)</span>
        <span class="n">outdic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dmelt</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;keep&#39;</span><span class="p">)</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span>  
        <span class="k">for</span> <span class="n">per</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span>  <span class="n">df</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span>  
            <span class="n">indicies</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">values</span><span class="p">,</span><span class="n">indicies</span> <span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvar</span><span class="p">))</span>
            <span class="c1"># breakpoint()</span>
<span class="c1">#csc_matrix((data, (row_ind, col_ind)), [shape=(M, N)]) </span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">normalized</span><span class="p">:</span>
                <span class="n">this</span> <span class="o">=</span> <span class="n">raw</span> <span class="o">-</span><span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvar</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csc&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">this</span> <span class="o">=</span> <span class="n">raw</span>
            <span class="n">outdic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">numbers_to_date</span><span class="p">[</span><span class="n">per</span><span class="p">]]</span> <span class="o">=</span> <span class="n">this</span> 

        <span class="k">return</span> <span class="n">outdic</span></div>


    
 
<div class="viewcode-block" id="newton_diff.get_diff_df_1per">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_df_1per">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_df_1per</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jacsparsedic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_mat_1per</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jacdfdic</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">jac</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endovar</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endovar</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">jac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacsparsedic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacdfdic</span></div>

     
    

 
<div class="viewcode-block" id="newton_diff.get_solve1perlu">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_solve1perlu">[docs]</a>
    <span class="k">def</span> <span class="nf">get_solve1perlu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="c1">#        if update or not hasattr(self,&#39;stacked&#39;):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jacsparsedic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_mat_1per</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ludic</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lu_factor</span><span class="p">(</span><span class="n">jac</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">jac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacsparsedic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solveludic</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">distance</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lu_solve</span><span class="p">(</span><span class="n">lu</span><span class="p">,</span><span class="n">distance</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">lu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ludic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solveludic</span></div>

    
<div class="viewcode-block" id="newton_diff.get_solve1per">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_solve1per">[docs]</a>
    <span class="k">def</span> <span class="nf">get_solve1per</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="c1">#        if update or not hasattr(self,&#39;stacked&#39;):</span>
        <span class="c1"># breakpoint()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jacsparsedic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_mat_1per</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solvelusparsedic</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">factorized</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">jac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jacsparsedic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvelusparsedic</span></div>


     
<div class="viewcode-block" id="newton_diff.get_solvestacked">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_solvestacked">[docs]</a>
    <span class="k">def</span> <span class="nf">get_solvestacked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="c1">#        if update or not hasattr(self,&#39;stacked&#39;):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_mat_tot</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solvestacked</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">factorized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stacked</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solvestacked</span></div>

    
<div class="viewcode-block" id="newton_diff.get_solvestacked_it">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_solvestacked_it">[docs]</a>
    <span class="k">def</span> <span class="nf">get_solvestacked_it</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">solver</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">bicg</span><span class="p">):</span>
<span class="c1">#        if update or not hasattr(self,&#39;stacked&#39;):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stacked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_mat_tot</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">solvestacked_it</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            <span class="k">return</span>  <span class="n">solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stacked</span><span class="p">,</span><span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> 
        
        <span class="k">return</span> <span class="n">solvestacked_it</span></div>


<div class="viewcode-block" id="newton_diff.get_diff_melted_var">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_melted_var">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_melted_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;makes dict with all  derivative matrices for all lags &#39;&#39;&#39;</span>
            
            <span class="k">def</span> <span class="nf">get_lagnr</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39; extract lag/lead from variable name and returns a signed lag (leads are positive&#39;&#39;&#39;</span>
                <span class="c1">#breakpoint()</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;AG&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            
            
            <span class="k">def</span> <span class="nf">get_elm</span><span class="p">(</span><span class="n">vartuples</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39; returns a list of lags  list of tupels &#39;&#39;&#39;</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vartuples</span><span class="p">]</span>
                
            <span class="n">_per_first</span> <span class="o">=</span> <span class="n">periode</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">periode</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">current_per</span>  
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_per_first</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="n">_per</span>  <span class="o">=</span> <span class="n">_per_first</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_per</span> <span class="o">=</span> <span class="p">[</span><span class="n">_per_first</span><span class="p">]</span>
                
            <span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>  <span class="o">!=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="k">else</span> <span class="n">df</span>  
            <span class="n">_df</span> <span class="o">=</span> <span class="n">_df</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df0</span><span class="p">:</span> <span class="n">df0</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df0</span><span class="o">.</span><span class="n">columns</span><span class="p">}))</span>
       
            <span class="bp">self</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">current_per</span> <span class="o">=</span> <span class="n">_per</span>     
            <span class="c1"># breakpoint()</span>
            <span class="n">difres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">res</span><span class="p">(</span><span class="n">_df</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">,</span><span class="n">stats</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ljit</span><span class="p">,</span><span class="n">chunk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nchunk</span>
                                         <span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_per</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">endogene</span><span class="p">)]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
                  
            <span class="n">cname</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;cname&#39;</span><span class="p">,</span><span class="s1">&#39;var,pvar,lag&#39;</span><span class="p">)</span>
            <span class="n">col_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">cname</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;__P__&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> 
                            <span class="n">i</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;__P__&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___L&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="n">get_lagnr</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;__P__&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___L&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span> 
                   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">difres</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            
            <span class="n">col_ident</span> <span class="o">=</span> <span class="p">[</span><span class="n">diff_value_col</span><span class="p">(</span><span class="o">**</span><span class="n">i</span><span class="o">.</span><span class="n">_asdict</span><span class="p">(),</span> <span class="n">var_plac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">placdic</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">var</span><span class="p">],</span>
            <span class="n">pvar_plac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">placdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">pvar</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">pvar</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">endogene</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span><span class="o">.</span><span class="n">pvar</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">pvar_endo</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">pvar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">endogene</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">pvar</span><span class="o">+</span><span class="s1">&#39;___RES&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">endogene</span><span class="p">,</span>
            <span class="n">pvar_exo_plac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exoplacdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">pvar</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_vars</span><span class="p">]</span>
            
            <span class="n">difres</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">col_ident</span>
            <span class="n">difres</span> <span class="o">=</span> <span class="n">difres</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 
            <span class="n">difres</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;dates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">difres</span><span class="o">.</span><span class="n">index</span>
            <span class="n">dmelt</span> <span class="o">=</span> <span class="n">difres</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;dates&#39;</span><span class="p">)</span>
            <span class="n">unfolded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">variable</span><span class="o">.</span><span class="n">values</span><span class="p">])</span>
            <span class="n">totalmelt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dmelt</span><span class="p">[[</span><span class="s1">&#39;dates&#39;</span><span class="p">,</span><span class="s1">&#39;value&#39;</span><span class="p">]],</span><span class="n">unfolded</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># breakpoint()</span>

            
            <span class="k">return</span> <span class="n">totalmelt</span></div>

        
<div class="viewcode-block" id="newton_diff.get_diff_mat_all_1per">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_mat_all_1per">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_mat_all_1per</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">asdf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">dmelt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_melted_var</span><span class="p">(</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Prepare numpy input to sparse matrix&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="n">outdic</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pvar_endo&#39;</span><span class="p">,</span><span class="s1">&#39;dates&#39;</span><span class="p">,</span><span class="s1">&#39;lag&#39;</span><span class="p">])</span>  
            <span class="k">for</span> <span class="p">(</span><span class="n">endo</span><span class="p">,</span><span class="n">date</span><span class="p">,</span><span class="n">lag</span><span class="p">),</span><span class="n">df</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span>  <span class="n">df</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span>  
                <span class="c1"># breakpoint()</span>
    <span class="c1"># #csc_matrix((data, (row_ind, col_ind)), [shape=(M, N)]) </span>
                <span class="c1"># print(f&#39;endo:{endo} ,date:{date}, lag:{lag}, \n df&#39;)</span>
                <span class="k">if</span> <span class="n">endo</span><span class="p">:</span>
                    <span class="n">indicies</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">var_plac</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">pvar_plac</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">this</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">values</span><span class="p">,</span><span class="n">indicies</span> <span class="p">),</span> 
                         <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">)))</span>
                    
                    <span class="k">if</span> <span class="n">asdf</span><span class="p">:</span> 
                        <span class="n">outdic</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;lag=</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> 
            <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outdic</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;endo&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;lag=</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indicies</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">var_plac</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">pvar_exo_plac</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">this</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">csc_matrix</span><span class="p">((</span><span class="n">values</span><span class="p">,</span><span class="n">indicies</span> <span class="p">),</span> 
                         <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endovar</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exovar</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">asdf</span><span class="p">:</span>
                        <span class="n">outdic</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;exo&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;lag=</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exovar</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">declared_endo_list</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outdic</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;exo&#39;</span><span class="p">][</span><span class="sa">f</span><span class="s1">&#39;lag=</span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">this</span> 
                         
        <span class="k">return</span> <span class="n">outdic</span></div>


<div class="viewcode-block" id="newton_diff.get_diff_values_all">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_diff_values_all">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diff_values_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">asdf</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; stuff the values of derivatives into nested dic &#39;&#39;&#39;</span>
        <span class="n">dmelt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_melted_var</span><span class="p">(</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ttimer</span><span class="p">(</span><span class="s1">&#39;Prepare numpy input to sparse matrix&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeit</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diffvalues</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">))</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="n">dmelt</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">,</span><span class="s1">&#39;pvar&#39;</span><span class="p">,</span><span class="s1">&#39;lag&#39;</span><span class="p">])</span>  
            <span class="k">for</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">pvar</span><span class="p">,</span><span class="n">lag</span><span class="p">),</span><span class="n">df</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;pvar&#39;</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;dates&#39;</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
                <span class="n">pvar_name</span> <span class="o">=</span> <span class="n">tovarlag</span><span class="p">(</span><span class="n">pvar</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">lag</span><span class="p">))</span>
                <span class="c1">#reakpoint()</span>
    <span class="c1"># #csc_matrix((data, (row_ind, col_ind)), [shape=(M, N)]) </span>
                <span class="c1"># print(f&#39;endo:{endo} ,date:{date}, lag:{lag}, \n df&#39;)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">diffvalues</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">pvar_name</span><span class="p">]</span><span class="o">=</span><span class="n">res</span>                         
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffvalues</span></div>

    
    

<div class="viewcode-block" id="newton_diff.get_eigenvalues">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_eigenvalues">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigenvalues</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">filnan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dropvar_nr</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">progressbar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate and return the eigenvectors based on the companion matrix for a dynamic system.</span>
<span class="sd">    </span>
<span class="sd">        This method computes the eigenvectors of a dynamic system represented by a companion matrix derived from Jacobian matrices for different periods. The computation involves handling missing values, optionally filling NaN values with zero, and the ability to drop specific variables from the calculation.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - periode (optional): The period for which the eigenvectors are to be calculated. If None, defaults to the entire range.</span>
<span class="sd">        - asdf (bool, optional): Determines the format of the matrices (DataFrame or sparse matrix). Defaults to True (DataFrame).</span>
<span class="sd">        - filnan (bool, optional): If True, fills NaN values in the Jacobian matrices with zero. Defaults to False.</span>
<span class="sd">        - silent (bool, optional): If False, prints detailed information about NaN values and other relevant details during the computation. Defaults to False.</span>
<span class="sd">        - dropvar (optional): Specifies variables to be dropped from the calculation. If None, no variables are dropped. Defaults to None.</span>
<span class="sd">        - dropvar_nr (int, optional): The number of variables to drop. Defaults to 0.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">        dict: A dictionary with keys as dates and values as eigenvectors for each period, derived from the companion matrix of the system.</span>
<span class="sd">    </span>
<span class="sd">        The function performs several steps:</span>
<span class="sd">        - Computes the Jacobian matrices for the given period.</span>
<span class="sd">        - Handles NaN values based on the &#39;filnan&#39; parameter.</span>
<span class="sd">        - Optionally drops specified variables from the calculation.</span>
<span class="sd">        - Constructs the companion matrix from the modified Jacobian matrices.</span>
<span class="sd">        - Calculates the eigenvectors from the companion matrix.</span>
<span class="sd">    </span>
<span class="sd">        Note:</span>
<span class="sd">        The companion matrix is crucial in analyzing the stability and dynamics of the system. The eigenvectors provide insights into the system&#39;s behavior over time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>
         
        <span class="n">first_element</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">dic</span><span class="p">:</span> <span class="n">dic</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># first element in a dict </span>
        <span class="c1"># print(&#39;Calculate derivatives&#39;)        </span>
        <span class="n">jacobiall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diff_mat_all_1per</span><span class="p">(</span><span class="n">periode</span><span class="p">,</span><span class="n">asdf</span><span class="o">=</span><span class="n">asdf</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">content</span> <span class="ow">in</span> <span class="n">jacobiall</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">lag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;endo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">this</span> <span class="o">:=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)])</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">filnan</span><span class="p">:</span> 
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1"> These elements in the jacobi is set to zero&#39;</span><span class="p">,</span><span class="n">this</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>     
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">lag</span><span class="si">}</span><span class="s1"> These elements in the jacobi contains NaN, You can use filnan = True to set values equal to 0&#39;</span><span class="p">,</span><span class="n">this</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        
                        <span class="n">pat</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">show_diff_latex</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
                            
                        
                    
        <span class="n">A_dic_gross0</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span> <span class="p">:</span> <span class="p">{</span><span class="n">lag</span> <span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="n">filnan</span> <span class="k">else</span> <span class="n">df</span> <span class="k">for</span> <span class="n">lag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">content</span><span class="p">[</span><span class="s1">&#39;endo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> 
                <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">content</span> <span class="ow">in</span> <span class="n">jacobiall</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
        <span class="c1"># vnow to get lag=-1 leftmost and so om </span>
        <span class="n">A_dic_gross</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="n">lag</span> <span class="p">:</span> <span class="n">content</span><span class="p">[</span><span class="n">lag</span><span class="p">]</span> 
                              <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                       
                      <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">content</span> <span class="ow">in</span>  <span class="n">A_dic_gross0</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dropvar</span><span class="p">)</span><span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">A_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="n">lag</span><span class="p">:</span> <span class="n">df</span> <span class="k">for</span> <span class="n">lag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">a_year</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span> <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">a_year</span> <span class="ow">in</span> <span class="n">A_dic_gross</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">A_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="n">lag</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">dropvar</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">dropvar</span><span class="p">)</span> <span class="k">for</span> <span class="n">lag</span><span class="p">,</span><span class="n">df</span> <span class="ow">in</span> <span class="n">a_year</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span> <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">a_year</span> <span class="ow">in</span> <span class="n">A_dic_gross</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
            <span class="c1"># print(f&#39;{dropvar_nr} {dropvar}&#39;)</span>
        <span class="c1"># breakpoint()    </span>
        <span class="n">xlags</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">lag</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">first_element</span><span class="p">(</span><span class="n">A_dic</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">lag</span> <span class="o">!=</span><span class="s1">&#39;lag=0&#39;</span><span class="p">],</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">lag</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">lag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">number</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">xlags</span><span class="p">)</span>
        <span class="c1"># dim = len(self.endovar) </span>
        <span class="n">first_A_dict</span> <span class="o">=</span> <span class="n">first_element</span><span class="p">(</span><span class="n">A_dic</span><span class="p">)</span> <span class="c1"># The first dict of A&#39;s </span>
        <span class="n">first_A</span> <span class="o">=</span> <span class="n">first_A_dict</span><span class="p">[</span><span class="s1">&#39;lag=0&#39;</span><span class="p">]</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span> <span class="o">=</span> <span class="n">first_A</span><span class="o">.</span><span class="n">columns</span> 
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first_A</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">asdf</span><span class="p">:</span>
            <span class="n">np_to_df</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">nparray</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nparray</span><span class="p">,</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">)</span> 
            <span class="n">lib</span>           <span class="o">=</span> <span class="n">np</span>
            <span class="n">values</span>        <span class="o">=</span> <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span>
            <span class="n">calc_eig</span>      <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span>
            <span class="n">calc_eig_reserve</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">sparse_matrix</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">sparse_matrix</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">np_to_df</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">sparse_matrix</span> <span class="p">:</span> <span class="n">sparse_matrix</span>           
            <span class="n">lib</span>           <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">sparse</span>
            <span class="n">values</span>        <span class="o">=</span> <span class="k">lambda</span> <span class="n">sparse_matrix</span> <span class="p">:</span> <span class="n">sparse_matrix</span>
            <span class="n">calc_eig</span>      <span class="o">=</span> <span class="k">lambda</span> <span class="n">sparse_matrix</span> <span class="p">:</span> <span class="n">lib</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigs</span><span class="p">(</span><span class="n">sparse_matrix</span><span class="p">)</span>
            <span class="n">calc_eig_reserve</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">sparse_matrix</span> <span class="p">:</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">sparse_matrix</span><span class="o">.</span><span class="n">toarray</span><span class="p">())</span>
            
        <span class="n">I</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0000</span>
     
        <span class="n">zeros</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_dic</span> <span class="o">=</span> <span class="n">A_dic</span> 

                                      <span class="c1"># a idendity matrix</span>
        <span class="n">AINV_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span><span class="p">:</span> <span class="n">np_to_df</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">I</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="s1">&#39;lag=0&#39;</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">A</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">A_dic</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="s1">&#39;Invert (I-A)&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progressbar</span> <span class="k">else</span> <span class="n">A_dic</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="p">}</span>  
        
        <span class="n">C_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span><span class="p">:</span> <span class="p">{</span><span class="n">lag</span> <span class="p">:</span> <span class="n">AINV_dic</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">@</span> <span class="n">A</span><span class="p">[</span><span class="n">lag</span><span class="p">]</span> <span class="k">for</span> <span class="n">lag</span><span class="p">,</span><span class="n">Alag</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">lag</span><span class="o">!=</span><span class="s1">&#39;lag=0&#39;</span><span class="p">}</span> 
                    <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">A</span> <span class="ow">in</span> <span class="n">A_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>         <span class="c1"># calculate A**-1*A(lag)</span>
        
        <span class="c1"># top=lib.eye((number-1)*dim,(number)*dim,dim)</span>
        <span class="n">newbottom</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">eye</span><span class="p">((</span><span class="n">number</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dim</span><span class="p">,(</span><span class="n">number</span><span class="p">)</span><span class="o">*</span><span class="n">dim</span><span class="p">)</span>
      <span class="c1">#  top=lib.eye((number)*dim,(number+1)*dim,dim)</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">top_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span><span class="p">:</span> <span class="n">lib</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">values</span><span class="p">(</span><span class="n">thisC</span><span class="p">)</span> <span class="k">for</span> <span class="n">thisC</span> <span class="ow">in</span> <span class="n">C</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> <span class="k">for</span> 
                      <span class="n">date</span><span class="p">,</span><span class="n">C</span> <span class="ow">in</span> <span class="n">C_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">comp_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">top</span> <span class="ow">in</span> <span class="n">top_dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">comp_dic</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">top</span><span class="p">,</span><span class="n">newbottom</span><span class="p">])</span> 
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">eigen_values_and_vectors</span> <span class="o">=</span>  <span class="p">{</span><span class="n">date</span> <span class="p">:</span> <span class="n">calc_eig</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="p">(</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">comp_dic</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span><span class="s1">&#39;Calculate  Eigenvalues&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">progressbar</span> <span class="k">else</span> <span class="n">comp_dic</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="p">}</span> 
        <span class="k">except</span><span class="p">:</span>     
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using reserve calculatioon of eigenvalues </span><span class="si">{</span><span class="n">dropvar_nr</span><span class="si">=}</span><span class="s1"> </span><span class="si">{</span><span class="n">dropvar</span><span class="si">=}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="n">eigen_values_and_vectors</span> <span class="o">=</span>  <span class="p">{</span><span class="n">date</span> <span class="p">:</span> <span class="n">calc_eig_reserve</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span> <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">comp</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">comp_dic</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span> 


        <span class="n">eig_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">date</span> <span class="p">:</span> <span class="n">both</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">both</span> <span class="ow">in</span> <span class="n">eigen_values_and_vectors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span> 
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eig_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">):</span>
            <span class="o">...</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> 
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;here&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eig_dic</span><span class="p">[</span><span class="n">date</span><span class="p">])))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">A_dic</span> <span class="o">=</span> <span class="n">A_dic</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_dic</span> <span class="o">=</span> <span class="n">comp_dic</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">eigen_values_and_vectors</span> <span class="o">=</span> <span class="n">eigen_values_and_vectors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eig_dic</span> <span class="o">=</span> <span class="n">eig_dic</span>
        <span class="k">return</span> <span class="n">eig_dic</span></div>

    
<div class="viewcode-block" id="newton_diff.get_eigen_jackknife">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_eigen_jackknife">[docs]</a>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>   
    <span class="k">def</span> <span class="nf">get_eigen_jackknife</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxnames</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Compute and cache eigenvalues for matrices with each variable excluded one at a time, up to a maximum number.</span>

<span class="sd">This function uses the jackknife technique to evaluate the impact of each variable on the system&#39;s stability by excluding each variable one by one from the eigenvector calculation. It caches the results for efficient repeated access.</span>

<span class="sd">Parameters:</span>
<span class="sd">- maxnames (int, optional): The maximum number of variables to consider for exclusion in the jackknife process. Defaults to 20.</span>

<span class="sd">Returns:</span>
<span class="sd">dict: A dictionary where keys are the names of variables excluded (or &#39;ALL&#39; for no exclusion) and values are the corresponding eigenvectors.</span>

<span class="sd">Note:</span>
<span class="sd">The function is computationally intensive and can take significant time for larger systems.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;eig_dic&#39;</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvalues</span> <span class="p">(</span><span class="n">filnan</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">asdf</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">name_to_loop</span> <span class="o">=</span><span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxnames</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_FITTED&#39;</span><span class="p">)</span> <span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Calculating eigenvalues of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">name_to_loop</span><span class="p">)</span><span class="si">}</span><span class="s1">  different matrices takes time, so make cup of coffee and a take a short nap&#39;</span><span class="p">)</span>
        <span class="n">jackknife_dict</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvalues</span> <span class="p">(</span><span class="n">dropvar</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">name_to_loop</span><span class="p">)</span> <span class="k">if</span> <span class="n">progressbar</span> <span class="k">else</span> <span class="n">name_to_loop</span><span class="p">)}</span>
        
        <span class="n">base_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NONE&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigenvalues</span> <span class="p">(</span><span class="n">dropvar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span>  <span class="p">)}</span> <span class="c1"># we leave the properties clean </span>

        
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">base_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">jackknife_dict</span><span class="p">}</span> </div>


<div class="viewcode-block" id="newton_diff.get_eigen_jackknife_df">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_eigen_jackknife_df">[docs]</a>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>   
    <span class="k">def</span> <span class="nf">get_eigen_jackknife_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">maxnames</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">,</span><span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filecache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the eigenvalue data obtained from a jackknife analysis into a pandas DataFrame, including additional columns for the absolute length, real, and imaginary parts of the eigenvalues.</span>

<span class="sd">    The jackknife analysis is performed by computing and caching eigenvalues for matrices with each variable excluded one at a time, up to a specified maximum number. This method uses the jackknife technique to evaluate the impact of each variable on the system&#39;s stability by excluding each variable one by one from the eigenvector calculation. The results are then flattened and transformed into a DataFrame for further analysis.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - maxnames (int, optional): The maximum number of variables to consider for exclusion in the jackknife process. Defaults to 200,000.</span>
<span class="sd">    - progressbar (bool, optional): If True, displays a progress bar during the computation of eigenvalues. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">    pandas.DataFrame: A DataFrame containing the eigenvalues with additional columns for length, real, and imaginary parts. Each row represents an eigenvalue for a specific variable exclusion, year, and index.</span>

<span class="sd">    Note:</span>
<span class="sd">    - The function is computationally intensive and can take significant time for larger systems.</span>
<span class="sd">    - A progress bar can be displayed for monitoring the computation progress.</span>
<span class="sd">    - The function is especially useful for detailed analysis and visualization of the eigenvalues obtained from the jackknife analysis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
        <span class="n">jackfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;jackdf.csv&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">refresh</span><span class="p">)</span>  <span class="ow">and</span> <span class="n">jackfile</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">filecache</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;jackdf.csv&#39;</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Jackdf read from file&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span> 
        
        <span class="n">jackdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigen_jackknife</span><span class="p">(</span><span class="n">maxnames</span> <span class="o">=</span> <span class="n">maxnames</span><span class="p">,</span><span class="n">progressbar</span><span class="o">=</span><span class="n">progressbar</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">)</span>
        
        <span class="n">flattened_data</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;excluded&#39;</span><span class="p">:</span> <span class="n">scenario</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                  <span class="k">for</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">years</span> <span class="ow">in</span> <span class="n">jackdict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">years</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)]</span>

        <span class="c1"># Creating the DataFrame</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">flattened_data</span><span class="p">)</span>
        
        <span class="c1"># Applying transformations</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;realvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;imagvalue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
        
        <span class="n">vardict</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;NONE&#39;</span><span class="p">:</span><span class="s1">&#39;whole model&#39;</span><span class="p">},</span> <span class="o">**</span><span class="p">{</span><span class="n">k</span> <span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">var_description</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">excluded_description</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;excluded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">vardict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>
        
        <span class="k">if</span> <span class="n">filecache</span><span class="p">:</span> 
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;jackdf.csv&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Jackdf written to file&#39;</span><span class="p">)</span>

            
            
        <span class="k">return</span> <span class="n">df</span> </div>

        
     
<div class="viewcode-block" id="newton_diff.get_eigen_jackknife_abs">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_eigen_jackknife_abs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigen_jackknife_abs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">largest</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">maxnames</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the absolute values of the largest eigenvalues from the jackknife eigenvalue analysis.</span>

<span class="sd">    This function calculates the absolute values of the largest eigenvalues for each set of eigenvalues obtained from the `get_eigen_jackknife` method. It focuses on the largest eigenvalues to understand the most significant influences on the system&#39;s stability.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - largest (int, optional): The number of largest eigenvalues to consider. Defaults to 20.</span>
<span class="sd">    - maxnames (int, optional): The maximum number of variables to exclude in the jackknife process. Defaults to 20.</span>

<span class="sd">    Returns:</span>
<span class="sd">    dict: A dictionary with the absolute values of the largest eigenvalues for each variable exclusion scenario.</span>

<span class="sd">    Note:</span>
<span class="sd">    This method helps in identifying the most impactful variables on the system&#39;s stability by focusing on the largest eigenvalues.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigen_jackknife</span><span class="p">(</span><span class="n">maxnames</span><span class="o">=</span><span class="n">maxnames</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span><span class="n">date</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">),</span> <span class="o">-</span><span class="n">largest</span><span class="p">)[</span><span class="o">-</span><span class="n">largest</span><span class="p">:])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    
               <span class="k">for</span> <span class="n">date</span><span class="p">,</span><span class="n">eigenvalues</span> <span class="ow">in</span> <span class="n">alldates</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> 
               <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">alldates</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">res</span></div>



<div class="viewcode-block" id="newton_diff.jack_largest_reduction">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.jack_largest_reduction">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">jack_largest_reduction</span><span class="p">(</span><span class="n">jackdf</span><span class="p">,</span> <span class="n">eigenvalue_row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imag_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies the largest reduction in eigenvalue magnitude for a specified period</span>
<span class="sd">        and optionally focuses on eigenvalues with imaginary parts if imag_only is True.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - jackdf (DataFrame): A DataFrame containing jackknife analysis results,</span>
<span class="sd">          including eigenvalues, their real and imaginary parts, and descriptions of</span>
<span class="sd">          exclusions.</span>
<span class="sd">        - eigenvalue_row (int, optional): The row index of the eigenvalue to analyze.</span>
<span class="sd">          Defaults to 0, which typically represents the largest magnitude eigenvalue.</span>
<span class="sd">        - periode (int/str, optional): The specific period (year) to analyze. If None,</span>
<span class="sd">          the function processes the first year found in the DataFrame. Defaults to None.</span>
<span class="sd">        - imag_only (bool, optional): If True, only considers eigenvalues with non-zero</span>
<span class="sd">          imaginary parts for analysis. Defaults to False.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">        DataFrame: A sorted DataFrame with the nth largest length (eigenvalue magnitude)</span>
<span class="sd">        for each excluded variable or condition, including the year, exclusion identifier,</span>
<span class="sd">        length (magnitude of the eigenvalue), description of the exclusion, and the real</span>
<span class="sd">        and imaginary parts of the eigenvalue. The row for &#39;excluded == &quot;NONE&quot;&#39; is moved to the front.</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">        Exception: If the specified period is not found in the DataFrame&#39;s years.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">years</span> <span class="o">=</span> <span class="n">jackdf</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
        <span class="c1"># Determine the year to analyze based on the input</span>
        <span class="k">if</span> <span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">periode</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">periode</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span> 
            <span class="n">year</span> <span class="o">=</span> <span class="n">years</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">periode</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span> 
            <span class="n">year</span> <span class="o">=</span> <span class="n">periode</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;No such year&#39;</span><span class="p">)</span>
    
        <span class="c1"># Filter DataFrame based on the specified year and condition</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">jackdf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;year == @year &amp; imagvalue != 0.0 &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">imag_only</span> <span class="k">else</span> <span class="n">jackdf</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;year == @year&#39;</span><span class="p">)</span>
    
        <span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;excluded&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
        <span class="n">nth_largest_length</span> <span class="o">=</span> <span class="n">df_sorted</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;excluded&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">nth</span><span class="p">(</span><span class="n">eigenvalue_row</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    
        <span class="c1"># Further refine and sort the resulting DataFrame</span>
        <span class="n">nth_largest_length</span> <span class="o">=</span> <span class="n">nth_largest_length</span><span class="p">[[</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;excluded&#39;</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;excluded_description&#39;</span><span class="p">,</span> <span class="s1">&#39;realvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;imagvalue&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;length&#39;</span><span class="p">)</span>
    
        <span class="c1"># Move the row where &#39;excluded == &quot;NONE&quot;&#39; to the front</span>
        <span class="n">none_row</span> <span class="o">=</span> <span class="n">nth_largest_length</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;excluded  == &quot;NONE&quot; &#39;</span><span class="p">)</span>
        <span class="n">others</span> <span class="o">=</span> <span class="n">nth_largest_length</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;excluded  != &quot;NONE&quot; &#39;</span><span class="p">)</span>
        <span class="n">new_nth_largest_length</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">none_row</span><span class="p">,</span> <span class="n">others</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">new_nth_largest_length</span></div>




<div class="viewcode-block" id="newton_diff.jack_largest_reduction_plot">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.jack_largest_reduction_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">jack_largest_reduction_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">jackdf</span><span class="p">,</span> <span class="n">eigenvalue_row</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">imag_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an interactive Plotly plot to visualize the reduction in eigenvalue magnitude across different exclusions,</span>
<span class="sd">        highlighting the &#39;NONE&#39; exclusion category with a distinct color and displaying detailed information on hover.</span>
<span class="sd">        Optionally focuses on eigenvalues with imaginary parts if imag_only is True.</span>
<span class="sd">        </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - jackdf (DataFrame): A DataFrame containing the results of a jackknife analysis, including eigenvalues and their</span>
<span class="sd">          descriptions. The DataFrame is expected to have at least the columns &#39;excluded&#39;, &#39;length&#39;, &#39;excluded_description&#39;,</span>
<span class="sd">          &#39;realvalue&#39;, and &#39;imagvalue&#39;.</span>
<span class="sd">        - eigenvalue_row (int, optional): Specifies the row index of the eigenvalue to analyze. Defaults to 0, which typically</span>
<span class="sd">          corresponds to the largest magnitude eigenvalue.</span>
<span class="sd">        - periode (int/str, optional): The specific period (year) to analyze. If None, the function processes data without</span>
<span class="sd">          filtering by period. Defaults to None.</span>
<span class="sd">        - imag_only (bool, optional): If True, only considers eigenvalues with non-zero imaginary parts for analysis.</span>
<span class="sd">          Defaults to False.</span>
<span class="sd">        </span>
<span class="sd">        The function processes the input DataFrame to highlight the &#39;NONE&#39; category in red and all other categories in blue.</span>
<span class="sd">        It then creates a Plotly FigureWidget to plot these data points as markers on a scatter plot. The y-axis tick labels are</span>
<span class="sd">        hidden to emphasize the data points rather than the categorical labels.</span>
<span class="sd">        </span>
<span class="sd">        An HTML widget is used to display detailed information about a data point (exclusion description, length, and imaginary</span>
<span class="sd">        part of the eigenvalue) when the user hovers over it. This interactive feature provides a deeper insight into the impact</span>
<span class="sd">        of each exclusion on the eigenvalue magnitude.</span>
<span class="sd">        </span>
<span class="sd">        Displays:</span>
<span class="sd">        - An interactive Plotly scatter plot within the Jupyter notebook.</span>
<span class="sd">        - A dynamic HTML widget that updates with detailed information about the hovered data point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">Textarea</span><span class="p">,</span> <span class="n">Layout</span> 
        
        <span class="n">result_df</span> <span class="o">=</span> <span class="vm">__class__</span><span class="o">.</span><span class="n">jack_largest_reduction</span><span class="p">(</span><span class="n">jackdf</span><span class="p">,</span> <span class="n">eigenvalue_row</span><span class="o">=</span><span class="n">eigenvalue_row</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="n">periode</span><span class="p">,</span><span class="n">imag_only</span><span class="o">=</span><span class="n">imag_only</span><span class="p">)</span>
        <span class="c1">#print(result_df)</span>
        
        <span class="c1"># Assign highlight colors based on the &#39;excluded&#39; category</span>
        <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;Highlight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;excluded&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;NONE&#39;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span> <span class="k">else</span> <span class="s1">&#39;Other&#39;</span><span class="p">)</span>
        <span class="c1"># Create a combined highlight column based on &#39;excluded&#39; and &#39;imagvalue&#39;</span>
        <span class="k">def</span> <span class="nf">get_highlight</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;excluded&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;imagvalue&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NONE (Non-zero Imag)&#39;</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;excluded&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;imagvalue&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;NONE (Zero Imag)&#39;</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;imagvalue&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Other (Non-zero Imag)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Other (Zero Imag)&#39;</span>
        
        <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;CombinedHighlight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_highlight</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Add a column for marker size based on the &#39;CombinedHighlight&#39; or any condition</span>
        <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;marker_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;CombinedHighlight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">20</span> <span class="k">if</span> <span class="s1">&#39;NONE&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">10</span><span class="p">)</span>


        <span class="c1"># Define color map for the combined highlight</span>
        <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;NONE (Non-zero Imag)&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NONE (Zero Imag)&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Other (Non-zero Imag)&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Other (Zero Imag)&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span>
        <span class="p">}</span>
        
        <span class="c1"># Create the Plotly FigureWidget using the combined highlight for color mapping</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;length&#39;</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;excluded&#39;</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;CombinedHighlight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">color_map</span><span class="p">),</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;marker_size&#39;</span><span class="p">]</span>  <span class="c1"># Use the marker_size column here</span>

                    <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">])</span>


        <span class="c1"># Create the Plotly FigureWidget with customized marker colors</span>
        <span class="c1"># fig = go.FigureWidget(data=[</span>
        <span class="c1">#     go.Scatter(x=result_df[&#39;length&#39;], y=result_df[&#39;excluded&#39;], mode=&#39;markers&#39;,</span>
        <span class="c1">#                marker=dict(color=result_df[&#39;Highlight&#39;].map({&#39;NONE&#39;: &#39;red&#39;, &#39;Other&#39;: &#39;blue&#39;})))</span>
        <span class="c1"># ])</span>
        
        <span class="c1"># Update layout to hide y-axis tick labels for a cleaner presentation</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Eigenvalue Lengths by excluded equation. </span><span class="si">{</span><span class="n">eigenvalue_row</span><span class="si">}</span><span class="s2">&#39;th largest eigenvalues, </span><span class="si">{</span><span class="s1">&#39;Only eigenvalues with imaginary values&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">imag_only</span><span class="w"> </span><span class="k">else</span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;y&#39;</span><span class="p">:</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="s1">&#39;xanchor&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
                <span class="s1">&#39;yanchor&#39;</span><span class="p">:</span> <span class="s1">&#39;top&#39;</span>
            <span class="p">},</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># Initialize the HTML widget for displaying hover information</span>
        <span class="n">textarea</span> <span class="o">=</span> <span class="n">Textarea</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Info:&#39;</span><span class="p">,</span>
                <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">layout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;95%&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="s1">&#39;100px&#39;</span><span class="p">}</span> <span class="p">,</span>
                <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;5%&#39;</span><span class="p">},</span>
                <span class="c1"># layout={&#39;width&#39;: &#39;100%&#39;, &#39;height&#39;: &#39;100px&#39;}  # Adjust the size as needed</span>
        <span class="p">)</span>
        <span class="n">info2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Length: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">   Imag: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;imagvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">textarea</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;The whole model, no equation excluded</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">info2</span> 


        
        <span class="c1"># Define the function to update the info widget upon hovering over a data point</span>
        <span class="k">def</span> <span class="nf">update_info</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Index of the hovered point</span>
                <span class="c1"># Format the information to display</span>
                
                <span class="n">info1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Excluded equation: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;excluded_description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">info2</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Length: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;length&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">   Imag: </span><span class="si">{</span><span class="n">result_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;imagvalue&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

                <span class="k">if</span> <span class="n">result_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;excluded&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NONE&#39;</span><span class="p">:</span>
                    <span class="n">textarea</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;The whole model, no equation excluded</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">info2</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">textarea</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">info1</span> <span class="o">+</span> <span class="n">info2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">result_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s1">&#39;excluded&#39;</span><span class="p">]][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span>
        
        <span class="c1"># Bind the on_hover event to the update_info function for each trace</span>
        
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">on_hover</span><span class="p">(</span><span class="n">update_info</span><span class="p">)</span>
        
        <span class="c1"># Combine the plot and info widget in a vertical layout and display them</span>
        <span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">fig</span><span class="p">,</span><span class="n">textarea</span><span class="p">]))</span></div>


   



<div class="viewcode-block" id="newton_diff.get_eigen_jackknife_abs_select">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_eigen_jackknife_abs_select">[docs]</a>
    <span class="k">def</span> <span class="nf">get_eigen_jackknife_abs_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">year</span><span class="o">=</span><span class="mi">2023</span><span class="p">,</span><span class="n">largest</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">maxnames</span> <span class="o">=</span> <span class="mi">200_000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Select and summarize the absolute largest eigenvalues for a specific year from the jackknife analysis.</span>

<span class="sd">This function focuses on a specific year and extracts the sum of the absolute largest eigenvalues obtained from the `get_eigen_jackknife_abs` method. It helps in understanding the aggregate impact of variable exclusions on the system&#39;s stability for a particular year.</span>

<span class="sd">Parameters:</span>
<span class="sd">- year (int, optional): The specific year to focus on. Defaults to 2023.</span>
<span class="sd">- largest (int, optional): The number of largest eigenvalues to consider. Defaults to 20.</span>
<span class="sd">- maxnames (int, optional): The maximum number of variables to exclude in the jackknife process. Defaults to 20.</span>

<span class="sd">Returns:</span>
<span class="sd">pandas.Series: A series sorted by the sum of the absolute largest eigenvalues for each variable exclusion scenario in the specified year.</span>

<span class="sd">Note:</span>
<span class="sd">This method is useful for temporal analysis of the system&#39;s stability, focusing on the contributions of each variable in a specific year.</span>
<span class="sd">&quot;&quot;&quot;</span>

        <span class="n">xx</span> <span class="o">=</span>  <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">year</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_eigen_jackknife_abs</span><span class="p">(</span><span class="n">maxnames</span><span class="o">=</span><span class="n">maxnames</span><span class="p">,</span><span class="n">largest</span><span class="o">=</span><span class="n">largest</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>    
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span> </div>

    
<div class="viewcode-block" id="newton_diff.get_df_eigen_dict">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_df_eigen_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">get_df_eigen_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rownames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}{</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">maxlag</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">]</span>   
        <span class="c1"># breakpoint()</span>
        <span class="n">values_and_vectors</span>  <span class="o">=</span> <span class="p">{</span><span class="n">per</span><span class="p">:</span> <span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Eigenvalues&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
                   <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">index</span> <span class="o">=</span> <span class="n">rownames</span><span class="p">)</span> <span class="p">]</span>
                       <span class="k">for</span> <span class="n">per</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigen_values_and_vectors</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="n">combined</span> <span class="o">=</span> <span class="p">{</span><span class="n">per</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">vandv</span><span class="p">)</span> 
                       <span class="k">for</span> <span class="n">per</span><span class="p">,</span><span class="n">vandv</span> <span class="ow">in</span> <span class="n">values_and_vectors</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        
        <span class="k">return</span> <span class="n">combined</span></div>


<div class="viewcode-block" id="newton_diff.get_df_comp_dict">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_df_comp_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">get_df_comp_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rownames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">c</span><span class="si">}{</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">maxlag</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                       <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">varnames</span><span class="p">]</span>   
        <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span> <span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">rownames</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">rownames</span><span class="p">)</span> 
                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">df_dict</span> </div>

        

<div class="viewcode-block" id="newton_diff.eigplot">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.eigplot">[docs]</a>
    <span class="k">def</span> <span class="nf">eigplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eig_dic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">eig_dic</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">this_eig_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_dic</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">this_eig_dic</span> <span class="o">=</span> <span class="n">eig_dic</span>
        <span class="c1"># breakpoint()    </span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">first_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">this_eig_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">first_key</span> <span class="o">=</span> <span class="n">per</span>
    
        <span class="n">w</span> <span class="o">=</span> <span class="n">this_eig_dic</span><span class="p">[</span><span class="n">first_key</span><span class="p">]</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="s1">&#39;polar&#39;</span><span class="p">})</span>  <span class="c1">#A4 </span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Eigen values in </span><span class="si">{</span><span class="n">first_key</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>   
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    
<div class="viewcode-block" id="newton_diff.eigenvector_plot">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.eigenvector_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">eigenvector_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        
        <span class="n">this_eig_dic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eig_dic</span> 
        <span class="c1"># breakpoint()    </span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">per</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="n">first_key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">this_eig_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">first_key</span> <span class="o">=</span> <span class="n">per</span>
    
        <span class="n">w</span> <span class="o">=</span> <span class="n">this_eig_dic</span><span class="p">[</span><span class="n">first_key</span><span class="p">]</span>
    
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="s1">&#39;polar&#39;</span><span class="p">})</span>  <span class="c1">#A4 </span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Eigen values in </span><span class="si">{</span><span class="n">first_key</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>   
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="newton_diff.get_feedback">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.get_feedback">[docs]</a>
    <span class="nd">@staticmethod</span>  
    <span class="k">def</span> <span class="nf">get_feedback</span><span class="p">(</span><span class="n">eig_dic</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Returns a dict of max abs eigenvector and the sign &#39;&#39;&#39;</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="n">per</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigen_vector</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigen_vector</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span> 
         <span class="k">for</span> <span class="n">per</span><span class="p">,</span><span class="n">eigen_vector</span> <span class="ow">in</span> <span class="n">eig_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span></div>

        
        
<div class="viewcode-block" id="newton_diff.eigplot_all0">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.eigplot_all0">[docs]</a>
    <span class="k">def</span> <span class="nf">eigplot_all0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eig_dic</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)):</span>
        <span class="n">colrows</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">colrows</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">eig_dic</span><span class="p">))</span>
        <span class="n">nrows</span><span class="o">=-</span><span class="p">((</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">eig_dic</span><span class="p">))</span><span class="o">//</span><span class="n">ncols</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nrows</span><span class="p">),</span>
                                 <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="s1">&#39;polar&#39;</span><span class="p">},</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">laxis</span> <span class="o">=</span> <span class="n">axis</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">ax</span><span class="p">,(</span><span class="n">key</span><span class="p">,</span><span class="n">w</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">laxis</span><span class="p">,</span><span class="n">eig_dic</span><span class="o">.</span><span class="n">items</span><span class="p">())):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

    
        <span class="k">return</span> <span class="n">fig</span></div>

    
    <span class="k">def</span> <span class="nf">eigplot_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eig_dic</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">maxfig</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Plots the eigenvalues for specified periods in polar coordinates.</span>

<span class="sd">This method takes a dictionary of eigenvalues, optionally filters them by specified periods, </span>
<span class="sd">and plots each eigenvalue on polar plots. The number of plots can be limited by `maxfig`. </span>
<span class="sd">If `periode` is not specified, it defaults to the current period defined in the model object. </span>
<span class="sd">The plots are arranged in a grid, with a maximum of two columns.</span>

<span class="sd">Parameters</span>
<span class="sd">----------</span>
<span class="sd">eig_dic : dict</span>
<span class="sd">    A dictionary where keys are period identifiers and values are iterables of complex numbers </span>
<span class="sd">    representing eigenvalues.</span>
<span class="sd">periode : iterable, optional</span>
<span class="sd">    An iterable of period identifiers to plot. If `None` (default), eigenvalues for the current </span>
<span class="sd">    period in the model are plotted.</span>
<span class="sd">size : tuple of int, optional</span>
<span class="sd">    The size of each subplot in inches. Default is (4, 3).</span>
<span class="sd">maxfig : int, optional</span>
<span class="sd">    The maximum number of figures to display. Default is 6.</span>

<span class="sd">Returns</span>
<span class="sd">-------</span>
<span class="sd">matplotlib.figure.Figure</span>
<span class="sd">    A matplotlib Figure object containing the generated plots.</span>



<span class="sd">&quot;&quot;&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span> 

        <span class="n">_per_first</span> <span class="o">=</span> <span class="n">periode</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">periode</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">current_per</span>  
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_per_first</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">_per</span>  <span class="o">=</span> <span class="n">_per_first</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_per</span> <span class="o">=</span> <span class="p">[</span><span class="n">_per_first</span><span class="p">]</span>

        <span class="n">plot_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span> <span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">eig_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_per</span> <span class="p">}</span>
        
        
        <span class="n">maxaxes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxfig</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_dic</span><span class="p">))</span>
        <span class="n">colrow</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">colrow</span><span class="p">,</span><span class="n">maxaxes</span><span class="p">)</span>
        <span class="n">nrows</span><span class="o">=-</span><span class="p">((</span><span class="o">-</span><span class="n">maxaxes</span><span class="p">)</span><span class="o">//</span><span class="n">ncols</span><span class="p">)</span>
         
        <span class="n">fig</span>  <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="n">ncols</span><span class="p">,</span><span class="mi">10</span><span class="o">*</span><span class="n">nrows</span><span class="p">),</span><span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span><span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span><span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        <span class="c1"># breakpoint()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Eigenvalues&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">key</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">maxaxes</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">i</span><span class="o">%</span><span class="n">colrow</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">i</span><span class="o">//</span><span class="n">colrow</span>
            <span class="c1"># print(i,row,col)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> 
        <span class="k">return</span> <span class="n">fig</span>
    
<div class="viewcode-block" id="newton_diff.eigplot_all">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.eigplot_all">[docs]</a>
    <span class="k">def</span> <span class="nf">eigplot_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eig_dic</span><span class="p">,</span> <span class="n">periode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">maxfig</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
    
        <span class="n">_per_first</span> <span class="o">=</span> <span class="n">periode</span> <span class="k">if</span> <span class="n">periode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">current_per</span>
    
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_per_first</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="n">_per</span> <span class="o">=</span> <span class="n">_per_first</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_per</span> <span class="o">=</span> <span class="p">[</span><span class="n">_per_first</span><span class="p">]</span>
    
        <span class="n">plot_dic</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">eig_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_per</span><span class="p">}</span>
    
        <span class="n">maxaxes</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxfig</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_dic</span><span class="p">))</span>
        <span class="n">colrow</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">colrow</span><span class="p">,</span> <span class="n">maxaxes</span><span class="p">)</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="n">maxaxes</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncols</span><span class="p">)</span>
        
        <span class="c1"># Dynamically calculate figure size based on subplot size and layout</span>
        <span class="n">fig_width</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ncols</span>  <span class="c1"># Adjusted to consider &#39;size&#39; parameter for width</span>
        <span class="n">fig_height</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">nrows</span>  <span class="c1"># Adjusted to consider &#39;size&#39; parameter for height</span>
        
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_width</span><span class="p">,</span> <span class="n">fig_height</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Eigenvalues&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">maxaxes</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">colrow</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="n">colrow</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;polar&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_rticks</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span></div>

    
<div class="viewcode-block" id="newton_diff.plot_eigenvalues_polar_old">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.plot_eigenvalues_polar_old">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_eigenvalues_polar_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eig_dic</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span>  <span class="n">Dropdown</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">HTML</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
        

        
        <span class="n">year_dropdown</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">eig_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Time:&#39;</span><span class="p">)</span>
        <span class="n">info_box</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;Hover over a point to see details.&quot;</span><span class="p">)</span>
        <span class="n">plot_output</span> <span class="o">=</span> <span class="n">Output</span><span class="p">()</span>
    
        <span class="k">def</span> <span class="nf">plot_eigenvalues_polar_vectors</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
            <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eig_dic</span><span class="p">[</span><span class="n">year</span><span class="p">]</span>
    
            <span class="k">with</span> <span class="n">plot_output</span><span class="p">:</span>
                <span class="n">plot_output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">r_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">eigenvalues</span><span class="p">]</span>  <span class="c1"># Magnitudes for the polar plot</span>
                <span class="n">theta_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">eigenvalues</span><span class="p">]</span>  <span class="c1"># Angles for the polar plot</span>
                
                <span class="c1"># Prepare data for the plot, repeating magnitude and angle for each eigenvalue, and adding breaks (None)</span>
                <span class="n">r_plot_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">r_values</span><span class="p">),</span> <span class="n">r_values</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">r_values</span><span class="p">))</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>
                <span class="n">theta_plot_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">theta_values</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_values</span><span class="p">))</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>
    
                <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatterpolar</span><span class="p">(</span>
                    <span class="n">r</span><span class="o">=</span><span class="n">r_plot_values</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">theta_plot_values</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+markers&#39;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                <span class="p">))</span>
    
                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Polar Plot of Eigenvalue Vectors for Year </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">polar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">radialaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">r_values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">]),</span>
                        <span class="n">angularaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;clockwise&#39;</span><span class="p">,</span> <span class="n">thetaunit</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
    
                <span class="k">def</span> <span class="nf">update_info</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">:</span>
                        <span class="c1"># Each eigenvalue is represented by 3 points in the plot data (start, end, None), calculate the index accordingly</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">3</span>
                        <span class="n">ev</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>  <span class="c1"># Get the eigenvalue</span>
    
                <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">trace</span><span class="o">.</span><span class="n">on_hover</span><span class="p">(</span><span class="n">update_info</span><span class="p">)</span>
    
                <span class="n">display</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    
        <span class="k">def</span> <span class="nf">on_year_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
            <span class="n">plot_eigenvalues_polar_vectors</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    
        <span class="n">year_dropdown</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_year_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">year_dropdown</span><span class="p">,</span> <span class="n">plot_output</span><span class="p">]))</span>
        <span class="n">plot_eigenvalues_polar_vectors</span><span class="p">(</span><span class="n">year_dropdown</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="newton_diff.eigenvalues_show">
<a class="viewcode-back" href="../core/modelnewton.html#modelnewton.newton_diff.eigenvalues_show">[docs]</a>
    <span class="k">def</span> <span class="nf">eigenvalues_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">eig_dic</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates and displays a polar plot of eigenvalues and their corresponding eigenvectors</span>
<span class="sd">        for a selected year from a dictionary of DataFrames. Each DataFrame contains eigenvalues</span>
<span class="sd">        and eigenvectors of the companion matrix for that year. The first row of the DataFrame</span>
<span class="sd">        consists of eigenvalues, and the subsequent rows contain the corresponding eigenvectors.</span>
<span class="sd">        The user can interact with the plot via a dropdown for year selection, a slider for eigenvalue</span>
<span class="sd">        selection, and a button to toggle additional plot details. The polar plot dynamically updates</span>
<span class="sd">        to reflect the selected eigenvalue, displaying its magnitude and phase. Additional information</span>
<span class="sd">        about the selected eigenvector is also displayed, facilitating a detailed temporal analysis</span>
<span class="sd">        of the eigenvalues.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - eig_dic (dict): A dictionary where keys are years (or time periods) and values are DataFrames</span>
<span class="sd">                          containing the first row as eigenvalues and the subsequent rows as the corresponding</span>
<span class="sd">                          eigenvectors of the companion matrix for each year.</span>
<span class="sd">    </span>
<span class="sd">        Side Effects:</span>
<span class="sd">        - Displays interactive widgets including a dropdown for year selection, a plot output area,</span>
<span class="sd">          and a slider for selecting specific eigenvalues. Additionally, displays textual information</span>
<span class="sd">          about the selected eigenvalue and its eigenvectors.</span>
<span class="sd">        - Utilizes Plotly for generating the polar plot and ipywidgets for interactive controls.</span>
<span class="sd">        - The method defines and uses several inner functions to handle events like year change,</span>
<span class="sd">          eigenvalue selection, and other interactions.</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">        - None. The method&#39;s primary function is to display interactive widgets and plots within a Jupyter</span>
<span class="sd">          notebook environment.</span>
<span class="sd">    </span>
<span class="sd">        Note:</span>
<span class="sd">        - This method is designed for use within a Jupyter notebook as it relies on IPython.display</span>
<span class="sd">          for rendering and ipywidgets for interactivity.</span>
<span class="sd">        - The actual plotting and widget setup are accomplished through several nested functions within</span>
<span class="sd">          this method, making use of closures and nonlocal variables for state management.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
        <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
        <span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span>  <span class="n">Dropdown</span><span class="p">,</span> <span class="n">Output</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">HBox</span><span class="p">,</span> <span class="n">IntSlider</span><span class="p">,</span><span class="n">Select</span><span class="p">,</span><span class="n">Textarea</span><span class="p">,</span><span class="n">Checkbox</span><span class="p">,</span><span class="n">Button</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
        


        
        
        
        <span class="n">year_dropdown</span> <span class="o">=</span> <span class="n">Dropdown</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">eig_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Time:&#39;</span><span class="p">)</span>
        <span class="n">plot_output</span> <span class="o">=</span> <span class="n">Output</span><span class="p">()</span>
        
        <span class="k">def</span> <span class="nf">get_a_eigenvalue_vector</span><span class="p">(</span><span class="n">eigenvalues_vectors</span><span class="p">,</span><span class="n">year</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Extracts and processes eigenvalues and their corresponding eigenvectors for a given year.</span>
<span class="sd">            Filters and sorts eigenvalues by their magnitude, returning the significant eigenvalues and</span>
<span class="sd">            their associated eigenvectors.</span>
<span class="sd">    </span>
<span class="sd">            Parameters:</span>
<span class="sd">            - eigenvalues_vectors (dict): Dictionary containing DataFrames of eigenvalues and eigenvectors</span>
<span class="sd">                                          indexed by year.</span>
<span class="sd">            - year (str/int): The year for which to extract and process the eigenvalue vector.</span>
<span class="sd">    </span>
<span class="sd">            Returns:</span>
<span class="sd">            - tuple: A tuple containing the significant eigenvalue and a DataFrame of the corresponding</span>
<span class="sd">                     eigenvectors after processing.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            
            <span class="n">compabs</span> <span class="o">=</span> <span class="k">lambda</span> <span class="nb">complex</span><span class="p">:</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">complex</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            
            <span class="n">eig_gt</span> <span class="o">=</span> <span class="p">(</span><span class="n">eigenvalues_vectors</span><span class="p">[</span><span class="n">year</span><span class="p">]</span><span class="o">.</span>   
                        <span class="n">T</span><span class="o">.</span>        <span class="c1"># Transpose as we query and eval on columns </span>
                        <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;absolute_value=@compabs(Eigenvalues)&#39;</span><span class="p">)</span><span class="o">.</span> <span class="c1"># calculate the absolute value of the eigenvalue </span>
                        <span class="n">query</span><span class="p">(</span><span class="s1">&#39;absolute_value &gt; 0.01&#39;</span><span class="p">)</span><span class="o">.</span>
                        <span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;absolute_value&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span>    <span class="c1"># Transpose again. </span>
                        <span class="n">drop</span><span class="p">(</span><span class="s1">&#39;absolute_value&#39;</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>                <span class="c1"># We dont need the absolute value anymore, so the column is dropped. </span>
             <span class="p">)</span>
    
            <span class="k">return</span> <span class="n">eig_gt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">eig_gt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> 

        
    
        <span class="k">def</span> <span class="nf">plot_eigenvalues_polar_vectors</span><span class="p">(</span><span class="n">year</span><span class="p">):</span>
            <span class="n">eigenvalues</span><span class="p">,</span><span class="n">eigenvectors</span> <span class="o">=</span> <span class="n">get_a_eigenvalue_vector</span><span class="p">(</span><span class="n">eig_dic</span><span class="p">,</span><span class="n">year</span> <span class="p">)</span>
            <span class="n">valueslider</span> <span class="o">=</span> <span class="n">IntSlider</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="nb">max</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Number:&#39;</span><span class="p">,</span>
                    <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">continuous_update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span>
                    <span class="n">readout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">readout_format</span><span class="o">=</span><span class="s1">&#39;d&#39;</span>
                <span class="p">)</span>
            
            <span class="n">var_info</span> <span class="o">=</span> <span class="n">Textarea</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Info:&#39;</span><span class="p">,</span>
                    <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">layout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;95%&#39;</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="s1">&#39;100px&#39;</span><span class="p">}</span> <span class="p">,</span>
                    <span class="n">style</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;5%&#39;</span><span class="p">},</span>
                    <span class="c1"># layout={&#39;width&#39;: &#39;100%&#39;, &#39;height&#39;: &#39;100px&#39;}  # Adjust the size as needed</span>
            <span class="p">)</span>

            <span class="n">wopenplot</span>  <span class="o">=</span> <span class="n">Button</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Open plot widget&#39;</span><span class="p">,</span><span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">icon</span><span class="o">=</span><span class="s1">&#39;check&#39;</span><span class="p">,</span>
                                         <span class="n">layout</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span><span class="s1">&#39;95%&#39;</span><span class="p">}</span>    <span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span><span class="s1">&#39;70%&#39;</span><span class="p">})</span>
            
            <span class="k">with</span> <span class="n">plot_output</span><span class="p">:</span>
                <span class="n">plot_output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">r_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">eigenvalues</span><span class="p">]</span>  <span class="c1"># Magnitudes for the polar plot</span>
                <span class="n">theta_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">eigenvalues</span><span class="p">]</span>  <span class="c1"># Angles for the polar plot</span>
                
                <span class="c1"># Prepare data for the plot, repeating magnitude and angle for each eigenvalue, and adding breaks (None)</span>
                <span class="n">r_plot_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">r_values</span><span class="p">),</span> <span class="n">r_values</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">r_values</span><span class="p">))</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>
                <span class="n">theta_plot_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">theta_values</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_values</span><span class="p">))</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>
    
                <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatterpolar</span><span class="p">(</span>
                    <span class="n">r</span><span class="o">=</span><span class="n">r_plot_values</span><span class="p">,</span>
                    <span class="n">theta</span><span class="o">=</span><span class="n">theta_plot_values</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines+markers&#39;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
                <span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                <span class="n">title_text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>  <span class="c1"># Ensure no title is set</span>
                <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># Adjust margins around the plot</span>
                  <span class="p">)</span>

                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                   <span class="c1"># title=f&#39;Polar Plot of Eigenvalue Vectors for Year {year}&#39;,</span>
                    <span class="n">polar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">radialaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">r_values</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">]),</span>
                        <span class="n">angularaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;clockwise&#39;</span><span class="p">,</span> <span class="n">thetaunit</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
                <span class="n">v_dropdown_description</span> <span class="o">=</span> <span class="n">HTML</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;&lt;strong&gt;Eigenvalue :&lt;/strong&gt; &lt;br&gt;&lt;strong&gt;Eigenvectors:&lt;/strong&gt;&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,)</span>
                <span class="n">v_dropdown</span> <span class="o">=</span> <span class="n">Select</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">rows</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">layout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="p">:</span> <span class="s1">&#39;95%&#39;</span><span class="p">})</span>
                <span class="n">box</span> <span class="o">=</span>  <span class="n">VBox</span><span class="p">([</span><span class="n">HBox</span><span class="p">([</span><span class="n">fig</span><span class="p">,</span><span class="n">valueslider</span><span class="p">,</span><span class="n">VBox</span><span class="p">([</span><span class="n">v_dropdown_description</span><span class="p">,</span><span class="n">v_dropdown</span><span class="p">,</span><span class="n">wopenplot</span><span class="p">])]),</span><span class="n">var_info</span><span class="p">])</span>
                
                <span class="n">lopenplot</span> <span class="o">=</span> <span class="kc">False</span> 
                
                <span class="k">def</span> <span class="nf">vector_info</span><span class="p">(</span><span class="n">selected_index</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Updates the displayed information for a selected eigenvector, including its magnitude,</span>
<span class="sd">                    phase, and detailed component values. Dynamically updates dropdown options to reflect</span>
<span class="sd">                    the components of the selected eigenvector.</span>
<span class="sd">    </span>
<span class="sd">                    Parameters:</span>
<span class="sd">                    - selected_index (int): Index of the selected eigenvalue/eigenvector.</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="k">nonlocal</span> <span class="n">lopenplot</span>
                    <span class="n">this_vector</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">selected_index</span><span class="p">,:]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">eigenvalue</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]</span>
                    
                    <span class="n">select_options</span> <span class="o">=</span> <span class="p">[(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">this_vector</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>  <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mf">0.01</span><span class="p">]</span>
                    <span class="n">v_dropdown</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">select_options</span>
                    
                    <span class="n">v_dropdown_description</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;strong&gt;Eigenvalue #: </span><span class="si">{</span><span class="n">selected_index</span><span class="si">}</span><span class="s2">&lt;/strong&gt; &lt;br&gt;Length: </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">eigenvalue</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;br&gt;Real: </span><span class="si">{</span><span class="n">eigenvalue</span><span class="o">.</span><span class="n">real</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&lt;br&gt;Imag: </span><span class="si">{</span><span class="n">eigenvalue</span><span class="o">.</span><span class="n">imag</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> &lt;br&gt;&lt;strong&gt;Eigenvectors:&lt;/strong&gt;&quot;</span>
                    <span class="c1"># gross_varnames = [v.split(&#39;(&#39;)[0] for t,v in select_options]</span>
                    <span class="c1"># varnames = &#39; &#39;.join(list(dict.fromkeys(gross_varnames)))  </span>
                    <span class="c1"># keepbox = self.mmodel.keep_show(use_var_groups=False,selectfrom = varnames,use_smpl= True)</span>
                    <span class="k">if</span> <span class="n">lopenplot</span> <span class="p">:</span> 
                        <span class="n">plot_output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># box =  VBox([HBox([fig,valueslider,VBox([v_dropdown_description,v_dropdown,wopenplot])]),var_info,keepbox.datawidget])</span>
                        <span class="n">box</span> <span class="o">=</span>  <span class="n">VBox</span><span class="p">([</span><span class="n">HBox</span><span class="p">([</span><span class="n">fig</span><span class="p">,</span><span class="n">valueslider</span><span class="p">,</span><span class="n">VBox</span><span class="p">([</span><span class="n">v_dropdown_description</span><span class="p">,</span><span class="n">v_dropdown</span><span class="p">,</span><span class="n">wopenplot</span><span class="p">])]),</span><span class="n">var_info</span><span class="p">])</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                        <span class="n">lopenplot</span> <span class="o">=</span> <span class="kc">False</span>


                
                <span class="n">vector_info</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                
                <span class="k">def</span> <span class="nf">on_openplot</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Handles the event triggered by clicking the &#39;Open plot widget&#39; button. It refreshes the plot</span>
<span class="sd">                    and optionally includes additional widgets for further data exploration.</span>
<span class="sd">    </span>
<span class="sd">                    Parameters:</span>
<span class="sd">                    - change (dict): Contains details of the button click event. Not used in the function body</span>
<span class="sd">                                     but necessary for event handler signature.</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="k">nonlocal</span> <span class="n">lopenplot</span>
                    <span class="n">lopenplot</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">gross_varnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span>  <span class="n">v_dropdown</span><span class="o">.</span><span class="n">options</span><span class="p">]</span>
                    <span class="n">varnames</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">gross_varnames</span><span class="p">)))</span>  
                    <span class="n">keepbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">keep_show</span><span class="p">(</span><span class="n">use_var_groups</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">selectfrom</span> <span class="o">=</span> <span class="n">varnames</span><span class="p">,</span><span class="n">use_smpl</span><span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">init_dif</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">box</span> <span class="o">=</span>  <span class="n">VBox</span><span class="p">([</span><span class="n">HBox</span><span class="p">([</span><span class="n">fig</span><span class="p">,</span><span class="n">valueslider</span><span class="p">,</span><span class="n">VBox</span><span class="p">([</span><span class="n">v_dropdown_description</span><span class="p">,</span><span class="n">v_dropdown</span><span class="p">,</span><span class="n">wopenplot</span><span class="p">])]),</span><span class="n">var_info</span><span class="p">,</span><span class="n">keepbox</span><span class="o">.</span><span class="n">datawidget</span><span class="p">])</span>
                    <span class="n">plot_output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">display</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">info_show</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Displays information about the eigenvalue and its corresponding eigenvectors for a given index.</span>
<span class="sd">                    This function is designed to update the displayed information based on user selection or interaction.</span>
<span class="sd">    </span>
<span class="sd">                    Parameters:</span>
<span class="sd">                    - ind (int): The index of the selected eigenvalue to display information for.</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="n">ev</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>  <span class="c1"># Get the eigenvalue</span>
                    <span class="n">vector_info</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    
                <span class="k">def</span> <span class="nf">update_info</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Callback function to handle hover events on the plot. It identifies the eigenvalue</span>
<span class="sd">                    corresponding to the hovered point and updates the information displayed to the user.</span>
<span class="sd">    </span>
<span class="sd">                    Parameters:</span>
<span class="sd">                    - trace: The trace object associated with the hover event. Not used in the function body.</span>
<span class="sd">                    - points: The points object containing information about the hovered point.</span>
<span class="sd">                    - _: Placeholder for additional arguments. Not used in the function body.</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="k">nonlocal</span> <span class="n">lopenplot</span>
                    <span class="k">if</span> <span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">lopenplot</span> <span class="p">:</span> 
                            <span class="n">plot_output</span><span class="o">.</span><span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># box =  VBox([HBox([fig,valueslider,VBox([v_dropdown_description,v_dropdown,wopenplot])]),var_info,keepbox.datawidget])</span>
                            <span class="n">box</span> <span class="o">=</span>  <span class="n">VBox</span><span class="p">([</span><span class="n">HBox</span><span class="p">([</span><span class="n">fig</span><span class="p">,</span><span class="n">valueslider</span><span class="p">,</span><span class="n">VBox</span><span class="p">([</span><span class="n">v_dropdown_description</span><span class="p">,</span><span class="n">v_dropdown</span><span class="p">,</span><span class="n">wopenplot</span><span class="p">])]),</span><span class="n">var_info</span><span class="p">])</span>
                            <span class="n">display</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
                            <span class="n">lopenplot</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># Each eigenvalue is represented by 3 points in the plot data (start, end, None), calculate the index accordingly</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">point_inds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">3</span>
                        <span class="n">valueslider</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ind</span> 
                        <span class="n">info_show</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                    
                
                    
                
                <span class="k">def</span> <span class="nf">on_v_dropdown_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span> 
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Handles changes in the eigenvector selection dropdown. Updates the displayed information</span>
<span class="sd">                    related to the selected eigenvector, including its description and formula.</span>
<span class="sd">    </span>
<span class="sd">                    Parameters:</span>
<span class="sd">                    - change (dict): Contains details of the selection change in the dropdown widget.</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="c1"># print(f&#39;{change=}&#39;)</span>
                    <span class="c1"># print(f&#39;{change.owner=}&#39;)</span>
                    <span class="c1"># print(f&#39;{change.owner.options=}&#39;)</span>
                    <span class="c1"># print(f&#39;{change.new=}&#39; + &#39;\n&#39;)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">new</span> <span class="p">):</span> 
                        <span class="n">index</span><span class="o">=</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">owner</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">varname</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">info1</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">varname</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">var_description</span><span class="p">[</span><span class="n">varname</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="n">info2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mmodel</span><span class="o">.</span><span class="n">allvar</span><span class="p">[</span><span class="n">varname</span><span class="p">][</span><span class="s1">&#39;frml&#39;</span><span class="p">]</span>
                        <span class="n">var_info</span><span class="o">.</span><span class="n">value</span><span class="o">=</span>   <span class="n">info1</span>  <span class="o">+</span>  <span class="n">info2</span>   
                


                    
                    
                <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">trace</span><span class="o">.</span><span class="n">on_hover</span><span class="p">(</span><span class="n">update_info</span><span class="p">)</span>
                
                
                
                
                <span class="k">def</span> <span class="nf">on_slide_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span> 
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Responds to changes in the eigenvalue selection slider. Updates the plot to highlight</span>
<span class="sd">                    the selected eigenvalue and its corresponding eigenvectors, and updates displayed information.</span>
<span class="sd">    </span>
<span class="sd">                    Parameters:</span>
<span class="sd">                    - change (dict): Contains details of the slider value change.</span>
<span class="sd">                    &quot;&quot;&quot;</span>

                    <span class="c1"># print(f&#39;{change.new=} &#39;)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span> 
                        <span class="n">selected_index</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">new</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">):</span>
                            <span class="n">selected_index</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span> 
                            <span class="k">return</span> 
                    <span class="c1"># print(f&#39;{change.new=} {selected_index=}&#39;)</span>
                    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">selected_index</span> <span class="k">else</span> <span class="s1">&#39;green&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">))]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="n">color</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span> <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>
                    <span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">selected_index</span> <span class="k">else</span> <span class="mi">5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">))]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">marker</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">[</span><span class="n">size</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span><span class="n">sizes</span><span class="p">,</span><span class="n">sizes</span><span class="p">)</span> <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">]</span>

                    <span class="n">info_show</span><span class="p">(</span><span class="n">selected_index</span><span class="p">)</span>
                
                <span class="c1"># update_info(None,SimulatedPoints(0),None) </span>
                
                
                <span class="n">wopenplot</span><span class="o">.</span><span class="n">on_click</span><span class="p">(</span><span class="n">on_openplot</span><span class="p">)</span> 
                
                <span class="n">valueslider</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_slide_change</span><span class="p">)</span>
                
                <span class="n">v_dropdown</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_v_dropdown_change</span><span class="p">)</span>
                
                <span class="n">valueslider</span><span class="o">.</span><span class="n">value</span><span class="o">=</span> <span class="mi">0</span> 
     
                <span class="n">display</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">on_year_change</span><span class="p">(</span><span class="n">change</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Callback function for handling changes in the year selection dropdown. Updates the polar plot</span>
<span class="sd">            to display the eigenvalues and eigenvectors for the newly selected year.</span>
<span class="sd">    </span>
<span class="sd">            Parameters:</span>
<span class="sd">            - change (dict): Contains details about the change event in the year dropdown.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">plot_eigenvalues_polar_vectors</span><span class="p">(</span><span class="n">change</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
    
        <span class="n">year_dropdown</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">on_year_change</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="n">display</span><span class="p">(</span><span class="n">VBox</span><span class="p">([</span><span class="n">year_dropdown</span><span class="p">,</span> <span class="n">plot_output</span><span class="p">]))</span>
        <span class="n">plot_eigenvalues_polar_vectors</span><span class="p">(</span><span class="n">year_dropdown</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>
</div>



<span class="c1">#%%    </span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1">#%% testing</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONBREAKPOINT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
    <span class="kn">from</span> <span class="nn">modelclass</span> <span class="kn">import</span> <span class="n">model</span>
    <span class="n">fsolow</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s1">    Y         = a * k**alfa * l **(1-alfa) </span>
<span class="s1">    C         = (1-SAVING_RATIO)  * Y(-1) </span>
<span class="s1">    I         = Y - C </span>
<span class="s1">    diff(K)   = I-depreciates_rate * K(-1)</span>
<span class="s1">    diff(l)   = labor_growth * (L(-1)+l(-2))/2 </span>
<span class="s1">    K_intense = K/L &#39;&#39;&#39;</span>
    <span class="n">msolow</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">from_eq</span><span class="p">(</span><span class="n">fsolow</span><span class="p">)</span>
    <span class="c1">#print(msolow.equations)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;L&#39;</span><span class="p">:[</span><span class="mi">100</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">:[</span><span class="mi">100</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">},</span><span class="n">index</span> <span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2000</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;ALFA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;DEPRECIATES_RATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;LABOR_GROWTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;SAVING_RATIO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.10</span>
    <span class="n">msolow</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ljit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">transpile_reset</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">msolow</span><span class="o">.</span><span class="n">normalized</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="n">newton_all</span>    <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="n">msolow</span><span class="p">,</span><span class="n">forcenum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="mi">2002</span><span class="p">)</span>
    <span class="n">dif__model</span> <span class="o">=</span> <span class="n">newton_all</span><span class="o">.</span><span class="n">diff_model</span><span class="o">.</span><span class="n">equations</span>
    <span class="n">melt</span> <span class="o">=</span> <span class="n">newton_all</span><span class="o">.</span><span class="n">get_diff_melted_var</span><span class="p">()</span>
    <span class="n">tt</span> <span class="o">=</span> <span class="n">newton_all</span><span class="o">.</span><span class="n">get_diff_mat_all_1per</span><span class="p">(</span><span class="mi">2002</span><span class="p">,</span><span class="n">asdf</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#newton_all.show_diff()</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">newton_all</span><span class="o">.</span><span class="n">get_eigenvalues</span> <span class="p">(</span><span class="n">asdf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">periode</span><span class="o">=</span><span class="mi">2010</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">=</span> <span class="n">newton_all</span><span class="o">.</span><span class="n">eigplot_all</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span><span class="n">maxfig</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1">#%% more testing </span>
    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">newton</span>    <span class="o">=</span> <span class="n">newton_diff</span><span class="p">(</span><span class="n">msolow</span><span class="p">)</span>
        <span class="n">pdic</span> <span class="o">=</span> <span class="n">newton</span><span class="o">.</span><span class="n">get_diff_df_1per</span><span class="p">()</span>
        <span class="n">longdf</span> <span class="o">=</span> <span class="n">newton</span><span class="o">.</span><span class="n">get_diff_melted</span><span class="p">()</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Ib Hansen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>